<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SABR METRICS LAB | Ultimate Calculator Edition</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" href="Copilot_20251122_185005.png" type="image/png">
    <link rel="apple-touch-icon" href="Copilot_20251122_185005.png">
    <!-- Chart.js for Radar Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M4CEZGS8HY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-M4CEZGS8HY');
    </script>
    <style>
        /* --- Design Tokens (Sports Analytics Style) --- */
        :root {
            --c-bg: #f4f5f7; /* æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼ã®å®Ÿå‹™çš„ãªèƒŒæ™¯ */
            --c-surface: #ffffff;
            --c-text-primary: #172b4d; /* æ¿ƒç´ºï¼ˆè¦–èªæ€§é‡è¦–ï¼‰ */
            --c-text-secondary: #5e6c84;
            --c-border: #dfe1e6;
            
            /* Category Colors (Solid & Sporty) */
            --cat-bat: #c0392b; --bg-bat: #f9ebea; /* Crimson Red */
            --cat-pit: #2980b9; --bg-pit: #ebf5fb; /* Strong Blue */
            --cat-fld: #d35400; --bg-fld: #fef5e7; /* Pumpkin Orange */
            --cat-tot: #27ae60; --bg-tot: #e9f7ef; /* Jungle Green */
            --cat-std: #5e6c84; --bg-std: #ebecf0; /* Neutral Grey */
            
            --data-source-color: #34495e;
            --ai-color: #2c3e50; /* AIè‰²ï¼ˆç´«ï¼‰ã‚’å»ƒæ­¢ã—ã€ã‚·ãƒƒã‚¯ãªè‰²ã¸ */
            
            /* Shadows: Flatter, crisper look */
            --shadow-card: 0 1px 2px rgba(9, 30, 66, 0.25);
            --shadow-hover: 0 4px 8px rgba(9, 30, 66, 0.25);
            --shadow-float: 0 8px 16px rgba(9, 30, 66, 0.25);

            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            --font-serif: "Georgia", "Times New Roman", Times, serif;
            
            /* Radius: Sharp & Professional */
            --radius-sm: 3px;
            --radius-md: 4px;
            --radius-lg: 6px;
        }

        /* --- Dark Mode Overrides (Professional Dark) --- */
        body.dark-mode {
            --c-bg: #121212; /* çœŸã£é»’ã«è¿‘ã„ã‚°ãƒ¬ãƒ¼ */
            --c-surface: #1e1e1e;
            --c-text-primary: #e0e0e0;
            --c-text-secondary: #a0a0a0;
            --c-border: #333333;
            
            --bg-bat: rgba(192, 57, 43, 0.2);
            --bg-pit: rgba(41, 128, 185, 0.2);
            --bg-fld: rgba(211, 84, 0, 0.2);
            --bg-tot: rgba(39, 174, 96, 0.2);
            --bg-std: rgba(94, 108, 132, 0.2);
            
            --shadow-card: 0 1px 2px rgba(0, 0, 0, 0.5);
            --shadow-hover: 0 4px 8px rgba(0, 0, 0, 0.6);
        }

        body {
            background-color: var(--c-bg);
            color: var(--c-text-primary);
            font-family: var(--font-sans);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            overflow-y: scroll;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Header (Solid & Clean) --- */
        header {
            background: #2c3e50; /* ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ€ãƒ¼ã‚¯ãƒã‚¤ãƒ“ãƒ¼ */
            padding: 1.5rem 2rem;
            color: #ffffff;
            border-bottom: 4px solid var(--cat-bat); /* é‡çƒã®ã‚¹ãƒ†ãƒƒãƒã‚„ãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼ã‚’æ„è­˜ã—ãŸã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
            text-align: left; /* å·¦å¯„ã›ã«å¤‰æ›´ã—ã¦ã‚¢ãƒ—ãƒªæ„Ÿã‚’å‡ºã™ */
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background-image: none; /* ãƒ‰ãƒƒãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³å‰Šé™¤ */
        }

        .brand {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin: 0;
            color: #ffffff;
            background: none; /* ãƒ†ã‚­ã‚¹ãƒˆã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤ */
            -webkit-text-fill-color: initial;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brand span { color: #ecf0f1; font-weight: 300; -webkit-text-fill-color: initial; opacity: 0.8; }
        
        .subtitle {
            color: rgba(255,255,255,0.7);
            margin: 0;
            font-size: 0.8rem;
            font-weight: 400;
            letter-spacing: 0.05em;
        }

        /* --- Sticky Controls (Toolbar Style) --- */
        .controls-area {
            position: sticky;
            top: 0;
            background: var(--c-surface); /* åŠé€æ˜å»ƒæ­¢ */
            opacity: 1;
            z-index: 100;
            border-bottom: 1px solid var(--c-border);
            padding: 0.75rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .search-input {
            border-radius: var(--radius-md); /* ä¸¸ã¿ã‚’å‰Šé™¤ */
            background: var(--c-bg);
            border: 1px solid var(--c-border);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        .search-input:focus {
            background: var(--c-surface);
            border-color: var(--c-text-primary); /* AIã‚«ãƒ©ãƒ¼ã§ã¯ãªãæ–‡å­—è‰²ã§å¼·èª¿ */
            box-shadow: none;
        }

        .theme-toggle {
            border-radius: var(--radius-md);
            border: 1px solid var(--c-border);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .filter-chip {
            border-radius: var(--radius-sm); /* ä¸¸ã¿ã‚’å‰Šé™¤ã—ã¦é•·æ–¹å½¢ã« */
            border: 1px solid var(--c-border);
            font-weight: 600;
            box-shadow: none;
        }
        .filter-chip.active {
            background: var(--c-text-primary);
            color: var(--c-surface);
            border-color: var(--c-text-primary);
            box-shadow: none;
        }

        /* --- Grid --- */
        .grid-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .metric-card {
            background: var(--c-surface);
            border-radius: var(--radius-md); /* è§’ä¸¸ã‚’å°ã•ã */
            border: 1px solid var(--c-border);
            border-left: 5px solid transparent; /* å·¦å´ã«è‰²ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆãƒ©ã‚¤ãƒ³ */
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease-out;
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            box-shadow: var(--shadow-card);
        }
        .metric-card:hover {
            transform: translateY(-2px); /* å‹•ãã‚’æ§ãˆã‚ã« */
            box-shadow: var(--shadow-hover);
            background-color: #fafbfc;
        }
        
        /* ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«å·¦ç·šã®è‰²ã‚’å¤‰ãˆã‚‹ */
        .metric-card.cat-bat { border-left-color: var(--cat-bat); }
        .metric-card.cat-pit { border-left-color: var(--cat-pit); }
        .metric-card.cat-fld { border-left-color: var(--cat-fld); }
        .metric-card.cat-tot { border-left-color: var(--cat-tot); }
        .metric-card.cat-std { border-left-color: var(--cat-std); }

        .card-header {
            display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;
        }
        
        .card-tag {
            font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border-radius: var(--radius-sm);
            text-transform: uppercase; letter-spacing: 0.05em; border: 1px solid currentColor;
            background: transparent !important; /* èƒŒæ™¯è‰²ã‚’ãªãã—ã¦æ ç·šã®ã¿ã« */
        }
        
        .metric-title {
            font-size: 1.8rem; /* å°‘ã—æ§ãˆã‚ã« */
            font-weight: 700;
            margin: 0;
            line-height: 1.1;
            color: var(--c-text-primary);
            font-family: var(--font-mono); /* æ•°å­—ã‚„ã‚³ãƒ¼ãƒ‰ã£ã½ã„ãƒ•ã‚©ãƒ³ãƒˆã« */
        }
        .metric-full {
            font-size: 0.8rem;
            color: var(--c-text-secondary);
            font-weight: 500;
            margin: 4px 0 15px;
            border-bottom: 1px solid var(--c-border);
            padding-bottom: 8px;
            display: block;
        }
        .metric-desc {
            font-size: 0.95rem;
            color: var(--c-text-secondary);
            margin: 0;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* --- Footer --- */
        .footer-area {
            max-width: 1200px;
            margin: 20px auto 60px;
            padding: 0 2rem;
        }
        .footer-details {
            background: var(--c-surface);
            border: 1px solid var(--c-border);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .footer-details[open] {
            box-shadow: var(--shadow-card);
            border-color: var(--cat-bat);
        }
        .footer-summary {
            padding: 20px 24px;
            cursor: pointer;
            font-weight: 700;
            color: var(--c-text-secondary);
            list-style: none;
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--c-bg);
            transition: background 0.2s, color 0.2s;
            font-size: 0.9rem;
        }
        .footer-summary:hover {
            color: var(--c-text-primary);
            background: var(--c-surface);
        }
        .footer-summary::-webkit-details-marker { display: none; }
        .footer-summary::after {
            content: '+'; margin-left: auto; font-size: 1.2rem; font-weight: 400; transition: transform 0.3s;
        }
        .footer-details[open] .footer-summary::after { transform: rotate(45deg); }
        
        /* Icon in Footer */
        .footer-icon svg { width: 20px; height: 20px; stroke-width: 2.5; }

        .footer-content {
            padding: 30px 40px;
            border-top: 1px solid var(--c-border);
            font-size: 0.9rem;
            color: var(--c-text-secondary);
            line-height: 1.8;
            animation: fadeIn 0.3s ease;
        }
        .footer-content h3 {
            font-size: 1rem; color: var(--c-text-primary); margin: 30px 0 12px 0;
            display: flex; align-items: center; gap: 8px; font-weight: 800; letter-spacing: 0.05em;
        }
        .footer-content h3:first-child { margin-top: 0; }
        .footer-content h3::before {
            content: ''; display: inline-block; width: 4px; height: 1.2em; background: var(--cat-bat); border-radius: 2px;
        }
        .footer-content ul {
            margin: 0; padding: 0; list-style: none;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;
        }
        .footer-content li { margin: 0; }
        .footer-content a {
            color: var(--c-text-primary); text-decoration: none; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px; padding: 8px 12px;
            background: var(--c-bg); border-radius: 8px; border: 1px solid transparent;
            font-weight: 600; font-size: 0.85rem;
        }
        .footer-content a:hover {
            border-color: var(--cat-bat); color: var(--cat-bat); background: var(--c-surface); transform: translateX(4px);
        }
        .footer-content p { margin-top: 0; margin-bottom: 16px; }

        .logic-box {
            background: var(--c-bg);
            border: 1px solid var(--c-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .logic-title {
            font-weight: 700; color: var(--c-text-primary); margin-bottom: 8px; font-size: 0.95rem;
            display: flex; align-items: center; justify-content: space-between;
        }
        .logic-cat { font-size: 0.7rem; background: var(--c-text-secondary); color: white; padding: 2px 6px; border-radius: 4px; }
        .logic-cat.bat { background: var(--cat-bat); }
        .logic-cat.pit { background: var(--cat-pit); }
        .logic-formula {
            font-family: var(--font-mono); font-size: 0.85rem; color: var(--cat-bat); background: rgba(255,255,255,0.5);
            padding: 10px; border-radius: 6px; border: 1px solid var(--c-border); margin-bottom: 10px;
        }
        .logic-desc { font-size: 0.85rem; color: var(--c-text-secondary); line-height: 1.6; }
        
        /* --- Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; }

        .modal-panel {
            background: var(--c-surface);
            width: 100%;
            max-width: 900px;
            max-height: 95vh;
            border-radius: var(--radius-lg); /* å°ã•ã‚ã®è§’ä¸¸ */
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); /* å½±ã¯æ·±ãã—ã¦é‡åšæ„Ÿã‚’ */
            border: 1px solid var(--c-border);
            transform: scale(1) translateY(0); /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç°¡ç´ åŒ– */
        }
        
        .modal-header {
            background: var(--c-bg);
            border-bottom: 1px solid var(--c-border);
            padding: 24px 40px;
        }

        .calc-btn {
            border-radius: var(--radius-md); /* æ¥•å††ãƒœã‚¿ãƒ³ã‚’é•·æ–¹å½¢ã« */
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .close-btn {
            border-radius: var(--radius-sm); /* ä¸¸ãƒœã‚¿ãƒ³ã‚’å››è§’ã« */
        }

        .section-label {
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--c-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin: 3rem 0 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        /* å¥ç‚¹ã‚’å‰Šé™¤ */
        .section-label::before { content:''; color: var(--cat-bat); }
        .section-label::after { content:''; flex:1; height:1px; background: var(--c-border); }
        .section-label.has-hash::before { content:'#'; }

        /* --- Formula Box --- */
        .formula-box {
            background: #1e293b; /* Always dark for formula */
            border: 1px solid #334155;
            padding: 30px;
            border-radius: 16px;
            font-family: var(--font-serif);
            font-size: 1.3rem;
            font-style: italic;
            color: #e2e8f0;
            overflow-x: auto;
            text-align: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
        }
        .formula-var {
            color: #38bdf8;
            font-weight: bold;
            margin: 0 2px;
            font-family: var(--font-sans);
            font-style: normal;
        }
        .formula-op { color: #94a3b8; margin: 0 5px; }

        /* --- Calculator Section --- */
        .calc-container {
            background: var(--c-bg);
            border: 1px solid var(--c-border);
            border-radius: 16px;
            padding: 30px;
            margin-top: 10px;
            position: relative; /* For ocr button positioning */
        }
        .calc-container.ai-mode {
            background: rgba(139, 92, 46, 0.05);
            border-color: var(--ai-color);
        }
        .calc-container.ai-mode .calc-title span { color: var(--ai-color); }
        .calc-container.ai-mode .calc-btn { background: var(--ai-color); }
        .calc-container.ai-mode .calc-btn:hover { background: #7c3aed; opacity: 0.9; }
        .calc-container.ai-mode .calc-res-value { color: var(--ai-color); }

        .calc-title {
            font-size: 1rem;
            font-weight: 800;
            color: var(--cat-bat);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .calc-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .calc-group { display: flex; flex-direction: column; gap: 5px; }
        .calc-label { font-size: 0.7rem; font-weight: 700; color: var(--c-text-secondary); text-transform: uppercase; }
        .calc-field, .calc-select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--c-border);
            font-family: var(--font-mono);
            text-align: right;
            font-size: 1rem;
            background: var(--c-surface);
            color: var(--c-text-primary);
        }
        .calc-select { text-align: left; font-family: var(--font-sans); cursor: pointer; }
        .calc-field:focus, .calc-select:focus { outline: none; border-color: var(--cat-bat); box-shadow: 0 0 0 2px rgba(14,165,233,0.2); }

        /* Preset Styles */
        .preset-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            align-items: center;
            background: rgba(0,0,0,0.03);
            padding: 12px;
            border-radius: 12px;
            flex-wrap: wrap;
            border: 1px solid var(--c-border);
        }
        .preset-label { width: 100%; font-size: 0.75rem; font-weight: 700; color: var(--c-text-secondary); margin-bottom: 4px; }
        .preset-select {
            flex: 1;
            min-width: 140px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--c-border);
            font-family: var(--font-sans);
            font-size: 0.9rem;
        }
        .preset-input {
            flex: 1;
            min-width: 140px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--c-border);
            font-family: var(--font-sans);
            font-size: 0.9rem;
        }
        .preset-btn {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.8rem;
            color: white;
            transition: 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .btn-load { background: var(--c-text-secondary); }
        .btn-load:hover { background: var(--c-text-primary); }
        .btn-save { background: var(--cat-bat); }
        .btn-save:hover { opacity: 0.9; }
        .btn-del { background: #ef4444; color: white; }
        .btn-del:hover { opacity: 0.9; }
        .preset-btn svg { width: 16px; height: 16px; stroke-width: 2.5; }

        /* --- Advanced Settings Style --- */
        .advanced-details {
            grid-column: 1 / -1;
            margin-top: 10px;
            border: 1px solid var(--c-border);
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0,0,0,0.02);
        }
        .advanced-summary {
            padding: 12px 15px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--c-text-secondary);
            background: rgba(255,255,255,0.5);
            user-select: none;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .advanced-summary::before {
            content: ' '; /* çµµæ–‡å­—å‰Šé™¤ */
            font-size: 1rem;
        }
        .advanced-summary:hover {
            background: var(--c-surface);
            color: var(--cat-bat);
        }
        .advanced-content {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            border-top: 1px solid var(--c-border);
        }
        .advanced-details[open] .advanced-summary {
            border-bottom: 1px solid transparent;
        }
        .advanced-summary .icon-gear {
            width: 16px;
            height: 16px;
            stroke-width: 2.5;
            color: var(--c-text-secondary);
        }
        .advanced-summary:hover .icon-gear { color: var(--cat-bat); }


        .warning-msg {
            grid-column: 1 / -1;
            background: #fffbeb;
            border: 1px solid #fcd34d;
            color: #b45309;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            animation: fadeIn 0.3s ease;
        }
        .warning-msg::before {
            content: 'âš ï¸';
            font-size: 1.2rem;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .calc-result-area {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed var(--c-border);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
        }
        .calc-res-label { font-size: 0.9rem; color: var(--c-text-secondary); font-weight: 600; }
        .calc-res-label span { font-size: 0.7em; background: var(--ai-color); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
        .calc-res-value { font-size: 2.5rem; font-weight: 900; color: var(--cat-bat); font-family: var(--font-mono); line-height: 1; }
        .calc-btn {
            background: var(--cat-bat);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .calc-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .calc-btn svg { width: 18px; height: 18px; stroke-width: 2.5; }

        .criteria-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        .criteria-table th { text-align: left; color: var(--c-text-secondary); width: 120px; padding: 12px 0; border-bottom: 1px solid var(--c-border); }
        .criteria-table td { padding: 12px 0; border-bottom: 1px solid var(--c-border); color: var(--c-text-primary); font-weight: 600; }

        .related-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .rel-chip {
            background: var(--c-bg);
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--c-text-secondary);
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .rel-chip:hover { background: var(--c-text-primary); color: var(--c-surface); }

        .no-result {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px;
            color: var(--c-text-secondary);
        }
        
        /* --- Smart Parser Style --- */
        .parser-area {
            margin-bottom: 20px;
            background: var(--c-surface);
            border: 1px dashed var(--cat-bat);
            padding: 15px;
            border-radius: 12px;
        }
        .parser-textarea {
            width: 100%;
            height: 120px;
            border: 1px solid var(--c-border);
            border-radius: 8px;
            padding: 15px;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            box-sizing: border-box;
            resize: vertical;
            background: #f8fafc;
            transition: all 0.2s;
        }
        .parser-textarea:focus {
            background: #ffffff;
            border-color: var(--cat-bat);
            outline: none;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        .parser-btn {
            background: var(--c-text-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            width: 100%;
            transition: all 0.3s;
            margin-top: 10px;
        }
        .parser-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .parser-btn.analyzing { background: var(--cat-bat); cursor: wait; animation: pulse 1.5s infinite; }
        .parser-btn svg { width: 18px; height: 18px; stroke-width: 2.5; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* --- Chart Container --- */
        .chart-wrapper {
            max-width: 400px;
            margin: 20px auto;
            position: relative;
        }
        
        /* Helper for formula formatting */
        .var { color: #38bdf8; font-family: var(--font-sans); font-weight: 600; font-style: normal; margin: 0 2px; }

        @media (max-width: 700px) {
            .brand { font-size: 2.5rem; }
            .m-title { font-size: 2.5rem; }
            .grid-container { grid-template-columns: 1fr; padding: 40px 1rem;}
            .modal-panel { width: 100%; height: 100%; border-radius: 0; }
            .search-wrapper { padding: 0 1rem; }
        }

        /* === New Career Mode Styles (v3.0 Power Pros Style) === */
        #career-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #f8fafc; /* èƒŒæ™¯è‰²: éå¸¸ã«è–„ã„é’ã‚°ãƒ¬ãƒ¼ */
            z-index: 2000;
            visibility: hidden; opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto; color: #1e293b;
            display: flex; flex-direction: column;
        }
        #career-overlay.active { visibility: visible; opacity: 1; transform: translateY(0); }
        
        .career-header {
            padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #e2e8f0;
            position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .career-brand { font-size: 1.4rem; font-weight: 900; letter-spacing: -0.02em; color: #0f172a; display: flex; align-items: center; gap: 10px; }
        .career-brand span { color: #3b82f6; background: #eff6ff; padding: 2px 8px; border-radius: 6px; font-size: 0.8em; }
        
        .career-content {
            max-width: 1200px; margin: 0 auto; width: 100%; padding: 40px 20px;
            box-sizing: border-box; flex: 1;
        }
        
        .career-grid { display: grid; grid-template-columns: 380px 1fr; gap: 30px; align-items: start; }
        
        /* ãƒ‘ãƒãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .career-panel { 
            background: #ffffff; 
            border-radius: 24px; 
            padding: 32px; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
        }
        
        .career-title { 
            font-size: 1.1rem; font-weight: 800; margin-bottom: 24px; 
            color: #1e293b; display: flex; align-items: center;
            letter-spacing: 0.05em; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;
        }
        .career-title svg { width: 20px; height: 20px; margin-right: 8px; color: #3b82f6; }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .c-form-group { margin-bottom: 24px; }
        .c-label { display: block; font-size: 0.85rem; font-weight: 700; color: #64748b; margin-bottom: 8px; }
        .c-input, .c-select {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid #cbd5e1; background: #f8fafc;
            color: #1e293b; font-weight: 600; font-size: 0.95rem;
            transition: 0.2s; box-sizing: border-box;
        }
        .c-input:focus, .c-select:focus { outline: none; border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        /* èƒ½åŠ›å€¤ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆãƒ‘ãƒ¯ãƒ—ãƒ­é¢¨ï¼‰ */
        .c-rank-bar {
            height: 6px; width: 100%; background: #e2e8f0; border-radius: 3px; position: relative; margin-top: 10px; margin-bottom: 25px;
        }
        .c-rank-fill {
            height: 100%; border-radius: 3px; background: linear-gradient(90deg, #3b82f6, #2563eb);
            width: 50%; transition: width 0.2s;
        }
        .c-rank-input {
            position: absolute; top: -8px; left: 0; width: 100%; height: 20px; opacity: 0; cursor: pointer;
        }
        .c-rank-label {
            display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 700; color: #475569;
        }
        /* ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã®è‰²åˆ†ã‘ */
        .rank-s { color: #eab308; } /* Gold */
        .rank-a { color: #f97316; } /* Orange */
        .rank-b { color: #ef4444; } /* Red */
        .rank-c { color: #f43f5e; } /* Pink/Red */
        .rank-d { color: #10b981; } /* Green */
        .rank-e { color: #3b82f6; } /* Blue */
        .rank-f { color: #64748b; } /* Slate */
        .rank-g { color: #94a3b8; } /* Gray */
        
        /* ãƒ­ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– */
        .role-tabs { display: flex; gap: 8px; margin-bottom: 24px; background: #f1f5f9; padding: 5px; border-radius: 12px; }
        .role-tab { 
            flex: 1; padding: 10px; text-align: center; cursor: pointer; border-radius: 8px; 
            font-weight: 700; font-size: 0.9rem; color: #94a3b8; transition: all 0.2s; 
        }
        .role-tab.active { background: #ffffff; color: #3b82f6; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .role-tab:hover:not(.active) { color: #1e293b; }
        
        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .c-result-header {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 15px; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 16px;
        }
        .c-big-stat { text-align: center; }
        .c-big-val { font-size: 1.8rem; font-weight: 900; color: #0f172a; line-height: 1; font-family: var(--font-mono); }
        .c-big-lbl { font-size: 0.7rem; font-weight: 700; color: #64748b; margin-top: 5px; letter-spacing: 0.05em; }
        
        /* å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œï¼‰ */
        .c-history-wrap {
            background: #ffffff; border-radius: 16px; border: 1px solid #e2e8f0;
            max-height: 500px; overflow: auto; /* ç¸¦æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
        }
        .c-table { width: 100%; min-width: 800px; border-collapse: collapse; font-size: 0.85rem; white-space: nowrap; }
        .c-table th { 
            text-align: center; padding: 12px 8px; background: #f1f5f9; 
            color: #475569; font-weight: 700; position: sticky; top: 0; z-index: 10;
            border-bottom: 1px solid #cbd5e1;
        }
        .c-table td { text-align: center; padding: 10px 8px; border-bottom: 1px solid #f1f5f9; color: #334155; font-family: var(--font-mono); }
        .c-table tr:hover { background: #f8fafc; }
        
        /* WARãªã©å¼·èª¿ */
        .val-outstanding { color: #d97706; font-weight: 800; background: #fffbeb; }
        .val-great { color: #ea580c; font-weight: 800; }
        .val-good { color: #16a34a; font-weight: 700; }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 900px) {
            .career-grid { grid-template-columns: 1fr; }
            .c-result-header { grid-template-columns: repeat(3, 1fr); }
        }

    </style>
</head>
<body>
    <!-- Utility Functions (Simplified for single file) -->
    <script>
        // Icon Definitions (Lucide Icons for a clean look)
        const icons = {
            search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
            sun: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`,
            moon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`,
            barChart: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>`,
            calculator: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calculator"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="10" y2="18"/><line x1="8" x2="8" y1="10" y2="18"/><line x1="12" x2="12" y1="10" y2="18"/><line x1="8" x2="16" y1="14" y2="14"/></svg>`,
            gear: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-2 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-2 2H2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 1 2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 1 2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 2-2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 2-2h.44v-.44a2 2 0 0 0-2-2h-.44a2 2 0 0 1-2-2v-.44a2 2 0 0 0-2-2h-.44a2 2 0 0 1-2-2V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>`,
            sparkle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="m12 3-1.83 2.66-2.67 1.84 2.67 1.84L12 13l1.83-2.66 2.67-1.84-2.67-1.84L12 3z"/><path d="m20.2 16.2-1.22 1.8-1.78 1.22 1.78 1.22 1.22 1.8 1.22-1.8 1.78-1.22-1.78-1.22-1.22-1.8z"/><path d="m4.64 10.36-1.15 1.68-1.57 1.08 1.57 1.08 1.15 1.68 1.15-1.68 1.57-1.08-1.57-1.08-1.15-1.68z"/></svg>`,
            loader: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 3h6"/></svg>`,
            save: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
            clipboard: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-copy"><rect width="8" height="4" x="8" y="2"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 22v-3a3 3 0 0 0-3-3l-2.5 2.5"/><path d="M8 13l2.5 2.5"/></svg>`
        };
    </script>
    
    <header>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h1 class="brand">SABR<span>METRICS</span> LAB</h1>
                <p class="subtitle">Ultimate Baseball Analytics Dictionary</p>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Dark Mode"></button>
                
                <button class="theme-toggle" onclick="openToolMenu()" style="
                    width:auto; padding:0 16px; font-weight:700; font-size: 0.9rem;
                    background: var(--c-surface); color: var(--c-text-primary);
                ">
                    <span style="margin-right:6px;">ğŸ› </span> TOOLS
                </button>
            </div>
        </div>
    
        <div class="search-wrapper" style="padding:0; margin-bottom:15px;">
            <input type="text" class="search-input" id="searchInput" placeholder="æŒ‡æ¨™åã€æ„å‘³ã€è¨ˆç®—å¼ã§æ¤œç´¢" oninput="handleSearch()">
        </div>
        
        <div class="filter-scroll" style="padding:0; justify-content:flex-start;">
            <div class="filter-chip active" onclick="filterCategory('all')" data-cat="all">ALL</div>
            <div class="filter-chip" onclick="filterCategory('std')" data-cat="std">åŸºæœ¬</div>
            <div class="filter-chip" onclick="filterCategory('bat')" data-cat="bat">æ‰“æ’ƒ</div>
            <div class="filter-chip" onclick="filterCategory('pit')" data-cat="pit">æŠ•çƒ</div>
            <div class="filter-chip" onclick="filterCategory('fld')" data-cat="fld">å®ˆå‚™èµ°å¡</div>
            <div class="filter-chip" onclick="filterCategory('tot')" data-cat="tot">ç·åˆ</div>
        </div>
    </header>

    <div style="max-width: 1200px; margin: 0 auto; padding: 50px 2rem 0;">
        <details class="footer-details" style="border-color: var(--cat-bat); background: var(--bg-bat); margin-bottom: 20px;">
            <summary class="footer-summary" style="font-weight:800; color:var(--cat-bat);">
                <span class="footer-icon">âš ï¸</span> 
                <span>ã€é‡è¦ã€‘å½“ã‚µã‚¤ãƒˆã®æŒ‡æ¨™ã¨è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã«ã¤ã„ã¦</span>
            </summary>
            <div class="footer-content">
                <div class="warning-msg" style="margin-bottom: 30px; display:block; border-left: 4px solid #f59e0b; background: #fffbeb; color: #1e293b;">
                    <strong style="display:block; margin-bottom:8px; color:#b45309;"> æŒ‡æ¨™ã®è§£é‡ˆã«é–¢ã™ã‚‹ã”æ³¨æ„</strong>
                    å½“ã‚µã‚¤ãƒˆã§ç®—å‡ºã•ã‚Œã‚‹æŒ‡æ¨™ï¼ˆWAR, wRC+, xFIPãªã©ï¼‰ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸé™ã‚‰ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«è¨ˆç®—ã•ã‚Œã‚‹<strong>ã€Œæ¦‚ç®—å€¤ã€</strong>ã§ã™ã€‚<br>
                    å…¬å¼è¨˜éŒ²ã‚„å°‚é–€ã‚µã‚¤ãƒˆï¼ˆ1.02ã‚„FanGraphsç­‰ï¼‰ã®å³å¯†ãªç®—å‡ºå€¤ã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿ã®ç²’åº¦ã‚„è£œæ­£ä¿‚æ•°ã®é•ã„ã«ã‚ˆã‚Š<strong>å¿…ãšä¹–é›¢ãŒç™ºç”Ÿã—ã¾ã™ã€‚</strong><br>
                    SNSç­‰ã§æ•°å€¤ã‚’å…±æœ‰ãƒ»å¼•ç”¨ã•ã‚Œã‚‹éš›ã¯ã€å…¬å¼è¨˜éŒ²ã¨æ··åŒã•ã‚Œãªã„ã‚ˆã†ã”é…æ…®ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
                </div>

                <div style="margin-bottom: 30px;">
                    <h3>è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®å‰æ</h3>
                    <p>
                        å…¥åŠ›é …ç›®ã¨ã—ã¦å­˜åœ¨ã—ãªã„ãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹ï¼šå¤–é‡ãƒ•ãƒ©ã‚¤ã®æ­£ç¢ºãªå‰²åˆã€çƒå ´ã”ã¨ã®è©³ç´°ãªãƒ‘ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼å¤‰å‹•ãªã©ï¼‰ã¯ã€è¿‘å¹´ã®NPBå¹³å‡å€¤ã«è¿‘ã„å€¤ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚<br>
                        ã‚ˆã‚Šæ­£ç¢ºãªå€¤ã‚’æ±‚ã‚ãŸã„å ´åˆã¯ã€å„è¨ˆç®—ç”»é¢ã®ã€Œè©³ç´°è¨­å®šã€ã‹ã‚‰ãƒªãƒ¼ã‚°ç·åˆæˆç¸¾ãªã©ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
                    </p>
                </div>

                <div style="margin-bottom: 30px;">
                    <h3>ä¸»è¦æŒ‡æ¨™ã®è©³ç´°è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæœ¬ã‚µã‚¤ãƒˆå†…ã®å‡¦ç†ï¼‰</h3>
                    
                    <div class="logic-box">
                        <div class="logic-title">é‡æ‰‹WAR <span class="logic-cat bat">Batting</span></div>
                        <div class="logic-formula">
                            WAR = (æ”»æ’ƒè²¢çŒ® + å®ˆå‚™è²¢çŒ® + èµ°å¡è²¢çŒ® + å®ˆå‚™ä½ç½®è£œæ­£ + ä»£æ›¿æ°´æº–è£œæ­£) Ã· RPW
                        </div>
                        <div class="logic-desc">
                            ã¾ãšãƒªãƒ¼ã‚°ç·åˆæˆç¸¾ï¼ˆè©³ç´°è¨­å®šã®å€¤ï¼‰ã‹ã‚‰ã€ãã®ç’°å¢ƒã«ãŠã‘ã‚‹å„ãƒ—ãƒ¬ãƒ¼ã®å¾—ç‚¹ä¾¡å€¤ï¼ˆwOBAä¿‚æ•°ï¼‰ã‚’å‹•çš„ã«ç®—å‡ºã—ã¾ã™ã€‚
                            ç®—å‡ºã—ãŸä¿‚æ•°ã‚’ç”¨ã„ã¦å¯¾è±¡é¸æ‰‹ã®wOBAã‚’æ±‚ã‚ã€ãƒªãƒ¼ã‚°å¹³å‡ã¨æ¯”è¼ƒã—ã¦ã€Œå¹³å‡çš„æ‰“è€…ã‚ˆã‚Šã©ã‚Œã ã‘å¾—ç‚¹ã‚’ç”Ÿã¿å‡ºã—ãŸã‹ï¼ˆwRAAï¼‰ã€ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
                            ã“ã‚Œã«æœ¬æ‹ åœ°ã®ãƒ‘ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼è£œæ­£ã€å®ˆå‚™ä½ç½®ã”ã¨ã®é›£æ˜“åº¦è£œæ­£ã€å…¥åŠ›ã•ã‚ŒãŸå®ˆå‚™è©•ä¾¡(UZR)ã¨èµ°å¡è²¢çŒ®(wSB)ã‚’åŠ ç®—ã—ã¾ã™ã€‚
                            æœ€å¾Œã«ã€å‡ºå ´æ‰“å¸­æ•°ã«å¿œã˜ãŸã€Œä»£æ›¿å¯èƒ½é¸æ‰‹ï¼ˆãƒªãƒ—ãƒ¬ã‚¤ã‚¹ãƒ¡ãƒ³ãƒˆãƒ»ãƒ¬ãƒ™ãƒ«ï¼‰ã¨ã®å·®åˆ†ã€ã‚’åŠ ãˆã€1å‹ã‚ãŸã‚Šã®å¾—ç‚¹ä¾¡å€¤(RPW)ã§å‰²ã‚‹ã“ã¨ã§å‹åˆ©æ•°ã«æ›ç®—ã—ã¦ã„ã¾ã™ã€‚
                        </div>
                    </div>

                    <div class="logic-box">
                        <div class="logic-title">wRC+ <span class="logic-cat bat">Batting</span></div>
                        <div class="logic-formula">
                            wRC+ = ( (ãƒ‘ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼è£œæ­£å¾Œã®å¾—ç‚¹å‰µå‡ºèƒ½åŠ›) Ã· ãƒªãƒ¼ã‚°å¹³å‡å¾—ç‚¹åŠ› ) Ã— 100
                        </div>
                        <div class="logic-desc">
                            ä¸Šè¨˜ã§ç®—å‡ºã—ãŸwRAAï¼ˆå¹³å‡ã‚ˆã‚Šå¢—ã‚„ã—ãŸå¾—ç‚¹æ•°ï¼‰ã«å¯¾ã—ã€æœ¬æ‹ åœ°ã®ãƒ‘ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã«åŸºã¥ãè£œæ­£ã‚’è¡Œã„ã¾ã™ï¼ˆæ‰“è€…æœ‰åˆ©ãªçƒå ´ãªã‚‰ãƒã‚¤ãƒŠã‚¹ã€ä¸åˆ©ãªã‚‰ãƒ—ãƒ©ã‚¹ï¼‰ã€‚
                            è£œæ­£å¾Œã®å€¤ã‚’æ‰“å¸­ã‚ãŸã‚Šã®å¾—ç‚¹ç”Ÿç”£åŠ›ã«æ›ç®—ã—ã€ã€Œãƒªãƒ¼ã‚°å¹³å‡ã‚’100ã¨ã—ãŸå ´åˆã®æŒ‡æ•°ã€ã¨ã—ã¦æ­£è¦åŒ–ã—ã¦ã„ã¾ã™ã€‚
                            ã“ã‚Œã«ã‚ˆã‚Šã€çƒå ´ã®é•ã„ã‚’æ’é™¤ã—ã¦æ‰“æ’ƒå‚‘å‡ºåº¦ã‚’æ¯”è¼ƒå¯èƒ½ã«ã—ã¦ã„ã¾ã™ã€‚
                        </div>
                    </div>

                    <div class="logic-box">
                        <div class="logic-title">æŠ•æ‰‹WAR <span class="logic-cat pit">Pitching</span></div>
                        <div class="logic-formula">
                            WAR = (å¹³å‡æ¯”å¤±ç‚¹æŠ‘æ­¢é‡ + ä»£æ›¿æ°´æº–è£œæ­£) Ã· RPW
                        </div>
                        <div class="logic-desc">
                            æœ¬ãƒ„ãƒ¼ãƒ«ã§ã¯FIPï¼ˆå®ˆå‚™ã®å½±éŸ¿ã‚’é™¤ã„ãŸç–‘ä¼¼é˜²å¾¡ç‡ï¼‰ã‚’ãƒ™ãƒ¼ã‚¹ã«è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚
                            ã¾ãšå¯¾è±¡æŠ•æ‰‹ã®FIPã¨ã€ãƒ‘ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼è£œæ­£ã‚’ã‹ã‘ãŸãƒªãƒ¼ã‚°å¹³å‡å¤±ç‚¹ç‡(RA9)ã‚’æ¯”è¼ƒã—ã€å¹³å‡ã«å¯¾ã—ã¦ã©ã‚Œã ã‘å¤±ç‚¹ã‚’é˜²ã„ã ã‹(RAA)ã‚’ç®—å‡ºã—ã¾ã™ã€‚
                            ãã“ã«å½¹å‰²ï¼ˆå…ˆç™ºãƒ»æ•‘æ´ï¼‰ã«å¿œã˜ãŸã€Œä»£æ›¿æ°´æº–æŠ•æ‰‹ã¨ã®å·®åˆ†ã€ã‚’åŠ ç®—ã—ã€RPWã§å‰²ã‚‹ã“ã¨ã§å‹åˆ©è²¢çŒ®æ•°ã‚’ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚
                            â€»FIPå®šæ•°ã¯ãƒªãƒ¼ã‚°ç·åˆæˆç¸¾ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚
                        </div>
                    </div>

                    <div class="logic-box">
                        <div class="logic-title">xFIP <span class="logic-cat pit">Pitching</span></div>
                        <div class="logic-formula">
                            xFIP = (13 Ã— (æ¨å®šãƒ•ãƒ©ã‚¤æ•° Ã— ãƒªãƒ¼ã‚°HR/FBç‡) + 3Ã—(BB+HBP) - 2Ã—SO) Ã· IP + å®šæ•°
                        </div>
                        <div class="logic-desc">
                            å…¥åŠ›ã•ã‚ŒãŸã€Œæ‰“çƒå‚¾å‘(GB%)ã€ã«åŸºã¥ãã€å…¨æ‰“çƒã«å¯¾ã™ã‚‹ã‚´ãƒ­ãƒ»ãƒ©ã‚¤ãƒŠãƒ¼ãƒ»ãƒ•ãƒ©ã‚¤ã®å†…è¨³ã‚’è‡ªå‹•æ¨å®šã—ã¾ã™ã€‚
                            ãã®ã†ã¡ãƒ•ãƒ©ã‚¤ãƒœãƒ¼ãƒ«(FB)ã«å¯¾ã—ã¦ã€Œãƒªãƒ¼ã‚°å¹³å‡ã®HR/FBç‡ï¼ˆãƒ•ãƒ©ã‚¤ãŒæœ¬å¡æ‰“ã«ãªã‚‹ç¢ºç‡ï¼‰ã€ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã§ã€ã€Œé‹ã«å·¦å³ã•ã‚Œãªã„æœŸå¾…è¢«æœ¬å¡æ‰“æ•°ã€ã‚’ç®—å‡ºã—ã¾ã™ã€‚
                            ã“ã®æœŸå¾…å€¤ã‚’ç”¨ã„ã¦FIPã®å¼ã‚’å†è¨ˆç®—ã—ã€ãƒªãƒ¼ã‚°å¹³å‡é˜²å¾¡ç‡ã®ã‚¹ã‚±ãƒ¼ãƒ«ã«åˆã†ã‚ˆã†å®šæ•°ï¼ˆãƒªãƒ¼ã‚°å¹³å‡RA9ã¨ãƒªãƒ¼ã‚°å¹³å‡xFIPã®å·®åˆ†ï¼‰ã‚’åŠ ç®—ã—ã¦èª¿æ•´ã—ã¦ã„ã¾ã™ã€‚
                        </div>
                    </div>

                    <div class="logic-box">
                        <div class="logic-title">tRA <span class="logic-cat pit">Pitching</span></div>
                        <div class="logic-formula">
                            tRA = ( Î£(å„ã‚¤ãƒ™ãƒ³ãƒˆæ•° Ã— æœŸå¾…å¤±ç‚¹ä¾¡å€¤) ) Ã· IP Ã— 27 + å®šæ•°
                        </div>
                        <div class="logic-desc">
                            å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨æ‰“çƒå‚¾å‘ã‹ã‚‰ã€ä¸‰æŒ¯ã€å››æ­»çƒã€è¢«æœ¬å¡æ‰“ã«åŠ ãˆã€ã‚´ãƒ­(GB)ã€ãƒ©ã‚¤ãƒŠãƒ¼(LD)ã€å¤–é‡ãƒ•ãƒ©ã‚¤(FB)ã€å†…é‡ãƒ•ãƒ©ã‚¤(PU)ã®å„æ‰“çƒæ•°ã‚’æ¨å®šã—ã¾ã™ã€‚
                            ãã‚Œãã‚Œã®ã‚¤ãƒ™ãƒ³ãƒˆã«å¯¾ã—ã¦çµ±è¨ˆçš„ã«å°ãå‡ºã•ã‚ŒãŸã€ŒæœŸå¾…å¤±ç‚¹ã‚¦ã‚§ã‚¤ãƒˆï¼ˆä¾‹ï¼šè¢«æœ¬å¡æ‰“=1.401, ãƒ©ã‚¤ãƒŠãƒ¼=0.289, ä¸‰æŒ¯=-0.108ãªã©ï¼‰ã€ã‚’æ›ã‘åˆã‚ã›ã€ç·å¤±ç‚¹æœŸå¾…å€¤ã‚’ç®—å‡ºã—ã¾ã™ã€‚
                            ã“ã‚Œã‚’27ã‚¢ã‚¦ãƒˆï¼ˆ9ã‚¤ãƒ‹ãƒ³ã‚°ï¼‰ã‚ãŸã‚Šã«æ›ç®—ã—ã€ãƒªãƒ¼ã‚°å…¨ä½“ã®å¤±ç‚¹ç‡ã‚¹ã‚±ãƒ¼ãƒ«ã«åˆã‚ã›ã‚‹ãŸã‚ã®å®šæ•°ã‚’åŠ ãˆã¦è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
                        </div>
                    </div>

                    <div class="logic-box">
                        <div class="logic-title">SIERA <span class="logic-cat pit">Pitching</span></div>
                        <div class="logic-formula">
                            SIERA = 6.145 - 16.99(K%) + 11.43(BB%) - 1.86(GB%) ... [å¤šé …å¼]
                        </div>
                        <div class="logic-desc">
                            æ‰“çƒå‚¾å‘ã‹ã‚‰æ¨å®šã—ãŸã‚´ãƒ­ç‡(GB%)ã¨ã€å¥ªä¸‰æŒ¯ç‡(K%)ã€ä¸å››çƒç‡(BB%)ãªã©ã‚’ç”¨ã„ã€ãã‚Œã‚‰ã®äºŒä¹—é …ã‚„ç›¸äº’ä½œç”¨é …ï¼ˆä¾‹ï¼šå¥ªä¸‰æŒ¯ç‡Ã—ã‚´ãƒ­ç‡ï¼‰ã‚’å«ã‚€è¤‡é›‘ãªå›å¸°å¼ã«ã‚ˆã£ã¦è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚
                            ã€Œå¥ªä¸‰æŒ¯ç‡ãŒé«˜ã„æŠ•æ‰‹ã¯æ‰“ãŸã‚ŒãŸã‚´ãƒ­ã‚‚ãƒ’ãƒƒãƒˆã«ãªã‚Šã«ãã„ã€ã€Œä¸å››çƒãŒå¤šã„æŠ•æ‰‹ã¯ã‚´ãƒ­ç‡ãŒé«˜ã„ã¨ä½µæ®ºã‚’å–ã‚Šã‚„ã™ã„ã€ã¨ã„ã£ãŸæŒ‡æ¨™é–“ã®ç›¸ä¹—åŠ¹æœã‚’æ•°å¼åŒ–ã—ã€æŠ•çƒã®è³ªã‚’ã‚ˆã‚Šè©³ç´°ã«è©•ä¾¡ã—ã¦ã„ã¾ã™ã€‚
                        </div>
                    </div>

                </div>
                
                <div>
                    <h3>å‚è€ƒã«ã—ãŸã‚µã‚¤ãƒˆ</h3>
                    <ul>
                        <li><a href="https://1point02.jp/op/index.aspx" target="_blank" rel="noopener noreferrer">1.02 - Essence of Baseball</a></li>
                        <li><a href="https://www.baseballprospectus.com/news/article/10027/introducing-siera-part-1/" target="_blank" rel="noopener noreferrer">Baseball Prospectus</a></li>
                        <li><a href="http://bbalone.blog119.fc2.com/blog-entry-551.html" target="_blank" rel="noopener noreferrer">Baseball Concrete Blog</a></li>
                        <li><a href="https://l-data-daily.com/post-1763/" target="_blank" rel="noopener noreferrer">ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹æŒ‡æ¨™ãƒ»ç”¨èªè¾å…¸</a></li>
                        <li><a href="https://bo-no05.hatenadiary.org/" target="_blank" rel="noopener noreferrer">ã¼ãƒ¼ã®ã®ãƒ–ãƒ­ã‚°</a></li>
                        <li><a href="https://ranzankeikoku.blog.fc2.com/blog-entry-6591.html" target="_blank" rel="noopener noreferrer">æ—¥æœ¬ãƒ—ãƒ­é‡çƒRCAA&PitchingRunã¾ã¨ã‚blog</a></li>
                    </ul>
                </div>
            </div>
        </details>
    </div>
        
    <script>
        let lastScrollY = window.scrollY;
        window.addEventListener('scroll', () => {
            const currentScrollY = window.scrollY;
            if (currentScrollY > 60) {
                document.body.classList.add('scrolled');
            } else {
                document.body.classList.remove('scrolled');
            }
            lastScrollY = currentScrollY;
        }, { passive: true });
    </script>

    <div class="grid-container" id="grid">
        <!-- Generated -->
    </div>

    <footer class="footer-area">
        <div style="text-align:center; color:var(--c-text-secondary); padding:20px;">
            <p style="margin:0; font-weight:600;">SABR METRICS LAB</p>
            <p style="margin:5px 0 0; font-size:0.8rem;">Ultimate Baseball Analytics Dictionary</p>
        </div>
    </footer>
    
    <div class="modal-overlay" id="modal" onclick="closeModalOutside(event)">
        <div class="modal-panel">
            <div class="modal-header" id="modal-header">
                <button class="close-btn" onclick="closeModal()">Ã—</button>
                <div id="modal-title-area"></div>
            </div>
            <div class="modal-body" id="modal-body-content"></div>
        </div>
    </div>

<script>
    // --- Data Helper ---
    const formatVar = (text) => `<span class="var">${text}</span>`;

    // --- Constants (Default Values) ---
    const DEFAULTS = {
        // ãƒªãƒ¼ã‚°å…¨ä½“ã®çµ±è¨ˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯æ¦‚ç®—ï¼‰
        LG_PA: 28500,
        LG_RUNS: 2800,
        LG_HITS: 6900,
        LG_2B: 1150,
        LG_3B: 120,
        LG_HR: 485, 
        LG_BB: 2300,
        // ãƒªãƒ¼ã‚°ç·æ•°è©³ç´°
        LG_AB: 28750, // æ‰“æ•°
        LG_HBP: 300,  // æ­»çƒ
        LG_SF: 190,   // çŠ é£›
        LG_SH: 550    // çŠ æ‰“
    };
    
    // --- çµ±ä¸€ã•ã‚ŒãŸè©³ç´°è¨­å®šã®å®šç¾© (11é …ç›®) ---
    const ADVANCED_LEAGUE_INPUTS = [
        {id:'lg_pa', label:'ãƒªãƒ¼ã‚°ç·æ‰“å¸­', type:'number', advanced:true, default: DEFAULTS.LG_PA},
        {id:'lg_runs', label:'ãƒªãƒ¼ã‚°ç·å¾—ç‚¹', type:'number', advanced:true, default: DEFAULTS.LG_RUNS},
        {id:'lg_ab', label:'ãƒªãƒ¼ã‚°ç·æ‰“æ•°', type:'number', advanced:true, default: DEFAULTS.LG_AB}, 
        {id:'lg_hits', label:'ãƒªãƒ¼ã‚°ç·å®‰æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_HITS},
        {id:'lg_2b', label:'ãƒªãƒ¼ã‚°ç·äºŒå¡æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_2B},
        {id:'lg_3b', label:'ãƒªãƒ¼ã‚°ç·ä¸‰å¡æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_3B},
        {id:'lg_hr', label:'ãƒªãƒ¼ã‚°ç·æœ¬å¡æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_HR},
        {id:'lg_bb', label:'ãƒªãƒ¼ã‚°ç·å››çƒ', type:'number', advanced:true, default: DEFAULTS.LG_BB},
        {id:'lg_hbp', label:'ãƒªãƒ¼ã‚°ç·æ­»çƒ', type:'number', advanced:true, default: DEFAULTS.LG_HBP},
        {id:'lg_sf', label:'ãƒªãƒ¼ã‚°ç·çŠ é£›', type:'number', advanced:true, default: DEFAULTS.LG_SF},
        {id:'lg_sh', label:'ãƒªãƒ¼ã‚°ç·çŠ æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_SH}
    ];

    // Park Factors
    const PARK_FACTORS = {
        'avg':      {name: 'å¹³å‡',     pf: 1.00},
        'jingu':    {name: 'æ˜æ²»ç¥å®®', pf: 1.19},
        'yoko':     {name: 'æ¨ªæµœ',     pf: 1.04},
        'mazda':    {name: 'ãƒãƒ„ãƒ€',   pf: 0.99},
        'tokyo':    {name: 'æ±äº¬ãƒ‰ãƒ¼ãƒ ', pf: 0.97},
        'koshien':  {name: 'ç”²å­åœ’',   pf: 0.92},
        'nagoya':   {name: 'ãƒãƒ³ãƒ†ãƒªãƒ³', pf: 0.86},
        'escon':    {name: 'ã‚¨ã‚¹ã‚³ãƒ³', pf: 1.06},
        'zozo':     {name: 'ZOZOãƒãƒªãƒ³', pf: 1.06},
        'paypay':   {name: 'PayPay',   pf: 1.05},
        'belluna':  {name: 'ãƒ™ãƒ«ãƒ¼ãƒŠ', pf: 0.97},
        'kyocera':  {name: 'äº¬ã‚»ãƒ©',   pf: 0.95},
        'rakuten':  {name: 'æ¥½å¤©ãƒ¢ãƒã‚¤ãƒ«', pf: 0.94}
    };

    // --- Helper to calculate Derived Constants ---
    function calcDerived(d) {
        // åŸºæœ¬å…¥åŠ›å€¤
        const lg_hr = d.lg_hr || DEFAULTS.LG_HR;
        const lg_bb = d.lg_bb || DEFAULTS.LG_BB;
        // è©³ç´°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        const lg_ab = d.lg_ab || DEFAULTS.LG_AB;
        const lg_hbp = d.lg_hbp || DEFAULTS.LG_HBP;
        const lg_sf = d.lg_sf || DEFAULTS.LG_SF;
        const lg_sh = d.lg_sh || DEFAULTS.LG_SH;
        
        // ãã®ä»–ã®ãƒªãƒ¼ã‚°çµ±è¨ˆ
        const lg_pa = d.lg_pa || DEFAULTS.LG_PA;
        const lg_runs = d.lg_runs || DEFAULTS.LG_RUNS;
        const lg_hits = d.lg_hits || DEFAULTS.LG_HITS;
        const lg_2b = d.lg_2b || DEFAULTS.LG_2B;
        const lg_3b = d.lg_3b || DEFAULTS.LG_3B;

        // --- ãƒªãƒ¼ã‚°è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®— ---
        const lg_ibb = lg_bb * 0.03; 
        const lg_roe = Math.max(0, lg_pa - (lg_ab + lg_bb + lg_hbp + lg_sf + lg_sh));
        const lg_1b = lg_hits - lg_2b - lg_3b - lg_hr;
        const lg_obp = (lg_hits + lg_bb + lg_hbp) / (lg_ab + lg_bb + lg_hbp + lg_sf);

        // æ¨å®š: ãƒªãƒ¼ã‚°ä¸‰æŒ¯æ•° (PAã®ç´„18%)
        const lg_so = lg_pa * 0.18;
        
        // æ¨å®š: ãƒªãƒ¼ã‚°æ‰“çƒæ•° (Batted Balls)
        // Batted Balls = PA - BB - HBP - SO
        const lg_batted = lg_pa - lg_bb - lg_hbp - lg_so;
        
        // æ¨å®š: ãƒªãƒ¼ã‚°å¤–é‡ãƒ•ãƒ©ã‚¤æ•° (ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®š: FB% 45%, GB% 45%, LD% 10%)
        const lg_fb_est = lg_batted * 0.45;

        // --- wOBAè¨ˆç®— (åŸºæº–ä¿‚æ•°: wOBA Scale=1.28æƒ³å®š) ---
        const woba_denom = lg_ab + lg_bb - lg_ibb + lg_hbp + lg_sf;
        
        const woba_num_std = 
            0.692 * (lg_bb - lg_ibb) +
            0.73  * lg_hbp +
            0.966 * lg_roe +
            0.865 * lg_1b +
            1.334 * lg_2b +
            1.725 * lg_3b +
            2.065 * lg_hr;
            
        const lg_woba_std = woba_denom > 0 ? woba_num_std / woba_denom : 0;

        // --- ä¿‚æ•°è£œæ­£æ¯”ç‡ (Fitting Ratio) ---
        const fitting_ratio = (lg_woba_std > 0 && lg_obp > 0) ? (lg_obp / lg_woba_std) : 1.0;
        const lg_woba = lg_woba_std * fitting_ratio;

        // --- wOBA Scale ---
        const woba_scale = 1.28 * fitting_ratio;

        // --- ãã®ä»–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ---
        const lg_r_pa = lg_runs / lg_pa;
        const est_lg_ip = lg_pa / 4.25;
        const rpw = 20 * (lg_runs / est_lg_ip);
        const rep_per_pa = 0.12 * (lg_woba / woba_scale);
        
        const lg_tra = (lg_runs / est_lg_ip) * 9 * 0.92;

        // --- xFIPå®šæ•° & æ¯”ç‡ã®è¨ˆç®— ---
        
        // æ¯”ç‡ = æœ¬å¡æ‰“ Ã· å¤–é‡ãƒ•ãƒ©ã‚¤
        const lg_xfip_ratio = lg_hr / lg_fb_est;
        
        // ãƒªãƒ¼ã‚°å¤±ç‚¹ç‡ (RA9)
        const lg_ra9 = (lg_runs / est_lg_ip) * 9;
        
        // ãƒªãƒ¼ã‚°é˜²å¾¡ç‡ (ERA) æ¨å®š (RA9ã®ç´„92%)
        const lg_era_est = lg_ra9 * 0.92;
        
        // xFIPã®ãƒªãƒ¼ã‚°æˆåˆ†
        const lg_xfip_component = (13 * lg_xfip_ratio * lg_fb_est + 3 * (lg_bb - lg_ibb + lg_hbp) - 2 * lg_so) / est_lg_ip;
        
        // å®šæ•° = ãƒªãƒ¼ã‚°é˜²å¾¡ç‡ - ãƒªãƒ¼ã‚°xFIPæˆåˆ†
        const xfip_constant = lg_era_est - lg_xfip_component;

        // --- tRAå®šæ•°ã®è¨ˆç®— (æ–°è¦è¿½åŠ ) ---
        // ãƒªãƒ¼ã‚°æ‰“çƒå†…è¨³ã®æ¨å®š
        // ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼æ‰“çƒ (BIP) = PA - BB - HBP - SO - HR
        let lg_bip = lg_pa - lg_bb - lg_hbp - lg_so - lg_hr;
        if (lg_bip < 0) lg_bip = 0;

        // å¹³å‡çš„ãªåˆ†å¸ƒç‡ (GB:45%, LD:21%, FBç³»:34%)
        const lg_gb = lg_bip * 0.45;
        const lg_ld = lg_bip * 0.21;
        const lg_fb_system = lg_bip * 0.34;
        const lg_pu = lg_fb_system * 0.10; // å†…é‡ãƒ•ãƒ©ã‚¤ (FBç³»ã®10%)
        const lg_fb = lg_fb_system - lg_pu; // ç´”ç²‹ãªå¤–é‡ãƒ•ãƒ©ã‚¤

        // ãƒªãƒ¼ã‚°tRAæˆåˆ† (å®šæ•°ãªã—ã®tRA)
        const lg_tra_num = 
            0.297 * lg_bb + 
            0.327 * lg_hbp - 
            0.108 * lg_so + 
            1.401 * lg_hr + 
            0.036 * lg_gb - 
            0.124 * lg_pu + 
            0.132 * lg_fb + 
            0.289 * lg_ld;

        const lg_tra_denom = 
            lg_so + 
            0.745 * lg_gb + 
            0.304 * lg_ld + 
            0.994 * lg_pu + 
            0.675 * lg_fb;
        
        let tra_constant = 0;
        if (lg_tra_denom > 0) {
            const lg_tra_raw = (lg_tra_num / lg_tra_denom) * 27;
            // å®šæ•° = ãƒªãƒ¼ã‚°å¤±ç‚¹ç‡(RA9) - ãƒªãƒ¼ã‚°tRA
            tra_constant = lg_ra9 - lg_tra_raw;
        }

        return { 
            lg_r_pa, rpw, rep_per_pa, lg_woba, lg_tra, woba_scale, fitting_ratio, 
            xfip_constant, lg_xfip_ratio, lg_fb_est, tra_constant, lg_ra9, lg_era_est
        };
    }

    // --- æ–°è¦è¿½åŠ : æ‰“çƒå†…è¨³ã®æ¨å®šãƒ­ã‚¸ãƒƒã‚¯ ---
    function estimateBattedBalls(d) {
        // æ—¢ã«å®Ÿæ•°ãŒã‚ã‚‹å ´åˆã¯è¨ˆç®—ã—ãªã„ï¼ˆå†è¨ˆç®—é˜²æ­¢ï¼‰
        // NOTE: dã«ã¯ãƒªãƒ¼ã‚°å¹³å‡å€¤ãŒå«ã¾ã‚Œã‚‹ãŸã‚ã€å†è¨ˆç®—é˜²æ­¢ã¯ã“ã“ã§ã¯è¡Œã‚ãªã„æ–¹ãŒè‰¯ã„
        // if (d.est_done) return d; 
        
        // ãƒªãƒ¼ã‚°ç·æœ¬å¡æ‰“ã‚’ä½¿ç”¨
        const lg_hr = d.lg_hr || DEFAULTS.LG_HR;

        // 1. æ‰“è€…æ•°(BF)ã®ç¢ºä¿
        let bf = d.bf;
        if (!bf) {
            // BFãŒãªã‘ã‚Œã°æŠ•çƒå›ã‹ã‚‰æ¨å®š (IP x 4.20 ç¨‹åº¦ãŒå¹³å‡çš„)
            bf = d.ip * 4.20; 
        }

        // 2. ä¸‰æŒ¯ã€å››æ­»çƒ
        const so = d.so || (d.ip * 0.8); // ä»®ç½®ã
        const bb = d.bb || (d.ip * 0.3);
        const hbp = d.hbp || 0;
        const hr = d.hr || 0; // è¢«æœ¬å¡æ‰“ (SIERA, tRAã®è¨ˆç®—ã«å¿…è¦)

        // 3. ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼æ‰“çƒæ•° (BIP) ã®æ¨å®š
        // BIP = æ‰“è€… - ä¸‰æŒ¯ - å››çƒ - æ­»çƒ - è¢«æœ¬å¡æ‰“
        let bip = bf - so - bb - hbp - hr;
        if (bip < 0) bip = 0;

        // 4. ã‚´ãƒ­ç‡ (GB%) ã®å–å¾—
        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®å€¤(æ–‡å­—åˆ—)ã‚’æ•°å€¤åŒ–ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å¹³å‡ã®45%
        let gb_pct_val = 45; 
        if (d.gb_type) {
            gb_pct_val = parseFloat(d.gb_type);
        }

        const gb_rate = gb_pct_val / 100;
        const ld_rate = 0.21; // Line Driveã¯æŠ•æ‰‹ã«ã‚ˆã‚‰ãšç´„21%ã§ä¸€å®šã¨ã™ã‚‹ã®ãŒä¸€èˆ¬çš„
        
        // æ®‹ã‚ŠãŒãƒ•ãƒ©ã‚¤ç³» (FB + PU)
        let fb_system_rate = 1.0 - gb_rate - ld_rate;
        if (fb_system_rate < 0) fb_system_rate = 0;

        // å†…é‡ãƒ•ãƒ©ã‚¤ç‡ (IFFB% / FB_total)
        // ãƒ•ãƒ©ã‚¤å…¨ä½“ã®ã†ã¡ç´„10%ãŒå†…é‡ãƒ•ãƒ©ã‚¤ã¨ä»®å®š
        const iffb_rate = 0.10; 

        // å®Ÿæ•°è¨ˆç®— (BIPã‚’ãƒ™ãƒ¼ã‚¹ã«åˆ†é…)
        const gb = bip * gb_rate;
        const ld = bip * ld_rate;
        const fb_total = bip * fb_system_rate;
        const pu = fb_total * iffb_rate;     // å†…é‡ãƒ•ãƒ©ã‚¤
        const fb = fb_total - pu;            // ç´”ç²‹ãªå¤–é‡ãƒ•ãƒ©ã‚¤ (HRã¯å«ã¾ãªã„)

        // ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ³¨å…¥
        d.gb = gb;
        d.ld = ld;
        d.fb = fb;
        d.pu = pu;
        d.bf = bf; // æ¨å®šã—ãŸBFã‚‚ä¿å­˜
        d.hr = hr; // è¢«æœ¬å¡æ‰“ã‚‚è¨ˆç®—ç”¨ã«æ³¨å…¥
        d.est_done = true; // ãƒ•ãƒ©ã‚°

        return d;
    }

    // --- Helper: è©³ç´°ã‚¹ã‚¿ãƒƒãƒ„ã®è¨ˆç®— (Calculate Details from Inputs) ---
    function estimateDetails(d) {
        // IBBã¯å…¥åŠ›ãŒãªã„ãŸã‚æ¦‚ç®— (å››çƒã®ç´„4%)
        const ibb = d.bb * 0.04;

        // ROE (å¤±ç­–å‡ºå¡) ã®è¨ˆç®—
        // ROE = æ‰“å¸­ - (æ‰“æ•° + å››çƒ + æ­»çƒ + çŠ é£› + çŠ æ‰“)
        const roe = Math.max(0, d.pa - (d.ab + d.bb + d.hbp + d.sf + d.sh));

        // å˜æ‰“ (S)
        // Note: d.h must be defined. Assuming it is 0 if undefined.
        const h = d.h || 0;
        const d_val = d.d || 0;
        const t = d.t || 0;
        const hr = d.hr || 0;
        const s = h - d_val - t - hr;

        return { ibb, roe, s };
    }

    // --- Terms Database (èª¬æ˜æ–‡ã‚’å¸¸ä½“ã«çµ±ä¸€) ---
    const terms = [
        /* ---------------- ç·åˆ (Total) ---------------- */
        {
            id: "war", category: "tot", title: "WAR (é‡æ‰‹)", full: "Wins Above Replacement (Batter)",
            short: "æ‰“æ’ƒã€èµ°å¡ã€å®ˆå‚™ã‚’ç·åˆçš„ã«è©•ä¾¡ã—ã¦é‡æ‰‹ã®è²¢çŒ®åº¦ã‚’è¡¨ã™æŒ‡æ¨™",
            desc: "ä»£æ›¿å¯èƒ½ãªæ§ãˆé¸æ‰‹ï¼ˆãƒªãƒ—ãƒ¬ã‚¤ã‚¹ãƒ¡ãƒ³ãƒˆãƒ»ãƒ¬ãƒ™ãƒ«ã®é¸æ‰‹ï¼‰ãŒå‡ºå ´ã™ã‚‹å ´åˆã«æ¯”ã¹ã€ã©ã‚Œã ã‘å‹åˆ©æ•°ã‚’å¢—ã‚„ã—ãŸã‹ã«ã‚ˆã£ã¦è¨ˆç®—ã•ã‚Œã‚‹ã€‚",
            formula: `(wRAA + UZR + BaseRunning + ãƒã‚¸ã‚·ãƒ§ãƒ³è£œæ­£ + ä»£æ›¿æ°´æº–è£œæ­£) Ã· RPW`,
            criteria: "2.0: ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ / 5.0: ã‚¹ã‚¿ãƒ¼ / 8.0: MVP",
            related: ["wraa", "uzr", "woba", "rpw"],
            aiMode: true,
            inputs: [
                {id:'pa', label:'æ‰“å¸­æ•°'}, {id:'ab', label:'æ‰“æ•°'},
                {id:'h', label:'å®‰æ‰“'}, {id:'d', label:'äºŒå¡æ‰“'}, {id:'t', label:'ä¸‰å¡æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'}, 
                {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ', default:0}, 
                {id:'sf', label:'çŠ é£›', default:0}, {id:'sh', label:'çŠ æ‰“', default:0},
                {id:'sb', label:'ç›—å¡'}, {id:'cs', label:'ç›—å¡æ­»'},
                
                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                {id:'pos', label:'å®ˆå‚™ä½ç½®', type:'select', options:{'dh':'DH', '1b':'ä¸€å¡', 'lf':'å·¦ç¿¼', 'rf':'å³ç¿¼', '3b':'ä¸‰å¡', '2b':'äºŒå¡', 'cf':'ä¸­å …', 'ss':'éŠæ’ƒ', 'c':'æ•æ‰‹'}},
                {id:'def', label:'å®ˆå‚™è©•ä¾¡', type:'select', options:{'0':'å¹³å‡çš„ (0)', '5':'ä¸Šæ‰‹ã„ (+5)', '10':'åæ‰‹ (+10)', '15':'ç¥ (+15)', '-5':'è‹¦æ‰‹ (-5)', '-10':'ä¸‹æ‰‹ (-10)'}},
                
                // --- çµ±ä¸€ã•ã‚ŒãŸè©³ç´°è¨­å®š ---
                ...ADVANCED_LEAGUE_INPUTS
            ],
            calc: (d) => {
                const C = calcDerived(d);
                const est = estimateDetails(d);
                const fr = C.fitting_ratio; // è£œæ­£ä¿‚æ•°

                // 1. Calculate wOBA (Coefficients scaled by fitting_ratio)
                const woba_denom = d.ab + d.bb - est.ibb + d.hbp + d.sf;

                const woba_num = 
                    (0.692 * fr) * (d.bb - est.ibb) +
                    (0.73  * fr) * d.hbp +
                    (0.966 * fr) * est.roe +
                    (0.865 * fr) * est.s +
                    (1.334 * fr) * d.d +
                    (1.725 * fr) * d.t +
                    (2.065 * fr) * d.hr;

                const woba_val = woba_denom > 0 ? woba_num / woba_denom : 0;
                
                // 2. wRAA
                const raw_wRAA = ((woba_val - C.lg_woba) / C.woba_scale) * d.pa;

                // 3. Park Adj
                const pf = PARK_FACTORS[d.stadium].pf;
                const home_ratio = 0.5;
                const pf_coef = (home_ratio * pf) + ((1 - home_ratio) * (6 - pf) / 5);
                const parkAdj = (1 - pf_coef) * C.lg_r_pa * d.pa;
                
                const battingRuns = raw_wRAA + parkAdj;
                
                // 4. Pos Adj
                const posVals = {'dh':-15.1, '1b':-14.1, 'lf':-12.0, 'rf':-5.0, '3b':-4.8, '2b':3.4, 'cf':4.2, 'ss':10.3, 'c':18.1};
                const posAdj = (posVals[d.pos] || 0) * (d.pa / 600);
                
                // 5. UZR & BaseRunning
                const uzr = parseFloat(d.def) || 0;
                const baseRunning = (d.sb * 0.2) - (d.cs * 0.4);
                
                // 6. Replacement Level
                const repRuns = C.rep_per_pa * d.pa;
                
                // 7. Calc WAR
                const totalRuns = battingRuns + uzr + baseRunning + posAdj + repRuns;
                return (totalRuns / C.rpw).toFixed(1);
            }
        },
        {
            id: "wrc_plus", category: "bat", title: "wRC+", full: "weighted Runs Created Plus",
            short: "æ‰“æ’ƒã®å‚‘å‡ºåº¦ã‚’è©•ä¾¡ã™ã‚‹æŒ‡æ¨™",
            desc: "æ‰“å¸­ã‚ãŸã‚Šã®å¾—ç‚¹å‰µå‡ºã®å¤šã•ã‚’ã€å¹³å‡çš„ãªæ‰“è€…ã‚’100ã¨ã—ãŸå ´åˆã®ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã§è©•ä¾¡ã™ã‚‹æŒ‡æ¨™",
            formula: `(((wRAA/æ‰“å¸­ + R/PA) + (R/PA - PFè£œæ­£ä¿‚æ•°Ã—R/PA)) Ã· R/PA) Ã— 100`,
            criteria: "100: å¹³å‡ / 160: MVPå€™è£œ / 200: æ­´å²çš„",
            related: ["woba", "wraa"],
            aiMode: true,
            inputs: [
                {id:'pa', label:'æ‰“å¸­æ•°'}, {id:'ab', label:'æ‰“æ•°'},
                {id:'h', label:'å®‰æ‰“'}, {id:'d', label:'äºŒå¡æ‰“'}, {id:'t', label:'ä¸‰å¡æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'}, 
                {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ', default:0}, 
                {id:'sf', label:'çŠ é£›', default:0}, {id:'sh', label:'çŠ æ‰“', default:0},

                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                
                // --- çµ±ä¸€ã•ã‚ŒãŸè©³ç´°è¨­å®š ---
                ...ADVANCED_LEAGUE_INPUTS
            ],
            calc: (d) => {
                const C = calcDerived(d);
                const est = estimateDetails(d);
                const fr = C.fitting_ratio;
                const pf = PARK_FACTORS[d.stadium].pf;
                
                // wOBA
                const woba_denom = d.ab + d.bb - est.ibb + d.hbp + d.sf;
                const woba_num = 
                    (0.692 * fr) * (d.bb - est.ibb) +
                    (0.73  * fr) * d.hbp +
                    (0.966 * fr) * est.roe +
                    (0.865 * fr) * est.s +
                    (1.334 * fr) * d.d +
                    (1.725 * fr) * d.t +
                    (2.065 * fr) * d.hr;
                const woba_val = woba_denom > 0 ? woba_num / woba_denom : 0;
                
                // wRAA
                const raw_wraa = ((woba_val - C.lg_woba) / C.woba_scale) * d.pa;
                
                // Park Adj
                const home_ratio = 0.5;
                const pf_coef = (home_ratio * pf) + ((1 - home_ratio) * (6 - pf) / 5);
                const parkAdj = (1 - pf_coef) * C.lg_r_pa * d.pa;

                // wRC+ Calc
                const wrc_plus_val = (((raw_wraa + parkAdj) / d.pa) + C.lg_r_pa) / C.lg_r_pa * 100;
                
                return wrc_plus_val.toFixed(0);
            }
        },
        {
            id: "pit_war", category: "tot", title: "WAR (æŠ•æ‰‹)", full: "Wins Above Replacement (Pitcher)",
            short: "æŠ•çƒã‚’ç·åˆçš„ã«è©•ä¾¡ã—ã¦æŠ•æ‰‹ã®è²¢çŒ®åº¦ã‚’è¡¨ã™æŒ‡æ¨™",
            desc: "ä»£æ›¿å¯èƒ½ãªæ§ãˆé¸æ‰‹ã«æ¯”ã¹ã€ã©ã‚Œã ã‘å‹åˆ©æ•°ã‚’å¢—ã‚„ã—ãŸã‹ã«ã‚ˆã£ã¦è¨ˆç®—ã•ã‚Œã‚‹ã€‚<br>SPRAR (å…ˆç™ºã¨ã—ã¦ã®è²¢çŒ®) ã¨ RPRAR (æ•‘æ´ã¨ã—ã¦ã®è²¢çŒ®) ã‚’è¶³ã—åˆã‚ã›ã€RPWã§å‰²ã£ã¦ç®—å‡ºã™ã‚‹",
            formula: `(SPRAR + RPRAR) Ã· RPW`,
            criteria: "2.0: ãƒ­ãƒ¼ãƒ†æŠ•æ‰‹ / 4.0: ã‚¨ãƒ¼ã‚¹",
            related: ["fip", "tra", "rsaa", "rpw"],
            aiMode: true,
            inputs: [
                {id:'ip', label:'æŠ•çƒå›'}, {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'hr', label:'è¢«æœ¬å¡æ‰“'},
                {id:'role', label:'å½¹å‰²', type:'select', options:{'sp':'å…ˆç™º', 'rp':'æ•‘æ´'}},
                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                
                // --- çµ±ä¸€ã•ã‚ŒãŸè©³ç´°è¨­å®š ---
                ...ADVANCED_LEAGUE_INPUTS
            ],
            calc: (d) => {
                const C = calcDerived(d);

                // 1. FIP Calculation (Standard Constant approx 3.10)
                const fip = (13 * d.hr + 3 * d.bb - 2 * d.so) / d.ip + 3.10; // Simple FIP constant is approx 3.10

                // 2. League Parameters
                // C.lg_ra9 is calculated inside calcDerived using the new comprehensive inputs
                const lg_ra9 = C.lg_ra9;

                // 3. Park Adjustment
                const pf = PARK_FACTORS[d.stadium].pf;
                // Park Adjusted League RA9
                const lg_ra9_park = lg_ra9 * pf;

                // 4. Runs Above Average (RAA) based on FIP
                // RAA = (League RA - Pitcher FIP) * IP / 9
                const raa = (lg_ra9_park - fip) * (d.ip / 9);

                // 5. Replacement Level Adjustment
                // SP: +0.38 runs/9, RP: +0.47 runs/9 (approx)
                const rep_bonus = d.role === 'sp' ? 0.38 : 0.47;
                const rep_runs = rep_bonus * (d.ip / 9);

                // 6. RAR (Runs Above Replacement) -> SPRAR or RPRAR
                const rar = raa + rep_runs;
                
                // Since inputs only allow one role, SPRAR+RPRAR is just RAR
                return (rar / C.rpw).toFixed(1);
            }
        },
        {
            id: "rpw", category: "tot", title: "RPW", full: "Runs Per Win",
            short: "å‹åˆ©ã‚’1ã¤å¢—ã‚„ã™ã®ã«å¿…è¦ãªå¾—ç‚¹æ•°",
            desc: "ã€Œ1å‹ã®é‡ã¿ã€ã‚’å¾—ç‚¹æ›ç®—ã—ãŸã‚‚ã®ã€‚",
            formula: `20 Ã— (ãƒªãƒ¼ã‚°ç·å¾—ç‚¹ Ã· ãƒªãƒ¼ã‚°ç·æŠ•çƒå›)`,
            criteria: "ç´„8.5 ï½ 10.0",
            related: ["war", "pythag"],
            inputs: [
                {id:'lg_runs', label:'ãƒªãƒ¼ã‚°ç·å¾—ç‚¹'},
                {id:'lg_pa', label:'ãƒªãƒ¼ã‚°ç·æ‰“å¸­'}
                // IPã¯PAã‹ã‚‰æ¨å®šã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯PAã‚’ä½¿ç”¨
            ],
            calc: (d) => {
                const est_lg_ip = d.lg_pa / 4.25; // Estimate IP from PA
                return (20 * (d.lg_runs / est_lg_ip)).toFixed(2);
            }
        },
        {
            id: "wpa", category: "tot", title: "WPA", full: "Win Probability Added",
            short: "å‹åˆ©ç¢ºç‡ã‚’ã©ã‚Œã ã‘å¤‰å‹•ã•ã›ãŸã‹ã‚’ç¤ºã™",
            desc: "çŠ¶æ³ï¼ˆç‚¹å·®ã€ã‚¤ãƒ‹ãƒ³ã‚°ã€èµ°è€…ã€ã‚¢ã‚¦ãƒˆï¼‰ã”ã¨ã®å‹åˆ©ç¢ºç‡ã‚’ã€ãƒ—ãƒ¬ã‚¤å‰å¾Œã§ã©ã‚Œã ã‘å¢—ã‚„ã—ãŸã‹ã«ã‚ˆã£ã¦è©•ä¾¡ã™ã‚‹ã€‚ã‚µãƒ¨ãƒŠãƒ©ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ãªã©ã¯éå¸¸ã«é«˜ã„å€¤ã«ãªã‚‹",
            formula: `ãƒ—ãƒ¬ã‚¤å¾Œã®å‹åˆ©ç¢ºç‡ - ãƒ—ãƒ¬ã‚¤å‰ã®å‹åˆ©ç¢ºç‡`,
            criteria: "çŠ¶æ³ã«ä¾å­˜",
            related: ["re24"]
        },
        {
            id: "re24", category: "tot", title: "RE24", full: "Run Expectancy 24",
            short: "çŠ¶æ³åˆ¥ã®ã€Œå¾—ç‚¹æœŸå¾…å€¤ã€ã®å¢—æ¸›ã‚’ç¤ºã™",
            desc: "24ç¨®é¡ã®çŠ¶æ³ï¼ˆç„¡æ­»ä¸€å¡ãªã©ï¼‰ã«ãŠã‘ã‚‹å¾—ç‚¹æœŸå¾…å€¤ã‚’ã©ã‚Œã ã‘æ”¹å–„ã•ã›ãŸã‹ã‚’æ¸¬ã‚‹ã€‚",
            formula: `ãƒ—ãƒ¬ã‚¤å¾ŒæœŸå¾…å€¤ - ãƒ—ãƒ¬ã‚¤å‰æœŸå¾…å€¤ + å¾—ç‚¹`,
            criteria: "0: å¹³å‡",
            related: ["wpa"]
        },
        {
            id: "pythag", category: "tot", title: "Pythagenpat", full: "Pythagorean Expectation",
            short: "å¾—å¤±ç‚¹ã‹ã‚‰äºˆæ¸¬ã•ã‚Œã‚‹ã€Œæœ¬æ¥ã‚ã‚‹ã¹ãå‹ç‡ã€",
            desc: "å®Ÿéš›ã®å‹ç‡ãŒã“ã‚Œã‚ˆã‚Šé«˜ã„ã¨ã€Œé‹ãŒè‰¯ã„ã€ã¾ãŸã¯ã€Œæ¥æˆ¦ã«å¼·ã„ï¼ˆç›£ç£ã®é‡‡é…ãŒè‰¯ã„ï¼‰ã€ã¨ã•ã‚Œã‚‹ã€‚æœªæ¥ã®å‹ç‡äºˆæ¸¬ã«å½¹ç«‹ã¤ã¨ã—ã¦é‡è¦–ã•ã‚Œã‚‹",
            formula: `${formatVar('å¾—ç‚¹')}^x Ã· (${formatVar('å¾—ç‚¹')}^x + ${formatVar('å¤±ç‚¹')}^x) <br><small style="font-size:0.7em; color:#94a3b8;">x = (å¾—ç‚¹+å¤±ç‚¹)^0.287</small>`,
            criteria: "å®Ÿéš›ã®å‹ç‡ã¨ã®ä¹–é›¢ã‚’ç¢ºèª",
            inputs: [
                {id:'rs', label:'å¾—ç‚¹'}, {id:'ra', label:'å¤±ç‚¹'}
            ],
            calc: (d) => {
                const x = Math.pow((d.rs + d.ra), 0.287);
                return (Math.pow(d.rs, x) / (Math.pow(d.rs, x) + Math.pow(d.ra, x))).toFixed(3);
            }
        },
        {
            id: "pf", category: "tot", title: "PF", full: "Park Factor",
            short: "çƒå ´ã®ç‰¹æ€§ï¼ˆæ‰“è€…æœ‰åˆ©/æŠ•æ‰‹æœ‰åˆ©ï¼‰ã‚’è¡¨ã™æ•°å€¤",
            desc: "1.00ãŒå¹³å‡ã€‚1.00ã‚ˆã‚Šå¤§ãã‘ã‚Œã°æ‰“è€…æœ‰åˆ©ã€å°ã•ã‘ã‚Œã°æŠ•æ‰‹æœ‰åˆ©ã¨ã•ã‚Œã‚‹ã€‚ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã¯ã€é¸æ‰‹ã®æˆç¸¾ã‚’æ¯”è¼ƒã™ã‚‹éš›ã«ã“ã®PFè£œæ­£ã‚’ã‹ã‘ã‚‹ã“ã¨ãŒå¸¸è­˜ã¨ãªã£ã¦ã„ã‚‹",
            formula: `(æœ¬æ‹ åœ°ã§ã®è©¦åˆã‚ãŸã‚Šå¾—ç‚¹ + å¤±ç‚¹) Ã· (æœ¬æ‹ åœ°ä»¥å¤–ã§ã®è©¦åˆã‚ãŸã‚Šå¾—ç‚¹ + å¤±ç‚¹)`,
            criteria: "1.00: ä¸­ç«‹ / 1.20: ãƒ’ãƒƒã‚¿ãƒ¼ã‚ºãƒ‘ãƒ¼ã‚¯",
            related: ["wrc_plus"]
        },

        /* ---------------- æ‰“æ’ƒ (Batting) ---------------- */
        {
            id: "avg", category: "std", title: "AVG", full: "Batting Average",
            short: "æ‰“ç‡",
            formula: `${formatVar('å®‰æ‰“')} Ã· ${formatVar('æ‰“æ•°')}`,
            criteria: ".250: å¹³å‡ / .300: å„ªç§€",
            inputs: [{id:'h', label:'å®‰æ‰“'}, {id:'ab', label:'æ‰“æ•°'}],
            calc: (d) => (d.h / d.ab).toFixed(3).replace(/^0/,'')
        },
        {
            id: "obp", category: "std", title: "OBP", full: "On Base Percentage",
            short: "å‡ºå¡ç‡",
            desc: "æ‰“ç‡ã‚ˆã‚Šã‚‚å¾—ç‚¹ã¨ã®ç›¸é–¢ãŒé«˜ã„ãŸã‚ã€ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã¯æ‰“ç‡ã‚ˆã‚Šé‡è¦–ã•ã‚Œã‚‹ã€‚å››æ­»çƒã‚’é¸ã¹ã‚‹æ‰“è€…ã¯ä¾¡å€¤ãŒé«˜ã„ã¨è©•ä¾¡ã•ã‚Œã‚‹",
            formula: `(${formatVar('å®‰æ‰“')} + ${formatVar('å››çƒ')} + ${formatVar('æ­»çƒ')}) Ã· (${formatVar('æ‰“æ•°')} + ${formatVar('å››çƒ')} + ${formatVar('æ­»çƒ')} + ${formatVar('çŠ é£›')})`,
            criteria: ".320: å¹³å‡ / .400: å„ªç§€",
            related: ["ops", "isod"],
            inputs: [{id:'h', label:'å®‰æ‰“'}, {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ'}, {id:'ab', label:'æ‰“æ•°'}, {id:'sf', label:'çŠ é£›'}],
            calc: (d) => ((d.h+d.bb+d.hbp)/(d.ab+d.bb+d.hbp+d.sf)).toFixed(3).replace(/^0/,'')
        },
        {
            id: "slg", category: "std", title: "SLG", full: "Slugging Percentage",
            short: "é•·æ‰“ç‡",
            desc: "æ‰“ç‡ã®ã‚ˆã†ãªåå‰ã ãŒã€Œ1æ‰“æ•°ã‚ãŸã‚Šã®æœŸå¾…å¡æ‰“æ•°ã€ã‚’è¡¨ã™ã€‚å˜æ‰“=1ã€æœ¬å¡æ‰“=4ã¨ã—ã¦è¨ˆç®—ã™ã‚‹",
            formula: `${formatVar('å¡æ‰“')} Ã· ${formatVar('æ‰“æ•°')}`,
            criteria: ".400: å¹³å‡ / .500: ãƒ‘ãƒ¯ãƒ¼ãƒ’ãƒƒã‚¿ãƒ¼",
            related: ["ops", "iso"],
            inputs: [{id:'tb', label:'å¡æ‰“'}, {id:'ab', label:'æ‰“æ•°'}],
            calc: (d) => (d.tb / d.ab).toFixed(3).replace(/^0/,'')
        },
        {
            id: "ops", category: "std", title: "OPS", full: "On-base Plus Slugging",
            short: "å‡ºå¡ç‡ + é•·æ‰“ç‡",
            desc: "è¨ˆç®—ãŒç°¡å˜ã§ã‚ã‚ŠãªãŒã‚‰ã€ãƒãƒ¼ãƒ ã®å¾—ç‚¹æ•°ã¨éå¸¸ã«é«˜ã„ç›¸é–¢ã‚’æŒã¤æŒ‡æ¨™ã€‚ç¾åœ¨ã§ã¯å…¬å¼è¨˜éŒ²ã¨ã—ã¦ã‚‚æ¡ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„",
            formula: `${formatVar('å‡ºå¡ç‡')} + ${formatVar('é•·æ‰“ç‡')}`,
            criteria: ".730: å¹³å‡ / .800: å„ªç§€ / 1.000: æœ€å¼·",
            related: ["woba", "xr"],
            inputs: [
                {id:'h', label:'å®‰æ‰“'}, {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ'}, 
                {id:'ab', label:'æ‰“æ•°'}, {id:'sf', label:'çŠ é£›'}, {id:'tb', label:'å¡æ‰“'}
            ],
            calc: (d) => {
                const obp = (d.h+d.bb+d.hbp)/(d.ab+d.bb+d.hbp+d.sf);
                const slg = d.tb / d.ab;
                return (obp + slg).toFixed(3).replace(/^0/,'');
            }
        },
        {
            id: "woba", category: "bat", title: "wOBA", full: "weighted On-Base Average",
            short: "å„ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾—ç‚¹ä¾¡å€¤ã§é‡ã¿ä»˜ã‘ã—ãŸã€ŒçœŸã®å‡ºå¡ç‡ã€",
            desc: "OPSã®æ¬ ç‚¹ã‚’ä¿®æ­£ã—ã€å„ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå˜æ‰“ã€æœ¬å¡æ‰“ã€å››çƒãªã©ï¼‰ãŒå¾—ç‚¹ã«ã©ã‚Œã ã‘è²¢çŒ®ã—ãŸã‹ã‚’ä¿‚æ•°åŒ–ã—ã¦è¨ˆç®—ã™ã‚‹ã€‚ä¿‚æ•°ã¯å¹´åº¦ã”ã¨ã«å¤‰å‹•ã™ã‚‹",
            formula: `(0.69Ã—${formatVar('å››çƒ')} + 0.72Ã—${formatVar('æ­»çƒ')} + 0.89Ã—${formatVar('å˜æ‰“')} + 1.27Ã—${formatVar('äºŒå¡æ‰“')} + 1.62Ã—${formatVar('ä¸‰å¡æ‰“')} + 2.10Ã—${formatVar('æœ¬å¡æ‰“')}) Ã· ${formatVar('æ‰“å¸­')}`,
            criteria: ".320: å¹³å‡ / .400: MVPç´š",
            related: ["ops", "wrc_plus"],
            inputs: [
                {id:'pa', label:'æ‰“å¸­'}, {id:'ab', label:'æ‰“æ•°'},
                {id:'s', label:'å˜æ‰“'}, {id:'d', label:'äºŒå¡æ‰“'}, {id:'t', label:'ä¸‰å¡æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'}, 
                {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ', default:0}, 
                {id:'sf', label:'çŠ é£›', default:0}, {id:'sh', label:'çŠ æ‰“', default:0},

                // --- çµ±ä¸€ã•ã‚ŒãŸè©³ç´°è¨­å®š ---
                ...ADVANCED_LEAGUE_INPUTS
            ],
            calc: (d) => {
                const C = calcDerived(d);
                const est = estimateDetails(d);
                const fr = C.fitting_ratio;
                
                const woba_denom = d.ab + d.bb - est.ibb + d.hbp + d.sf;
                const woba_num = 
                    (0.692 * fr) * (d.bb - est.ibb) +
                    (0.73  * fr) * d.hbp +
                    (0.966 * fr) * est.roe +
                    (0.865 * fr) * d.s + 
                    (1.334 * fr) * d.d +
                    (1.725 * fr) * d.t +
                    (2.065 * fr) * d.hr;
                    
                return woba_denom > 0 ? (woba_num / woba_denom).toFixed(3).replace(/^0/,'') : "---";
            }
        },
        {
            id: "wraa", category: "bat", title: "wRAA", full: "weighted Runs Above Average",
            short: "å¹³å‡çš„ãªæ‰“è€…ã‚ˆã‚Šã€Œä½•ç‚¹ã€å¤šãå–ã£ãŸã‹ã‚’ç¤ºã™",
            desc: "ç©ã¿ä¸Šã’æŒ‡æ¨™ã€‚å‡ºå ´æ•°ãŒå¤šãã€ã‹ã¤æ‰“æ’ƒæˆç¸¾ãŒè‰¯ã„ã»ã©æ•°å€¤ãŒé«˜ããªã‚‹ã€‚WARã®æ‰“æ’ƒæ§‹æˆè¦ç´ ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã€‚<br>å¼ä¸­ã®<strong>wOBAScaleï¼ˆç´„1.24ï¼‰</strong>ã¯ã€wOBAã‚’å‡ºå¡ç‡ã®ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆ.320å‰å¾ŒãŒå¹³å‡ï¼‰ã«åˆã‚ã›ã‚‹ãŸã‚ã«æ›ã‘ã‚‰ã‚Œã¦ã„ãŸä¿‚æ•°ã‚’ã€å¾—ç‚¹å˜ä½ã«æˆ»ã™ãŸã‚ã«å‰²ã‚‹ã‚‚ã®",
            formula: `(${formatVar('wOBA')} - ãƒªãƒ¼ã‚°å¹³å‡wOBA) Ã· wOBAScale Ã— ${formatVar('æ‰“å¸­')}`,
            criteria: "0: å¹³å‡ / +20: ä¸€æµ",
            related: ["war", "woba"]
        },
        {
            id: "iso", category: "bat", title: "ISO", full: "Isolated Power",
            short: "æ‰“ç‡ã‚’é™¤ã„ãŸç´”ç²‹ãªé•·æ‰“åŠ›",
            desc: "é•·æ‰“ç‡ã‹ã‚‰æ‰“ç‡ã‚’å¼•ã„ã¦ç®—å‡ºã™ã‚‹ã€‚å˜æ‰“ã‚’ç„¡è¦–ã—ã€äºŒå¡æ‰“ä»¥ä¸Šã‚’æ‰“ã¤èƒ½åŠ›ã®ã¿ã‚’è©•ä¾¡ã™ã‚‹",
            formula: `${formatVar('é•·æ‰“ç‡')} - ${formatVar('æ‰“ç‡')}`,
            criteria: ".140: å¹³å‡ / .250: å¼·æ‰“è€…",
            inputs: [
                {id:'slg', label:'é•·æ‰“ç‡', default: 0.400}, 
                {id:'avg', label:'æ‰“ç‡', default: 0.250}
            ],
            calc: (d) => (d.slg - d.avg).toFixed(3).replace(/^0/,'')
        },
        {
            id: "babip", category: "bat", title: "BABIP", full: "Batting Average on Balls In Play",
            short: "ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼æ‰“çƒã®ãƒ’ãƒƒãƒˆç‡ï¼ˆé‹ã®æŒ‡æ¨™ï¼‰",
            desc: "æœ¬å¡æ‰“ä»¥å¤–ã®ãƒ•ã‚§ã‚¢ã‚¾ãƒ¼ãƒ³ã«é£›ã‚“ã æ‰“çƒãŒãƒ’ãƒƒãƒˆã«ãªã£ãŸå‰²åˆã€‚æ¥µç«¯ã«é«˜ã„/ä½ã„å ´åˆã¯ã€Œé‹ã€ã‚„ã€Œå®ˆå‚™ã€ã®å½±éŸ¿ãŒå¼·ã„",
            formula: `(${formatVar('å®‰æ‰“')}-${formatVar('æœ¬å¡æ‰“')}) Ã· (${formatVar('æ‰“æ•°')}-${formatVar('ä¸‰æŒ¯')}-${formatVar('æœ¬å¡æ‰“')}+${formatVar('çŠ é£›')})`,
            criteria: ".300å‰å¾ŒãŒåŸºæº–",
            inputs: [{id:'h', label:'å®‰æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'}, {id:'ab', label:'æ‰“æ•°'}, {id:'so', label:'ä¸‰æŒ¯'}, {id:'sf', label:'çŠ é£›'}],
            calc: (d) => ((d.h - d.hr) / (d.ab - d.so - d.hr + d.sf)).toFixed(3).replace(/^0/,'')
        },
        {
            id: "bb_k", category: "bat", title: "BB/K", full: "Walk to Strikeout Ratio",
            short: "ä¸‰æŒ¯1ã¤ã«å¯¾ã™ã‚‹å››çƒã®æ•°",
            desc: "é¸çƒçœ¼ã¨ã‚³ãƒ³ã‚¿ã‚¯ãƒˆèƒ½åŠ›ã®ãƒãƒ©ãƒ³ã‚¹ã‚’ç¤ºã™ã€‚1.0ã‚’è¶…ãˆã‚Œã°éå¸¸ã«å„ªç§€ãªæ‰“è€…ã¨ã•ã‚Œã‚‹",
            formula: `${formatVar('å››çƒ')} Ã· ${formatVar('ä¸‰æŒ¯')}`,
            criteria: "0.4: å¹³å‡ / 1.0ä»¥ä¸Š: å„ªç§€",
            inputs: [{id:'bb', label:'å››çƒ'}, {id:'so', label:'ä¸‰æŒ¯'}],
            calc: (d) => (d.bb / d.so).toFixed(2)
        },
        {
            id: "k_pct", category: "bat", title: "K%", full: "Strikeout Percentage",
            short: "æ‰“å¸­ã«å ã‚ã‚‹ä¸‰æŒ¯ã®å‰²åˆ",
            desc: "ä¸‰æŒ¯ãŒå°‘ãªã„ã»ã©ã‚³ãƒ³ã‚¿ã‚¯ãƒˆèƒ½åŠ›ãŒé«˜ã„ã¨ã•ã‚Œã‚‹ãŒã€ç¾ä»£é‡çƒã§ã¯é•·æ‰“ã¨ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã¨ã—ã¦ã‚ã‚‹ç¨‹åº¦è¨±å®¹ã•ã‚Œã‚‹å‚¾å‘ãŒã‚ã‚‹",
            formula: `${formatVar('ä¸‰æŒ¯')} Ã· ${formatVar('æ‰“å¸­')}`,
            criteria: "20%: å¹³å‡ / 10%ä»¥ä¸‹: ã‚³ãƒ³ã‚¿ã‚¯ãƒˆå·§è€…",
            inputs: [{id:'so', label:'ä¸‰æŒ¯'}, {id:'pa', label:'æ‰“å¸­'}],
            calc: (d) => ((d.so / d.pa) * 100).toFixed(1) + '%'
        },
        {
            id: "bb_pct", category: "bat", title: "BB%", full: "Walk Percentage",
            short: "æ‰“å¸­ã«å ã‚ã‚‹å››çƒã®å‰²åˆ",
            desc: "é¸çƒçœ¼ã®è‰¯ã•ã‚’ç¤ºã™ã€‚æ‰“ç‡ãŒä½ãã¦ã‚‚BB%ãŒé«˜ã„é¸æ‰‹ã¯å‡ºå¡èƒ½åŠ›ãŒé«˜ãã€ãƒãƒ¼ãƒ ã¸ã®è²¢çŒ®åº¦ã¯å¤§ãã„ã¨ã•ã‚Œã‚‹",
            formula: `${formatVar('å››çƒ')} Ã· ${formatVar('æ‰“å¸­')}`,
            criteria: "8%: å¹³å‡ / 10%ä»¥ä¸Š: é¸çƒçœ¼ãŒè‰¯ã„",
            inputs: [{id:'bb', label:'å››çƒ'}, {id:'pa', label:'æ‰“å¸­'}],
            calc: (d) => ((d.bb / d.pa) * 100).toFixed(1) + '%'
        },
        {
            id: "rc", category: "bat", title: "RC", full: "Runs Created",
            short: "æ‰“è€…ãŒå‰µå‡ºã—ãŸç·å¾—ç‚¹æ•°",
            desc: "ãƒ“ãƒ«ãƒ»ã‚¸ã‚§ãƒ¼ãƒ ã‚ºãŒè€ƒæ¡ˆã—ãŸå¤å…¸çš„ãªæŒ‡æ¨™ã€‚å®‰æ‰“ã‚„å››çƒãªã©ã®å‡ºå¡èƒ½åŠ›ã¨ã€é•·æ‰“åŠ›ã‚’æ›ã‘åˆã‚ã›ã¦å¾—ç‚¹èƒ½åŠ›ã‚’æ¨å®šã™ã‚‹",
            formula: `(å‡ºå¡èƒ½åŠ›A Ã— é€²å¡èƒ½åŠ›B) Ã· (æ‰“å¸­C)`,
            criteria: "ç©ã¿ä¸Šã’å‹æŒ‡æ¨™",
            inputs: [{id:'h', label:'å®‰æ‰“'}, {id:'bb', label:'å››çƒ'}, {id:'tb', label:'å¡æ‰“'}, {id:'ab', label:'æ‰“æ•°'}, {id:'sf', label:'çŠ é£›'}],
            calc: (d) => {
                // Basic RC Formula
                const a = d.h + d.bb;
                const b = d.tb;
                const c = d.ab + d.bb;
                return ((a * b) / c).toFixed(1);
            }
        },
        {
            id: "rc27", category: "bat", title: "RC27", full: "Runs Created per 27 Outs",
            short: "ã“ã®æ‰“è€…9äººã§æ‰“ç·šã‚’çµ„ã‚“ã æ™‚ã®1è©¦åˆäºˆæƒ³å¾—ç‚¹",
            desc: "RCã‚’27ã‚¢ã‚¦ãƒˆï¼ˆ1è©¦åˆåˆ†ï¼‰ã«æ›ç®—ã—ãŸã‚‚ã®ã€‚æ‰“è€…ã®å¾—ç‚¹èƒ½åŠ›ã‚’ç›´æ„Ÿçš„ã«ç†è§£ã—ã‚„ã™ã„",
            formula: `RC Ã· (${formatVar('æ‰“æ•°')}-${formatVar('å®‰æ‰“')}+${formatVar('ç›—å¡æ­»')}+${formatVar('ä½µæ®º')}+${formatVar('çŠ æ‰“')}+${formatVar('çŠ é£›')}) Ã— 27`,
            criteria: "4.5ç‚¹: å¹³å‡",
            inputs: [{id:'h', label:'å®‰æ‰“'}, {id:'bb', label:'å››çƒ'}, {id:'tb', label:'å¡æ‰“'}, {id:'ab', label:'æ‰“æ•°'}],
            calc: (d) => {
                const rc = ((d.h + d.bb) * d.tb) / (d.ab + d.bb);
                const outs = d.ab - d.h; 
                return (rc / outs * 27).toFixed(2);
            }
        },
        {
            id: "xr", category: "bat", title: "XR", full: "Extrapolated Runs",
            short: "å„ãƒ—ãƒ¬ãƒ¼ã«å¾—ç‚¹ä¾¡å€¤ä¿‚æ•°ã‚’æ›ã‘ã¦ç®—å‡ºã™ã‚‹å¾—ç‚¹åŠ›",
            desc: "RCã¨ä¼¼ã¦ã„ã‚‹ãŒã€ã‚ˆã‚Šå„ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå˜æ‰“0.5ç‚¹ã€æœ¬å¡æ‰“1.44ç‚¹ãªã©ï¼‰ã®å¾—ç‚¹è²¢çŒ®ã‚’ç·šå½¢çš„ã«è¶³ã—åˆã‚ã›ã¦è©•ä¾¡ã™ã‚‹æŒ‡æ¨™",
            formula: `0.5Ã—${formatVar('å˜æ‰“')} + 0.72Ã—${formatVar('äºŒå¡æ‰“')} + 1.44Ã—${formatVar('HR')} + 0.34Ã—(${formatVar('å››çƒ')}+${formatVar('æ­»çƒ')})...`,
            criteria: "RC27ã¨åŒæ§˜ã«è©•ä¾¡å¯èƒ½",
            related: ["rc27"],
            inputs: [{id:'s', label:'å˜æ‰“'}, {id:'d', label:'äºŒå¡æ‰“'}, {id:'t', label:'ä¸‰å¡æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'}, {id:'bb', label:'å››æ­»çƒ'}],
            calc: (d) => (0.5*d.s + 0.72*d.d + 1.04*d.t + 1.44*d.hr + 0.34*d.bb).toFixed(1)
        },
        {
            id: "ab_hr", category: "bat", title: "AB/HR", full: "At Bats per Home Run",
            short: "HR1æœ¬æ‰“ã¤ã®ã«ã‹ã‹ã‚‹æ‰“æ•°",
            formula: `${formatVar('æ‰“æ•°')} Ã· ${formatVar('æœ¬å¡æ‰“')}`,
            criteria: "20.0ä»¥ä¸‹: æœ¬å¡æ‰“æ‰“è€…",
            inputs: [{id:'ab', label:'æ‰“æ•°'}, {id:'hr', label:'æœ¬å¡æ‰“'}],
            calc: (d) => (d.ab / d.hr).toFixed(1)
        },
        {
            id: "pa_bb", category: "bat", title: "PA/BB", full: "Plate Appearances per Walk",
            short: "å››çƒã‚’1ã¤é¸ã¶ã®ã«ã‹ã‹ã‚‹æ‰“å¸­æ•°",
            formula: `${formatVar('æ‰“å¸­')} Ã· ${formatVar('å››çƒ')}`,
            inputs: [{id:'pa', label:'æ‰“å¸­'}, {id:'bb', label:'å››çƒ'}],
            calc: (d) => (d.pa / d.bb).toFixed(1)
        },
        {
            id: "isod", category: "bat", title: "IsoD", full: "Isolated Discipline",
            short: "å››æ­»çƒã«ã‚ˆã‚‹å‡ºå¡èƒ½åŠ›",
            desc: "å‡ºå¡ç‡ã‹ã‚‰æ‰“ç‡ã‚’å¼•ã„ã¦ç®—å‡ºã™ã‚‹ã€‚é¸çƒçœ¼ã®è‰¯ã•ã‚’ç¤ºã™",
            formula: `${formatVar('å‡ºå¡ç‡')} - ${formatVar('æ‰“ç‡')}`,
            criteria: "0.06: å¹³å‡ / 0.10: é¸çƒçœ¼è‰¯",
            inputs: [{id:'obp', label:'å‡ºå¡ç‡'}, {id:'avg', label:'æ‰“ç‡'}],
            calc: (d) => (d.obp - d.avg).toFixed(3).replace(/^0/,'')
        },
        {
            id: "gpa", category: "bat", title: "GPA", full: "Gross Production Average",
            short: "OPSã‚ˆã‚Šæ‰“ç‡ã«è¿‘ã„æ„Ÿè¦šã§è©•ä¾¡ã§ãã‚‹æŒ‡æ¨™",
            desc: "OPSã¯å‡ºå¡ç‡ã‚’éå°è©•ä¾¡ã™ã‚‹å‚¾å‘ãŒã‚ã‚‹ãŸã‚ã€å‡ºå¡ç‡ã«1.8å€ã®é‡ã¿ã‚’ã‹ã‘ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã€ã•ã‚‰ã«æ‰“ç‡ã®ã‚ˆã†ãªã‚¹ã‚±ãƒ¼ãƒ«ã«å¤‰æ›ã—ãŸã‚‚ã®",
            formula: `(1.8 Ã— ${formatVar('å‡ºå¡ç‡')} + ${formatVar('é•·æ‰“ç‡')}) Ã· 4`,
            criteria: ".250: å¹³å‡",
            inputs: [{id:'obp', label:'å‡ºå¡ç‡'}, {id:'slg', label:'é•·æ‰“ç‡'}],
            calc: (d) => ((1.8 * d.obp + d.slg) / 4).toFixed(3).replace(/^0/,'')
        },
        {
            id: "seca", category: "bat", title: "SecA", full: "Secondary Average",
            short: "æ‰“ç‡ä»¥å¤–ã®è¦ç´ ï¼ˆå››çƒã€é•·æ‰“ã€ç›—å¡ï¼‰ã§ã®è²¢çŒ®åº¦",
            desc: "ãƒ“ãƒ«ãƒ»ã‚¸ã‚§ãƒ¼ãƒ ã‚ºè€ƒæ¡ˆã€‚ã€Œæ‰“ç‡ã€ã«å«ã¾ã‚Œãªã„æ”»æ’ƒåŠ›ã‚’æ¸¬ã‚‹",
            formula: `(${formatVar('å¡æ‰“')}-${formatVar('å®‰æ‰“')} + ${formatVar('å››çƒ')} + ${formatVar('ç›—å¡')} - ${formatVar('ç›—å¡æ­»')}) Ã· ${formatVar('æ‰“æ•°')}`,
            criteria: ".250: å¹³å‡ / .400: è¶…å„ªç§€",
            inputs: [{id:'tb', label:'å¡æ‰“'}, {id:'h', label:'å®‰æ‰“'}, {id:'bb', label:'å››çƒ'}, {id:'sb', label:'ç›—å¡'}, {id:'cs', label:'ç›—å¡æ­»'}, {id:'ab', label:'æ‰“æ•°'}],
            calc: (d) => ((d.tb - d.h + d.bb + d.sb - d.cs) / d.ab).toFixed(3).replace(/^0/,'')
        },
        {
            id: "noi", category: "bat", title: "NOI", full: "New Offensive Index",
            short: "å‡ºå¡ç‡ï¼‹é•·æ‰“ç‡Ã·3",
            desc: "OPSã®ç°¡æ˜“ä¿®æ­£ç‰ˆã€‚å‡ºå¡ç‡ã®ä¾¡å€¤ã‚’é•·æ‰“ç‡ã®3å€ã¨è¦‹ç©ã‚‚ã£ã¦è¨ˆç®—ã™ã‚‹ã€‚",
            formula: `(${formatVar('å‡ºå¡ç‡')} + ${formatVar('é•·æ‰“ç‡')} Ã· 3) Ã— 1000`,
            criteria: "450: å¹³å‡ / 550: å„ªç§€",
            inputs: [{id:'obp', label:'å‡ºå¡ç‡'}, {id:'slg', label:'é•·æ‰“ç‡'}],
            calc: (d) => ((d.obp + d.slg / 3) * 1000).toFixed(0)
        },
        
        /* ---------------- æŠ•çƒ (Pitching) ---------------- */
        {
            id: "era", category: "std", title: "ERA", full: "Earned Run Average",
            short: "é˜²å¾¡ç‡",
            formula: `${formatVar('è‡ªè²¬ç‚¹')} Ã— 9 Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "3.00: å¹³å‡",
            inputs: [{id:'er', label:'è‡ªè²¬ç‚¹'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => (d.er * 9 / d.ip).toFixed(2)
        },
        {
            id: "whip", category: "std", title: "WHIP", full: "Walks plus Hits per Inning Pitched",
            short: "1å›ã‚ãŸã‚Šã«å‡ºã—ãŸãƒ©ãƒ³ãƒŠãƒ¼ã®æ•°",
            formula: `(${formatVar('è¢«å®‰æ‰“')} + ${formatVar('ä¸å››çƒ')}) Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "1.30: å¹³å‡ / 1.00æœªæº€: ã‚¨ãƒ¼ã‚¹",
            inputs: [{id:'h', label:'è¢«å®‰æ‰“'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => ((d.h + d.bb) / d.ip).toFixed(2)
        },
        {
            id: "fip", category: "pit", title: "FIP", full: "Fielding Independent Pitching",
            short: "å®ˆå‚™ã®å½±éŸ¿ã‚’é™¤å¤–ã—ãŸã€ŒçœŸã®é˜²å¾¡ç‡ã€",
            desc: "æŠ•æ‰‹ã®è²¬ä»»ã§ã‚ã‚‹ä¸‰æŒ¯ãƒ»å››çƒãƒ»è¢«æœ¬å¡æ‰“ã®ã¿ã§è©•ä¾¡ã™ã‚‹ã€‚é˜²å¾¡ç‡ã‚ˆã‚Šã‚‚å°†æ¥ã®æˆç¸¾äºˆæ¸¬ã«å½¹ç«‹ã¤",
            formula: `(13Ã—${formatVar('æœ¬å¡æ‰“')} + 3Ã—(${formatVar('å››çƒ')}+${formatVar('æ­»çƒ')}) - 2Ã—${formatVar('ä¸‰æŒ¯')}) Ã· ${formatVar('æŠ•çƒå›')} + 3.10`,
            criteria: "é˜²å¾¡ç‡ã‚¹ã‚±ãƒ¼ãƒ«",
            inputs: [{id:'hr', label:'è¢«æœ¬å¡æ‰“'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'hbp', label:'ä¸æ­»çƒ'}, {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => ((13*d.hr + 3*(d.bb+d.hbp) - 2*d.so)/d.ip + 3.10).toFixed(2)
        },
        {
            id: "xfip", category: "pit", title: "xFIP", full: "Expected FIP",
            short: "è¢«æœ¬å¡æ‰“ã®ä»£ã‚ã‚Šã«ã€Œãƒ•ãƒ©ã‚¤ãƒœãƒ¼ãƒ«æ•°ã€ã‚’ç”¨ã„ãŸFIPã®é€²åŒ–ç‰ˆ",
            desc: "HR/FBï¼ˆãƒ•ãƒ©ã‚¤ã«å¯¾ã™ã‚‹æœ¬å¡æ‰“ã®å‰²åˆï¼‰ã‚’ãƒªãƒ¼ã‚°å¹³å‡å€¤ã«ç½®ãæ›ãˆã¦è¨ˆç®—ã™ã‚‹ã€‚è¢«æœ¬å¡æ‰“ã®é‹è¦ç´ ã‚’æ’é™¤ã—ã€ã‚ˆã‚Šç´”ç²‹ãªå®ŸåŠ›ã‚’æ¸¬ã‚‹ã€‚",
            formula: `(13 Ã— (FB Ã— LgHR/LgFB) + 3 Ã— (BB - IBB + HBP) - 2 Ã— SO) Ã· IP + å®šæ•°`,
            criteria: "é˜²å¾¡ç‡ã‚¹ã‚±ãƒ¼ãƒ«",
            aiMode: true,
            inputs: [
                {id:'ip', label:'æŠ•çƒå›'}, {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'hbp', label:'ä¸æ­»çƒ'},
                // å¤‰æ›´: å®Ÿæ•°å…¥åŠ›å»ƒæ­¢ -> å‚¾å‘é¸æŠã¸
                {id:'gb_type', label:'æ‰“çƒå‚¾å‘(GB%)', type:'select', options:{
                    '55':'55% (è¶…ã‚´ãƒ­P)', 
                    '50':'50% (ã‚´ãƒ­P)', 
                    '45':'45% (å¹³å‡)', 
                    '40':'40% (ãƒ•ãƒ©ã‚¤P)', 
                    '35':'35% (è¶…ãƒ•ãƒ©ã‚¤P)'
                }},
                // --- çµ±ä¸€ã•ã‚ŒãŸè©³ç´°è¨­å®š ---
                ...ADVANCED_LEAGUE_INPUTS
            ],
            calc: (d) => {
                // æ‰“çƒå†…è¨³ã‚’æ¨å®š
                estimateBattedBalls(d);
                
                const C = calcDerived(d);
                const est_ibb = d.bb * 0.04;
                
                // d.fb ã¯ estimateBattedBalls ã§ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
                const term1 = 13 * C.lg_xfip_ratio * d.fb;
                const term2 = 3 * (d.bb - est_ibb + d.hbp);
                const term3 = 2 * d.so;
                
                // xFIP = (13 * lg_xfip_ratio * FB + 3 * (BB - IBB + HBP) - 2 * SO) / IP + xfip_constant
                const val = (term1 + term2 - term3) / d.ip + C.xfip_constant;
                
                return isFinite(val) ? val.toFixed(2) : "---";
            }
        },
        {
            id: "siera", category: "pit", title: "SIERA", full: "Skill-Interactive Earned Run Average",
            short: "æ‰“çƒã®è³ªã‚„ä¸‰æŒ¯ãƒ»å››çƒã‚’è€ƒæ…®ã—ãŸã€FIPã‚ˆã‚Šç²¾åº¦ã®é«˜ã„æŒ‡æ¨™",
            desc: "æŠ•çƒã®ã€Œè³ªã€ã‚’æœ€ã‚‚æ­£ç¢ºã«åæ˜ ã™ã‚‹ã¨ã•ã‚Œã‚‹æŒ‡æ¨™ã€‚ã‚´ãƒ­ç‡ã‚„ä¸‰æŒ¯ã€å››çƒã®ãƒãƒ©ãƒ³ã‚¹ã‹ã‚‰ç®—å‡ºã•ã‚Œã‚‹ã€‚",
            // formula: `6.145 - 16.99(SO/PA) + 11.43(BB/PA) - 1.86((GB-FB-PU)/PA) + ...`,
            formula: `6.145 - 16.99(SO/PA) + 11.43(BB/PA) - 1.86((GB-FB-PU)/PA) + 7.65((SO/PA)Â²) - 6.66(((GB-FB-PU)/PA)Â²) + 10.13(SO/PA)((GB-FB-PU)/PA) - 5.20(BB/PA)((GB-FB-PU)/PA)`,
            criteria: "å¤±ç‚¹ç‡ã‚¹ã‚±ãƒ¼ãƒ« (3.00: å„ªç§€)",
            related: ["fip", "xfip", "tra"],
            aiMode: true,
            inputs: [
                {id:'ip', label:'æŠ•çƒå›'}, {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}, 
                {id:'hr', label:'è¢«æœ¬å¡æ‰“'}, // å¿…é ˆé …ç›®ã«å¤‰æ›´
                // å¤‰æ›´: å®Ÿæ•°å…¥åŠ›å»ƒæ­¢ -> å‚¾å‘é¸æŠã¸
                {id:'gb_type', label:'æ‰“çƒå‚¾å‘(GB%)', type:'select', options:{
                    '55':'55% (è¶…ã‚´ãƒ­P)', 
                    '50':'50% (ã‚´ãƒ­P)', 
                    '45':'45% (å¹³å‡)', 
                    '40':'40% (ãƒ•ãƒ©ã‚¤P)', 
                    '35':'35% (è¶…ãƒ•ãƒ©ã‚¤P)'
                }},
                {id:'bf', label:'æ‰“è€…æ•°'}, // å¿…é ˆé …ç›®ã«å¤‰æ›´
                
                // --- çµ±ä¸€ã•ã‚ŒãŸè©³ç´°è¨­å®šã®è¿½åŠ  ---
                ...ADVANCED_LEAGUE_INPUTS
            ],
            calc: (d) => {
                // æ‰“çƒå†…è¨³ã‚’æ¨å®š
                estimateBattedBalls(d);

                const pa = d.bf;
                // ã‚¼ãƒ­é™¤ç®—é˜²æ­¢ (æ‰“è€…æ•°(bf)ãŒ0ã®å ´åˆã¯è¨ˆç®—ä¸å¯)
                if (!pa || pa === 0) return "---";

                // SIERAè¨ˆç®— (Updated Formula)
                // SIERA = 6.145 â€“ 16.986*(SO/PA) + 11.434*(BB/PA) â€“ 1.858*((GB-FB-PU)/PA) 
                //       + 7.653*((SO/PA)^2) - 6.664*(((GB-FB-PU)/PA)^2)
                //       + 10.130*(SO/PA)*((GB-FB-PU)/PA) â€“ 5.195*(BB/PA)*((GB-FB-PU)/PA)
                
                const A = d.so / pa;
                const B = d.bb / pa;
                const C_val = (d.gb - d.fb - d.pu) / pa;
                
                const val = 6.145 
                    - 16.986 * A 
                    + 11.434 * B 
                    - 1.858 * C_val 
                    + 7.653 * (A * A) 
                    - 6.664 * (C_val * C_val) 
                    + 10.130 * A * C_val 
                    - 5.195 * B * C_val;
                
                return isFinite(val) ? val.toFixed(2) : "---";
            }
        },
        {
            id: "tra", category: "pit", title: "tRA", full: "True Runs Allowed",
            short: "æ‰“çƒã®ç¨®é¡ï¼ˆã‚´ãƒ­ãƒ»ãƒ•ãƒ©ã‚¤ãªã©ï¼‰ã‚‚è€ƒæ…®ã—ãŸæŒ‡æ¨™",
            desc: "FIPã‚’ç™ºå±•ã•ã›ã€å„æ‰“çƒç¨®åˆ¥ï¼ˆãƒ©ã‚¤ãƒŠãƒ¼ã€ã‚´ãƒ­ã€ãƒ•ãƒ©ã‚¤ï¼‰ã®æœŸå¾…å¤±ç‚¹å€¤ã‚’å‰²ã‚Šå½“ã¦ã¦ç®—å‡ºã™ã‚‹æŒ‡æ¨™ã€‚",
            formula: `( (0.297Ã—BB + 0.327Ã—HBP - 0.108Ã—SO + 1.401Ã—HR + 0.036Ã—GB - 0.124Ã—PU + 0.132Ã—FB + 0.289Ã—LD) Ã· (SO + 0.745Ã—GB + 0.304Ã—LD + 0.994Ã—PU + 0.675Ã—FB) Ã— 27 ) + å®šæ•°`,
            criteria: "å¤±ç‚¹ç‡ã‚¹ã‚±ãƒ¼ãƒ«",
            related: ["fip"],
            aiMode: true,
            inputs: [
                {id:'ip', label:'æŠ•çƒå›'}, {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'hbp', label:'ä¸æ­»çƒ'}, {id:'hr', label:'è¢«HR'},
                {id:'gb_type', label:'æ‰“çƒå‚¾å‘(GB%)', type:'select', options:{
                    '55':'55% (è¶…ã‚´ãƒ­P)', 
                    '50':'50% (ã‚´ãƒ­P)', 
                    '45':'45% (å¹³å‡)', 
                    '40':'40% (ãƒ•ãƒ©ã‚¤P)', 
                    '35':'35% (è¶…ãƒ•ãƒ©ã‚¤P)'
                }},
                // --- çµ±ä¸€ã•ã‚ŒãŸè©³ç´°è¨­å®š ---
                ...ADVANCED_LEAGUE_INPUTS
            ],
            calc: (d) => {
                estimateBattedBalls(d);
                const C = calcDerived(d);
                
                // tRAè¨ˆç®— (Updated Formula)
                const numerator = 
                    0.297 * d.bb + 
                    0.327 * d.hbp - 
                    0.108 * d.so + 
                    1.401 * d.hr + 
                    0.036 * d.gb - 
                    0.124 * d.pu + 
                    0.132 * d.fb + 
                    0.289 * d.ld;
                    
                const denominator = 
                    d.so + 
                    0.745 * d.gb + 
                    0.304 * d.ld + 
                    0.994 * d.pu + 
                    0.675 * d.fb;
                
                if (denominator === 0) return "---";

                // tRA Raw (Base value)
                const tra_raw = (numerator / denominator) * 27;
                
                // å®šæ•°åŠ ç®— (ãƒªãƒ¼ã‚°RA9ã«åˆã‚ã›ã‚‹è£œæ­£)
                const val = tra_raw + C.tra_constant;
                
                return isFinite(val) ? val.toFixed(2) : "---";
            }
        },
        {
            id: "k_9", category: "pit", title: "K/9", full: "Strikeouts per 9",
            short: "å¥ªä¸‰æŒ¯ç‡",
            formula: `${formatVar('å¥ªä¸‰æŒ¯')} Ã— 9 Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "7.0: å¹³å‡ / 9.0: ãƒ‰ã‚¯ã‚¿ãƒ¼K",
            inputs: [{id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => (d.so * 9 / d.ip).toFixed(2)
        },
        {
            id: "bb_9", category: "pit", title: "BB/9", full: "Walks per 9",
            short: "ä¸å››çƒç‡",
            formula: `${formatVar('ä¸å››çƒ')} Ã— 9 Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "3.0: å¹³å‡ / 2.0ä»¥ä¸‹: åˆ¶çƒè‰¯",
            inputs: [{id:'bb', label:'ä¸å››çƒ'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => (d.bb * 9 / d.ip).toFixed(2)
        },
        {
            id: "k_pct_pit", category: "pit", title: "K%", full: "Strikeout Percentage (Pitcher)",
            short: "å¯¾æˆ¦æ‰“è€…ã«å ã‚ã‚‹å¥ªä¸‰æŒ¯ã®å‰²åˆ",
            desc: "å¥ªä¸‰æŒ¯ç‡(K/9)ã‚ˆã‚Šã‚‚æŠ•çƒå›æ•°ã«ä¾å­˜ã›ãšã€æŠ•æ‰‹ã®æ”¯é…åŠ›ã‚’æ­£ç¢ºã«è¡¨ã™æŒ‡æ¨™",
            formula: `${formatVar('å¥ªä¸‰æŒ¯')} Ã· ${formatVar('æ‰“è€…æ•°')}`,
            criteria: "20%: å¹³å‡ / 30%: å„ªç§€",
            inputs: [{id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bf', label:'æ‰“è€…æ•°'}],
            calc: (d) => ((d.so / d.bf) * 100).toFixed(1) + '%'
        },
        {
            id: "bb_pct_pit", category: "pit", title: "BB%", full: "Walk Percentage (Pitcher)",
            short: "å¯¾æˆ¦æ‰“è€…ã«å ã‚ã‚‹ä¸å››çƒã®å‰²åˆ",
            desc: "ä¸å››çƒç‡(BB/9)ã‚ˆã‚Šã‚‚æŠ•çƒå›æ•°ã«ä¾å­˜ã›ãšã€åˆ¶çƒåŠ›ã‚’æ­£ç¢ºã«è¡¨ã™æŒ‡æ¨™",
            formula: `${formatVar('ä¸å››çƒ')} Ã· ${formatVar('æ‰“è€…æ•°')}`,
            criteria: "8%: å¹³å‡ / 5%ä»¥ä¸‹: å„ªç§€",
            inputs: [{id:'bb', label:'ä¸å››çƒ'}, {id:'bf', label:'æ‰“è€…æ•°'}],
            calc: (d) => ((d.bb / d.bf) * 100).toFixed(1) + '%'
        },
        {
            id: "k_bb_pit", category: "pit", title: "K/BB", full: "K-to-BB Ratio",
            short: "å¥ªä¸‰æŒ¯ã¨ä¸å››çƒã®æ¯”ç‡",
            desc: "æŠ•æ‰‹ã®å®Œæˆåº¦ãƒ»å®‰å®šæ„Ÿã‚’ç¤ºã™é‡è¦æŒ‡æ¨™ã€‚3.5ã‚’è¶…ãˆã‚‹ã¨éå¸¸ã«å„ªç§€ã¨ã•ã‚Œã‚‹",
            formula: `${formatVar('å¥ªä¸‰æŒ¯')} Ã· ${formatVar('ä¸å››çƒ')}`,
            criteria: "2.5: å¹³å‡ / 4.0: éå¸¸ã«å„ªç§€",
            inputs: [{id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}],
            calc: (d) => (d.so / d.bb).toFixed(2)
        },
        {
            id: "gb_pct", category: "pit", title: "GB%", full: "Ground Ball Percentage (Est)",
            short: "æ‰“çƒå‚¾å‘è¨­å®šã«åŸºã¥ãæ¨å®šã‚´ãƒ­ç‡",
            desc: "é¸æŠã•ã‚ŒãŸæ‰“çƒå‚¾å‘è¨­å®šã‹ã‚‰ç®—å‡ºã•ã‚ŒãŸã‚´ãƒ­ç‡ã‚’è¡¨ç¤ºã™ã‚‹",
            formula: `æ¨å®šå€¤`,
            criteria: "45%: å¹³å‡ / 50%è¶…: ã‚´ãƒ­P",
            aiMode: true,
            inputs: [
                {id:'gb_type', label:'æ‰“çƒå‚¾å‘(GB%)', type:'select', options:{
                    '55':'55% (è¶…ã‚´ãƒ­P)', 
                    '50':'50% (ã‚´ãƒ­P)', 
                    '45':'45% (å¹³å‡)', 
                    '40':'40% (ãƒ•ãƒ©ã‚¤P)', 
                    '35':'35% (è¶…ãƒ•ãƒ©ã‚¤P)'
                }}
            ],
            calc: (d) => d.gb_type ? d.gb_type + '%' : "45%"
        },
        {
            id: "fb_pct", category: "pit", title: "FB%", full: "Fly Ball Percentage (Est)",
            short: "æ‰“çƒå‚¾å‘è¨­å®šã«åŸºã¥ãæ¨å®šãƒ•ãƒ©ã‚¤ç‡",
            desc: "é¸æŠã•ã‚ŒãŸæ‰“çƒå‚¾å‘è¨­å®šã‹ã‚‰ç®—å‡ºã•ã‚ŒãŸãƒ•ãƒ©ã‚¤ç‡ï¼ˆå†…é‡ãƒ•ãƒ©ã‚¤å«ã‚€ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹",
            formula: `æ¨å®šå€¤`,
            criteria: "35%: å¹³å‡",
            aiMode: true,
            inputs: [
                {id:'gb_type', label:'æ‰“çƒå‚¾å‘(GB%)', type:'select', options:{
                    '55':'55% (è¶…ã‚´ãƒ­P)', 
                    '50':'50% (ã‚´ãƒ­P)', 
                    '45':'45% (å¹³å‡)', 
                    '40':'40% (ãƒ•ãƒ©ã‚¤P)', 
                    '35':'35% (è¶…ãƒ•ãƒ©ã‚¤P)'
                }}
            ],
            calc: (d) => {
                const gb = parseFloat(d.gb_type || 45);
                // LD 21%å›ºå®šã¨ä»®å®šã—ãŸå ´åˆã®æ®‹ã‚Š
                const fb = 100 - gb - 21;
                return fb + '%';
            }
        },

        /* ---------------- å®ˆå‚™ (Fielding) ---------------- */
        {
            id: "uzr", category: "fld", title: "UZR", full: "Ultimate Zone Rating",
            short: "å®ˆå‚™ã«ã‚ˆã‚‹å¤±ç‚¹é˜²æ­¢é‡ï¼ˆå¹³å‡æ¯”ï¼‰",
            desc: "1.02ãªã©ã§æ¡ç”¨ã•ã‚Œã‚‹å®ˆå‚™æŒ‡æ¨™ã®ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã€‚ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ã‚¾ãƒ¼ãƒ³ã«åˆ†å‰²ã—ã€æ‰“çƒã”ã¨ã®å‡¦ç†é›£æ˜“åº¦ã«å¿œã˜ã¦è²¢çŒ®åº¦ã‚’ç®—å‡ºã™ã‚‹",
            formula: "åŠ ç‚¹æ–¹å¼",
            criteria: "0: å¹³å‡ / +15: ã‚´ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ©ãƒ–",
            // å…¥åŠ›ã•ã‚ŒãŸå®ˆå‚™è©•ä¾¡(def)ã‚’ãã®ã¾ã¾è¿”ã™ç°¡æ˜“å®Ÿè£…
            inputs: [{id:'def', label:'å®ˆå‚™è©•ä¾¡'}], 
            calc: (d) => d.def ? parseFloat(d.def).toFixed(1) : "---"
        },
        {
            id: "der", category: "fld", title: "DER", full: "Defensive Efficiency Ratio",
            short: "æœ¬å¡æ‰“ä»¥å¤–ã®ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼æ‰“çƒã‚’ã‚¢ã‚¦ãƒˆã«ã—ãŸå‰²åˆ",
            desc: "ãƒãƒ¼ãƒ å…¨ä½“ã®å®ˆå‚™åŠ›ã‚’æ¸¬ã‚‹æŒ‡æ¨™ã€‚1-è¢«BABIP",
            formula: `1 - ((${formatVar('è¢«å®‰æ‰“')} - ${formatVar('è¢«HR')}) Ã· (${formatVar('æ‰“è€…')} - ${formatVar('ä¸‰æŒ¯')} - ${formatVar('å››çƒ')} - ${formatVar('æ­»çƒ')} - ${formatVar('è¢«HR')}))`,
            criteria: ".700å‰å¾ŒãŒå¹³å‡",
            inputs: [{id:'h', label:'è¢«å®‰æ‰“'}, {id:'hr', label:'è¢«HR'}, {id:'bf', label:'æ‰“è€…æ•°'}, {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'hbp', label:'ä¸æ­»çƒ'}],
            calc: (d) => (1 - ((d.h - d.hr) / (d.bf - d.so - d.bb - d.hbp - d.hr))).toFixed(3).replace(/^0/,'')
        },
        {
            id: "drs", category: "fld", title: "DRS", full: "Defensive Runs Saved",
            short: "UZRã¨ä¸¦ã¶å®ˆå‚™æŒ‡æ¨™",
            desc: "UZRã¨åŒæ§˜ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã ãŒã€æ¸¬å®šæ–¹æ³•ãŒç•°ãªã‚‹ã€‚MLBã§ã¯UZRã¨å…±ã«ã‚´ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ©ãƒ–è³ã®é¸è€ƒåŸºæº–ã¨ãªã‚‹",
            formula: "åŠ ç‚¹æ–¹å¼",
            criteria: "+15ä»¥ä¸Š: æœ€é«˜ãƒ¬ãƒ™ãƒ«"
        },
        {
            id: "rf", category: "fld", title: "RF", full: "Range Factor",
            short: "1è©¦åˆã‚ãŸã‚Šã«é–¢ä¸ã—ãŸã‚¢ã‚¦ãƒˆã®æ•°",
            desc: "å®ˆå‚™ç¯„å›²ã®åºƒã•ã‚’ç¤ºã™ã¨ã•ã‚Œã‚‹æŒ‡æ¨™ã ãŒã€æŠ•æ‰‹ã®å¥ªä¸‰æŒ¯èƒ½åŠ›ãªã©ã«å½±éŸ¿ã‚’å—ã‘ã‚‹ãŸã‚ã€UZRãªã©ã‚ˆã‚Šç²¾åº¦ã¯ä½ã„",
            formula: `(${formatVar('åˆºæ®º')}+${formatVar('è£œæ®º')}) Ã· ${formatVar('å®ˆå‚™å›')} Ã— 9`,
            inputs: [{id:'po', label:'åˆºæ®º'}, {id:'a', label:'è£œæ®º'}, {id:'inn', label:'å®ˆå‚™å›'}],
            calc: (d) => ((d.po + d.a) / d.inn * 9).toFixed(2)
        },
        {
            id: "fp", category: "fld", title: "FP%", full: "Fielding Percentage",
            short: "å®ˆå‚™ç‡",
            desc: "å¤±ç­–ã‚’ã—ãªã‹ã£ãŸå‰²åˆã€‚å®ˆå‚™ç¯„å›²ã®åºƒã•ã¯è€ƒæ…®ã•ã‚Œãªã„ãŸã‚ã€ç¾ä»£ã®ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã¯é‡è¦è¦–ã•ã‚Œãªã„",
            formula: `(${formatVar('åˆºæ®º')}+${formatVar('è£œæ®º')}) Ã· (${formatVar('åˆºæ®º')}+${formatVar('è£œæ®º')}+${formatVar('å¤±ç­–')})`,
            inputs: [{id:'po', label:'åˆºæ®º'}, {id:'a', label:'è£œæ®º'}, {id:'e', label:'å¤±ç­–'}],
            calc: (d) => ((d.po + d.a)/(d.po + d.a + d.e)).toFixed(3).replace(/^0/,'')
        },

        /* ---------------- èµ°å¡ (Running) ---------------- */
        {
            id: "wsb", category: "fld", title: "wSB", full: "weighted Stolen Base Runs",
            short: "ç›—å¡ã«ã‚ˆã‚‹å¾—ç‚¹è²¢çŒ®",
            desc: "ç›—å¡æˆåŠŸã«ã‚ˆã‚‹ãƒ—ãƒ©ã‚¹ã¨ã€ç›—å¡æ­»ã«ã‚ˆã‚‹ãƒã‚¤ãƒŠã‚¹ï¼ˆæˆåŠŸã‚ˆã‚ŠãƒšãƒŠãƒ«ãƒ†ã‚£ãŒå¤§ãã„ï¼‰ã‚’åˆç®—ã—ãŸã‚‚ã®",
            formula: `0.2Ã—${formatVar('ç›—å¡')} - 0.4Ã—${formatVar('ç›—å¡æ­»')}`,
            desc: "ä¿‚æ•°ã¯æ¦‚ç®—å€¤ã€‚ç›—å¡æ­»ã®ãƒã‚¤ãƒŠã‚¹ã¯æˆåŠŸã®ãƒ—ãƒ©ã‚¹ã‚ˆã‚Šå¤§ãã„ã¨ã•ã‚Œã‚‹",
            inputs: [{id:'sb', label:'ç›—å¡'}, {id:'cs', label:'ç›—å¡æ­»'}],
            calc: (d) => (0.2*d.sb - 0.4*d.cs).toFixed(1)
        },
        {
            id: "sb_pct", category: "fld", title: "SB%", full: "Stolen Base Percentage",
            short: "ç›—å¡æˆåŠŸç‡",
            formula: `${formatVar('ç›—å¡')} Ã· (${formatVar('ç›—å¡')} + ${formatVar('ç›—å¡æ­»')})`,
            criteria: "70%ä»¥ä¸ŠãŒæç›Šåˆ†å²ç‚¹",
            inputs: [{id:'sb', label:'ç›—å¡'}, {id:'cs', label:'ç›—å¡æ­»'}],
            calc: (d) => ((d.sb / (d.sb + d.cs)) * 100).toFixed(1) + '%'
        },

        /* ---------------- ãã®ä»– ---------------- */
        {
            id: "p_ip", category: "pit", title: "P/IP", full: "Pitches per Inning",
            short: "1ã‚¤ãƒ‹ãƒ³ã‚°ã‚ãŸã‚Šã®æŠ•çƒæ•°",
            formula: `${formatVar('æŠ•çƒæ•°')} Ã— 9 Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "15çƒä»¥ä¸‹: çœã‚¨ãƒ",
            inputs: [{id:'np', label:'çƒæ•°'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => d.np > 0 ? (d.np / d.ip).toFixed(1) : "---"
        },
        {
            id: "rsaa", category: "pit", title: "RSAA", full: "Runs Saved Above Average",
            short: "å¹³å‡çš„ãªæŠ•æ‰‹ã«æ¯”ã¹ã¦ã€ã©ã‚Œã ã‘å¤±ç‚¹ã‚’é˜²ã„ã ã‹ã‚’ç¤ºã™",
            desc: "é˜²å¾¡ç‡ã¨æŠ•çƒå›ã‚’åŸºã«ç®—å‡ºã™ã‚‹ç©ã¿ä¸Šã’ç³»æŒ‡æ¨™ã€‚WARã®æŠ•çƒç‰ˆã®ç°¡æ˜“è¨ˆç®—ã«ä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹",
            formula: `(ãƒªãƒ¼ã‚°å¹³å‡é˜²å¾¡ç‡ - ${formatVar('é˜²å¾¡ç‡')}) Ã— ${formatVar('æŠ•çƒå›')} Ã· 9`,
            criteria: "ãƒ—ãƒ©ã‚¹ãªã‚‰å¹³å‡ä»¥ä¸Š",
            inputs: [
                {id:'er', label:'è‡ªè²¬ç‚¹'}, 
                {id:'ip', label:'æŠ•çƒå›'},
                // ãƒªãƒ¼ã‚°å¹³å‡é˜²å¾¡ç‡ã®ä»£ã‚ã‚Šã«ã€è©³ç´°è¨­å®šã‹ã‚‰æ¨å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                ...ADVANCED_LEAGUE_INPUTS
            ],
            calc: (d) => {
                // ERAã‚’è¨ˆç®— (å…¥åŠ›ãŒãªã„å ´åˆã¯è‡ªè²¬ç‚¹ã‹ã‚‰è¨ˆç®—)
                const my_era = d.er ? (d.er * 9 / d.ip) : 0;
                
                // ãƒªãƒ¼ã‚°å¹³å‡é˜²å¾¡ç‡ã‚’è©³ç´°è¨­å®šã‹ã‚‰æ¨å®š
                const C = calcDerived(d);
                const lg_era = C.lg_era_est;
                
                return ((lg_era - my_era) * d.ip / 9).toFixed(1);
            }
        },
        {
            id: "ta", category: "bat", title: "TA", full: "Total Average",
            short: "æ”»æ’ƒã®åŠ¹ç‡æ€§ã‚’æ¸¬ã‚‹å¤å…¸çš„æŒ‡æ¨™",
            desc: "ç²å¾—ã—ãŸå¡æ•°ã‚’ã€æ¶ˆè²»ã—ãŸã‚¢ã‚¦ãƒˆæ•°ã§å‰²ã£ãŸã‚‚ã®ã€‚OPSæ™®åŠä»¥å‰ã«ã‚ˆãä½¿ã‚ã‚Œã¦ã„ãŸæŒ‡æ¨™ã€‚",
            formula: `(${formatVar('å¡æ‰“')}+${formatVar('å››çƒ')}+${formatVar('æ­»çƒ')}+${formatVar('ç›—å¡')}) Ã· (${formatVar('æ‰“æ•°')}-${formatVar('å®‰æ‰“')}+${formatVar('ç›—å¡æ­»')}+${formatVar('ä½µæ®ºæ‰“')})`,
            criteria: "0.700: å¹³å‡ / 1.000: å„ªç§€",
            inputs: [
                {id:'tb', label:'å¡æ‰“'}, {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ'}, {id:'sb', label:'ç›—å¡'},
                {id:'ab', label:'æ‰“æ•°'}, {id:'h', label:'å®‰æ‰“'}, {id:'cs', label:'ç›—å¡æ­»'}, {id:'gidp', label:'ä½µæ®ºæ‰“'}
            ],
            calc: (d) => {
                const num = d.tb + d.bb + d.hbp + d.sb;
                const denom = d.ab - d.h + d.cs + d.gidp;
                return denom > 0 ? (num / denom).toFixed(3) : "---";
            }
        },
        {
            id: "psn", category: "bat", title: "PSN", full: "Power-Speed Number",
            short: "ãƒ‘ãƒ¯ãƒ¼ã¨ã‚¹ãƒ”ãƒ¼ãƒ‰ã®å…¼å‚™ãƒ¬ãƒ™ãƒ«ã‚’ç¤ºã™",
            desc: "æœ¬å¡æ‰“æ•°ã¨ç›—å¡æ•°ã®èª¿å’Œå¹³å‡ã€‚ãƒˆãƒªãƒ—ãƒ«ã‚¹ãƒªãƒ¼ãªã©ã‚’ç‹™ã†é¸æ‰‹ã®ãƒãƒ©ãƒ³ã‚¹è©•ä¾¡ã«ä½¿ã‚ã‚Œã‚‹ã€‚",
            formula: `(2 Ã— ${formatVar('æœ¬å¡æ‰“')} Ã— ${formatVar('ç›—å¡')}) Ã· (${formatVar('æœ¬å¡æ‰“')} + ${formatVar('ç›—å¡')})`,
            criteria: "20.0: ä¸€æµ / 30.0: è¶…ä¸€æµ",
            inputs: [{id:'hr', label:'æœ¬å¡æ‰“'}, {id:'sb', label:'ç›—å¡'}],
            calc: (d) => {
                return (d.hr + d.sb) > 0 ? ((2 * d.hr * d.sb) / (d.hr + d.sb)).toFixed(2) : "0.00";
            }
        },
        {
            id: "tto_pct", category: "bat", title: "TTO%", full: "Three True Outcomes Percentage",
            short: "ã€Œé‹ã«å·¦å³ã•ã‚Œãªã„çµæœã€ã®å‰²åˆ",
            desc: "æ‰“å¸­çµæœãŒå®ˆå‚™ã®å½±éŸ¿ã‚’å—ã‘ãªã„ã€Œä¸‰æŒ¯ã€å››çƒã€æœ¬å¡æ‰“ã€ã®ã„ãšã‚Œã‹ã§çµ‚ã‚ã£ãŸå‰²åˆã€‚ç¾ä»£é‡çƒã§ã¯ã“ã®å‰²åˆãŒå¢—åŠ å‚¾å‘ã«ã‚ã‚‹ã€‚",
            formula: `(${formatVar('ä¸‰æŒ¯')} + ${formatVar('å››çƒ')} + ${formatVar('æœ¬å¡æ‰“')}) Ã· ${formatVar('æ‰“å¸­')}`,
            criteria: "35%: å¹³å‡ / 50%: æ¥µç«¯ãªãƒ‘ãƒ¯ãƒ¼ãƒ’ãƒƒã‚¿ãƒ¼",
            inputs: [{id:'so', label:'ä¸‰æŒ¯'}, {id:'bb', label:'å››çƒ'}, {id:'hr', label:'æœ¬å¡æ‰“'}, {id:'pa', label:'æ‰“å¸­'}],
            calc: (d) => ((d.so + d.bb + d.hr) / d.pa * 100).toFixed(1) + '%'
        },
        {
            id: "pa_so", category: "bat", title: "PA/K", full: "Plate Appearances per Strikeout",
            short: "1ä¸‰æŒ¯ã™ã‚‹ã¾ã§ã«ã‹ã‹ã‚‹æ‰“å¸­æ•°",
            desc: "ä¸‰æŒ¯ã®å°‘ãªã•ï¼ˆã‚³ãƒ³ã‚¿ã‚¯ãƒˆèƒ½åŠ›ï¼‰ã‚’ç¤ºã™æŒ‡æ¨™ã€‚K%ã®é€†æ•°çš„ãªæ„å‘³åˆã„ã‚’æŒã¤ã€‚",
            formula: `${formatVar('æ‰“å¸­')} Ã· ${formatVar('ä¸‰æŒ¯')}`,
            criteria: "5.0: å¹³å‡ / 10.0: ä¸‰æŒ¯ã—ãªã„",
            inputs: [{id:'pa', label:'æ‰“å¸­'}, {id:'so', label:'ä¸‰æŒ¯'}],
            calc: (d) => (d.so > 0 ? (d.pa / d.so).toFixed(1) : "---")
        },
        {
            id: "hr_fb_bat", category: "bat", title: "HR/FB", full: "HR per Fly Ball (Batter)",
            short: "ãƒ•ãƒ©ã‚¤ãŒæœ¬å¡æ‰“ã«ãªã‚‹ç¢ºç‡",
            desc: "ãƒ‘ãƒ¯ãƒ¼ã®æŒ‡æ¨™ã€‚ã“ã‚ŒãŒæ¥µç«¯ã«é«˜ã„å ´åˆã¯é‹ãŒè‰¯ã„ã‹ã€çœŸã®ãƒ‘ãƒ¯ãƒ¼ãƒ’ãƒƒã‚¿ãƒ¼ã‹ã®ã©ã¡ã‚‰ã‹ã§ã‚ã‚‹ã€‚",
            formula: `${formatVar('æœ¬å¡æ‰“')} Ã· ${formatVar('ãƒ•ãƒ©ã‚¤ç·æ•°')}`,
            criteria: "10%: å¹³å‡ / 20%: ãƒ‘ãƒ¯ãƒ¼ãƒ’ãƒƒã‚¿ãƒ¼",
            related: ["xfip"]
        },
        {
            id: "hard_pct", category: "bat", title: "Hard%", full: "Hard Contact Percentage",
            short: "å¼·ã„æ‰“çƒï¼ˆ95mphä»¥ä¸Šï¼‰ã®å‰²åˆ",
            desc: "Statcastãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãæŒ‡æ¨™ã€‚æ‰“çƒé€Ÿåº¦ãŒé€Ÿã„ã»ã©ãƒ’ãƒƒãƒˆã‚„é•·æ‰“ã«ãªã‚‹ç¢ºç‡ã¯é«˜ã¾ã‚‹ã€‚",
            formula: "æ‰“çƒé€Ÿåº¦95ãƒã‚¤ãƒ«ä»¥ä¸Šã®æ‰“çƒæ•° Ã· å…¨æ‰“çƒæ•°",
            criteria: "35%: å¹³å‡ / 50%: ã‚¨ãƒªãƒ¼ãƒˆ"
        },
        {
            id: "barrel_pct", category: "bat", title: "Barrel%", full: "Barrel Percentage",
            short: "ã€Œãƒãƒ¬ãƒ«ã€ã‚¾ãƒ¼ãƒ³ã«å…¥ã£ãŸæ‰“çƒã®å‰²åˆ",
            desc: "æ‰“çƒé€Ÿåº¦ã¨è§’åº¦ã®çµ„ã¿åˆã‚ã›ãŒã€é•·æ‰“ã«ãªã‚‹ç¢ºç‡ãŒæœ€ã‚‚é«˜ã„ã‚¾ãƒ¼ãƒ³ï¼ˆãƒãƒ¬ãƒ«ï¼‰ã«å…¥ã£ãŸå‰²åˆã€‚",
            formula: "ãƒãƒ¬ãƒ«æ‰“çƒæ•° Ã· æ‰“çƒæ•° (BBE)",
            criteria: "6-9%: å¹³å‡ / 15%ä»¥ä¸Š: ã‚¨ãƒªãƒ¼ãƒˆ",
            related: ["xwoba"]
        },
        {
            id: "xwoba", category: "bat", title: "xwOBA", full: "Expected wOBA",
            short: "æ‰“çƒã®è³ªã‹ã‚‰æ¨å®šã•ã‚Œã‚‹wOBA",
            desc: "æ‰“çƒé€Ÿåº¦ã¨è§’åº¦ã‹ã‚‰ã€Œæœ¬æ¥ãªã‚‹ã¯ãšã ã£ãŸçµæœã€ã‚’ç®—å‡ºã—ã€ä¸‰æŒ¯ãƒ»å››çƒã¨åˆã‚ã›ã¦è¨ˆç®—ã—ãŸwOBAã€‚é‹ã®è¦ç´ ã‚’æ’é™¤ã—ãŸçœŸã®å®ŸåŠ›ã€‚",
            formula: "Statcastæ¨å®š",
            criteria: ".320: å¹³å‡",
            related: ["woba"]
        },
        {
            id: "xba", category: "bat", title: "xBA", full: "Expected Batting Average",
            short: "æœŸå¾…æ‰“ç‡",
            desc: "æ‰“çƒé€Ÿåº¦ãƒ»è§’åº¦ãƒ»ã‚¹ãƒ—ãƒªãƒ³ãƒˆã‚¹ãƒ”ãƒ¼ãƒ‰ãªã©ã‹ã‚‰æ¨å®šã•ã‚Œã‚‹ã€Œæœ¬æ¥ã‚ã‚‹ã¹ãæ‰“ç‡ã€ã€‚",
            formula: "Statcastæ¨å®š",
            related: ["avg", "babip"]
        },
        {
            id: "whiff_pct", category: "bat", title: "Whiff%", full: "Whiff Percentage",
            short: "ç©ºæŒ¯ã‚Šç‡ï¼ˆã‚¹ã‚¤ãƒ³ã‚°å¯¾æ¯”ï¼‰",
            desc: "æŒ¯ã£ãŸã‚¹ã‚¤ãƒ³ã‚°ã®ã†ã¡ã€ç©ºæŒ¯ã‚Šã«ãªã£ãŸå‰²åˆã€‚ã‚³ãƒ³ã‚¿ã‚¯ãƒˆèƒ½åŠ›ã®ä½ã•ã‚’ç¤ºã™ã€‚",
            formula: "ç©ºæŒ¯ã‚Šæ•° Ã· ã‚¹ã‚¤ãƒ³ã‚°ç·æ•°",
            criteria: "25%: å¹³å‡"
        },
        {
            id: "chase_pct", category: "bat", title: "O-Swing%", full: "Outside Zone Swing % (Chase Rate)",
            short: "ãƒœãƒ¼ãƒ«çƒã‚¹ã‚¤ãƒ³ã‚°ç‡",
            desc: "ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã‚¾ãƒ¼ãƒ³ã‹ã‚‰å¤–ã‚ŒãŸçƒã‚’æŒ¯ã£ã¦ã—ã¾ã£ãŸå‰²åˆã€‚é¸çƒçœ¼ã®æ‚ªã•ã‚„ç©æ¥µæ€§ã‚’ç¤ºã™ã€‚",
            formula: "ã‚¾ãƒ¼ãƒ³å¤–ã‚¹ã‚¤ãƒ³ã‚° Ã· ã‚¾ãƒ¼ãƒ³å¤–æŠ•çƒæ•°",
            criteria: "30%: å¹³å‡ / 20%: é¸çƒçœ¼è‰¯"
        },
        {
            id: "zone_pct", category: "bat", title: "Zone%", full: "Zone Percentage",
            short: "ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã‚¾ãƒ¼ãƒ³ã¸ã®æŠ•çƒå‰²åˆ",
            desc: "ç›¸æ‰‹æŠ•æ‰‹ãŒã©ã‚Œã ã‘ã‚¾ãƒ¼ãƒ³å†…ã§å‹è² ã—ã¦ãã¦ã„ã‚‹ã‹ã‚’ç¤ºã™ã€‚å¼·æ‰“è€…ã»ã©é¿ã‘ã‚‰ã‚Œã‚„ã™ãã€Zone%ã¯ä¸‹ãŒã‚‹å‚¾å‘ãŒã‚ã‚‹ã€‚",
            formula: "ã‚¾ãƒ¼ãƒ³å†…æŠ•çƒæ•° Ã· å…¨æŠ•çƒæ•°",
            criteria: "48-51%: å¹³å‡"
        },
        {
            id: "swstr_pct", category: "bat", title: "SwStr%", full: "Swinging Strike Percentage",
            short: "ç©ºæŒ¯ã‚Šç‡ï¼ˆå…¨æŠ•çƒå¯¾æ¯”ï¼‰",
            desc: "å…¨æŠ•çƒã®ã†ã¡ç©ºæŒ¯ã‚Šã‚’å¥ªã£ãŸå‰²åˆã€‚æŠ•æ‰‹è¦–ç‚¹ã§ã¯å¥ªä¸‰æŒ¯èƒ½åŠ›ã€æ‰“è€…è¦–ç‚¹ã§ã¯ã‚³ãƒ³ã‚¿ã‚¯ãƒˆé›£æ˜“åº¦ã€‚",
            formula: "ç©ºæŒ¯ã‚Šæ•° Ã· å…¨æŠ•çƒæ•°",
            criteria: "10-12%: å¹³å‡"
        },
        {
            id: "ubr", category: "fld", title: "UBR", full: "Ultimate Base Running",
            short: "ç›—å¡ä»¥å¤–ã®èµ°å¡è²¢çŒ®",
            desc: "ã‚¿ãƒƒãƒã‚¢ãƒƒãƒ—ã‚„ä¸€å¡ã‹ã‚‰ã®é•·æ‰“ã§ã®ç”Ÿé‚„ãªã©ã€ç›—å¡ä»¥å¤–ã®èµ°å¡ã«ã‚ˆã‚‹å¾—ç‚¹è²¢çŒ®ã‚’å¾—ç‚¹ä¾¡å€¤åŒ–ã—ãŸã‚‚ã®ã€‚",
            formula: "åŠ ç‚¹æ–¹å¼",
            criteria: "0: å¹³å‡"
        },
        {
            id: "wgdp", category: "bat", title: "wGDP", full: "Weighted GIDP Runs",
            short: "ä½µæ®ºæ‰“ã«ã‚ˆã‚‹å¾—ç‚¹æå¤±",
            desc: "å¹³å‡çš„ãªé¸æ‰‹ã¨æ¯”è¼ƒã—ã¦ã€ä½µæ®ºæ‰“ã«ã‚ˆã£ã¦ã©ã‚Œã ã‘å¾—ç‚¹æ©Ÿä¼šã‚’æ½°ã—ãŸã‹ï¼ˆã‚ã‚‹ã„ã¯å›é¿ã—ãŸã‹ï¼‰ã‚’ç¤ºã™ã€‚",
            formula: "ä½µæ®ºæ‰“æ•° Ã— æå¤±ä¾¡å€¤ä¿‚æ•°",
            criteria: "0: å¹³å‡"
        },
        {
            id: "bsr", category: "fld", title: "BsR", full: "Base Running Runs",
            short: "èµ°å¡ç·åˆè²¢çŒ® (wSB + UBR + wGDP)",
            desc: "ç›—å¡(wSB)ã€èµ°å¡(UBR)ã€ä½µæ®ºå›é¿(wGDP)ã‚’ã™ã¹ã¦åˆè¨ˆã—ãŸã€èµ°å¡ã«ã‚ˆã‚‹ç·åˆçš„ãªå¾—ç‚¹è²¢çŒ®ã€‚",
            formula: "wSB + UBR + wGDP",
            criteria: "0: å¹³å‡ / +6.0: ç¥è¶³"
        },
    
        /* ---------------- æŠ•æ‰‹ (Pitching) ---------------- */
        {
            id: "ra9", category: "pit", title: "RA9", full: "Runs Allowed per 9 Innings",
            short: "9ã‚¤ãƒ‹ãƒ³ã‚°ã‚ãŸã‚Šã®å¤±ç‚¹ç‡",
            desc: "é˜²å¾¡ç‡(ERA)ã¨ã¯ç•°ãªã‚Šã€è‡ªè²¬ç‚¹ã§ã¯ãªãã€Œç·å¤±ç‚¹ã€ã‚’ç”¨ã„ã¦è¨ˆç®—ã™ã‚‹ã€‚å®Ÿéš›ã«é˜²ã„ã å¤±ç‚¹é‡ã‚’ç¤ºã™ã€‚",
            formula: `${formatVar('å¤±ç‚¹')} Ã— 9 Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "4.00å‰å¾Œ: å¹³å‡",
            inputs: [{id:'r', label:'å¤±ç‚¹'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => (d.r * 9 / d.ip).toFixed(2)
        },
        {
            id: "h_9", category: "pit", title: "H/9", full: "Hits per 9",
            short: "9ã‚¤ãƒ‹ãƒ³ã‚°ã‚ãŸã‚Šã®è¢«å®‰æ‰“æ•°",
            desc: "æ‰“ãŸã‚Œã«ãã•ã‚’ç¤ºã™ãŒã€é‹ã‚„å®ˆå‚™åŠ›ã®å½±éŸ¿ã‚’å—ã‘ã‚„ã™ã„ã€‚",
            formula: `${formatVar('è¢«å®‰æ‰“')} Ã— 9 Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "8.5: å¹³å‡",
            inputs: [{id:'h', label:'è¢«å®‰æ‰“'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => (d.h * 9 / d.ip).toFixed(2)
        },
        {
            id: "hr_9", category: "pit", title: "HR/9", full: "Home Runs per 9",
            short: "9ã‚¤ãƒ‹ãƒ³ã‚°ã‚ãŸã‚Šã®è¢«æœ¬å¡æ‰“æ•°",
            desc: "ä¸€ç™ºç—…ã®å‚¾å‘ã‚’ç¤ºã™ã€‚è¢«æœ¬å¡æ‰“ã¯FIPè¨ˆç®—ã«ãŠã„ã¦æœ€ã‚‚é‡ã„ã‚¦ã‚§ã‚¤ãƒˆã‚’å ã‚ã‚‹ã€‚",
            formula: `${formatVar('è¢«æœ¬å¡æ‰“')} Ã— 9 Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "1.0: å¹³å‡ / 0.5: å„ªç§€",
            inputs: [{id:'hr', label:'è¢«æœ¬å¡æ‰“'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => (d.hr * 9 / d.ip).toFixed(2)
        },
        {
            id: "k_minus_bb", category: "pit", title: "K-BB%", full: "Strikeout minus Walk Percentage",
            short: "å¥ªä¸‰æŒ¯ç‡ã¨ä¸å››çƒç‡ã®å·®",
            desc: "K/BBã‚ˆã‚Šã‚‚æŠ•æ‰‹ã®èƒ½åŠ›ã‚’ç´ ç›´ã«åæ˜ ã™ã‚‹ã¨ã•ã‚Œã‚‹æŒ‡æ¨™ã€‚æŠ•æ‰‹ã®åŸºç¤èƒ½åŠ›ã‚’æ¸¬ã‚‹ã®ã«æœ€é©ã€‚",
            formula: `${formatVar('K%')} - ${formatVar('BB%')}`,
            criteria: "15%: å¹³å‡ / 20%: å„ªç§€ / 25%: ã‚¨ãƒ¼ã‚¹",
            inputs: [{id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'bf', label:'æ‰“è€…æ•°'}],
            calc: (d) => (((d.so - d.bb) / d.bf) * 100).toFixed(1) + '%'
        },
        {
            id: "lob_pct", category: "pit", title: "LOB%", full: "Left On Base Percentage",
            short: "æ®‹å¡ç‡ï¼ˆç²˜ã‚Šå¼·ã•ï¼‰",
            desc: "å‡ºå¡ã•ã›ãŸãƒ©ãƒ³ãƒŠãƒ¼ã‚’ã©ã‚Œã ã‘ãƒ›ãƒ¼ãƒ ã«é‚„ã•ãªã‹ã£ãŸã‹ã€‚72%å‰å¾ŒãŒå¹³å‡ã§ã€æ¥µç«¯ã«é«˜ã„ãƒ»ä½ã„å ´åˆã¯é‹ã®å½±éŸ¿ãŒç–‘ã‚ã‚Œã‚‹ã€‚",
            formula: `(${formatVar('å®‰æ‰“')}+${formatVar('å››æ­»çƒ')}-${formatVar('å¤±ç‚¹')}) Ã· (${formatVar('å®‰æ‰“')}+${formatVar('å››æ­»çƒ')}-1.4Ã—${formatVar('HR')})`,
            criteria: "70-72%: å¹³å‡",
            inputs: [{id:'h', label:'è¢«å®‰æ‰“'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'hbp', label:'ä¸æ­»çƒ'}, {id:'r', label:'å¤±ç‚¹'}, {id:'hr', label:'è¢«æœ¬å¡æ‰“'}],
            calc: (d) => {
                const num = d.h + d.bb + d.hbp - d.r;
                const denom = d.h + d.bb + d.hbp - (1.4 * d.hr);
                return denom > 0 ? ((num / denom) * 100).toFixed(1) + '%' : "---";
            }
        },
        {
            id: "gb_fb_ratio", category: "pit", title: "GB/FB", full: "Ground Ball to Fly Ball Ratio",
            short: "ã‚´ãƒ­ã¨ãƒ•ãƒ©ã‚¤ã®æ¯”ç‡",
            desc: "1.0ã‚’è¶…ãˆã‚‹ã¨ã‚´ãƒ­æŠ•æ‰‹ã€ä¸‹å›ã‚‹ã¨ãƒ•ãƒ©ã‚¤æŠ•æ‰‹å‚¾å‘ã€‚ã‚´ãƒ­æŠ•æ‰‹ã¯é•·æ‰“ã‚’æµ´ã³ã«ãã„ãŒã€å®ˆå‚™ã®å½±éŸ¿ã‚’å—ã‘ã‚„ã™ã„ã€‚",
            formula: `${formatVar('ã‚´ãƒ­')} Ã· ${formatVar('ãƒ•ãƒ©ã‚¤')}`,
            criteria: "1.0: å¹³å‡ / 1.5ä»¥ä¸Š: ã‚´ãƒ­P",
            // æ‰“çƒå‚¾å‘å…¥åŠ›ã‹ã‚‰è¨ˆç®—
            aiMode: true,
            inputs: [{id:'gb_type', label:'æ‰“çƒå‚¾å‘(GB%)', type:'select', options:{'55':'55% (è¶…ã‚´ãƒ­P)', '50':'50% (ã‚´ãƒ­P)', '45':'45% (å¹³å‡)', '40':'40% (ãƒ•ãƒ©ã‚¤P)', '35':'35% (è¶…ãƒ•ãƒ©ã‚¤P)'}}],
            calc: (d) => {
                const gb = parseFloat(d.gb_type);
                const fb = 100 - gb - 21; // LD 21% fixed
                return (gb / fb).toFixed(2);
            }
        },
        {
            id: "gmsc", category: "pit", title: "GmSc", full: "Game Score",
            short: "å…ˆç™ºæŠ•æ‰‹ã®1è©¦åˆã”ã¨ã®æŠ•çƒè©•ä¾¡",
            desc: "50ã‚’åŸºæº–ã¨ã—ã€ã‚¤ãƒ‹ãƒ³ã‚°æ•°ã€å¥ªä¸‰æŒ¯ã€è¢«å®‰æ‰“ã€å¤±ç‚¹ãªã©ã‹ã‚‰ç®—å‡ºã•ã‚Œã‚‹ã‚¹ã‚³ã‚¢ã€‚100ã«è¿‘ã¥ãã»ã©ä¼èª¬çš„ãªæŠ•çƒã€‚",
            formula: `50 + ã‚¢ã‚¦ãƒˆ1ã¤ã«ã¤ã1ç‚¹ + 5å›ä»¥é™1å›ã«ã¤ã2ç‚¹ + ä¸‰æŒ¯1ç‚¹ - è¢«å®‰æ‰“2ç‚¹ - è‡ªè²¬ç‚¹4ç‚¹...`,
            criteria: "50: å¹³å‡ / 60: QSãƒ¬ãƒ™ãƒ« / 90: æœ€é«˜",
            inputs: [{id:'ip', label:'æŠ•çƒå›'}, {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'h', label:'è¢«å®‰æ‰“'}, {id:'r', label:'å¤±ç‚¹'}, {id:'er', label:'è‡ªè²¬ç‚¹'}, {id:'bb', label:'ä¸å››çƒ'}],
            calc: (d) => {
                const outs = Math.floor(d.ip) * 3 + (d.ip % 1 * 10);
                const inn_bonus = d.ip > 4 ? (d.ip - 4) * 2 : 0; // ç°¡æ˜“è¨ˆç®—
                return (50 + outs + inn_bonus + d.so - (2 * d.h) - (4 * d.er) - (2 * (d.r - d.er)) - d.bb).toFixed(0);
            }
        },
        {
            id: "qs", category: "pit", title: "QS", full: "Quality Start",
            short: "å…ˆç™ºæŠ•æ‰‹ã®æœ€ä½é™ã®è²¬ä»»å›æ•°",
            desc: "å…ˆç™ºã—ã¦6ã‚¤ãƒ‹ãƒ³ã‚°ä»¥ä¸Šã‚’æŠ•ã’ã€è‡ªè²¬ç‚¹3ä»¥å†…ã«æŠ‘ãˆãŸè©¦åˆæ•°ã€‚",
            criteria: "é”æˆç‡50%ä»¥ä¸Šã§ãƒ­ãƒ¼ãƒ†å®šç€"
        },
        {
            id: "hqs", category: "pit", title: "HQS", full: "High Quality Start",
            short: "QSã‚ˆã‚Šå³ã—ã„åŸºæº–",
            desc: "7ã‚¤ãƒ‹ãƒ³ã‚°ä»¥ä¸Šã‚’æŠ•ã’ã€è‡ªè²¬ç‚¹2ä»¥å†…ã«æŠ‘ãˆãŸè©¦åˆæ•°ã€‚ã‚¨ãƒ¼ã‚¹ç´šã®æŒ‡æ¨™ã€‚",
            criteria: "ã‚¨ãƒ¼ã‚¹ã®è¨¼"
        },
        {
            id: "csw_pct", category: "pit", title: "CSW%", full: "Called Strikes + Whiffs Percentage",
            short: "è¦‹é€ƒã—ï¼‹ç©ºæŒ¯ã‚Šç‡",
            desc: "å…¨æŠ•çƒã®ã†ã¡ã€è¦‹é€ƒã—ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã¨ç©ºæŒ¯ã‚Šã‚’å¥ªã£ãŸå‰²åˆã€‚K%ã‚„SIERAã¨ã®ç›¸é–¢ãŒå¼·ãã€æŠ•æ‰‹ã®ã€Œæ”¯é…åŠ›ã€ã‚’ç¤ºã™ã€‚",
            formula: "(è¦‹é€ƒã—S + ç©ºæŒ¯ã‚Š) Ã· å…¨æŠ•çƒ",
            criteria: "30%: å„ªç§€"
        },
        {
            id: "stuff_plus", category: "pit", title: "Stuff+", full: "Stuff Plus",
            short: "ã€Œçƒå¨ã€ã®å‚‘å‡ºåº¦",
            desc: "çƒé€Ÿã€å›è»¢æ•°ã€å¤‰åŒ–é‡ãªã©ç‰©ç†çš„ç‰¹æ€§ã®ã¿ã‹ã‚‰ã€Œã©ã‚Œã ã‘æ‰“ãŸã‚Œã«ãã„çƒã‹ã€ã‚’è©•ä¾¡ã—ãŸæŒ‡æ¨™ã€‚100ãŒå¹³å‡ã€‚",
            formula: "ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿è§£æ",
            criteria: "100: å¹³å‡ / 120: ã‚¨ãƒ¼ã‚¹ç´š"
        },
        {
            id: "location_plus", category: "pit", title: "Location+", full: "Location Plus",
            short: "ã€Œã‚³ãƒãƒ³ãƒ‰ï¼ˆåˆ¶çƒï¼‰ã€ã®å‚‘å‡ºåº¦",
            desc: "ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã‚¾ãƒ¼ãƒ³ã®é©åˆ‡ãªä½ç½®ã«æŠ•ã’ã‚‰ã‚Œã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡ã—ãŸæŒ‡æ¨™ã€‚100ãŒå¹³å‡ã€‚",
            criteria: "100: å¹³å‡"
        },
        {
            id: "pitching_plus", category: "pit", title: "Pitching+", full: "Pitching Plus",
            short: "Stuff+ã¨Location+ã®ç·åˆè©•ä¾¡",
            desc: "çƒå¨ã¨åˆ¶çƒã‚’ç·åˆã—ãŸæŠ•æ‰‹ã®èƒ½åŠ›å€¤ã€‚å°†æ¥ã®æˆç¸¾äºˆæ¸¬ã«å½¹ç«‹ã¤ã€‚",
            criteria: "100: å¹³å‡"
        },
        {
            id: "sv_pct", category: "pit", title: "SV%", full: "Save Percentage",
            short: "ã‚»ãƒ¼ãƒ–æˆåŠŸç‡",
            desc: "ã‚»ãƒ¼ãƒ–æ©Ÿä¼šã«å¯¾ã—ã¦ã‚»ãƒ¼ãƒ–ã«æˆåŠŸã—ãŸå‰²åˆã€‚",
            formula: `${formatVar('ã‚»ãƒ¼ãƒ–')} Ã· (${formatVar('ã‚»ãƒ¼ãƒ–')} + ${formatVar('æ•‘æ´å¤±æ•—')})`,
            criteria: "90%ä»¥ä¸Š: çµ¶å¯¾çš„å®ˆè­·ç¥",
            inputs: [{id:'sv', label:'ã‚»ãƒ¼ãƒ–'}, {id:'bs', label:'æ•‘æ´å¤±æ•—(BS)'}],
            calc: (d) => (d.sv + d.bs) > 0 ? ((d.sv / (d.sv + d.bs)) * 100).toFixed(1) + '%' : "---"
        },
        {
            id: "hld", category: "pit", title: "HLD", full: "Hold",
            short: "ãƒ›ãƒ¼ãƒ«ãƒ‰",
            desc: "ã‚»ãƒ¼ãƒ–ã®æ¡ä»¶ã‚’æº€ãŸã™å±€é¢ã§ç™»æ¿ã—ã€ãƒªãƒ¼ãƒ‰ã‚’ä¿ã£ã¦é™æ¿ã—ãŸæ•‘æ´æŠ•æ‰‹ã«è¨˜éŒ²ã•ã‚Œã‚‹ã€‚",
            criteria: "ç©ã¿ä¸Šã’æŒ‡æ¨™"
        },
        {
            id: "bs", category: "pit", title: "BS", full: "Blown Save",
            short: "ã‚»ãƒ¼ãƒ–å¤±æ•—",
            desc: "ã‚»ãƒ¼ãƒ–æ©Ÿä¼šã§ç™»æ¿ã—ãªãŒã‚‰åŒç‚¹ã¾ãŸã¯é€†è»¢ã‚’è¨±ã—ãŸå›æ•°ã€‚å‹åˆ©æŠ•æ‰‹ã«ãªã£ã¦ã‚‚BSã¯è¨˜éŒ²ã•ã‚Œã‚‹ã€‚",
            criteria: "å°‘ãªã„ã»ã©è‰¯ã„"
        },
        {
            id: "irs_pct", category: "pit", title: "IRS%", full: "Inherited Runners Scored Percentage",
            short: "å‰ã®æŠ•æ‰‹ãŒæ®‹ã—ãŸèµ°è€…ã‚’é‚„ã—ãŸç‡",
            desc: "ãƒªãƒªãƒ¼ãƒ•æŠ•æ‰‹ã®ã€Œç«æ¶ˆã—ã€èƒ½åŠ›ã‚’ç¤ºã™ã€‚ä½ã„ã»ã©å„ªç§€ã€‚",
            formula: `${formatVar('é‚„ã—ãŸèµ°è€…')} Ã· ${formatVar('å¼•ãç¶™ã„ã èµ°è€…')}`,
            criteria: "30%: å¹³å‡ / 20%ä»¥ä¸‹: å„ªç§€",
            inputs: [{id:'is', label:'é‚„ã—ãŸèµ°è€…'}, {id:'ir', label:'å¼•ãç¶™ã„ã èµ°è€…'}],
            calc: (d) => d.ir > 0 ? ((d.is / d.ir) * 100).toFixed(1) + '%' : "---"
        },
        {
            id: "rs_9", category: "pit", title: "RS/9", full: "Run Support per 9",
            short: "9ã‚¤ãƒ‹ãƒ³ã‚°ã‚ãŸã‚Šã®æ´è­·ç‚¹",
            desc: "å‘³æ–¹æ‰“ç·šãŒã©ã‚Œã ã‘ç‚¹ã‚’å–ã£ã¦ãã‚ŒãŸã‹ã€‚å‹æ•—æ•°ã«å¤§ããå½±éŸ¿ã™ã‚‹ãŒã€æŠ•æ‰‹è‡ªèº«ã®èƒ½åŠ›ã§ã¯ãªã„ã€‚",
            formula: `${formatVar('æ´è­·ç‚¹')} Ã— 9 Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "4.0: å¹³å‡",
            inputs: [{id:'rs_runs', label:'æ´è­·ç‚¹ç·æ•°'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => (d.rs_runs * 9 / d.ip).toFixed(2)
        },
        {
            id: "kw_era", category: "pit", title: "kwERA", full: "Kitchen Sink ERA",
            short: "ä¸‰æŒ¯ã¨å››çƒã®ã¿ã§è¨ˆç®—ã™ã‚‹ç°¡æ˜“é˜²å¾¡ç‡äºˆæ¸¬",
            desc: "è¢«æœ¬å¡æ‰“ã™ã‚‰é™¤å¤–ã—ã€ä¸‰æŒ¯ã¨å››çƒã®ã¿ã§èƒ½åŠ›ã‚’æ¸¬ã‚‹ã€‚FIPã‚ˆã‚Šã‚‚ã•ã‚‰ã«ç´”ç²‹ãªèƒ½åŠ›æŒ‡æ¨™ã€‚",
            formula: `5.40 - 12 Ã— (${formatVar('K%')} - ${formatVar('BB%')})`,
            criteria: "ä½ã„ã»ã©å„ªç§€",
            inputs: [{id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'bf', label:'æ‰“è€…æ•°'}],
            calc: (d) => d.bf > 0 ? (5.40 - 12 * ((d.so - d.bb) / d.bf)).toFixed(2) : "---"
        },
    
        /* ---------------- å®ˆå‚™ãƒ»ç·åˆ (Fielding / Overall) ---------------- */
        {
            id: "rngr", category: "fld", title: "RngR", full: "Range Runs",
            short: "å®ˆå‚™ç¯„å›²ã«ã‚ˆã‚‹å¤±ç‚¹æŠ‘æ­¢",
            desc: "å¹³å‡çš„ãªé‡æ‰‹ã‚ˆã‚Šã©ã‚Œã ã‘å¤šãã®æ‰“çƒã‚’ã‚¢ã‚¦ãƒˆã«ã—ãŸã‹ï¼ˆã¾ãŸã¯ãƒ’ãƒƒãƒˆã«ã—ã¦ã—ã¾ã£ãŸã‹ï¼‰ã‚’ç‚¹æ•°åŒ–ã—ãŸã‚‚ã®ã€‚UZRã®ä¸»è¦æ§‹æˆè¦ç´ ã€‚",
            criteria: "0: å¹³å‡"
        },
        {
            id: "errr", category: "fld", title: "ErrR", full: "Error Runs",
            short: "å¤±ç­–ã«ã‚ˆã‚‹å¤±ç‚¹é–¢ä¸",
            desc: "å¹³å‡çš„ãªé‡æ‰‹ã¨æ¯”è¼ƒã—ã¦ã€å¤±ç­–ã«ã‚ˆã£ã¦ã©ã‚Œã ã‘å¤±ç‚¹ã‚’å¢—ã‚„ã—ãŸã‹ï¼ˆæ¸›ã‚‰ã—ãŸã‹ï¼‰ã€‚",
            criteria: "0: å¹³å‡"
        },
        {
            id: "arm", category: "fld", title: "ARM", full: "Arm Runs",
            short: "é€çƒã«ã‚ˆã‚‹å¤±ç‚¹æŠ‘æ­¢",
            desc: "å¤–é‡æ‰‹ã®è£œæ®ºï¼ˆé€²å¡é˜»æ­¢ï¼‰ã«ã‚ˆã‚‹è²¢çŒ®ã‚’ç‚¹æ•°åŒ–ã—ãŸã‚‚ã®ã€‚è‚©ã®å¼·ã•ã¨æ­£ç¢ºã•ã‚’ç¤ºã™ã€‚",
            criteria: "0: å¹³å‡"
        },
        {
            id: "dpr", category: "fld", title: "DPR", full: "Double Play Runs",
            short: "ä½µæ®ºå®Œæˆã«ã‚ˆã‚‹å¤±ç‚¹æŠ‘æ­¢",
            desc: "å†…é‡æ‰‹ãŒä½µæ®ºã‚’å–ã‚‹ã“ã¨ã§é˜²ã„ã å¤±ç‚¹é‡ã€‚",
            criteria: "0: å¹³å‡"
        },
        {
            id: "tz", category: "fld", title: "TZ", full: "Total Zone",
            short: "ãƒˆãƒ¼ã‚¿ãƒ«ã‚¾ãƒ¼ãƒ³",
            desc: "UZRãŒç™»å ´ã™ã‚‹å‰ã«ä¸»æµã ã£ãŸå®ˆå‚™æŒ‡æ¨™ã€‚ãƒ—ãƒ¬ã‚¤ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªãã€ã‚¾ãƒ¼ãƒ³ã”ã¨ã®é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ã€‚",
            related: ["uzr", "drs"]
        },
        {
            id: "fraa", category: "fld", title: "FRAA", full: "Fielding Runs Above Average",
            short: "Baseball Prospectusç‰ˆã®å®ˆå‚™æŒ‡æ¨™",
            desc: "UZRã‚„DRSã¨ã¯ç•°ãªã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ç®—å‡ºã•ã‚Œã‚‹å®ˆå‚™è²¢çŒ®åº¦ã€‚ãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ãªã©ã‚‚è€ƒæ…®ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ã€‚",
            criteria: "0: å¹³å‡"
        },
        {
            id: "wpa_li", category: "tot", title: "WPA/LI", full: "Context Neutral Wins",
            short: "å ´é¢é‡è¦åº¦ã‚’ä¸­ç«‹åŒ–ã—ãŸWPA",
            desc: "WPAï¼ˆå‹åˆ©ç¢ºç‡å¯„ä¸ï¼‰ã‹ã‚‰ã€Œå ´é¢ã®é‡è¦åº¦ã€ã®å½±éŸ¿ã‚’å–ã‚Šé™¤ã„ãŸã‚‚ã®ã€‚ãƒãƒ£ãƒ³ã‚¹ã§æ‰“ã£ãŸã‹ã©ã†ã‹ã«é–¢ã‚ã‚‰ãšã€ãƒ—ãƒ¬ã‚¤ãã®ã‚‚ã®ã®ä¾¡å€¤ã‚’è©•ä¾¡ã™ã‚‹ã€‚",
            related: ["wpa", "li"]
        },
        {
            id: "li", category: "tot", title: "LI", full: "Leverage Index",
            short: "å ´é¢ã®é‡è¦åº¦ï¼ˆãƒ¬ãƒãƒ¬ãƒƒã‚¸ï¼‰",
            desc: "ãã®ãƒ—ãƒ¬ã‚¤ãŒè©¦åˆã®å‹æ•—ã«ã©ã‚Œã ã‘å½±éŸ¿ã™ã‚‹ã‹ã‚’ç¤ºã™æŒ‡æ•°ã€‚1.0ãŒå¹³å‡ã€‚ã‚µãƒ¨ãƒŠãƒ©ã®å ´é¢ãªã©ã§ã¯éå¸¸ã«é«˜ããªã‚‹ã€‚",
            criteria: "1.0: å¹³å‡ / 2.0ä»¥ä¸Š: å‹è² æ‰€"
        },
        {
            id: "clutch", category: "tot", title: "Clutch", full: "Clutch",
            short: "å‹è² å¼·ã•",
            desc: "ã€Œå®Ÿéš›ã®WPAã€ã¨ã€Œå ´é¢é‡è¦åº¦ã‚’è€ƒæ…®ã—ãªã„å ´åˆã®WPAã€ã®å·®ã€‚ãƒ—ãƒ©ã‚¹ãªã‚‰å‹è² å¼·ã„ã€ãƒã‚¤ãƒŠã‚¹ãªã‚‰å‹è² å¼±ã„ã¨ã•ã‚Œã‚‹ãŒã€å¹´æ¬¡å¤‰å‹•ãŒå¤§ããå®ŸåŠ›ã¨ã¯ã¿ãªã•ã‚Œã«ãã„ã€‚",
            formula: "WPA - (WPA/LI)",
            criteria: "0: å¹³å‡"
        },
        {
            id: "cwpa", category: "tot", title: "cWPA", full: "Championship WPA",
            short: "å„ªå‹ç¢ºç‡ã¸ã®è²¢çŒ®åº¦",
            desc: "WPAãŒã€Œãã®è©¦åˆã®å‹åˆ©ã€ã¸ã®è²¢çŒ®ãªã‚‰ã€cWPAã¯ã€Œãƒãƒ¼ãƒ ã®å„ªå‹ï¼ˆãƒã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³é€²å‡ºï¼‰ã€ã¸ã®è²¢çŒ®åº¦ã‚’ç¤ºã™ã€‚å„ªå‹äº‰ã„ã‚’ã—ã¦ã„ã‚‹æ™‚æœŸã®æ´»èºã»ã©é«˜ããªã‚‹ã€‚",
            criteria: "%è¡¨è¨˜"
        },
        {
            id: "re", category: "tot", title: "RE", full: "Run Expectancy",
            short: "å¾—ç‚¹æœŸå¾…å€¤",
            desc: "ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆã¨èµ°è€…çŠ¶æ³ï¼ˆ24ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ã”ã¨ã«ã€ãã®ã‚¤ãƒ‹ãƒ³ã‚°ãŒçµ‚äº†ã™ã‚‹ã¾ã§ã«å¹³å‡ã‚ã¨ä½•ç‚¹å…¥ã‚‹ã‹ã‚’ç¤ºã—ãŸæ•°å€¤ã€‚",
            criteria: "ç„¡æ­»æº€å¡ã§ç´„2.3ç‚¹ãªã©",
            related: ["re24"]
        },
        {
            id: "linear_weights", category: "tot", title: "LWts", full: "Linear Weights",
            short: "ç·šå½¢åŠ é‡",
            desc: "wOBAãªã©ã®åŸºç¤ã¨ãªã‚‹è€ƒãˆæ–¹ã€‚å„ãƒ—ãƒ¬ã‚¤ï¼ˆå˜æ‰“ã€å››çƒãªã©ï¼‰ãŒå¾—ç‚¹æœŸå¾…å€¤ã‚’å¹³å‡ã§ä½•ç‚¹å¢—ã‚„ã—ãŸã‹ã‚’ç®—å‡ºã—ã€ä¿‚æ•°ã¨ã—ã¦ç”¨ã„ã‚‹æ‰‹æ³•ã€‚",
            related: ["woba", "xr"]
        },
        {
            id: "xera", category: "pit", title: "xERA", full: "Expected ERA",
            short: "äºˆæƒ³é˜²å¾¡ç‡ï¼ˆStatcastï¼‰",
            desc: "æ‰“ãŸã‚ŒãŸæ‰“çƒã®è³ªï¼ˆxwOBAï¼‰ã«åŸºã¥ã„ã¦ç®—å‡ºã•ã‚Œã‚‹é˜²å¾¡ç‡ã€‚xFIPã‚ˆã‚Šã‚‚ã•ã‚‰ã«æ‰“çƒã®ç‰©ç†çš„æ€§è³ªã‚’è€ƒæ…®ã—ã¦ã„ã‚‹ã€‚",
            related: ["era", "xwoba"]
        },
        {
            id: "dra", category: "pit", title: "DRA", full: "Deserved Run Average",
            short: "æœ€ã‚‚æ´—ç·´ã•ã‚ŒãŸé˜²å¾¡ç‡æŒ‡æ¨™",
            desc: "Baseball ProspectusãŒç®—å‡ºã€‚çƒå ´ã€å®ˆå‚™ã€æ•æ‰‹ã®ãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ã€å¯¾æˆ¦æ‰“è€…ã®è³ªã€æ°—æ¸©ãªã©ã‚ã‚‰ã‚†ã‚‹è¦ç´ ã‚’èª¿æ•´ã—ãŸã€ŒæŠ•æ‰‹ã®çœŸã®è²¬ä»»å¤±ç‚¹ç‡ã€ã€‚",
            criteria: "å¤±ç‚¹ç‡ã‚¹ã‚±ãƒ¼ãƒ«"
        },
        {
            id: "wrc", category: "bat", title: "wRC", full: "weighted Runs Created",
            short: "æ‰“è€…ãŒå‰µå‡ºã—ãŸç·å¾—ç‚¹æ•°ï¼ˆwRAAãƒ™ãƒ¼ã‚¹ï¼‰",
            desc: "wRC+ã®å…ƒã¨ãªã‚‹ç©ã¿ä¸Šã’æŒ‡æ¨™ã€‚å¹³å‡çš„ãªæ‰“è€…ã¨æ¯”è¼ƒã—ãŸwRAAã«ã€ãƒªãƒ¼ã‚°å¹³å‡ãƒ¬ãƒ™ãƒ«ã®å¾—ç‚¹å‰µå‡ºæ•°ã‚’åŠ ãˆã¦ç®—å‡ºã™ã‚‹ã€‚RCã‚ˆã‚Šã‚‚å³å¯†ãªå¾—ç‚¹ä¾¡å€¤ã«åŸºã¥ãã€‚",
            formula: `wRAA + (ãƒªãƒ¼ã‚°å¹³å‡å¾—ç‚¹ç‡ Ã— æ‰“å¸­æ•°)`,
            criteria: "ç©ã¿ä¸Šã’æŒ‡æ¨™",
            related: ["wrc_plus", "wraa"],
            inputs: [
                // wRAAè¨ˆç®—ç”¨
                {id:'pa', label:'æ‰“å¸­æ•°'}, {id:'ab', label:'æ‰“æ•°'},
                {id:'h', label:'å®‰æ‰“'}, {id:'d', label:'äºŒå¡æ‰“'}, {id:'t', label:'ä¸‰å¡æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'}, 
                {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ'}, {id:'sf', label:'çŠ é£›'},
                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                ...ADVANCED_LEAGUE_INPUTS
            ],
            calc: (d) => {
                const C = calcDerived(d);
                const est = estimateDetails(d);
                const fr = C.fitting_ratio;
                const pf = PARK_FACTORS[d.stadium].pf;
    
                // wOBA
                const woba_denom = d.ab + d.bb - est.ibb + d.hbp + d.sf;
                const woba_num = (0.692*fr)*(d.bb-est.ibb) + (0.73*fr)*d.hbp + (0.966*fr)*est.roe + (0.865*fr)*est.s + (1.334*fr)*d.d + (1.725*fr)*d.t + (2.065*fr)*d.hr;
                const woba_val = woba_denom > 0 ? woba_num / woba_denom : 0;
    
                // wRAA
                const raw_wraa = ((woba_val - C.lg_woba) / C.woba_scale) * d.pa;
                const home_ratio = 0.5;
                const pf_coef = (home_ratio * pf) + ((1 - home_ratio) * (6 - pf) / 5);
                const parkAdj = (1 - pf_coef) * C.lg_r_pa * d.pa;
                const wraa = raw_wraa + parkAdj;
    
                // wRC = wRAA + (lg_R/PA * PA)
                return (wraa + (C.lg_r_pa * d.pa)).toFixed(1);
            }
        },
        {
            id: "xslg", category: "bat", title: "xSLG", full: "Expected Slugging Percentage",
            short: "æœŸå¾…é•·æ‰“ç‡",
            desc: "æ‰“çƒé€Ÿåº¦ã¨è§’åº¦ã‹ã‚‰ã€æ‰“çƒãŒæœ¬æ¥ã©ã®ç¨‹åº¦ã®é•·æ‰“ã«ãªã‚‹ç¢ºç‡ãŒã‚ã£ãŸã‹ã‚’æ¨å®šã—ãŸæŒ‡æ¨™ã€‚å®Ÿéš›ã®SLGã¨ã®ä¹–é›¢ã§é‹ä¸é‹ã‚’æ¸¬ã‚‹ã€‚",
            formula: "Statcastæ¨å®š",
            criteria: ".400: å¹³å‡",
            related: ["slg", "xwoba"]
        },
        {
            id: "xwobacon", category: "bat", title: "xwOBAcon", full: "xwOBA on Contact",
            short: "æ‰“çƒã®ã¿ã®xwOBAï¼ˆä¸‰æŒ¯ãƒ»å››çƒé™¤ãï¼‰",
            desc: "ãƒãƒƒãƒˆã«å½“ãŸã£ãŸæ‰“çƒãŒã©ã‚Œã ã‘å¾—ç‚¹ä¾¡å€¤ã‚’æŒã£ã¦ã„ãŸã‹ã‚’ç¤ºã™ã€‚ã‚³ãƒ³ã‚¿ã‚¯ãƒˆèƒ½åŠ›ã¯ç„¡è¦–ã—ã€ç´”ç²‹ãªã€Œç ´å£ŠåŠ›ã€ã‚’è©•ä¾¡ã™ã‚‹ã€‚",
            formula: "Statcastæ¨å®š",
            criteria: ".370å‰å¾Œ: å¹³å‡"
        },
        {
            id: "barrels_pa", category: "bat", title: "Brls/PA%", full: "Barrels per Plate Appearance",
            short: "æ‰“å¸­ã‚ãŸã‚Šã®ãƒãƒ¬ãƒ«ç‡",
            desc: "å…¨æ‰“å¸­ã®ã†ã¡ã€ãƒãƒ¬ãƒ«æ‰“çƒï¼ˆé•·æ‰“ç¢ºç‡ãŒéå¸¸ã«é«˜ã„æ‰“çƒï¼‰ã‚’æ”¾ã£ãŸå‰²åˆã€‚é•·æ‰“åŠ›ã‚’ç¤ºã™ä¿¡é ¼æ€§ã®é«˜ã„æŒ‡æ¨™ã€‚",
            formula: "ãƒãƒ¬ãƒ«æ•° Ã· æ‰“å¸­æ•°",
            criteria: "4-5%: å¹³å‡ / 10%: è¶…ä¸€æµ"
        },
        {
            id: "la_avg", category: "bat", title: "LA", full: "Average Launch Angle",
            short: "å¹³å‡æ‰“çƒè§’åº¦",
            desc: "æ‰“çƒã®å¹³å‡è§’åº¦ã€‚10åº¦ã€œ20åº¦ãŒãƒ©ã‚¤ãƒ³ãƒ‰ãƒ©ã‚¤ãƒ–ï¼ˆå®‰æ‰“ã«ãªã‚Šã‚„ã™ã„ï¼‰ã€25åº¦ã€œ30åº¦ãŒãƒ•ãƒ©ã‚¤ï¼ˆæœ¬å¡æ‰“ã«ãªã‚Šã‚„ã™ã„ï¼‰ã¨ã•ã‚Œã‚‹ã€‚",
            formula: "å¹³å‡å€¤(åº¦)",
            criteria: "12åº¦: å¹³å‡"
        },
        {
            id: "ev_avg", category: "bat", title: "EV", full: "Average Exit Velocity",
            short: "å¹³å‡æ‰“çƒé€Ÿåº¦",
            desc: "æ‰“çƒã®å¹³å‡é€Ÿåº¦ã€‚é€Ÿã„ã»ã©å®‰æ‰“ã‚„é•·æ‰“ã«ãªã‚‹ç¢ºç‡ãŒé«˜ã„ã€‚è¿‘å¹´æœ€ã‚‚é‡è¦–ã•ã‚Œã‚‹åŸºç¤èƒ½åŠ›ã®ä¸€ã¤ã€‚",
            formula: "å¹³å‡å€¤(km/h or mph)",
            criteria: "88mph (141km/h): å¹³å‡"
        },
        {
            id: "max_ev", category: "bat", title: "MaxEV", full: "Maximum Exit Velocity",
            short: "æœ€é«˜æ‰“çƒé€Ÿåº¦",
            desc: "ãã®é¸æ‰‹ãŒè¨˜éŒ²ã—ãŸæœ€ã‚‚é€Ÿã„æ‰“çƒé€Ÿåº¦ã€‚æ‰“è€…ã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ï¼ˆé™ç•Œèƒ½åŠ›ï¼‰ã‚’ç¤ºã™ã€‚",
            criteria: "110mph (177km/h)ä»¥ä¸Š: ãƒ‘ãƒ¯ãƒ¼ãƒ’ãƒƒã‚¿ãƒ¼"
        },
        {
            id: "sweet_spot", category: "bat", title: "SweetSpot%", full: "Sweet Spot Percentage",
            short: "æœ€é©è§’åº¦ï¼ˆ8ã€œ32åº¦ï¼‰ã®æ‰“çƒå‰²åˆ",
            desc: "ãƒ’ãƒƒãƒˆã‚„é•·æ‰“ã«ãªã‚Šã‚„ã™ã„è§’åº¦ï¼ˆã‚¹ã‚¤ãƒ¼ãƒˆã‚¹ãƒãƒƒãƒˆï¼‰ã§æ‰“çƒã‚’æ”¾ã£ãŸå‰²åˆã€‚",
            formula: "æœ€é©è§’åº¦æ‰“çƒ Ã· å…¨æ‰“çƒ",
            criteria: "33%: å¹³å‡"
        },
        {
            id: "pull_pct", category: "bat", title: "Pull%", full: "Pull Percentage",
            short: "å¼•ã£å¼µã‚Šæ–¹å‘ã¸ã®æ‰“çƒå‰²åˆ",
            desc: "æ‰“çƒãŒå¼•ã£å¼µã‚Šæ–¹å‘ï¼ˆå³æ‰“è€…ãªã‚‰ãƒ¬ãƒ•ãƒˆå´ï¼‰ã«é£›ã‚“ã å‰²åˆã€‚é«˜ã„ã¨é•·æ‰“åŠ›ãŒã‚ã‚‹å‚¾å‘ã ãŒã€ã‚·ãƒ•ãƒˆã‚’æ•·ã‹ã‚Œã‚„ã™ã„ã€‚",
            formula: "å¼•å¼µæ‰“çƒ Ã· å…¨æ‰“çƒ",
            criteria: "40%: å¹³å‡",
            inputs: [{id:'pull', label:'å¼•å¼µæ‰“çƒæ•°'}, {id:'bbe', label:'å…¨æ‰“çƒæ•°'}],
            calc: (d) => d.bbe > 0 ? ((d.pull/d.bbe)*100).toFixed(1)+'%' : '---'
        },
        {
            id: "oppo_pct", category: "bat", title: "Oppo%", full: "Opposite Field Percentage",
            short: "é€†æ–¹å‘ã¸ã®æ‰“çƒå‰²åˆ",
            desc: "æ‰“çƒãŒæµã—æ–¹å‘ï¼ˆå³æ‰“è€…ãªã‚‰ãƒ©ã‚¤ãƒˆå´ï¼‰ã«é£›ã‚“ã å‰²åˆã€‚åºƒè§’ã«æ‰“ã¦ã‚‹æŠ€è¡“ã‚’ç¤ºã™ã€‚",
            formula: "é€†æ–¹å‘æ‰“çƒ Ã· å…¨æ‰“çƒ",
            criteria: "25%: å¹³å‡",
            inputs: [{id:'oppo', label:'é€†æ–¹å‘æ‰“çƒæ•°'}, {id:'bbe', label:'å…¨æ‰“çƒæ•°'}],
            calc: (d) => d.bbe > 0 ? ((d.oppo/d.bbe)*100).toFixed(1)+'%' : '---'
        },
        {
            id: "gb_pct_bat", category: "bat", title: "GB% (Bat)", full: "Ground Ball Percentage (Batter)",
            short: "æ‰“è€…ã®ã‚´ãƒ­ç‡",
            desc: "æ‰“çƒã«å ã‚ã‚‹ã‚´ãƒ­ã®å‰²åˆã€‚è¶³ã®é€Ÿã„é¸æ‰‹ä»¥å¤–ã¯ä½ã„æ–¹ãŒå¥½ã¾ã—ã„ã¨ã•ã‚Œã‚‹ï¼ˆã‚´ãƒ­ã¯é•·æ‰“ã«ãªã‚Šã«ãã„ãŸã‚ï¼‰ã€‚",
            formula: "ã‚´ãƒ­ Ã· å…¨æ‰“çƒ",
            criteria: "45%: å¹³å‡",
            inputs: [{id:'gb', label:'ã‚´ãƒ­æ•°'}, {id:'bbe', label:'å…¨æ‰“çƒæ•°'}],
            calc: (d) => d.bbe > 0 ? ((d.gb/d.bbe)*100).toFixed(1)+'%' : '---'
        },
        {
            id: "ld_pct", category: "bat", title: "LD%", full: "Line Drive Percentage",
            short: "ãƒ©ã‚¤ãƒŠãƒ¼ç‡",
            desc: "æ‰“çƒã«å ã‚ã‚‹ãƒ©ã‚¤ãƒŠãƒ¼ã®å‰²åˆã€‚æœ€ã‚‚å®‰æ‰“ã«ãªã‚Šã‚„ã™ã„æ‰“çƒã€‚",
            formula: "ãƒ©ã‚¤ãƒŠãƒ¼ Ã· å…¨æ‰“çƒ",
            criteria: "21%: å¹³å‡",
            inputs: [{id:'ld', label:'ãƒ©ã‚¤ãƒŠãƒ¼æ•°'}, {id:'bbe', label:'å…¨æ‰“çƒæ•°'}],
            calc: (d) => d.bbe > 0 ? ((d.ld/d.bbe)*100).toFixed(1)+'%' : '---'
        },
        {
            id: "iffb_pct", category: "bat", title: "IFFB%", full: "Infield Fly Ball Percentage",
            short: "å†…é‡ãƒ•ãƒ©ã‚¤ç‡",
            desc: "ãƒ•ãƒ©ã‚¤ã«å ã‚ã‚‹å†…é‡ãƒ•ãƒ©ã‚¤ã®å‰²åˆã€‚ã»ã¼è‡ªå‹•çš„ã«ã‚¢ã‚¦ãƒˆã«ãªã‚‹ãŸã‚ã€æ‰“è€…ã«ã¨ã£ã¦ã¯ã€Œæœ€æ‚ªã®ãƒ•ãƒ©ã‚¤ã€ã€‚",
            formula: "å†…é‡ãƒ•ãƒ©ã‚¤ Ã· å…¨ãƒ•ãƒ©ã‚¤",
            criteria: "10%: å¹³å‡",
            inputs: [{id:'iffb', label:'å†…é‡ãƒ•ãƒ©ã‚¤'}, {id:'fb', label:'å…¨ãƒ•ãƒ©ã‚¤'}],
            calc: (d) => d.fb > 0 ? ((d.iffb/d.fb)*100).toFixed(1)+'%' : '---'
        },
        {
            id: "swing_pct", category: "bat", title: "Swing%", full: "Swing Percentage",
            short: "ã‚¹ã‚¤ãƒ³ã‚°ç‡",
            desc: "å…¨æŠ•çƒã«å¯¾ã—ã¦ã‚¹ã‚¤ãƒ³ã‚°ã—ãŸå‰²åˆã€‚ç©æ¥µæ€§ã‚’ç¤ºã™ã€‚é«˜ã™ãã‚‹ã¨ãƒœãƒ¼ãƒ«çƒã«æ‰‹ã‚’å‡ºã—ã‚„ã™ããªã‚‹å‚¾å‘ãŒã‚ã‚‹ã€‚",
            formula: "ã‚¹ã‚¤ãƒ³ã‚° Ã· å…¨æŠ•çƒ",
            criteria: "47%: å¹³å‡"
        },
        {
            id: "contact_pct", category: "bat", title: "Contact%", full: "Contact Percentage",
            short: "ã‚³ãƒ³ã‚¿ã‚¯ãƒˆç‡",
            desc: "ã‚¹ã‚¤ãƒ³ã‚°ã—ãŸéš›ã«ãƒãƒƒãƒˆã«ãƒœãƒ¼ãƒ«ãŒå½“ãŸã£ãŸï¼ˆç©ºæŒ¯ã‚Šã—ãªã‹ã£ãŸï¼‰å‰²åˆã€‚",
            formula: "(ã‚¹ã‚¤ãƒ³ã‚° - ç©ºæŒ¯ã‚Š) Ã· ã‚¹ã‚¤ãƒ³ã‚°",
            criteria: "76%: å¹³å‡"
        },
        {
            id: "z_contact_pct", category: "bat", title: "Z-Contact%", full: "Zone Contact Percentage",
            short: "ã‚¾ãƒ¼ãƒ³å†…ã‚³ãƒ³ã‚¿ã‚¯ãƒˆç‡",
            desc: "ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã‚¾ãƒ¼ãƒ³å†…ã®çƒã‚’ã‚¹ã‚¤ãƒ³ã‚°ã—ãŸéš›ã®ã‚³ãƒ³ã‚¿ã‚¯ãƒˆç‡ã€‚ã“ã®æ•°å€¤ãŒé«˜ã„æ‰“è€…ã¯ä¸‰æŒ¯ã—ã«ãã„ã€‚",
            formula: "Statcastè¨ˆæ¸¬",
            criteria: "85%: å¹³å‡"
        },
        {
            id: "tav", category: "bat", title: "TAv", full: "True Average",
            short: "æ‰“æ’ƒã®ç·åˆè²¢çŒ®åº¦ï¼ˆæ‰“ç‡ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰",
            desc: "Baseball ProspectusãŒç®—å‡ºã™ã‚‹ç·åˆæŒ‡æ¨™ã€‚æ‰“ç‡ã®ã‚ˆã†ãªæ„Ÿè¦šã§è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹ãŒã€å‡ºå¡ã‚„é•·æ‰“ã®ä¾¡å€¤ã‚‚é©åˆ‡ã«å«ã¾ã‚Œã¦ã„ã‚‹ã€‚",
            criteria: ".260: å¹³å‡"
        },
    
        /* --- Pitching (Advanced / Statcast) --- */
        {
            id: "era_minus", category: "pit", title: "ERA-", full: "ERA Minus",
            short: "ãƒ‘ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼è£œæ­£æ¸ˆã¿é˜²å¾¡ç‡ï¼ˆå‚‘å‡ºåº¦ï¼‰",
            desc: "ãƒªãƒ¼ã‚°å¹³å‡ã‚’100ã¨ã—ã¦é˜²å¾¡ç‡ã‚’æŒ‡æ•°åŒ–ã—ãŸã‚‚ã®ã€‚100ã‚ˆã‚Šä½ã„ã»ã©å„ªç§€ï¼ˆä¾‹ï¼š90ãªã‚‰å¹³å‡ã‚ˆã‚Š10%å„ªã‚Œã¦ã„ã‚‹ï¼‰ã€‚çƒå ´ã®æœ‰åˆ©ä¸åˆ©ã‚‚è£œæ­£ã•ã‚Œã‚‹ã€‚",
            formula: "100 Ã— (ERA Ã· (LgERA Ã— PF))",
            criteria: "100: å¹³å‡ / 80: ã‚¨ãƒ¼ã‚¹ç´š",
            related: ["era", "fip_minus"],
            inputs: [
                {id:'er', label:'è‡ªè²¬ç‚¹'}, {id:'ip', label:'æŠ•çƒå›'},
                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                ...ADVANCED_LEAGUE_INPUTS
            ],
            calc: (d) => {
                const era = d.ip > 0 ? (d.er * 9 / d.ip) : 0;
                const C = calcDerived(d);
                const pf = PARK_FACTORS[d.stadium].pf;
                const lg_era = C.lg_era_est; // æ¨å®šãƒªãƒ¼ã‚°é˜²å¾¡ç‡
                
                // ERA- = 100 * (ERA / (LgERA * PF)) â€»PFã¯ãƒªãƒ¼ã‚°å¹³å‡ã«å¯¾ã™ã‚‹ãã®çƒå ´ã®å€ç‡
                // ç°¡æ˜“å¼ã¨ã—ã¦ã€çƒå ´è£œæ­£ã‚’ã‹ã‘ãŸå¹³å‡é˜²å¾¡ç‡ã¨æ¯”è¼ƒã™ã‚‹
                const adj_lg_era = lg_era * pf;
                return adj_lg_era > 0 ? (100 * (era / adj_lg_era)).toFixed(0) : "---";
            }
        },
        {
            id: "fip_minus", category: "pit", title: "FIP-", full: "FIP Minus",
            short: "ãƒ‘ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼è£œæ­£æ¸ˆã¿FIPï¼ˆå‚‘å‡ºåº¦ï¼‰",
            desc: "ERA-ã¨åŒæ§˜ã«ã€FIPã‚’ãƒªãƒ¼ã‚°å¹³å‡ã¨æ¯”è¼ƒã—ã¦æŒ‡æ•°åŒ–ã—ãŸã‚‚ã®ã€‚100ã‚ˆã‚Šä½ã„ã»ã©å„ªç§€ã€‚å®ˆå‚™ã®å½±éŸ¿ã‚’æ’é™¤ã—ãŸçœŸã®æŠ•æ‰‹åŠ›ã‚’æ¯”è¼ƒã™ã‚‹ã®ã«æœ€é©ã€‚",
            formula: "100 Ã— (FIP Ã· (LgFIP Ã— PF))",
            criteria: "100: å¹³å‡ / 80: ã‚¨ãƒ¼ã‚¹ç´š",
            related: ["fip", "era_minus"],
            inputs: [
                {id:'hr', label:'è¢«æœ¬å¡æ‰“'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'hbp', label:'ä¸æ­»çƒ'}, {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'ip', label:'æŠ•çƒå›'},
                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                ...ADVANCED_LEAGUE_INPUTS
            ],
            calc: (d) => {
                const fip = d.ip > 0 ? ((13*d.hr + 3*(d.bb+d.hbp) - 2*d.so)/d.ip + 3.10) : 0;
                const C = calcDerived(d);
                // ãƒªãƒ¼ã‚°FIPã¯ãƒªãƒ¼ã‚°é˜²å¾¡ç‡ã«è¿‘ã„ã¨ä»®å®šï¼ˆå®šæ•°3.10ã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ï¼‰
                // æ­£ç¢ºã«ã¯ãƒªãƒ¼ã‚°ã”ã¨ã®FIPå®šæ•°ãŒå¿…è¦ã ãŒã€ã“ã“ã§ã¯LgERAã‚’ä»£ç”¨åŸºæº–ã¨ã™ã‚‹
                const pf = PARK_FACTORS[d.stadium].pf;
                const adj_lg_fip = C.lg_era_est * pf; 
                return adj_lg_fip > 0 ? (100 * (fip / adj_lg_fip)).toFixed(0) : "---";
            }
        },
        {
            id: "era_plus", category: "pit", title: "ERA+", full: "Adjusted ERA+",
            short: "ERA-ã®é€†æ•°ç‰ˆï¼ˆå¤§ãã„ã»ã©å„ªç§€ï¼‰",
            desc: "ãƒªãƒ¼ã‚°å¹³å‡é˜²å¾¡ç‡ã‚’è‡ªèº«ã®é˜²å¾¡ç‡ã§å‰²ã£ãŸã‚‚ã®ã€‚100ãŒå¹³å‡ã§ã€æ•°å€¤ãŒå¤§ãã„ã»ã©å„ªã‚Œã¦ã„ã‚‹ï¼ˆä¾‹ï¼š120ãªã‚‰å¹³å‡ã‚ˆã‚Š20%è‰¯ã„ï¼‰ã€‚",
            formula: "100 Ã— (LgERA Ã— PF Ã· ERA)",
            criteria: "100: å¹³å‡ / 130: å„ªç§€",
            related: ["era_minus"]
        },
        {
            id: "vaa", category: "pit", title: "VAA", full: "Vertical Approach Angle",
            short: "ç¸¦ã®é€²å…¥è§’åº¦",
            desc: "ãƒ›ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹é€šéæ™‚ã®ãƒœãƒ¼ãƒ«ã®ç¸¦ã®è§’åº¦ã€‚é«˜ã‚ã®ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã¯VAAãŒæµ…ã„ï¼ˆåœ°é¢ã¨å¹³è¡Œã«è¿‘ã„ï¼‰ã»ã©ãƒ›ãƒƒãƒ—ã—ã¦è¦‹ãˆã€ç©ºæŒ¯ã‚ŠãŒå–ã‚Œã‚„ã™ã„ã€‚",
            formula: "ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿",
            criteria: "-4åº¦å°: ãƒ›ãƒƒãƒ—å‹ / -6åº¦å°: æ²ˆã‚€çƒ"
        },
        {
            id: "ivb", category: "pit", title: "IVB", full: "Induced Vertical Break",
            short: "ä¼¸ã³ï¼ˆãƒ›ãƒƒãƒ—æˆåˆ†ï¼‰",
            desc: "é‡åŠ›ã®å½±éŸ¿ã‚’é™¤ã„ãŸç¸¦ã®å¤‰åŒ–é‡ã€‚ãƒœãƒ¼ãƒ«ãŒã©ã‚Œã ã‘ã€Œè½ã¡ãªã‹ã£ãŸã‹ã€ã‚’ç¤ºã™ã€‚æ•°å€¤ãŒå¤§ãã„ã»ã©æ‰“è€…ã®æ‰‹å…ƒã§ä¼¸ã³ã‚‹ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã¨ãªã‚‹ã€‚",
            formula: "ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿",
            criteria: "18ã‚¤ãƒ³ãƒä»¥ä¸Š: ãƒãƒ“ãŒã‚ã‚‹"
        },
        {
            id: "spin_rate", category: "pit", title: "SpinRate", full: "Spin Rate",
            short: "å›è»¢æ•°",
            desc: "ãƒœãƒ¼ãƒ«ãŒ1åˆ†é–“ã«å›è»¢ã™ã‚‹å›æ•°(rpm)ã€‚å›è»¢æ•°ãŒå¤šã„ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã¯è½ã¡ã«ããã€ã‚«ãƒ¼ãƒ–ã¯å¤§ããæ›²ãŒã‚‹å‚¾å‘ãŒã‚ã‚‹ã€‚",
            formula: "å›è»¢æ•°/åˆ†",
            criteria: "2200rpm: ç›´çƒå¹³å‡"
        },
        {
            id: "bauer_units", category: "pit", title: "Bauer Units", full: "Bauer Units",
            short: "çƒé€Ÿã«å¯¾ã™ã‚‹å›è»¢æ•°ã®æ¯”ç‡",
            desc: "å›è»¢æ•°ã‚’çƒé€Ÿ(mph)ã§å‰²ã£ãŸã‚‚ã®ã€‚çƒé€Ÿã«é–¢ã‚ã‚‰ãšã€Œå›è»¢ã®è³ªã€ãŒé«˜ã„ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã™ã‚‹ç›®å®‰ã¨ãªã‚‹ã€‚",
            formula: "å›è»¢æ•° Ã· çƒé€Ÿ(mph)",
            criteria: "24.0: å¹³å‡",
            inputs: [{id:'spin', label:'å›è»¢æ•°(rpm)'}, {id:'velo', label:'çƒé€Ÿ(mph)'}],
            calc: (d) => d.velo > 0 ? (d.spin / d.velo).toFixed(1) : "---"
        },
        {
            id: "extension", category: "pit", title: "Extension", full: "Extension",
            short: "ãƒªãƒªãƒ¼ã‚¹ãƒã‚¤ãƒ³ãƒˆã®å‰ã®ã‚ã‚Šåº¦",
            desc: "ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ä½ç½®ã¾ã§ã®è·é›¢ã€‚ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ãŒé•·ã„ã»ã©æ‰“è€…ã¾ã§ã®è·é›¢ãŒç¸®ã¾ã‚Šã€ä½“æ„Ÿé€Ÿåº¦ãŒä¸ŠãŒã‚‹ã€‚",
            formula: "ãƒ•ã‚£ãƒ¼ãƒˆ(ft)",
            criteria: "6.3ft: å¹³å‡"
        },
        {
            id: "active_spin", category: "pit", title: "Active Spin", full: "Active Spin (Spin Efficiency)",
            short: "æœ‰åŠ¹å›è»¢ç‡",
            desc: "ãƒœãƒ¼ãƒ«ã®å¤‰åŒ–ã«å¯„ä¸ã—ã¦ã„ã‚‹å›è»¢ã®å‰²åˆã€‚100%ã«è¿‘ã„ã»ã©ç¶ºéº—ãªç¸¦å›è»¢ï¼ˆã¾ãŸã¯æ¨ªå›è»¢ï¼‰ã§ã€å¤‰åŒ–ã®åŠ¹ç‡ãŒè‰¯ã„ã€‚",
            formula: "æœ‰åŠ¹å›è»¢ Ã· ç·å›è»¢",
            criteria: "ç›´çƒã¯é«˜ã„ã»ã©è‰¯ã„"
        },
        {
            id: "meatball_pct", category: "pit", title: "Meatball%", full: "Meatball Percentage",
            short: "ã©çœŸã‚“ä¸­å¤±æŠ•ç‡",
            desc: "ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã‚¾ãƒ¼ãƒ³ã®çœŸã‚“ä¸­ä»˜è¿‘ï¼ˆç”˜ã„ã‚³ãƒ¼ã‚¹ï¼‰ã«æŠ•ã˜ã‚‰ã‚ŒãŸçƒã®å‰²åˆã€‚ä½ã„ã»ã©ã‚³ãƒãƒ³ãƒ‰ï¼ˆåˆ¶çƒï¼‰ãŒè‰¯ã„ã€‚",
            formula: "Statcastè¨ˆæ¸¬",
            criteria: "7%: å¹³å‡"
        },
        {
            id: "putaway_pct", category: "pit", title: "PutAway%", full: "Put Away Percentage",
            short: "æ±ºã‚çƒã§ã®ä¸‰æŒ¯å¥ªå–ç‡",
            desc: "2ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã¨è¿½ã„è¾¼ã‚“ã çŠ¶æ³ã§ã€ãã®çƒç¨®ã‚’æŠ•ã˜ãŸéš›ã«ä¸‰æŒ¯ã‚’å¥ªãˆãŸå‰²åˆã€‚ã‚¦ã‚¤ãƒ‹ãƒ³ã‚°ã‚·ãƒ§ãƒƒãƒˆã®å¨åŠ›ã€‚",
            formula: "ä¸‰æŒ¯ Ã· 2ã‚¹ãƒˆãƒ©ã‚¤ã‚¯å¾Œã®æŠ•çƒæ•°",
            criteria: "20%: å„ªç§€"
        },
        {
            id: "edge_pct", category: "pit", title: "Edge%", full: "Edge Percentage",
            short: "ã‚¨ãƒƒã‚¸ï¼ˆã‚¾ãƒ¼ãƒ³å¢ƒç•Œï¼‰æŠ•çƒç‡",
            desc: "ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã‚¾ãƒ¼ãƒ³ã®å¢ƒç•Œç·šä»˜è¿‘ï¼ˆå¹…ãƒœãƒ¼ãƒ«1å€‹åˆ†ï¼‰ã¸ã®æŠ•çƒå‰²åˆã€‚ã‚³ãƒãƒ³ãƒ‰èƒ½åŠ›ã®é«˜ã•ã‚’ç¤ºã™ã€‚",
            formula: "Statcastè¨ˆæ¸¬",
            criteria: "42%: å¹³å‡"
        },
        {
            id: "f_strike_pct", category: "pit", title: "F-Strike%", full: "First Pitch Strike Percentage",
            short: "åˆçƒã‚¹ãƒˆãƒ©ã‚¤ã‚¯ç‡",
            desc: "åˆçƒã§ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ï¼ˆãƒ•ã‚¡ã‚¦ãƒ«ãƒ»ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼å«ã‚€ï¼‰ã‚’å–ã£ãŸå‰²åˆã€‚ã‚«ã‚¦ãƒ³ãƒˆæœ‰åˆ©ã«é€²ã‚ã‚‹èƒ½åŠ›ã€‚",
            formula: "åˆçƒã‚¹ãƒˆãƒ©ã‚¤ã‚¯ Ã· å…¨å¯¾æˆ¦æ•°",
            criteria: "60%: å¹³å‡ / 65%ä»¥ä¸Š: å„ªç§€"
        },
        {
            id: "hr_fb_pit", category: "pit", title: "HR/FB (Pit)", full: "HR per Fly Ball (Pitcher)",
            short: "è¢«ãƒ•ãƒ©ã‚¤ã‚ãŸã‚Šã®è¢«æœ¬å¡æ‰“ç‡",
            desc: "æ‰“ãŸã‚ŒãŸãƒ•ãƒ©ã‚¤ãŒæœ¬å¡æ‰“ã«ãªã£ãŸå‰²åˆã€‚ãƒªãƒ¼ã‚°å¹³å‡ã‚ˆã‚Šæ¥µç«¯ã«é«˜ã„å ´åˆã¯ã€Œé‹ãŒæ‚ªã„ã€å¯èƒ½æ€§ãŒã‚ã‚Šã€xFIPã§ã®è£œæ­£å¯¾è±¡ã¨ãªã‚‹ã€‚",
            formula: "è¢«æœ¬å¡æ‰“ Ã· è¢«ãƒ•ãƒ©ã‚¤æ•°",
            criteria: "10-12%: å¹³å‡",
            inputs: [{id:'hr', label:'è¢«æœ¬å¡æ‰“'}, {id:'fb', label:'è¢«ãƒ•ãƒ©ã‚¤æ•°'}],
            calc: (d) => d.fb > 0 ? ((d.hr/d.fb)*100).toFixed(1)+'%' : '---'
        },
        {
            id: "pace", category: "pit", title: "Pace", full: "Pace",
            short: "æŠ•çƒé–“éš”ï¼ˆç§’ï¼‰",
            desc: "æŠ•æ‰‹ãŒå‰ã®æŠ•çƒã‹ã‚‰æ¬¡ã®æŠ•çƒå‹•ä½œã«å…¥ã‚‹ã¾ã§ã®å¹³å‡ç§’æ•°ã€‚è¿‘å¹´ã¯ãƒ”ãƒƒãƒã‚¯ãƒ­ãƒƒã‚¯å°å…¥ã«ã‚ˆã‚ŠçŸ­ç¸®å‚¾å‘ã€‚",
            formula: "ç§’æ•°",
            criteria: "é€Ÿã„ã»ã†ãŒå®ˆå‚™ã®ãƒªã‚ºãƒ ãŒè‰¯ã„ã¨ã•ã‚Œã‚‹"
        },
    
        /* --- Fielding / Running / Other --- */
        {
            id: "oaa", category: "fld", title: "OAA", full: "Outs Above Average",
            short: "å¹³å‡ã‚ˆã‚Šå¤šãå–ã£ãŸã‚¢ã‚¦ãƒˆã®æ•°",
            desc: "Statcastã«ã‚ˆã‚‹å®ˆå‚™æŒ‡æ¨™ã€‚æ‰“çƒã®æ»ç©ºæ™‚é–“ã‚„é‡æ‰‹ã®ç§»å‹•è·é›¢ã‹ã‚‰ã€Œã‚¢ã‚¦ãƒˆç¢ºç‡ã€ã‚’ç®—å‡ºã—ã€å®Ÿéš›ã«ã‚¢ã‚¦ãƒˆã«ã—ãŸã‹ã©ã†ã‹ã§è²¢çŒ®åº¦ã‚’ç©ç®—ã™ã‚‹ã€‚",
            formula: "Statcastè¨ˆæ¸¬",
            criteria: "0: å¹³å‡ / +10: åæ‰‹"
        },
        {
            id: "frm", category: "fld", title: "FRM", full: "Catcher Framing",
            short: "ãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°è²¢çŒ®åº¦",
            desc: "æ•æ‰‹ãŒéš›ã©ã„ã‚³ãƒ¼ã‚¹ã‚’ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã¨åˆ¤å®šã•ã›ã‚‹æŠ€è¡“ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ï¼‰ã«ã‚ˆã‚‹å¾—ç‚¹è²¢çŒ®ã€‚",
            formula: "CSAAç­‰ã‚’æ›ç®—",
            criteria: "0: å¹³å‡"
        },
        {
            id: "pop_time", category: "fld", title: "Pop Time", full: "Pop Time",
            short: "ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ ï¼ˆäºŒå¡é€çƒæ™‚é–“ï¼‰",
            desc: "æ•æ‰‹ãŒæ•çƒã—ã¦ã‹ã‚‰äºŒå¡ãƒ™ãƒ¼ã‚¹ä¸Šã®é‡æ‰‹ãŒæ•çƒã™ã‚‹ã¾ã§ã®æ™‚é–“ã€‚ç›—å¡é˜»æ­¢èƒ½åŠ›ã«ç›´çµã™ã‚‹ã€‚",
            formula: "ç§’æ•°",
            criteria: "2.0ç§’: å¹³å‡ / 1.8ç§’: å¼·è‚©"
        },
        {
            id: "exchange_time", category: "fld", title: "Exchange", full: "Exchange Time",
            short: "æ¡ã‚Šæ›¿ãˆæ™‚é–“",
            desc: "æ•æ‰‹ãŒãƒœãƒ¼ãƒ«ã‚’æ•ã£ã¦ã‹ã‚‰æ‰‹ã‹ã‚‰é›¢ã™ã¾ã§ã®æ™‚é–“ã€‚ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ çŸ­ç¸®ã«ã¯è‚©ã®å¼·ã•ã‚ˆã‚Šé‡è¦ã¨ã‚‚è¨€ã‚ã‚Œã‚‹ã€‚",
            formula: "ç§’æ•°",
            criteria: "0.7ç§’: å¹³å‡"
        },
        {
            id: "raa_fld", category: "fld", title: "RAA (Fld)", full: "Runs Above Average (Fielding)",
            short: "å®ˆå‚™ã«ã‚ˆã‚‹å¹³å‡æ¯”å¾—ç‚¹è²¢çŒ®",
            desc: "OAAã‚’å¾—ç‚¹ä¾¡å€¤ã«æ›ç®—ã—ãŸæŒ‡æ¨™ã€‚UZRã‚„DRSã¨åŒæ§˜ã«WARã®å®ˆå‚™è¦ç´ ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã€‚",
            criteria: "0: å¹³å‡"
        },
        {
            id: "spd", category: "fld", title: "Spd", full: "Speed Score",
            short: "ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¹ã‚³ã‚¢",
            desc: "ç›—å¡æˆåŠŸç‡ã€ä¸‰å¡æ‰“ã€å¾—ç‚¹ç‡ã€ä½µæ®ºæ‰“ã®å°‘ãªã•ãªã©ã‹ã‚‰ç®—å‡ºã•ã‚Œã‚‹ã€é¸æ‰‹ã®ã€Œè¶³ã®é€Ÿã•ã€ã‚’0ã€œ10ã§è©•ä¾¡ã—ãŸæŒ‡æ¨™ã€‚ãƒ“ãƒ«ãƒ»ã‚¸ã‚§ãƒ¼ãƒ ã‚ºè€ƒæ¡ˆã€‚",
            formula: "0ã€œ10ã®ã‚¹ã‚³ã‚¢",
            criteria: "4.5: å¹³å‡ / 7.0: ä¿Šè¶³"
        },
        {
            id: "sprint_speed", category: "fld", title: "Sprint Speed", full: "Sprint Speed",
            short: "ã‚¹ãƒ—ãƒªãƒ³ãƒˆã‚¹ãƒ”ãƒ¼ãƒ‰",
            desc: "å…¨åŠ›ç–¾èµ°æ™‚ã®ãƒˆãƒƒãƒ—ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚£ãƒ¼ãƒˆ/ç§’ï¼‰ã€‚èµ°åŠ›ã®æœ€ã‚‚ç´”ç²‹ãªæŒ‡æ¨™ã€‚",
            formula: "ft/sec",
            criteria: "27ft/s: å¹³å‡ / 30ft/s: ã‚¨ãƒªãƒ¼ãƒˆ"
        },
        {
            id: "hp_to_1b", category: "fld", title: "HP to 1B", full: "Home to First Base Time",
            short: "ä¸€å¡åˆ°é”ã‚¿ã‚¤ãƒ ",
            desc: "æ‰“æ’ƒã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‹ã‚‰ä¸€å¡ãƒ™ãƒ¼ã‚¹ã«åˆ°é”ã™ã‚‹ã¾ã§ã®æ™‚é–“ã€‚å·¦æ‰“è€…ã®æ–¹ãŒæœ‰åˆ©ã«ãªã‚‹å‚¾å‘ãŒã‚ã‚‹ã€‚",
            formula: "ç§’æ•°",
            criteria: "4.3ç§’: å¹³å‡(å³) / 4.2ç§’: å¹³å‡(å·¦)"
        },
        {
            id: "baseruns", category: "tot", title: "BaseRuns", full: "BaseRuns",
            short: "ãƒãƒ¼ãƒ å¾—ç‚¹åŠ›ã®æ¨è¨ˆå¼",
            desc: "ãƒãƒ¼ãƒ ã®å®‰æ‰“ã€å››çƒã€æœ¬å¡æ‰“ãªã©ã®è¦ç´ ã‹ã‚‰ã€Œç†è«–ä¸Šã®ç·å¾—ç‚¹ã€ã‚’ç®—å‡ºã™ã‚‹ã€‚å®Ÿéš›ã®å¾—ç‚¹ã¨ã®ä¹–é›¢ã‚’è¦‹ã‚‹ã“ã¨ã§ã€é‹ã‚„å‹è² å¼·ã•ã‚’åˆ†æã§ãã‚‹ã€‚",
            formula: "BSR = A*B / (A+B) ...",
            criteria: "å®Ÿéš›ã®å¾—ç‚¹ã¨æ¯”è¼ƒ"
        },
        {
            id: "vorp", category: "tot", title: "VORP", full: "Value Over Replacement Player",
            short: "ä»£æ›¿é¸æ‰‹å¯¾æ¯”ä¾¡å€¤",
            desc: "WARã®æ¦‚å¿µã®å…ˆé§†ã‘ã¨ãªã£ãŸæŒ‡æ¨™ã€‚ãƒã‚¸ã‚·ãƒ§ãƒ³è£œæ­£ã‚’å«ã¾ãªã„æ”»æ’ƒã®è²¢çŒ®åº¦ã‚’å¾—ç‚¹æ•°ã§è¡¨ã™ã€‚",
            criteria: "ç©ã¿ä¸Šã’æŒ‡æ¨™"
        },
        {
            id: "log5", category: "tot", title: "Log5", full: "Log5 Method",
            short: "å¯¾æˆ¦å‹ç‡äºˆæ¸¬å¼",
            desc: "ãƒãƒ¼ãƒ Aã¨ãƒãƒ¼ãƒ Bã®å‹ç‡ã‹ã‚‰ã€ç›´æ¥å¯¾æ±ºã—ãŸéš›ã®å‹ç‡ã‚’äºˆæ¸¬ã™ã‚‹è¨ˆç®—å¼ã€‚",
            formula: "(A - AÃ—B) Ã· (A + B - 2Ã—AÃ—B)",
            inputs: [{id:'wa', label:'Aå‹ç‡(0.xxx)'}, {id:'wb', label:'Bå‹ç‡(0.xxx)'}],
            calc: (d) => {
                const num = d.wa - (d.wa * d.wb);
                const den = d.wa + d.wb - (2 * d.wa * d.wb);
                return den !== 0 ? (num / den).toFixed(3) : "---";
            }
        },
        {
            id: "pli", category: "tot", title: "pLI", full: "Player Leverage Index",
            short: "å¹³å‡é‡è¦å±€é¢æŒ‡æ•°",
            desc: "ãã®é¸æ‰‹ãŒæ‰“å¸­ï¼ˆã¾ãŸã¯ãƒã‚¦ãƒ³ãƒ‰ï¼‰ã«ç«‹ã£ãŸå ´é¢ã®å¹³å‡çš„ãªé‡è¦åº¦ã€‚1.0ã‚ˆã‚Šé«˜ã„å ´åˆã€å‹æ•—ã‚’åˆ†ã‘ã‚‹é‡è¦ãªå ´é¢ã§ã®èµ·ç”¨ãŒå¤šã‹ã£ãŸã“ã¨ã‚’ç¤ºã™ã€‚",
            criteria: "1.0: å¹³å‡"
        }
    ];
    // --- End Terms Database ---


    // --- Application Logic ---
    const grid = document.getElementById('grid');
    const modal = document.getElementById('modal');
    const modalTitleArea = document.getElementById('modal-title-area');
    const modalBodyContent = document.getElementById('modal-body-content');
    const searchInput = document.getElementById('searchInput');
    const filterChips = document.querySelectorAll('.filter-chip');
    const themeToggleBtn = document.getElementById('themeToggle');
    // è¿½åŠ : æ¤œç´¢ã‚¢ã‚¤ã‚³ãƒ³ã®è¦ç´ 
    const searchIconEl = document.getElementById('searchIcon');
    
    let currentFilter = 'all';
    let currentSearch = '';
    let currentTermId = null; 

    // Dark Mode Toggle Function
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        // ä¿®æ­£: ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‹•çš„ã«æ›´æ–°
        if (document.body.classList.contains('dark-mode')) {
            themeToggleBtn.innerHTML = icons.sun;
            themeToggleBtn.title = "Light Mode";
            localStorage.setItem('theme', 'dark');
        } else {
            themeToggleBtn.innerHTML = icons.moon;
            themeToggleBtn.title = "Dark Mode";
            localStorage.setItem('theme', 'light');
        }
    }
    
    // Initial theme check & icon setup
    (function() {
        // 1. æ¤œç´¢ã‚¢ã‚¤ã‚³ãƒ³ã®è¨­å®š
        if (searchIconEl) {
            searchIconEl.innerHTML = icons.search;
        }

        // 2. ãƒ†ãƒ¼ãƒè¨­å®šã¨ã‚¢ã‚¤ã‚³ãƒ³ã®è¨­å®š
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.body.classList.add('dark-mode');
            themeToggleBtn.innerHTML = icons.sun;
            themeToggleBtn.title = "Light Mode";
        } else {
             themeToggleBtn.innerHTML = icons.moon;
             themeToggleBtn.title = "Dark Mode";
        }
    })();


    function render() {
        grid.innerHTML = '';
        
        const filtered = terms.filter(term => {
            const catMatch = currentFilter === 'all' || term.category === currentFilter;
            const searchLower = currentSearch.toLowerCase();
            const searchMatch = !currentSearch || 
                term.title.toLowerCase().includes(searchLower) || 
                term.full.toLowerCase().includes(searchLower) ||
                term.short.includes(currentSearch) ||
                (term.desc && term.desc.includes(currentSearch));
            return catMatch && searchMatch;
        });

        if(filtered.length === 0) {
            grid.innerHTML = '<div class="no-result">ä¸€è‡´ã™ã‚‹ç”¨èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
            return;
        }

        filtered.forEach(term => {
            const el = document.createElement('div');
            el.className = `metric-card cat-${term.category}`;
            el.onclick = () => openModal(term.id);
            
            let catLabel = getCatLabel(term.category);
            
            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’SVGã«ç½®ãæ›ãˆ
            let iconSvg = icons.calculator;
            if(term.aiMode) {
                iconSvg = icons.barChart;
            }
            const hasCalc = term.inputs ? `<span class="calc-icon ${term.aiMode ? 'ai' : ''}" title="${term.aiMode ? 'æ¨å®š' : 'è¨ˆç®—å¯èƒ½'}">${iconSvg}</span>` : '';
            
            el.innerHTML = `
                <div class="card-header">
                    <span class="card-tag">${catLabel}</span>
                    ${hasCalc}
                </div>
                <h3 class="metric-title">${term.title}</h3>
                <div class="metric-full">${term.full}</div>
                <p class="metric-desc">${term.short}</p>
            `;
            grid.appendChild(el);
        });
    }

    function getCatLabel(cat) {
        switch(cat){
            case 'bat': return "Batting";
            case 'pit': return "Pitching";
            case 'fld': return "Fielding";
            case 'tot': return "Overall";
            case 'std': return "Basic";
            default: return "";
        }
    }
    
    function getCatColor(cat) {
        switch(cat){
            case 'bat': return "#0ea5e9";
            case 'pit': return "#f43f5e";
            case 'fld': return "#d97706";
            case 'tot': return "#10b981";
            case 'std': return "#6366f1";
            default: return "#64748b";
        }
    }

    function handleSearch() {
        currentSearch = searchInput.value;
        render();
    }

    function filterCategory(cat) {
        currentFilter = cat;
        filterChips.forEach(chip => {
            if(chip.dataset.cat === cat) chip.classList.add('active');
            else chip.classList.remove('active');
        });
        render();
    }

    function createInputHtml(inp) {
        if(inp.type === 'select') {
            const opts = Object.keys(inp.options).map(k => `<option value="${k}">${inp.options[k]}</option>`).join('');
            return `
                <div class="calc-group">
                    <label class="calc-label">${inp.label}</label>
                    <select class="calc-select" id="calc-${inp.id}">
                        ${opts}
                    </select>
                </div>
            `;
        } else {
            // Handle default value if present
            // ä¿®æ­£: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒ0ã®å ´åˆã¯valueå±æ€§ã«å…¥ã‚Œãªã„ï¼ˆç©ºæ¬„ã«ã—ã¦ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤ºï¼‰
            let val = '';
            if (inp.default !== undefined) {
                val = inp.default === 0 ? '' : inp.default;
            }
            
            const advClass = inp.advanced ? 'advanced-input' : '';
            return `
                <div class="calc-group">
                    <label class="calc-label">${inp.label}</label>
                    <input type="number" class="calc-field ${advClass}" id="calc-${inp.id}" placeholder="0" value="${val}" ${inp.advanced ? 'oninput="checkAdvancedChanges()"' : ''}>
                </div>
            `;
        }
    }

    function openModal(id) {
        currentTermId = id; // Set current term ID
        const term = terms.find(t => t.id === id);
        if(!term) return;

        // Build Related HTML
        let relatedHtml = '';
        if(term.related && term.related.length > 0) {
            term.related.forEach(rid => {
                const rTerm = terms.find(t => t.id === rid);
                if(rTerm) {
                    relatedHtml += `<div class="rel-chip" onclick="event.stopPropagation(); openModal('${rid}')">${rTerm.title}</div>`;
                }
            });
        }

        // Build Calculator HTML if inputs exist
        let calcHtml = '';
        if(term.inputs && term.calc) {
            const basicInputs = [];
            const advancedInputs = [];

            term.inputs.forEach(inp => {
                if (inp.advanced) {
                    advancedInputs.push(inp);
                } else {
                    basicInputs.push(inp);
                }
            });

            const basicInputsHtml = basicInputs.map(inp => createInputHtml(inp)).join('');
            
            let advancedSectionHtml = '';
            if (advancedInputs.length > 0) {
                const advInputsHtml = advancedInputs.map(inp => createInputHtml(inp)).join('');
                
                // --- è¿½åŠ : ãƒªãƒ¼ã‚°è¨­å®šç”¨ãƒ—ãƒªã‚»ãƒƒãƒˆUI ---
                const leaguePresetHtml = `
                    <div class="preset-bar" style="margin-bottom:15px; background:rgba(255,255,255,0.5); border:1px dashed var(--c-border);">
                        <div class="preset-label" style="width:auto; margin-right:auto;">${icons.gear} ãƒªãƒ¼ã‚°è¨­å®šãƒ—ãƒªã‚»ãƒƒãƒˆ</div>
                        <select class="preset-select" id="league-preset-select" style="min-width:100px; font-size:0.85rem; padding:6px;">
                            <option value="">è¨­å®šã‚’é¸æŠ...</option>
                        </select>
                        <button type="button" class="preset-btn btn-load" onclick="loadLeaguePreset()" style="padding:6px 10px; font-size:0.75rem;">èª­è¾¼</button>
                        <button type="button" class="preset-btn btn-del" onclick="removeLeaguePreset()" title="å‰Šé™¤" style="padding:6px 10px;">${icons.trash}</button>
                        <input type="text" class="preset-input" id="league-preset-name" placeholder="è¨­å®šå (ä¾‹: 2023ã‚»)" style="min-width:100px; font-size:0.85rem; padding:6px;">
                        <button type="button" class="preset-btn btn-save" onclick="saveLeaguePreset()" style="padding:6px 10px; font-size:0.75rem;">ä¿å­˜</button>
                    </div>
                `;
                // --------------------------------------

                advancedSectionHtml = `
                    <details class="advanced-details">
                        <summary class="advanced-summary">
                            <span class="icon-gear">${icons.gear}</span>
                            è©³ç´°è¨­å®š (ãƒªãƒ¼ã‚°å¹³å‡å€¤ãªã©)
                        </summary>
                        <div class="advanced-content">
                            ${leaguePresetHtml}  ${advInputsHtml}
                        </div>
                        <div id="warning-box" class="warning-msg" style="display:none;">
                            è©³ç´°è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã¨ç²¾åº¦ãŒè½ã¡ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
                        </div>
                    </details>
                `;
            }

            const aiClass = term.aiMode ? 'ai-mode' : '';
            const aiIcon = term.aiMode ? icons.barChart : icons.calculator;
            const aiText = term.aiMode ? 'æ¨å®šã‚’å®Ÿè¡Œ' : 'CALCULATE';
            const titleText = term.aiMode ? 'ESTIMATOR' : 'SIMULATOR';
            const calcBtnIcon = term.aiMode ? icons.barChart : icons.calculator;
            const delIcon = icons.trash;
            const saveIcon = icons.save;

            // è¦‹å‡ºã—ã®å¥ç‚¹ã‚’å‰Šé™¤
            calcHtml = `
                <div class="section-label has-hash">LABORATORY / ${aiText}</div>
                <div class="calc-container ${aiClass}" id="calc-container">
                    <div class="calc-title">
                        <div><span>${aiIcon}</span> ${term.title} ${titleText}</div>
                    </div>
                    
                    <!-- Preset Controls -->
                    <div class="preset-bar">
                        <div class="preset-label">${saveIcon} æˆç¸¾ãƒ—ãƒªã‚»ãƒƒãƒˆ (è‡ªå‹•å…¥åŠ›)</div>
                        <select class="preset-select" id="preset-select">
                            <option value="">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ...</option>
                        </select>
                        <button type="button" class="preset-btn btn-load" onclick="loadPreset()">èª­è¾¼</button>
                        <button type="button" class="preset-btn btn-del" onclick="removePreset()" title="å‰Šé™¤">${delIcon}</button>
                        <div style="flex-basis: 100%; height: 0; margin: 0;"></div> <!-- Line break for visual -->
                        <input type="text" class="preset-input" id="preset-name" placeholder="æ–°è¦ä¿å­˜å (ä¾‹: 2024å±±ç”°)">
                        <button type="button" class="preset-btn btn-save" onclick="savePreset()">ä¿å­˜</button>
                    </div>

                    <div class="calc-inputs">
                        ${basicInputsHtml}
                        ${advancedSectionHtml}
                    </div>
                    <button class="calc-btn" onclick="calculateMetric('${term.id}')">
                        ${calcBtnIcon} ${aiText}
                    </button>
                    <div class="calc-result-area">
                        <div class="calc-res-label">RESULT ${term.aiMode ? '<span>æ¨å®šå€¤</span>' : ''}:</div>
                        <div class="calc-res-value" id="calc-result">---</div>
                    </div>
                </div>
            `;
        }

        const catLabel = getCatLabel(term.category);
        const catColor = getCatColor(term.category);

        // Header
        modalTitleArea.innerHTML = `
            <div class="m-cat" style="color:${catColor}">${catLabel}</div>
            <h2 class="m-title">${term.title}</h2>
            <div class="m-full">${term.full}</div>
        `;

        // Body
        modalBodyContent.innerHTML = `
            <p style="font-size:1.2rem; font-weight:700; line-height:1.6; color:var(--c-text-primary);">${term.short}</p>
            ${term.desc ? `<p style="color:var(--c-text-secondary); line-height:1.8;">${term.desc}</p>` : ''}

            <div class="section-label has-hash">è¨ˆç®—å¼ / FORMULA</div>
            <div class="formula-box">${term.formula}</div>

            ${calcHtml}

            <div class="section-label has-hash">è©•ä¾¡åŸºæº– / CRITERIA</div>
            <table class="criteria-table">
                <tr><th>ç›®å®‰</th><td>${term.criteria || '---'}</td></tr>
            </table>

            <div class="section-label has-hash">é–¢é€£æŒ‡æ¨™ / RELATED</div>
            <div class="related-grid">${relatedHtml || '<span style="color:#94a3b8; font-size:0.9rem">ãªã—</span>'}</div>
        `;

        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('show');
        });

        // Initialize Preset List
        updatePresetList();
        updateLeaguePresetList();
    }

    // Logic to check advanced inputs
    window.checkAdvancedChanges = function() {
        const warningBox = document.getElementById('warning-box');
        if (!warningBox) return;

        const advInputs = document.querySelectorAll('.advanced-input');
        let isChanged = false;

        advInputs.forEach(input => {
            const key = input.id.replace('calc-', '').toUpperCase();
            const defVal = DEFAULTS[key];
            if (defVal !== undefined && parseFloat(input.value) !== defVal) {
                isChanged = true;
            }
        });

        warningBox.style.display = isChanged ? 'flex' : 'none';
    }

    // Calculation Function
    window.calculateMetric = function(id) {
        const term = terms.find(t => t.id === id);
        if(!term || !term.inputs) return;

        const data = {};
        let allFilled = true;
        
        term.inputs.forEach(inp => {
            const el = document.getElementById(`calc-${inp.id}`);
            const val = el.value;
            
            // å¿…é ˆå…¥åŠ›ã®ãƒã‚§ãƒƒã‚¯ (selectä»¥å¤–ã§advanced:trueãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‚‚ã®)
            const isBasicRequired = inp.type !== 'select' && !inp.advanced;
            if (isBasicRequired && val === '') {
                allFilled = false;
            }
            
            if(inp.type === 'select') {
                data[inp.id] = val;
            } else {
                data[inp.id] = parseFloat(val) || 0;
            }
        });

        if(!allFilled && !confirm("æœªå…¥åŠ›ã®å¿…é ˆé …ç›®ã¯0ã¨ã—ã¦è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿ")) return;

        const result = term.calc(data);
        
        const resDiv = document.getElementById('calc-result');
        resDiv.style.opacity = 0;
        resDiv.style.transform = "translateY(10px)";
        setTimeout(() => {
            resDiv.innerHTML = result;
            resDiv.style.transition = "all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)";
            resDiv.style.opacity = 1;
            resDiv.style.transform = "translateY(0)";
        }, 50);
    }

    function closeModal() {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    function closeModalOutside(e) {
        if (e.target === modal) closeModal();
    }

    /* --- Batch Calculator Logic --- */
    function openBatchCalc(mode) {
        const isBat = mode === 'bat';
        const title = isBat ? "é‡æ‰‹æŒ‡æ¨™ ä¸€æ‹¬è¨ˆç®—" : "æŠ•æ‰‹æŒ‡æ¨™ ä¸€æ‹¬è¨ˆç®—";
        const catColor = isBat ? getCatColor('bat') : getCatColor('pit');
        
        // Define input fields for batch mode
        let fields = [];
        if (isBat) {
            fields = [
                {id:'pa', label:'æ‰“å¸­æ•°'}, {id:'ab', label:'æ‰“æ•°'},
                {id:'h', label:'å®‰æ‰“'}, {id:'d', label:'äºŒå¡æ‰“'}, {id:'t', label:'ä¸‰å¡æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'},
                {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ'}, {id:'so', label:'ä¸‰æŒ¯'},
                {id:'sf', label:'çŠ é£›'}, {id:'sh', label:'çŠ æ‰“'},
                {id:'sb', label:'ç›—å¡'}, {id:'cs', label:'ç›—å¡æ­»'},
                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                {id:'pos', label:'å®ˆå‚™ä½ç½®', type:'select', options:{'dh':'DH', '1b':'ä¸€å¡', 'lf':'å·¦ç¿¼', 'rf':'å³ç¿¼', '3b':'ä¸‰å¡', '2b':'äºŒå¡', 'cf':'ä¸­å …', 'ss':'éŠæ’ƒ', 'c':'æ•æ‰‹'}},
                {id:'def', label:'å®ˆå‚™è©•ä¾¡', type:'select', options:{'0':'å¹³å‡çš„ (0)', '5':'ä¸Šæ‰‹ã„ (+5)', '10':'åæ‰‹ (+10)', '15':'ç¥ (+15)', '-5':'è‹¦æ‰‹ (-5)', '-10':'ä¸‹æ‰‹ (-10)'}}
            ];
        } else {
            fields = [
                {id:'ip', label:'æŠ•çƒå›'}, {id:'r', label:'å¤±ç‚¹'},
                {id:'h', label:'è¢«å®‰æ‰“'}, {id:'hr', label:'è¢«æœ¬å¡æ‰“'}, 
                {id:'bb', label:'ä¸å››çƒ'}, {id:'hbp', label:'ä¸æ­»çƒ'},
                {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bf', label:'æ‰“è€…æ•°'}, // è¿½åŠ : K%, BB%ç”¨
                // å¤‰æ›´: å®Ÿæ•°å…¥åŠ›å»ƒæ­¢ -> å‚¾å‘é¸æŠã¸
                {id:'gb_type', label:'æ‰“çƒå‚¾å‘(GB%)', type:'select', options:{
                    '55':'55% (è¶…ã‚´ãƒ­P)', 
                    '50':'50% (ã‚´ãƒ­P)', 
                    '45':'45% (å¹³å‡)', 
                    '40':'40% (ãƒ•ãƒ©ã‚¤P)', 
                    '35':'35% (è¶…ãƒ•ãƒ©ã‚¤P)'
                }},
                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                {id:'role', label:'å½¹å‰²', type:'select', options:{'sp':'å…ˆç™º', 'rp':'æ•‘æ´'}}
            ];
        }

        // Generate HTML
        const inputsHtml = fields.map(inp => createInputHtml(inp)).join('');
        
        // Generate Advanced Settings (Unified)
        const advInputsHtml = ADVANCED_LEAGUE_INPUTS.map(inp => createInputHtml(inp)).join('');

        // Smart Parser HTML (Text Only AI)
        const parserHtml = `
            <div class="parser-area" style="border-color:${catColor}">
                <div style="font-size:0.8rem; font-weight:700; color:var(--c-text-secondary); margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span>${icons.sparkle} AIãƒ†ã‚­ã‚¹ãƒˆè§£æ (AI ANALYZER)</span>
                    <span style="font-size:0.7em; background:#e2e8f0; padding:2px 6px; border-radius:4px;">TEXT MODE</span>
                </div>
                <textarea class="parser-textarea" id="smart-text" placeholder="ã“ã“ã«Webã‚µã‚¤ãƒˆã®æˆç¸¾è¡¨ãªã©ã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„...&#13;&#10;ï¼ˆä¾‹ï¼šæ‰“ç‡.300 è©¦åˆ143 æœ¬å¡æ‰“20...ï¼‰"></textarea>
                
                <button class="parser-btn" id="parser-btn" onclick="parseSmartContent('${mode}')" style="background:${catColor}">
                    <span>${icons.sparkle}</span> AIã§ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã—ã¦å…¥åŠ›
                </button>
                <div id="parser-msg" style="font-size:0.85rem; color:var(--c-text-secondary); margin-top:10px; text-align:center; display:none; line-height:1.5;"></div>
            </div>
        `;

        const saveIcon = icons.save;
        const delIcon = icons.trash;
        const gearIcon = icons.gear;

        const html = `
            <div class="section-label has-hash">INPUT DATA / ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</div>
            <div class="calc-container" style="border-color:${catColor}">
                
                ${parserHtml}

                <!-- Preset Controls -->
                <div class="preset-bar">
                    <div class="preset-label">${saveIcon} æˆç¸¾ãƒ—ãƒªã‚»ãƒƒãƒˆ (è‡ªå‹•å…¥åŠ›)</div>
                    <select class="preset-select" id="preset-select">
                        <option value="">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ...</option>
                    </select>
                    <button type="button" class="preset-btn btn-load" onclick="loadPreset()">èª­è¾¼</button>
                    <button type="button" class="preset-btn btn-del" onclick="removePreset()" title="å‰Šé™¤">${delIcon}</button>
                    <div style="flex-basis: 100%; height: 0; margin: 0;"></div> <!-- Line break for visual -->
                    <input type="text" class="preset-input" id="preset-name" placeholder="æ–°è¦ä¿å­˜å (ä¾‹: 2024å±±ç”°)">
                    <button type="button" class="preset-btn btn-save" onclick="savePreset()">ä¿å­˜</button>
                </div>

                <div class="calc-inputs">
                    ${inputsHtml}
                    <details class="advanced-details">
                        <summary class="advanced-summary">
                            <span class="icon-gear">${gearIcon}</span>
                            è©³ç´°è¨­å®š (ãƒªãƒ¼ã‚°å¹³å‡å€¤ãªã©)
                        </summary>
                        <div class="advanced-content">
                            <div class="preset-bar" style="margin-bottom:15px; background:rgba(255,255,255,0.5); border:1px dashed var(--c-border);">
                                <div class="preset-label" style="width:auto; margin-right:auto;">${icons.gear} ãƒªãƒ¼ã‚°è¨­å®šãƒ—ãƒªã‚»ãƒƒãƒˆ</div>
                                <select class="preset-select" id="league-preset-select" style="min-width:100px; font-size:0.85rem; padding:6px;">
                                    <option value="">è¨­å®šã‚’é¸æŠ...</option>
                                </select>
                                <button type="button" class="preset-btn btn-load" onclick="loadLeaguePreset()" style="padding:6px 10px; font-size:0.75rem;">èª­è¾¼</button>
                                <button type="button" class="preset-btn btn-del" onclick="removeLeaguePreset()" title="å‰Šé™¤" style="padding:6px 10px;">${icons.trash}</button>
                                <input type="text" class="preset-input" id="league-preset-name" placeholder="è¨­å®šå (ä¾‹: 2023ã‚»)" style="min-width:100px; font-size:0.85rem; padding:6px;">
                                <button type="button" class="preset-btn btn-save" onclick="saveLeaguePreset()" style="padding:6px 10px; font-size:0.75rem;">ä¿å­˜</button>
                            </div>
                            ${advInputsHtml}
                        </div>
                    </details>
                </div>
                <button class="calc-btn" style="background:${catColor}" onclick="runBatchCalc('${mode}')">
                    ${icons.barChart} ä¸€æ‹¬è¨ˆç®—å®Ÿè¡Œ (CALCULATE ALL)
                </button>
            </div>
            <div id="batch-results-area" style="margin-top:30px;"></div>
        `;

        modalTitleArea.innerHTML = `
            <div class="m-cat" style="color:${catColor}">BATCH CALCULATOR</div>
            <h2 class="m-title">${title}</h2>
        `;
        modalBodyContent.innerHTML = html;
        
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('show');
        });
        
        updatePresetList();
        updateLeaguePresetList();
    }

    // --- Smart Text Parser Logic ---
    window.parseSmartContent = function(mode) {
        const textInput = document.getElementById('smart-text');
        const btn = document.getElementById('parser-btn');
        const msg = document.getElementById('parser-msg');

        const text = textInput.value.trim();

        if (!text) {
            // alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); // è­¦å‘Šã‚’ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›´
            msg.style.display = 'block';
            msg.innerHTML = `<div style="color:#ef4444;">âŒ ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>`;
            return;
        }

        // AIåˆ†ææ¼”å‡º
        btn.innerHTML = `${icons.loader} ãƒ†ã‚­ã‚¹ãƒˆæ§‹é€ ã‚’è§£æä¸­...`;
        btn.classList.add('analyzing');
        msg.style.display = 'none';

        setTimeout(() => {
            // è§£æå®Ÿè¡Œ
            btn.innerHTML = `${icons.sparkle} AIã§ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã—ã¦å…¥åŠ›`;
            btn.classList.remove('analyzing');
            
            runParser(text, mode);
            
        }, 800); // æ¼”å‡ºç”¨ã®ã‚¦ã‚§ã‚¤ãƒˆ
    };

    function runParser(text, mode) {
        const msg = document.getElementById('parser-msg');
        
        // AI Analysis Logic (Advanced Regex Pattern Matching)
        // Added synonyms for better matching
        const mapBat = {
            'æ‰“å¸­': 'pa', 'æ‰“æ•°': 'ab', 'å®‰æ‰“': 'h', 'äºŒå¡æ‰“': 'd', 'ä¸‰å¡æ‰“': 't', 'æœ¬å¡æ‰“': 'hr', 'æœ¬': 'hr', 'HR': 'hr',
            'å››çƒ': 'bb', 'æ­»çƒ': 'hbp', 'ä¸‰æŒ¯': 'so', 'çŠ é£›': 'sf', 'çŠ æ‰“': 'sh', 'ç›—å¡': 'sb', 'ç›—å¡æ­»': 'cs', 'ä½µæ®º': 'gidp'
        };
        const mapPit = {
            // ä¿®æ­£: WHIPã®"IP"ã«åå¿œã—ãªã„ã‚ˆã†ã« (?<!WH) ã‚’è¿½åŠ 
            'å›': 'ip', 'æŠ•çƒå›': 'ip', 'IP': 'ip', 
            'å¤±ç‚¹': 'r', 'è‡ªè²¬': 'er', 'è¢«å®‰æ‰“': 'h', 'è¢«æœ¬å¡æ‰“': 'hr', 'è¢«æœ¬': 'hr',
            // ä¿®æ­£: ç„¡å››çƒã®"å››çƒ"ã«åå¿œã—ãªã„ã‚ˆã†ã« (?<!ç„¡) ã‚’è¿½åŠ 
            'ä¸å››çƒ': 'bb', 'å››çƒ': 'bb', 
            'ä¸æ­»çƒ': 'hbp', 'æ­»çƒ': 'hbp', 'å¥ªä¸‰æŒ¯': 'so', 'ä¸‰æŒ¯': 'so', 'æ‰“è€…': 'bf'
        };

        const map = mode === 'bat' ? mapBat : mapPit;
        let count = 0;
        let extractedInfo = [];

        for (const [key, id] of Object.entries(map)) {
            // Regex: Label followed by space/colon/tab, then number
            const regex = new RegExp(`${key}[:\\sã€€]*([0-9]+(?:\\.[0-9]+)?)`, 'g');
            let match;
            // Need to handle regex.exec(text) iteration correctly if text contains multiple matches for one key (e.g., 'å››çƒ 20 å››çƒ 30')
            // For simplicity, we use matchAll and take the last match.
            const matches = [...text.matchAll(regex)];
            if(matches.length > 0) {
                match = matches[matches.length - 1]; // Take the last match
            }

            if(match) {
                const val = parseFloat(match[1]);
                const el = document.getElementById(`calc-${id}`);
                if(el) {
                    el.value = val;
                    el.style.backgroundColor = "#dcfce7"; // Success Color
                    setTimeout(()=>el.style.backgroundColor="", 2000);
                    count++;
                    if(extractedInfo.length < 6) extractedInfo.push(key);
                }
            }
        }

        msg.style.display = 'block';
        if (count > 0) {
            msg.innerHTML = `
                <div style="color:var(--cat-tot); font-weight:bold;">
                    ${icons.sparkle} è§£æå®Œäº†: ${count} é …ç›®ã‚’æŠ½å‡ºã—ã¾ã—ãŸ
                </div>
                <div style="font-size:0.8em; color:var(--c-text-secondary);">
                    æ¤œå‡º: ${extractedInfo.join(', ')}${extractedInfo.length>=6 ? '...' : ''}
                </div>
            `;
        } else {
            msg.innerHTML = `
                <div style="color:#ef4444;">
                    âŒ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>
                    ã€Œæ‰“ç‡.300 æœ¬å¡æ‰“20ã€ã®ã‚ˆã†ã«é …ç›®åã¨æ•°å­—ãŒå«ã¾ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
                </div>
            `;
        }
    }

    let radarChartInstance = null;

    function runBatchCalc(mode) {
        const isBat = mode === 'bat';
        const data = {};
        
        // Collect all inputs
        const inputs = document.querySelectorAll('.calc-field, .calc-select');
        inputs.forEach(el => {
            const id = el.id.replace('calc-', '');
            if(el.tagName === 'SELECT') {
                data[id] = el.value;
            } else {
                data[id] = parseFloat(el.value) || 0;
            }
        });
        
        // å¿…é ˆã®ãƒªãƒ¼ã‚°å¹³å‡å€¤ã‚’ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ³¨å…¥ (calcDerivedã®ä¾å­˜é–¢ä¿‚ã‚’è§£æ±ºã™ã‚‹ãŸã‚)
        ADVANCED_LEAGUE_INPUTS.forEach(inp => {
            const id = inp.id;
            const el = document.getElementById(`calc-${id}`);
            data[id] = parseFloat(el.value) || inp.default || 0;
        });

        // Calculate Indicators
        let results = [];
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®æŒ‡æ¨™IDãƒªã‚¹ãƒˆã‚’æ›´æ–° (ISO, xFIPã‚’è¿½åŠ )
        const targetIds = isBat ? 
            ['war', 'wrc_plus', 'woba', 'iso', 'babip', 'k_pct', 'bb_pct', 'wsb'] : 
            ['pit_war', 'fip', 'xfip', 'siera', 'k_pct_pit', 'bb_pct_pit'];

        terms.forEach(term => {
            if (targetIds.includes(term.id) && term.calc) {
                try {
                    // ISO, wsb, wrc_plusãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã‚‹ã‚ˆã†ã€å¿…è¦ãªå…¥åŠ›ã‚’äº‹å‰ã«æº–å‚™
                    if (isBat) {
                        if (term.id === 'iso') {
                            // ISOã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã«å¿…è¦ãªSLG, AVGã‚’è¨ˆç®—
                            const tb = (data.h - (data.d+data.t+data.hr) + 2*data.d + 3*data.t + 4*data.hr) || 0;
                            const slg = data.ab > 0 ? tb / data.ab : 0;
                            const avg = data.ab > 0 ? data.h / data.ab : 0;
                            data.slg = slg;
                            data.avg = avg;
                        } else if (term.id === 'k_pct' || term.id === 'bb_pct') {
                            // K%ã¨BB%ã®è¨ˆç®—ã«ã¯PAãŒå¿…è¦
                            if (data.pa === 0) return;
                        }
                    }

                    const res = term.calc(data);
                    if (res !== "---" && res !== "NaN" && res !== "Infinity") {
                        results.push({
                            title: term.title,
                            full: term.full,
                            value: res,
                            criteria: term.criteria,
                            cat: term.category,
                            id: term.id
                        });
                    }
                } catch(e) {
                    console.error(`Error calculating ${term.id}:`, e);
                }
            }
        });

        // --- Radar Chart Logic ---
        let radarHtml = '';
        if (results.length > 0) {
            radarHtml = `
                <div class="chart-wrapper">
                    <canvas id="radarChart"></canvas>
                </div>
                <div style="font-size:0.75rem; color:var(--c-text-secondary); text-align:center; margin-bottom:20px; line-height:1.5;">
                    <strong>ã€ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆè©•ä¾¡é …ç›®ã€‘</strong><br>
                    ${mode === 'bat' 
                        ? 'ç·åˆæ”»æ’ƒåŠ›(wRC+) / ãƒ‘ãƒ¯ãƒ¼(ISO) / èµ°åŠ›(wSB) / é¸çƒçœ¼(BB%) / å®ˆå‚™(UZR)' 
                        : 'çƒå¨(K%) / åˆ¶çƒ(BB%) / å°†æ¥æ€§(xFIP) / çœŸã®å®ŸåŠ›(SIERA) / ã‚´ãƒ­ç‡(GB%)'}
                </div>
            `;
        }

        // Render Table
        if (results.length === 0) {
            document.getElementById('batch-results-area').innerHTML = '<div class="no-result">è¨ˆç®—å¯èƒ½ãªæŒ‡æ¨™ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
            return;
        }

        let tableHtml = `
            <div class="section-label has-hash">ANALYSIS RESULTS / åˆ†æçµæœ</div>
            ${radarHtml}
            <table class="criteria-table" style="margin-top:20px;">
                <thead>
                    <tr style="background:var(--c-bg);">
                        <th style="padding-left:10px;">æŒ‡æ¨™ (METRIC)</th>
                        <th style="text-align:right; padding-right:20px;">å€¤ (VALUE)</th>
                        <th>åŸºæº– (CRITERIA)</th>
                    </tr>
                </thead>
                <tbody>
        `;

        results.forEach(r => {
            const catColor = getCatColor(r.cat);
            tableHtml += `
                <tr>
                    <td style="padding-left:10px;">
                        <span style="color:${catColor}; font-weight:900;">${r.title}</span>
                        <div style="font-size:0.75rem; color:var(--c-text-secondary);">${r.full}</div>
                    </td>
                    <td style="text-align:right; padding-right:20px; font-family:var(--font-mono); font-size:1.5rem; font-weight:700; color:var(--c-text-primary);">
                        ${r.value}
                    </td>
                    <td style="font-size:0.85rem; color:var(--c-text-secondary);">
                        ${r.criteria || '-'}
                    </td>
                </tr>
            `;
        });

        tableHtml += `</tbody></table>`;
        
        // ğŸ“‹ã‚’SVGã«ç½®ãæ›ãˆ
        tableHtml += `
            <button class="calc-btn" style="margin-top:20px; background:var(--c-text-secondary);" onclick="copyBatchResults()">
                ${icons.clipboard} çµæœã‚’ã‚³ãƒ”ãƒ¼ (COPY TEXT)
            </button>
        `;

        const resArea = document.getElementById('batch-results-area');
        resArea.innerHTML = tableHtml;
        resArea.scrollIntoView({behavior: 'smooth'});

        // --- Render Chart ---
        if (radarChartInstance) {
            radarChartInstance.destroy();
        }
        
        const ctx = document.getElementById('radarChart');
        if (ctx) {
            // Calculate Scores (0-100)
            let scores = [];
            let labels = [];
            
            // Helper function to calculate raw metric values needed for the chart, even if they weren't in the table.
            const calculateMetricValue = (id, inputData) => {
                const term = terms.find(t => t.id === id);
                if (term && term.calc) {
                    try {
                        const val = term.calc(inputData);
                        return parseFloat(val) || 0;
                    } catch(e) {
                        return 0; // Return 0 if calculation fails
                    }
                }
                return 0;
            };

            if (isBat) {
                // Batting Scores
                // 1. wRC+ (Overall Offense): 40(min) - 180(max) -> 100 is avg
                const wrc = calculateMetricValue('wrc_plus', data);
                const scoreWrc = Math.min(100, Math.max(0, (wrc - 40) / 140 * 100));
                
                // 2. ISO (Power): .050 - .350
                const tb = (data.h - (data.d+data.t+data.hr) + 2*data.d + 3*data.t + 4*data.hr) || 0;
                const slg = data.ab > 0 ? tb / data.ab : 0;
                const avg = data.ab > 0 ? data.h / data.ab : 0;
                const iso = slg - avg;
                const scoreIso = Math.min(100, Math.max(0, (iso - 0.050) / 0.300 * 100));
                
                // 3. wSB (Speed/Running): -5 - +10
                const wsb = calculateMetricValue('wsb', data);
                const scoreWsb = Math.min(100, Math.max(0, (wsb - (-5)) / 15 * 100));
                
                // 4. BB% (Eye): 3% - 18%
                const bb_pct = data.pa > 0 ? data.bb / data.pa : 0;
                const scoreBb = Math.min(100, Math.max(0, (bb_pct - 0.03) / 0.15 * 100));
                
                // 5. UZR (Defense): -15 - +15
                const uzr = parseFloat(data.def) || 0;
                const scoreUzr = Math.min(100, Math.max(0, (uzr - (-15)) / 30 * 100));

                labels = ['wRC+', 'ISO', 'wSB', 'BB%', 'UZR'];
                scores = [scoreWrc, scoreIso, scoreWsb, scoreBb, scoreUzr];

            } else {
                // Pitching Scores
                // 1. K% (Stuff): 10% - 35%
                const k_pct = data.bf > 0 ? data.so / data.bf : 0;
                const scoreK = Math.min(100, Math.max(0, (k_pct - 0.10) / 0.25 * 100));
                
                // 2. BB% (Control): 15% - 2% (Reverse)
                const bb_pct = data.bf > 0 ? data.bb / data.bf : 0.10;
                const scoreBb = Math.min(100, Math.max(0, (0.15 - bb_pct) / 0.13 * 100));
                
                // 3. xFIP (Expected Performance): 6.00 - 2.00 (Reverse)
                const xfip = calculateMetricValue('xfip', data); // Recalculate xFIP using input data
                const scoreXfip = Math.min(100, Math.max(0, (6.00 - xfip) / 4.00 * 100));
                
                // 4. SIERA (True Skill): 6.00 - 2.00 (Reverse)
                const siera = calculateMetricValue('siera', data); // Recalculate SIERA using input data
                const scoreSiera = Math.min(100, Math.max(0, (6.00 - siera) / 4.00 * 100));
                
                // 5. GB% (Groundball): 30% - 60%
                const gb_pct = parseFloat(data.gb_type || 45) / 100;
                const scoreGb = Math.min(100, Math.max(0, (gb_pct - 0.30) / 0.30 * 100));

                labels = ['K%', 'BB%', 'xFIP', 'SIERA', 'GB%'];
                scores = [scoreK, scoreBb, scoreXfip, scoreSiera, scoreGb];
            }

            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score',
                        data: scores,
                        backgroundColor: isBat ? 'rgba(14, 165, 233, 0.2)' : 'rgba(244, 63, 94, 0.2)',
                        borderColor: isBat ? '#0ea5e9' : '#f43f5e',
                        pointBackgroundColor: '#fff',
                        pointBorderColor: isBat ? '#0ea5e9' : '#f43f5e',
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            ticks: { display: false }, // Hide numbers
                            pointLabels: {
                                font: { size: 14, weight: '800', family: 'var(--font-mono)' },
                                color: document.body.classList.contains('dark-mode') ? '#94a3b8' : '#475569'
                            },
                            grid: {
                                color: document.body.classList.contains('dark-mode') ? 'rgba(51, 65, 85, 0.5)' : 'rgba(203, 213, 225, 0.5)'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    }

    function copyBatchResults() {
        const rows = document.querySelectorAll('#batch-results-area tr');
        let text = "ã€SABR METRICS LAB Calculation Resultsã€‘\n";
        rows.forEach((row, i) => {
            if(i===0) return; // skip header
            const cols = row.querySelectorAll('td');
            if(cols.length > 0) {
                const metric = cols[0].querySelector('span').innerText;
                const value = cols[1].innerText.trim();
                text += `${metric}: ${value}\n`;
            }
        });

        // Fallback approach for iframe/sandbox environments
        const textArea = document.createElement("textarea");
        textArea.value = text;
        
        // Avoid scrolling to bottom
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        textArea.style.opacity = "0";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if(successful) {
                alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
            } else {
                alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
            alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }

        document.body.removeChild(textArea);
    }

    /* --- Preset Logic (LocalStorage) --- */
    const STORAGE_KEY = 'sabr_metrics_presets';

    function getPresets() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        } catch (e) {
            console.error("Failed to parse presets", e);
            return {};
        }
    }

    function savePresets(presets) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(presets));
    }

    function updatePresetList() {
        const select = document.getElementById('preset-select');
        if (!select) return;

        const presets = getPresets();
        select.innerHTML = '<option value="">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ...</option>';
        
        Object.keys(presets).forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        });
    }

    window.savePreset = function() {
        const nameInput = document.getElementById('preset-name');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('ä¿å­˜åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // Collect current input values
        const inputs = document.querySelectorAll('.calc-field, .calc-select');
        const data = {};
        let hasData = false;

        inputs.forEach(input => {
            // Strip "calc-" prefix from ID
            const key = input.id.replace('calc-', '');
            if (input.value) {
                data[key] = input.value;
                hasData = true;
            }
        });

        if (!hasData) {
            alert('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }

        const presets = getPresets();
        if (presets[name] && !confirm(`"${name}" ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
        }

        presets[name] = data;
        savePresets(presets);
        
        updatePresetList();
        document.getElementById('preset-select').value = name;
        nameInput.value = ''; // clear input
        alert(`"${name}" ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
    }

    window.loadPreset = function() {
        const select = document.getElementById('preset-select');
        const name = select.value;
        
        if (!name) return;

        const presets = getPresets();
        const data = presets[name];
        
        if (data) {
            let count = 0;
            Object.keys(data).forEach(key => {
                const el = document.getElementById(`calc-${key}`);
                if (el) {
                    el.value = data[key];
                    // Visual feedback
                    el.style.backgroundColor = "#f0fdf4";
                    setTimeout(() => el.style.backgroundColor = "", 1000);
                    count++;
                }
            });
            
            // Trigger advanced check if any advanced inputs were loaded
            if (window.checkAdvancedChanges) window.checkAdvancedChanges();
        }
    }

    window.removePreset = function() {
        const select = document.getElementById('preset-select');
        const name = select.value;
        
        if (!name) return;

        // "Are you sure?" confirmation removed for easier deletion
        const presets = getPresets();
        if (presets[name]) {
            delete presets[name];
            savePresets(presets);
            updatePresetList();
            select.value = ""; // Reset selection
            alert(`"${name}" ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
    }
    /* --- League Preset Logic (Advanced Settings) --- */
    const LEAGUE_STORAGE_KEY = 'sabr_league_presets';

    function getLeaguePresets() {
        try {
            const stored = localStorage.getItem(LEAGUE_STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        } catch (e) {
            console.error("Failed to parse league presets", e);
            return {};
        }
    }

    function saveLeaguePresets(presets) {
        localStorage.setItem(LEAGUE_STORAGE_KEY, JSON.stringify(presets));
    }

    window.updateLeaguePresetList = function() {
        const select = document.getElementById('league-preset-select');
        if (!select) return;

        const presets = getLeaguePresets();
        select.innerHTML = '<option value="">è¨­å®šã‚’é¸æŠ...</option>';
        
        Object.keys(presets).forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        });
    }

    window.saveLeaguePreset = function() {
        const nameInput = document.getElementById('league-preset-name');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('è¨­å®šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        const data = {};
        // ADVANCED_LEAGUE_INPUTS ã§å®šç¾©ã•ã‚ŒãŸIDã®ã¿ã‚’åé›†
        ADVANCED_LEAGUE_INPUTS.forEach(inp => {
            const el = document.getElementById(`calc-${inp.id}`);
            if (el && el.value) {
                data[inp.id] = el.value;
            }
        });

        if (Object.keys(data).length === 0) {
            alert('ä¿å­˜ã™ã‚‹è©³ç´°è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }

        const presets = getLeaguePresets();
        if (presets[name] && !confirm(`"${name}" ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
        }

        presets[name] = data;
        saveLeaguePresets(presets);
        
        updateLeaguePresetList();
        document.getElementById('league-preset-select').value = name;
        nameInput.value = '';
        alert(`ãƒªãƒ¼ã‚°è¨­å®š "${name}" ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
    }

    window.loadLeaguePreset = function() {
        const select = document.getElementById('league-preset-select');
        const name = select.value;
        if (!name) return;

        const presets = getLeaguePresets();
        const data = presets[name];
        
        if (data) {
            Object.keys(data).forEach(key => {
                const el = document.getElementById(`calc-${key}`);
                if (el) {
                    el.value = data[key];
                    // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                    el.style.backgroundColor = "#e0f2fe"; // è–„ã„é’
                    setTimeout(() => el.style.backgroundColor = "", 1000);
                }
            });
            // å¤‰æ›´æ¤œçŸ¥ï¼ˆè­¦å‘Šè¡¨ç¤ºã®æ›´æ–°ãªã©ï¼‰
            if (window.checkAdvancedChanges) window.checkAdvancedChanges();
        }
    }

    window.removeLeaguePreset = function() {
        const select = document.getElementById('league-preset-select');
        const name = select.value;
        if (!name) return;

        const presets = getLeaguePresets();
        if (presets[name]) {
            delete presets[name];
            saveLeaguePresets(presets);
            updateLeaguePresetList();
            select.value = "";
            alert(`ãƒªãƒ¼ã‚°è¨­å®š "${name}" ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
    }

/* --- Tool Menu Logic (ä¿®æ­£ç‰ˆ) --- */
    function openToolMenu() {
        const title = "LABORATORY TOOLS";
        const catColor = "var(--c-text-primary)";
    
        // ãƒ„ãƒ¼ãƒ«ä¸€è¦§ã®å®šç¾©
        // keepOpen: true ã®å ´åˆã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨åŒã˜ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½¿ã†ãŸã‚ closeModal() ã‚’å®Ÿè¡Œã—ãªã„
        const tools = [
            { 
                id: 'batch-bat', name: 'é‡æ‰‹ä¸€æ‹¬è¨ˆç®—', 
                icon: icons.calculator, func: "openBatchCalc('bat')", 
                color: 'var(--cat-bat)', desc: 'æ‰“æ’ƒãƒ»å®ˆå‚™æŒ‡æ¨™ã‚’ã¾ã¨ã‚ã¦è¨ˆç®—',
                keepOpen: true
            },
            { 
                id: 'batch-pit', name: 'æŠ•æ‰‹ä¸€æ‹¬è¨ˆç®—', 
                icon: icons.calculator, func: "openBatchCalc('pit')", 
                color: 'var(--cat-pit)', desc: 'æŠ•çƒæŒ‡æ¨™ãƒ»FIPç­‰ã‚’ã¾ã¨ã‚ã¦è¨ˆç®—',
                keepOpen: true
            },
            { 
                id: 'galaxy', name: 'GALAXY EXPLORER', 
                icon: icons.sparkle, func: "openMindMap()", 
                color: '#8b5cf6', desc: 'æŒ‡æ¨™ã®é–¢ä¿‚æ€§ã‚’å®‡å®™åœ°å›³ã§æ¢ç´¢',
                keepOpen: false // ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã¯åˆ¥ç”»é¢ãªã®ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            },
            { 
                id: 'gm', name: 'GM CHALLENGE', 
                icon: icons.barChart, func: "openGMChallenge()", 
                color: '#10b981', desc: 'æœ€å¼·ãƒãƒ¼ãƒ ç·¨æˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                keepOpen: true
            },
            { 
                id: 'career', name: 'MY CAREER', 
                icon: icons.save, func: "openCareerSim()", 
                color: '#d97706', desc: 'é¸æ‰‹äººç”Ÿã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                keepOpen: true
            }
        ];
    
        let html = `<div class="grid-container" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); padding:0; gap:15px; max-width:100%;">`;
        
        let count = 0;
        tools.forEach(t => {
            const fnName = t.func.split('(')[0];
            if (typeof window[fnName] === 'function') {
                // keepOpenãƒ•ãƒ©ã‚°ã«å¿œã˜ã¦ closeModal() ã‚’å‘¼ã¶ã‹æ±ºå®š
                const clickAction = t.keepOpen ? t.func : `${t.func}; closeModal();`;
                
                html += `
                    <div onclick="${clickAction}" style="
                        background:var(--c-bg); border:1px solid var(--c-border); border-radius:16px; padding:20px; 
                        cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:15px; box-shadow:var(--shadow-card);
                    " onmouseover="this.style.borderColor='${t.color}'; this.style.transform='translateY(-3px)';" 
                      onmouseout="this.style.borderColor='var(--c-border)'; this.style.transform='none';">
                        <div style="
                            width:50px; height:50px; border-radius:12px; background:${t.color}; color:white; 
                            display:flex; align-items:center; justify-content:center; flex-shrink:0;
                        ">
                            ${t.icon}
                        </div>
                        <div>
                            <div style="font-weight:800; color:var(--c-text-primary); font-size:1rem; line-height:1.2; margin-bottom:4px;">${t.name}</div>
                            <div style="font-size:0.75rem; color:var(--c-text-secondary); line-height:1.4;">${t.desc}</div>
                        </div>
                    </div>
                `;
                count++;
            }
        });
        html += `</div>`;
        
        if(count === 0) html += `<div style="text-align:center; padding:20px;">åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    
        modalTitleArea.innerHTML = `
            <div class="m-cat" style="color:${catColor}">MENU</div>
            <h2 class="m-title">${title}</h2>
            <div class="m-full">Select a tool to launch</div>
        `;
        modalBodyContent.innerHTML = html;
    
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('show');
        });
    }

    /* --- New Career Simulation Logic (v3.1 Fixed K-Rate & Name) --- */
    
    let careerMode = 'batter'; // 'batter' or 'pitcher'
    
    function openCareerSim() {
        const overlay = document.getElementById('career-overlay');
        renderCareerCreationUI();
        overlay.classList.add('active');
        closeModal();
    }
    
    function closeCareerSim() {
        document.getElementById('career-overlay').classList.remove('active');
    }
    
    function setCareerMode(mode) {
        careerMode = mode;
        renderCareerCreationUI();
    }
    
    // ãƒ©ãƒ³ã‚¯åˆ¤å®šç”¨é–¢æ•°
    function getRank(val) {
        if (val >= 90) return { rank: 'S', class: 'rank-s' };
        if (val >= 80) return { rank: 'A', class: 'rank-a' };
        if (val >= 70) return { rank: 'B', class: 'rank-b' };
        if (val >= 60) return { rank: 'C', class: 'rank-c' };
        if (val >= 53) return { rank: 'D', class: 'rank-d' };
        if (val >= 40) return { rank: 'E', class: 'rank-e' };
        if (val >= 20) return { rank: 'F', class: 'rank-f' };
        return { rank: 'G', class: 'rank-g' };
    }
    
    function updateRankDisplay(id, val) {
        const r = getRank(val);
        const labelEl = document.getElementById(`val-${id}`);
        const fillEl = document.getElementById(`fill-${id}`);
        
        if(labelEl && fillEl) {
            labelEl.innerHTML = `<span class="${r.class}" style="margin-right:8px; font-size:1.1em;">${r.rank}</span>${val}`;
            fillEl.style.width = `${val}%`;
            
            const colorMap = {
                'S': '#eab308', 'A': '#f97316', 'B': '#ef4444', 
                'C': '#f43f5e', 'D': '#10b981', 'E': '#3b82f6', 
                'F': '#64748b', 'G': '#94a3b8'
            };
            fillEl.style.background = colorMap[r.rank];
        }
    }
    
    function renderCareerCreationUI() {
        const content = document.getElementById('career-content');
        
        const isBat = careerMode === 'batter';
        const activeClassBat = isBat ? 'active' : '';
        const activeClassPit = !isBat ? 'active' : '';
    
        const params = isBat ? [
            {id:'contact', label:'ãƒŸãƒ¼ãƒˆ (Contact)', val:55, desc:'æ‰“ç‡ãƒ»ã‚³ãƒ³ã‚¿ã‚¯ãƒˆèƒ½åŠ›'},
            {id:'power', label:'ãƒ‘ãƒ¯ãƒ¼ (Power)', val:55, desc:'æœ¬å¡æ‰“ãƒ»é•·æ‰“åŠ›'},
            {id:'speed', label:'èµ°åŠ› (Speed)', val:55, desc:'ç›—å¡ãƒ»å†…é‡å®‰æ‰“ãƒ»å®ˆå‚™ç¯„å›²'},
            {id:'arm', label:'è‚©åŠ› (Arm)', val:55, desc:'è£œæ®ºãƒ»å®ˆå‚™è²¢çŒ®(UZR)'},
            {id:'defense', label:'å®ˆå‚™åŠ› (Fielding)', val:55, desc:'å¤±ç­–ç‡ãƒ»å®ˆå‚™ç¯„å›²'},
            {id:'catch', label:'æ•çƒ (Error)', val:55, desc:'å¤±ç­–å›é¿ç‡'}
        ] : [
            {id:'velocity', label:'çƒé€Ÿ (km/h)', val:145, min:120, max:170, desc:'æœ€é«˜çƒé€Ÿãƒ»å¥ªä¸‰æŒ¯ç‡'},
            {id:'control', label:'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«', val:55, desc:'ä¸å››çƒç‡ãƒ»ä¸å¯§ã•'},
            {id:'stamina', label:'ã‚¹ã‚¿ãƒŸãƒŠ', val:55, desc:'æŠ•çƒå›æ•°ãƒ»å®ŒæŠ•èƒ½åŠ›'},
            {id:'breaking', label:'å¤‰åŒ–çƒç·å¤‰åŒ–é‡', val:3, min:0, max:20, desc:'ç©ºæŒ¯ã‚Šç‡ãƒ»è¢«æ‰“ç‡'}
        ];
    
        const slidersHtml = params.map(p => {
            const isSpecial = (p.id === 'velocity' || p.id === 'breaking');
            const min = p.min || 1;
            const max = p.max || 100;
            
            let valDisplay = p.val;
            let rankHtml = '';
            
            if (!isSpecial) {
                const r = getRank(p.val);
                rankHtml = `<span class="${r.class}" style="margin-right:8px; font-size:1.1em;">${r.rank}</span>`;
            }
            
            let percent = ((p.val - min) / (max - min)) * 100;
    
            return `
                <div class="c-form-group">
                    <div class="c-rank-label">
                        <span>${p.label}</span>
                        <span id="val-${p.id}">${rankHtml}${valDisplay}</span>
                    </div>
                    <div class="c-rank-bar">
                        <div class="c-rank-fill" id="fill-${p.id}" style="width:${percent}%"></div>
                        <input type="range" id="sim-${p.id}" min="${min}" max="${max}" value="${p.val}" class="c-rank-input"
                            oninput="
                                const v = parseInt(this.value);
                                const min = ${min}, max = ${max};
                                const pct = ((v - min) / (max - min)) * 100;
                                if(${!isSpecial}) {
                                    updateRankDisplay('${p.id}', v);
                                } else {
                                    document.getElementById('val-${p.id}').innerText = v;
                                    document.getElementById('fill-${p.id}').style.width = pct + '%';
                                }
                            "
                        >
                    </div>
                </div>
            `;
        }).join('');
    
        const posOptions = isBat 
            ? `<option value="c">ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼</option><option value="1b">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ</option><option value="2b">ã‚»ã‚«ãƒ³ãƒ‰</option><option value="3b">ã‚µãƒ¼ãƒ‰</option><option value="ss">ã‚·ãƒ§ãƒ¼ãƒˆ</option><option value="cf">ã‚»ãƒ³ã‚¿ãƒ¼</option><option value="lf">ãƒ¬ãƒ•ãƒˆ</option><option value="rf">ãƒ©ã‚¤ãƒˆ</option><option value="dh">DH</option>`
            : `<option value="sp">å…ˆç™º (Starter)</option><option value="rp">æ•‘æ´ (Reliever)</option>`;
    
        content.innerHTML = `
            <div class="career-grid">
                <div class="career-panel">
                    <div class="career-title">
                        <div>
                            ${icons.save} PLAYER CREATION
                        </div>
                    </div>
                    
                    <div class="role-tabs">
                        <div class="role-tab ${activeClassBat}" onclick="setCareerMode('batter')">é‡æ‰‹</div>
                        <div class="role-tab ${activeClassPit}" onclick="setCareerMode('pitcher')">æŠ•æ‰‹</div>
                    </div>
    
                    <div class="c-form-group">
                        <label class="c-label">é¸æ‰‹å</label>
                        <input type="text" id="sim-name" class="c-input" placeholder="å…¥åŠ›ãªã—ã§ã€Œåç„¡ã—é¸æ‰‹ã€" value="">
                    </div>
    
                    <div class="c-form-group">
                        <div class="c-slider-row">
                            <span class="c-label" style="margin:0;">é–‹å§‹å¹´é½¢</span>
                            <span class="c-slider-val" id="val-age">18æ­³</span>
                        </div>
                        <input type="range" id="sim-age" min="18" max="30" value="18" class="c-slider"
                            oninput="document.getElementById('val-age').innerText = this.value + 'æ­³'">
                        <div style="font-size:0.75rem; color:#94a3b8; margin-top:5px; display:flex; justify-content:space-between;">
                            <span>é«˜å’(18)</span><span>å¤§å’(22)</span><span>ç¤¾ä¼šäºº(24~)</span>
                        </div>
                    </div>
    
                    <div class="c-form-group">
                        <label class="c-label">ãƒã‚¸ã‚·ãƒ§ãƒ³</label>
                        <select id="sim-pos" class="c-select">
                            ${posOptions}
                        </select>
                    </div>
    
                    <hr style="border:0; border-top:1px dashed #e2e8f0; margin:20px 0;">
    
                    ${slidersHtml}
    
                    <button class="calc-btn" style="background:#0f172a; margin-top:20px; box-shadow:0 4px 12px rgba(15,23,42,0.2);" onclick="runCareerSim()">
                        ã‚­ãƒ£ãƒªã‚¢ã‚¹ã‚¿ãƒ¼ãƒˆ
                    </button>
                </div>
    
                <div class="career-panel" id="career-result-panel" style="min-height:500px; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center; color:#94a3b8;">
                    <div style="font-size:3rem; margin-bottom:15px; opacity:0.3; filter:grayscale(1);">ğŸŸï¸</div>
                    <div style="font-weight:700;">PLAYER SIMULATION</div>
                    <div style="font-size:0.85rem; margin-top:8px;">
                        å·¦å´ã®ãƒ‘ãƒãƒ«ã§èƒ½åŠ›ã‚’è¨­å®šã—ã€<br>ãƒ—ãƒ­é‡çƒäººç”Ÿã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚<br>
                        èƒ½åŠ›å€¤ã¯ãƒ‘ãƒ¯ãƒ—ãƒ­é¢¨ï¼ˆSã€œGï¼‰ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚
                    </div>
                </div>
            </div>
        `;
        
        if(isBat) {
            ['contact','power','speed','arm','defense','catch'].forEach(id => updateRankDisplay(id, 55));
        } else {
            updateRankDisplay('control', 55);
            updateRankDisplay('stamina', 55);
        }
    }
    
    function runCareerSim() {
        // åå‰ãŒç©ºãªã‚‰ã€Œåç„¡ã—é¸æ‰‹ã€ã‚’è¨­å®š
        let rawName = document.getElementById('sim-name').value;
        const name = rawName.trim() === "" ? "åç„¡ã—é¸æ‰‹" : rawName;
        
        const startAge = parseInt(document.getElementById('sim-age').value);
        const pos = document.getElementById('sim-pos').value;
        const isBat = careerMode === 'batter';
    
        let stats = {};
        if (isBat) {
            ['contact', 'power', 'speed', 'arm', 'defense', 'catch'].forEach(id => {
                stats[id] = parseInt(document.getElementById(`sim-${id}`).value);
            });
        } else {
            ['velocity', 'control', 'stamina', 'breaking'].forEach(id => {
                stats[id] = parseInt(document.getElementById(`sim-${id}`).value);
            });
        }
    
        let age = startAge;
        let active = true;
        let history = [];
        let career = isBat 
            ? { g:0, pa:0, ab:0, h:0, hr:0, rbi:0, sb:0, bb:0, so:0, war:0 }
            : { g:0, ip_outs:0, w:0, l:0, sv:0, hld:0, so:0, bb:0, war:0, er:0 };
    
        let peakWar = -999;
        let peakStatsData = null;
    
        while (active && age < 46) {
            // --- æˆé•·ãƒ»è¡°é€€ ---
            let growth = 0;
            if (age < 24) growth = Math.random() * 4 + 1;
            else if (age < 28) growth = Math.random() * 2;
            else if (age < 32) growth = Math.random() * 1 - 1;
            else if (age < 36) growth = -Math.random() * 3 - 1;
            else growth = -Math.random() * 5 - 3;
    
            if (isBat) {
                Object.keys(stats).forEach(k => {
                    stats[k] = Math.max(1, Math.min(100, stats[k] + growth));
                });
            } else {
                stats.velocity = Math.max(120, Math.min(170, stats.velocity + (growth * 0.5))); 
                ['control', 'stamina', 'breaking'].forEach(k => {
                    stats[k] = Math.max(1, Math.min(100, stats[k] + growth));
                });
            }
    
            let abilityScore = 0;
            if (isBat) {
                abilityScore = (stats.contact + stats.power + stats.defense + stats.speed)/4;
            } else {
                let veloScore = (stats.velocity - 130) * 2;
                abilityScore = (veloScore + stats.control + stats.stamina + stats.breaking*5) / 4;
            }
    
            let season = {};
            let war = 0;
    
            if (abilityScore < 40) {
                // 2è»
                season = isBat 
                    ? { g:0, avg:'.---', hr:0, rbi:0, sb:0, ops:'.---', bb:0, so:0, uzr:'---' } 
                    : { g:0, w:0, l:0, sv:0, hld:0, era:'-.--', so:0, whip:'-.--', ip:'0.0' };
                war = 0;
                if (age > 25 && Math.random() < 0.3) active = false; 
            } else {
                // 1è»
                if (isBat) {
                    let games = Math.floor(Math.min(143, (abilityScore - 30) * 2.5 + Math.random()*20));
                    if(games > 143) games = 143;
                    
                    let pa = Math.floor(games * (3.5 + Math.random())); 
                    let bb_pct = 0.05 + (stats.contact * 0.0005); 
                    let bb = Math.floor(pa * bb_pct);
                    let ab = pa - bb;
    
                    let avg = 0.150 + (stats.contact * 0.002) + (Math.random()*0.04 - 0.02);
                    let h = Math.floor(ab * avg);
    
                    let hr_rate = Math.pow(stats.power, 2) / 180000;
                    let hr = Math.floor(pa * hr_rate * (0.8 + Math.random()*0.4));
    
                    let so_rate = 0.15 + (stats.power*0.0015) - (stats.contact*0.001);
                    if(so_rate < 0.05) so_rate = 0.05;
                    let so = Math.floor(pa * so_rate);
    
                    let sb = Math.floor(games * (stats.speed > 60 ? (stats.speed-50)*0.02 : 0) * Math.random());
                    let rbi = Math.floor(h*0.15 + hr*2.8 + Math.random()*10);
    
                    let obp = pa>0 ? (h+bb)/pa : 0;
                    let slg = ab>0 ? (h + hr*3)/ab : 0; 
                    let ops = obp + slg;
                    
                    let defScore = (stats.defense*2 + stats.arm + stats.catch)/4;
                    let uzr = (defScore - 50) * 0.5; 
                    let posVal = {'ss':1, '2b':0.8, 'cf':0.5, '3b':0, 'rf':-0.5, 'lf':-0.8, '1b':-1, 'dh':-1.5, 'c':1.2}[pos] || 0;
                    let effectiveUzr = uzr * (games/143);
    
                    let wRAA = ((ops - 0.730) / 1.2) * pa * 0.1; 
                    let rep = 20 * (pa/600);
                    let posAdj = posVal * 10 * (games/143);
                    war = (wRAA + effectiveUzr + posAdj + rep) / 10;
                    if(war > 12) war = 12;
    
                    let opsStr = ops.toFixed(3);
                    if(ops < 1.0) opsStr = opsStr.replace(/^0/, ''); 
    
                    season = { g:games, avg: avg.toFixed(3).replace(/^0/,''), hr, rbi, sb, bb, so, ops: opsStr, uzr: effectiveUzr.toFixed(1) };
                    
                    career.g += games; career.pa += pa; career.ab += ab; career.h += h; 
                    career.hr += hr; career.rbi += rbi; career.sb += sb; career.bb += bb; career.so += so;
                } else {
                    let isStarter = pos === 'sp';
                    let games = isStarter ? Math.floor(Math.min(28, abilityScore/2.2)) : Math.floor(Math.min(70, abilityScore/1.1));
                    
                    let ipPerG = isStarter ? (4 + stats.stamina*0.05) : (0.5 + stats.stamina*0.01);
                    let totalIp = games * ipPerG;
                    let outs = Math.floor(totalIp * 3);
                    
                    let pitSkill = (stats.velocity-100)*1.5 + stats.control + stats.breaking*10;
                    let baseEra = 6.00 - (pitSkill * 0.03); 
                    let era = Math.max(0.80, baseEra + (Math.random()*1.5 - 0.75));
                    
                    // --- å¥ªä¸‰æŒ¯ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£ ---
                    // Velocity 130-170, Breaking 0-20
                    // K/9 = 4.0 (åŸºæº–) + çƒé€Ÿåˆ† + å¤‰åŒ–çƒåˆ†
                    // çƒé€Ÿ: 150kmåŸºæº–ã§ Â±10kmã§Â±1.5ç¨‹åº¦å¤‰å‹•
                    let k9_velo = (stats.velocity - 130) * 0.15; 
                    let k9_break = stats.breaking * 0.35;
                    let k9 = 3.5 + k9_velo + k9_break;
                    
                    // ä¸Šé™ã‚­ãƒ£ãƒƒãƒ— (K/9 ãŒ 16.0 ã‚’è¶…ãˆãªã„ã‚ˆã†ã«)
                    if(k9 > 16.0) k9 = 16.0;
    
                    let so = Math.floor(totalIp * k9 / 9);
    
                    // ç‰©ç†åˆ¶é™: å¥ªä¸‰æŒ¯æ•°ã¯ã‚¢ã‚¦ãƒˆã®ç·æ•°ã‚’è¶…ãˆãªã„
                    if(so > outs) so = outs - 1; 
    
                    let bb9 = 5.0 - (stats.control * 0.04); 
                    if(bb9<1) bb9=1;
                    let bb = Math.floor(totalIp * bb9 / 9);
    
                    let whip = 1.30 + (era - 3.50)*0.1; 
    
                    let w=0, l=0, sv=0, hld=0;
                    if(isStarter) {
                        let winPct = 0.5 - (era - 3.50)*0.15;
                        let dec = games * 0.9;
                        w = Math.max(0, Math.floor(dec * winPct));
                        l = Math.max(0, Math.floor(dec * (1-winPct)));
                    } else {
                        w = Math.floor(games * 0.1);
                        l = Math.floor(games * 0.1);
                        if (stats.velocity >= 150 || stats.breaking >= 10) {
                            sv = Math.floor(games * 0.6);
                        } else {
                            hld = Math.floor(games * 0.5);
                        }
                    }
    
                    let fip = era; 
                    let raa = (4.50 - fip) * (totalIp/9);
                    let rep = 20 * (totalIp/200);
                    war = (raa + rep) / 10;
    
                    let ipDisplay = Math.floor(outs/3) + (outs%3 === 0 ? "" : "." + (outs%3));
    
                    season = { g:games, w, l, sv, hld, era: era.toFixed(2), so, whip: whip.toFixed(2), ip: ipDisplay };
                    
                    career.g += games; career.ip_outs += outs; career.w += w; career.l += l; 
                    career.sv += sv; career.hld += hld; career.so += so; career.bb += bb; 
                    career.er += (era * (outs/3) / 9);
                }
            }
            
            career.war += war;
            history.push({ age, ...season, war: war.toFixed(1) });
    
            if (war > peakWar) {
                peakWar = war;
                window.tempPeakStats = isBat ? {
                    name: `${name} (${age}æ­³)`,
                    pa: Math.floor(season.g*4), ab: Math.floor(season.g*4)-season.bb, 
                    h: Math.floor((season.g*4-season.bb) * parseFloat(season.avg)), 
                    hr: season.hr, sb: season.sb, bb: season.bb, so: season.so,
                    stadium: 'avg', pos: pos
                } : {
                    name: `${name} (${age}æ­³)`,
                    ip: parseFloat(season.ip), 
                    er: Math.floor(parseFloat(season.ip)*parseFloat(season.era)/9),
                    so: season.so, bb: Math.floor(season.so/3), 
                    h: Math.floor(season.so*0.8), hr: Math.floor(season.so/10),
                    role: pos, stadium: 'avg'
                };
            }
    
            age++;
            if (age >= 45) active = false;
            if (age > 30 && war < 0 && Math.random() < 0.5) active = false;
        }
    
        const resultPanel = document.getElementById('career-result-panel');
        
        let bigStats = '';
        if (isBat) {
            let careerAvg = career.ab ? (career.h / career.ab).toFixed(3).replace(/^0/,'') : '.---';
            bigStats = `
                <div class="c-big-stat"><div class="c-big-val">${career.h}</div><div class="c-big-lbl">å®‰æ‰“</div></div>
                <div class="c-big-stat"><div class="c-big-val">${career.hr}</div><div class="c-big-lbl">æœ¬å¡æ‰“</div></div>
                <div class="c-big-stat"><div class="c-big-val">${careerAvg}</div><div class="c-big-lbl">æ‰“ç‡</div></div>
                <div class="c-big-stat"><div class="c-big-val">${career.sb}</div><div class="c-big-lbl">ç›—å¡</div></div>
                <div class="c-big-stat"><div class="c-big-val" style="color:#d97706;">${career.war.toFixed(1)}</div><div class="c-big-lbl">é€šç®—WAR</div></div>
            `;
        } else {
            let careerIp = Math.floor(career.ip_outs/3) + (career.ip_outs%3===0 ? "" : "." + (career.ip_outs%3));
            bigStats = `
                <div class="c-big-stat"><div class="c-big-val">${career.w}</div><div class="c-big-lbl">å‹åˆ©</div></div>
                <div class="c-big-stat"><div class="c-big-val">${career.sv}</div><div class="c-big-lbl">ã‚»ãƒ¼ãƒ–</div></div>
                <div class="c-big-stat"><div class="c-big-val">${career.so}</div><div class="c-big-lbl">å¥ªä¸‰æŒ¯</div></div>
                <div class="c-big-stat"><div class="c-big-val">${careerIp}</div><div class="c-big-lbl">æŠ•çƒå›</div></div>
                <div class="c-big-stat"><div class="c-big-val" style="color:#d97706;">${career.war.toFixed(1)}</div><div class="c-big-lbl">é€šç®—WAR</div></div>
            `;
        }
    
        const th = isBat 
            ? `<th>å¹´é½¢</th><th>è©¦åˆ</th><th>æ‰“ç‡</th><th>HR</th><th>æ‰“ç‚¹</th><th>ç›—å¡</th><th>å››çƒ</th><th>ä¸‰æŒ¯</th><th>OPS</th><th>UZR</th><th>WAR</th>`
            : `<th>å¹´é½¢</th><th>ç™»æ¿</th><th>å‹</th><th>æ•—</th><th>S</th><th>H</th><th>å›</th><th>é˜²ç‡</th><th>å¥ªä¸‰æŒ¯</th><th>WHIP</th><th>WAR</th>`;
    
        const rows = history.map(h => {
            const w = parseFloat(h.war);
            const style = w >= 5.0 ? 'background:#fff7ed;' : '';
            const warClass = w >= 8.0 ? 'val-outstanding' : (w >= 5.0 ? 'val-great' : (w >= 2.0 ? 'val-good' : ''));
            
            if (isBat) {
                return `<tr style="${style}">
                    <td>${h.age}</td><td>${h.g}</td><td>${h.avg}</td><td>${h.hr}</td><td>${h.rbi}</td><td>${h.sb}</td>
                    <td>${h.bb}</td><td>${h.so}</td><td>${h.ops}</td><td>${h.uzr}</td>
                    <td class="${warClass}">${h.war}</td>
                </tr>`;
            } else {
                return `<tr style="${style}">
                    <td>${h.age}</td><td>${h.g}</td><td>${h.w}</td><td>${h.l}</td><td>${h.sv}</td><td>${h.hld}</td>
                    <td>${h.ip}</td><td>${h.era}</td><td>${h.so}</td><td>${h.whip}</td>
                    <td class="${warClass}">${h.war}</td>
                </tr>`;
            }
        }).join('');
    
        resultPanel.innerHTML = `
            <div style="width:100%;">
                <div class="career-title" style="justify-content:center; border:none; font-size:1.5rem;">
                    ${name} <span style="font-size:0.9rem; font-weight:normal; margin-left:10px; color:#64748b;">${pos.toUpperCase()} / ${history.length}å¹´</span>
                </div>
                
                <div class="c-result-header">
                    ${bigStats}
                </div>
                
                <div class="c-history-wrap">
                    <table class="c-table">
                        <thead><tr>${th}</tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
    
                <div style="margin-top:20px; text-align:center;">
                    <button class="calc-btn" style="background:#3b82f6; width:auto; padding:10px 30px;" onclick="savePeakStats()">
                        å…¨ç››æœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    </button>
                </div>
            </div>
        `;
    }

    // Initial Render
    render();

</script>

<style>
    /* --- Settings & Variables --- */
    :root {
        --g-node-size: 85px;
        --g-focus-size: 320px; /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚µã‚¤ã‚º */
        --g-font-size: 0.85rem;
    }
    @media (max-width: 768px) {
        :root {
            --g-node-size: 65px;
            --g-focus-size: 280px;
            --g-font-size: 0.75rem;
        }
        /* ãƒ¢ãƒã‚¤ãƒ«è»½é‡åŒ–: å½±ã¨ãƒ–ãƒ©ãƒ¼ã‚’å‰Šé™¤ */
        .g-node {
            box-shadow: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            background: rgba(30, 41, 59, 0.98) !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
        }
        .g-node.is-focused {
            box-shadow: 0 0 40px rgba(0,0,0,0.5) !important;
        }
    }

    /* --- Space Environment --- */
    #galaxy-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: radial-gradient(ellipse at center, #1e293b 0%, #020617 100%);
        z-index: 9999;
        visibility: hidden; opacity: 0;
        transform: scale(1.1);
        transition: opacity 0.5s, transform 0.5s, visibility 0.5s;
        overflow: hidden;
        cursor: grab;
        touch-action: none;
        user-select: none;
        -webkit-user-select: none;
        /* ãƒ•ã‚©ãƒ³ãƒˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ– */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    #galaxy-overlay.active { visibility: visible; opacity: 1; transform: scale(1); }
    #galaxy-overlay:active { cursor: grabbing; }

    /* Canvas Starfield (Max Performance) */
    #starfield-canvas {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 0;
    }

    /* --- Universe Wrapper --- */
    #galaxy-universe {
        position: absolute; top: 50%; left: 50%; width: 0; height: 0;
        transform-style: preserve-3d;
        /* é€šå¸¸æ™‚ã¯ will-change ã‚’å¤–ã—ã¦é«˜ç”»è³ªç¶­æŒ */
    }
    /* æ“ä½œä¸­ã®ã¿GPUåˆæˆã‚’å¼·åˆ¶ã—ã¦æ»‘ã‚‰ã‹ã«ã™ã‚‹ */
    #galaxy-universe.is-interacting {
        will-change: transform;
    }

    /* --- Cosmos Container --- */
    #galaxy-cosmos {
        position: absolute; top: 0; left: 0; width: 0; height: 0;
        transform-style: preserve-3d;
    }
    
    /* Launch Animation */
    .launching #galaxy-cosmos {
        animation: galaxyLaunch 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }
    @keyframes galaxyLaunch {
        0% { transform: scale(0) rotate(45deg); opacity: 0; }
        100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    /* --- Nodes --- */
    .g-node {
        position: absolute;
        /* ã‚µã‚¤ã‚ºå¤‰æ›´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ– */
        width: var(--g-node-size); height: var(--g-node-size);
        transform: translate(-50%, -50%) scale(0);
        border-radius: 50%;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        text-align: center; cursor: pointer;
        
        /* width/heightã®é·ç§»ã‚’è¿½åŠ ã—ã¦ã‚¯ãƒƒã‚­ãƒªæ‹¡å¤§ã‚’å®Ÿç¾ */
        transition: 
            width 0.4s cubic-bezier(0.19, 1, 0.22, 1),
            height 0.4s cubic-bezier(0.19, 1, 0.22, 1),
            transform 0.4s cubic-bezier(0.19, 1, 0.22, 1),
            opacity 0.3s, filter 0.3s;
            
        box-shadow: 0 0 15px rgba(0,0,0,0.3), inset 0 0 10px rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.2);
        z-index: 10;
        background: rgba(30, 41, 59, 0.85);
        color: #94a3b8;
        font-weight: 700;
        font-size: var(--g-font-size);
        touch-action: none;
        animation: nodePop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        animation-play-state: paused;
        
        /* ãƒ†ã‚­ã‚¹ãƒˆã®æ»²ã¿ã‚’é˜²æ­¢ */
        transform-style: flat; 
    }
    @keyframes nodePop {
        from { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    @media (hover: hover) {
        .g-node:hover {
            z-index: 50;
            border-color: white; color: white;
            box-shadow: 0 0 25px rgba(255,255,255,0.25);
            /* ãƒ›ãƒãƒ¼æ™‚ã¯Scaleã§æ‹¡å¤§ï¼ˆä¸€æ™‚çš„ãªã®ã§OKï¼‰ */
            transform: translate(-50%, -50%) scale(1.15);
        }
    }

    .g-node.is-dimmed {
        opacity: 0.1 !important;
        transform: translate(-50%, -50%) scale(0.8) !important;
        pointer-events: none;
        filter: grayscale(100%);
    }
    
    .g-node.is-related {
        opacity: 1 !important;
        border-color: rgba(255,255,255,0.9);
        z-index: 40;
    }
    @media (min-width: 769px) { .g-node.is-related { box-shadow: 0 0 20px rgba(255,255,255,0.2); } }

    /* Focused State - High Resolution Mode */
    .g-node.is-focused {
        /* Scaleã§ã¯ãªãWidth/Heightã§æ‹¡å¤§ã™ã‚‹ã“ã¨ã§å†æç”»ã‚’ä¿ƒã—é«˜ç”»è³ªåŒ– */
        width: var(--g-focus-size); height: var(--g-focus-size);
        z-index: 100;
        background: rgba(15, 23, 42, 0.98) !important;
        border: 2px solid rgba(255,255,255,0.6) !important;
        transform: translate(-50%, -50%) scale(1) !important; /* Scaleã¯1ã«æˆ»ã™ */
        cursor: default;
        box-shadow: 0 0 60px rgba(0,0,0,0.6) !important;
    }
    
    .g-content-normal { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; transition: opacity 0.2s; }
    .g-node.is-focused .g-content-normal { display: none; opacity: 0; }

    .g-content-focus {
        display: none; opacity: 0; width: 100%; height: 100%;
        flex-direction: column; align-items: center; justify-content: center;
        padding: 25px; box-sizing: border-box;
    }
    .g-node.is-focused .g-content-focus { display: flex; opacity: 1; animation: fadeIn 0.4s ease 0.1s forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Focus Content - Optimized Sizes */
    .gf-icon svg { width: 48px; height: 48px; margin-bottom: 10px; opacity: 1; }
    .gf-title { font-size: 1.8rem; font-weight: 900; line-height: 1.1; margin-bottom: 5px; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    .gf-full { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8; margin-bottom: 12px; color: #cbd5e1; }
    .gf-desc { font-size: 0.85rem; line-height: 1.5; color: #e2e8f0; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; white-space: normal; }
    .gf-btn { 
        padding: 10px 24px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.4); 
        background: rgba(255,255,255,0.15); color: white; cursor: pointer; 
        font-size: 0.9rem; font-weight: bold; pointer-events: auto; z-index: 200; position: relative;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .gf-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }
    
    @media (max-width: 768px) { 
        .gf-title { font-size: 1.5rem; } 
        .gf-desc { font-size: 0.8rem; -webkit-line-clamp: 4; } 
        .gf-icon svg { width: 36px; height: 36px; }
    }
    .g-node .icon-normal svg { width: 28px; height: 28px; margin-bottom: 4px; opacity: 0.8; }
    
    /* Lines */
    #galaxy-lines { position: absolute; top: -5000px; left: -5000px; width: 10000px; height: 10000px; pointer-events: none; z-index: 1; }
    .g-line { stroke: rgba(255,255,255,0.15); stroke-width: 1.5; transition: opacity 0.3s; opacity: 0; shape-rendering: geometricPrecision; }
    .active .g-line { animation: lineFadeIn 1s 0.5s forwards; }
    @keyframes lineFadeIn { to { opacity: 1; } }
    .g-line.is-dimmed { opacity: 0.02 !important; }
    .g-line.is-related { stroke: rgba(255,255,255,0.6); stroke-width: 2.0; opacity: 1 !important; }

    /* Category Colors */
    .g-cat-bat { border-color: rgba(14, 165, 233, 0.4); } .g-cat-bat.is-focused { border-color: #0ea5e9; } .g-cat-bat .icon-normal { color: #0ea5e9; }
    .g-cat-pit { border-color: rgba(244, 63, 94, 0.4); } .g-cat-pit.is-focused { border-color: #f43f5e; } .g-cat-pit .icon-normal { color: #f43f5e; }
    .g-cat-fld { border-color: rgba(217, 119, 6, 0.4); } .g-cat-fld.is-focused { border-color: #d97706; } .g-cat-fld .icon-normal { color: #d97706; }
    .g-cat-tot { border-color: rgba(16, 185, 129, 0.4); } .g-cat-tot.is-focused { border-color: #10b981; } .g-cat-tot .icon-normal { color: #10b981; }

    /* Controls */
    .galaxy-controls {
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã®ç«¶åˆã‚’é¿ã‘ã‚‹ãŸã‚ã€marginã«ã‚ˆã‚‹ä¸­å¤®å¯„ã›ã«å¤‰æ›´ */
        position: absolute; 
        bottom: 30px; 
        left: 0; 
        right: 0; 
        margin: 0 auto; 
        width: max-content; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…ã«åˆã‚ã›ã‚‹ */
        
        display: flex; gap: 12px; z-index: 1000;
        padding: 8px 16px; border-radius: 40px;
        background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.15);
        opacity: 0; animation: fadeIn 1s 0.5s forwards;
    }
    .g-btn {
        background: transparent; border: none; color: rgba(255,255,255,0.8); padding: 0; border-radius: 50%; cursor: pointer;
        width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
    }
    .g-btn svg { width: 22px; height: 22px; stroke-width: 2; }
    .g-btn.close { color: #f43f5e; }
    @media (max-width: 768px) {
        .galaxy-controls {
            /* === é…ç½®ã®ä¿®æ­£ === */
            top: auto !important;           /* ä¸Šå›ºå®šã‚’è§£é™¤ */
            bottom: 30px !important;        /* ä¸‹ã‹ã‚‰30pxã®ä½ç½®ã« */
            right: auto !important;         /* å³å¯„ã›ã‚’è§£é™¤ */
            
            /* ã€é‡è¦ã€‘å·¦ç«¯ã‚’ç”»é¢ä¸­å¤®(50%)ã«ç½®ã„ãŸå¾Œã€è‡ªèº«ã®å¹…ã®åŠåˆ†(-50%)ã ã‘å·¦ã«æˆ»ã™ */
            left: 50% !important;
            transform: translateX(-50%) !important;
            
            /* === è¦‹ãŸç›®ã®èª¿æ•´ === */
            padding: 8px 16px;              /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„ã‚ˆã†å°‘ã—åºƒã‚ã« */
            border-radius: 30px;            /* ä¸¸ã¿ã‚’å¼·ã‚ã‚‹ */
            width: max-content;             /* å†…å®¹å¹…ã«åˆã‚ã›ã‚‹ */
            max-width: 90%;                 /* ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
        }
    }
</style>

<div id="galaxy-overlay">
    <div id="galaxy-universe">
        <div id="galaxy-cosmos">
            <svg id="galaxy-lines"></svg>
            <div id="galaxy-nodes"></div>
        </div>
    </div>
    <div class="galaxy-controls">
        <button class="g-btn" onclick="zoomIn()" title="æ‹¡å¤§"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></svg></button>
        <button class="g-btn" onclick="zoomOut()" title="ç¸®å°"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="8" x2="16" y1="12" y2="12"/></svg></button>
        <button class="g-btn" onclick="fitToScreen()" title="ãƒªã‚»ãƒƒãƒˆ"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M16 3h3a2 2 0 0 1 2 2v3"/><path d="M8 21H5a2 2 0 0 1-2-2v-3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg></button>
        <div style="width:1px; height:24px; background:rgba(255,255,255,0.2); margin:auto 5px;"></div>
        <button class="g-btn close" onclick="closeMindMap()" title="é–‰ã˜ã‚‹"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
    </div>
</div>

<div id="career-overlay">
    <div class="career-header">
        <div class="career-brand">MY CAREER <span>SIMULATION</span></div>
        <button class="g-btn close" onclick="closeCareerSim()" title="é–‰ã˜ã‚‹">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
    </div>
    <div class="career-content" id="career-content">
        </div>
</div>

<script>
    const gOverlay = document.getElementById('galaxy-overlay');
    const gUniverse = document.getElementById('galaxy-universe');
    const gNodesContainer = document.getElementById('galaxy-nodes');
    const gLines = document.getElementById('galaxy-lines');

    let isInitialized = false;
    let nodesData = [];
    let viewState = { 
        scale: 0.35, panX: 0, panY: 0, 
        isDragging: false, lastX: 0, lastY: 0, 
        isPinching: false, pinchStartDist: 0, pinchStartScale: 1,
        suppressClick: false
    };
    const MAX_SCALE = 1.2; const MIN_SCALE = 0.35;

    const CATEGORY_CENTERS = { 'tot': { x: 0, y: 0 }, 'std': { x: 0, y: -450 }, 'bat': { x: 800, y: 0 }, 'pit': { x: -800, y: 0 }, 'fld': { x: 0, y: 650 } };
    const extraRelations = {
        'avg': ['obp', 'slg', 'ops', 'babip', 'woba'], 'obp': ['avg', 'slg', 'ops', 'bb_pct', 'isod', 'woba'], 'slg': ['avg', 'obp', 'ops', 'iso', 'hr_ab', 'woba'],
        'ops': ['avg', 'obp', 'slg', 'woba', 'wrc_plus'], 'woba': ['ops', 'wrc_plus', 'wrc', 'wraa', 'xwoba'], 'wrc_plus': ['woba', 'wraa', 'war'],
        'war': ['wraa', 'uzr', 'wsb', 'bsr', 'fip', 'pit_war'], 'bb_pct': ['k_pct', 'bb_k', 'isod'], 'k_pct': ['bb_pct', 'bb_k'],
        'era': ['fip', 'xfip', 'siera', 'ra9'], 'fip': ['era', 'xfip', 'siera', 'k_pct_pit'], 'xfip': ['fip', 'siera', 'gb_pct'], 'siera': ['fip', 'xfip'],
        'uzr': ['drs', 'oaa', 'rngr'], 'drs': ['uzr', 'oaa'], 'oaa': ['uzr', 'drs']
    };
    const gIcons = {
        bat: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M2 17 17 2"/><path d="m2 2 20 20"/><path d="m19 2 2 2"/><path d="m2 19 2 2"/><path d="m10 2 2 2"/><path d="m2 10 2 2"/></svg>`,
        pit: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>`,
        fld: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>`,
        tot: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
        std: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="2" y2="22"/><line x1="2" x2="22" y1="12" y2="12"/></svg>`
    };

    function initGalaxy() {
        if (isInitialized) return;
        terms.forEach(t => {
            if(!t.related) t.related = [];
            if(extraRelations[t.id]) extraRelations[t.id].forEach(rid => { if(!t.related.includes(rid)) t.related.push(rid); });
        });
        terms.forEach(t => {
            t.related.forEach(rid => {
                const target = terms.find(x => x.id === rid);
                if(target && (!target.related || !target.related.includes(t.id))) {
                    if(!target.related) target.related = []; target.related.push(t.id);
                }
            });
        });

        nodesData = terms.map(t => {
            const center = CATEGORY_CENTERS[t.category] || {x:0, y:0};
            const angle = Math.random() * Math.PI * 2;
            const dist = Math.random() * 320;
            return { ...t, x: center.x + Math.cos(angle)*dist, y: center.y + Math.sin(angle)*dist, links: t.related||[] };
        });

        const NODE_RADIUS = 140;
        for(let k=0; k<50; k++){
            for(let i=0; i<nodesData.length; i++){
                for(let j=i+1; j<nodesData.length; j++){
                    const n1 = nodesData[i], n2 = nodesData[j];
                    const dx = n1.x - n2.x, dy = n1.y - n2.y;
                    const d = Math.sqrt(dx*dx+dy*dy);
                    if(d < NODE_RADIUS){
                        const f = (NODE_RADIUS - d)/(d||1)*0.5;
                        const mx = dx*f, my = dy*f;
                        n1.x+=mx; n1.y+=my; n2.x-=mx; n2.y-=my;
                    }
                }
            }
        }

        renderLines();
        nodesData.forEach(node => createNodeElement(node));
        isInitialized = true;
    }

    function renderLines() {
        const pairs = new Set(); let html = '';
        nodesData.forEach(source => {
            if(!source.links) return;
            source.links.forEach(targetId => {
                const target = nodesData.find(n => n.id === targetId);
                if(target){
                    const pairId = [source.id, target.id].sort().join('-');
                    if(!pairs.has(pairId)){
                        const x1=5000+source.x, y1=5000+source.y, x2=5000+target.x, y2=5000+target.y;
                        html += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" class="g-line" data-src="${source.id}" data-tgt="${target.id}" />`;
                        pairs.add(pairId);
                    }
                }
            });
        });
        gLines.innerHTML = html;
    }

    function createNodeElement(node) {
        const el = document.createElement('div');
        el.className = `g-node g-cat-${node.category}`;
        el.id = `g-node-${node.id}`;
        el.style.left = `${node.x}px`;
        el.style.top = `${node.y}px`;
        el.style.animationDelay = `${Math.random() * 0.8 + 0.1}s`;

        const iconSvg = gIcons[node.category] || gIcons.std;
        
        el.innerHTML = `
            <div class="g-content-normal"><div class="icon-normal">${iconSvg}</div><div>${node.title}</div></div>
            <div class="g-content-focus">
                <div class="gf-icon">${iconSvg}</div>
                <div class="gf-title">${node.title}</div>
                <div class="gf-full">${node.full}</div>
                <div class="gf-desc">${node.short || '...'}</div>
                <button class="gf-btn" onclick="closeMindMap(); openModal('${node.id}')">è©³ç´°ãƒ»è¨ˆç®—</button>
            </div>
        `;

        const handleTap = (e) => {
            if (e.target.closest('.gf-btn')) return; 
            if(viewState.isDragging || viewState.suppressClick) return;
            e.stopPropagation();
            if(e.type === 'touchend') e.preventDefault();
            activateNode(node);
        };
        el.onclick = handleTap;
        el.ontouchend = handleTap;
        gNodesContainer.appendChild(el);
    }

    function activateNode(node) {
        resetFocus();
        const currentId = node.id;
        const relatedIds = node.links || [];
        
        document.querySelectorAll('.g-node').forEach(el => {
            const elId = el.id.replace('g-node-', '');
            if(elId === currentId) el.classList.add('is-focused');
            else if(relatedIds.includes(elId)) el.classList.add('is-related');
            else el.classList.add('is-dimmed');
        });

        document.querySelectorAll('.g-line').forEach(line => {
            const src = line.getAttribute('data-src'), tgt = line.getAttribute('data-tgt');
            if((src===currentId && relatedIds.includes(tgt)) || (tgt===currentId && relatedIds.includes(src))) line.classList.add('is-related');
            else line.classList.add('is-dimmed');
        });

        // æ‹¡å¤§è¡¨ç¤ºæ™‚ã¯ã‚ºãƒ¼ãƒ ã‚’æœ€å¤§ã«ã—ã¦è¦–èªæ€§ã‚’é«˜ã‚ã‚‹
        animateView(-node.x, -node.y, MAX_SCALE);
    }

    function resetFocus() {
        document.querySelectorAll('.g-node').forEach(el => el.classList.remove('is-focused', 'is-related', 'is-dimmed'));
        document.querySelectorAll('.g-line').forEach(el => el.classList.remove('is-related', 'is-dimmed'));
    }

    gOverlay.addEventListener('click', (e) => {
        if(viewState.isDragging || viewState.suppressClick) return;
        if(e.target.closest('.g-node') || e.target.closest('.galaxy-controls')) return;
        resetFocus();
    });

    function animateView(targetX, targetY, targetScale) {
        gUniverse.classList.add('is-interacting'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®ã¿è»½é‡åŒ–
        gUniverse.style.transition = 'transform 0.6s cubic-bezier(0.19, 1, 0.22, 1)';
        viewState.panX = targetX; viewState.panY = targetY; viewState.scale = targetScale;
        updateTransform();
        setTimeout(() => { 
            gUniverse.style.transition = 'none'; 
            gUniverse.classList.remove('is-interacting'); // ã‚¢ãƒ‹ãƒ¡çµ‚äº†å¾Œã«é«˜ç”»è³ªåŒ–
        }, 600);
    }

    function openMindMap() {
        initGalaxy();
        gOverlay.classList.add('active');
        gOverlay.classList.add('launching');
        document.querySelectorAll('.g-node').forEach(el => { el.style.animationPlayState = 'running'; });
        fitToScreen();
        setTimeout(() => { gOverlay.classList.remove('launching'); }, 1500);
    }

    function closeMindMap() { gOverlay.classList.remove('active'); resetFocus(); }
    
    function updateTransform() { gUniverse.style.transform = `translate(${viewState.panX}px, ${viewState.panY}px) scale(${viewState.scale})`; }
    
    function fitToScreen() {
        viewState.panX = 0; viewState.panY = 0;
        const minDim = Math.min(window.innerWidth, window.innerHeight);
        viewState.scale = Math.max(minDim / 1500, MIN_SCALE);
        gUniverse.style.transition = 'transform 0.6s ease';
        updateTransform();
        setTimeout(() => { gUniverse.style.transition = 'none'; }, 600);
        resetFocus();
    }
    function zoomIn() { viewState.scale = Math.min(viewState.scale * 1.3, MAX_SCALE); animateView(viewState.panX, viewState.panY, viewState.scale); }
    function zoomOut() { viewState.scale = Math.max(viewState.scale / 1.3, MIN_SCALE); animateView(viewState.panX, viewState.panY, viewState.scale); }

    /* Performance Control & Interaction */
    const startInteraction = () => { gUniverse.style.transition = 'none'; gUniverse.classList.add('is-interacting'); };
    const endInteraction = () => { setTimeout(() => { gUniverse.classList.remove('is-interacting'); }, 100); };

    function getDistance(touches) {
        const dx = touches[0].clientX - touches[1].clientX, dy = touches[0].clientY - touches[1].clientY;
        return Math.sqrt(dx*dx + dy*dy);
    }
    gOverlay.addEventListener('wheel', (e) => { 
        e.preventDefault(); startInteraction();
        const delta = e.deltaY * -0.001; 
        viewState.scale = Math.min(Math.max(MIN_SCALE, viewState.scale+delta), MAX_SCALE); 
        updateTransform();
        clearTimeout(window.wheelTimer); window.wheelTimer = setTimeout(endInteraction, 150);
    }, {passive:false});

    const handleStart = (x, y) => { if(viewState.isPinching)return; viewState.isDragging = false; viewState.lastX = x; viewState.lastY = y; startInteraction(); };
    const handleMove = (x, y) => {
        if(viewState.isPinching)return;
        const dx = x - viewState.lastX, dy = y - viewState.lastY;
        if(Math.abs(dx)>3 || Math.abs(dy)>3) viewState.isDragging = true;
        if(viewState.isDragging){ viewState.panX += dx; viewState.panY += dy; updateTransform(); }
        viewState.lastX = x; viewState.lastY = y;
    };

    gOverlay.addEventListener('mousedown', (e) => { if(e.target.closest('.galaxy-controls'))return; handleStart(e.clientX, e.clientY); gOverlay.style.cursor = 'grabbing'; });
    window.addEventListener('mousemove', (e) => { if(gOverlay.style.cursor === 'grabbing') handleMove(e.clientX, e.clientY); });
    window.addEventListener('mouseup', () => { gOverlay.style.cursor = 'grab'; endInteraction(); setTimeout(()=>viewState.isDragging=false, 50); });

    gOverlay.addEventListener('touchstart', (e) => {
        if(e.target.closest('.galaxy-controls'))return;
        if(e.touches.length===2){ viewState.isPinching=true; viewState.pinchStartDist=getDistance(e.touches); viewState.pinchStartScale=viewState.scale; startInteraction(); }
        else if(e.touches.length===1){ viewState.isPinching=false; handleStart(e.touches[0].clientX, e.touches[0].clientY); }
    }, {passive:false});
    window.addEventListener('touchmove', (e) => {
        if(e.touches.length===2 && viewState.isPinching){
            const dist = getDistance(e.touches); const scaleChange = dist/viewState.pinchStartDist;
            viewState.scale = Math.min(Math.max(MIN_SCALE, viewState.pinchStartScale*scaleChange), MAX_SCALE);
            updateTransform(); e.preventDefault();
        } else if(e.touches.length===1 && !viewState.isPinching) handleMove(e.touches[0].clientX, e.touches[0].clientY);
    }, {passive:false});
    window.addEventListener('touchend', (e) => {
        if(e.touches.length<2) { if(viewState.isPinching) { viewState.suppressClick = true; setTimeout(() => { viewState.suppressClick = false; }, 300); } viewState.isPinching=false; }
        endInteraction(); setTimeout(()=>viewState.isDragging=false, 50);
    });

    function drawStars() {
        const cvs = document.getElementById('starfield-canvas'), ctx = cvs.getContext('2d');
        const setSize = () => { cvs.width = window.innerWidth; cvs.height = window.innerHeight; render(); };
        window.addEventListener('resize', setSize);
        const stars = []; const numStars = window.innerWidth < 768 ? 60 : 150;
        for(let i=0; i<numStars; i++) stars.push({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, r: Math.random()*1.5, a: Math.random() });
        setSize();
        function render() {
            ctx.clearRect(0,0,cvs.width,cvs.height); ctx.fillStyle = "white";
            stars.forEach(s => { ctx.globalAlpha = s.a; ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill(); });
        }
    }
</script>

<script>
    // PWA Service Worker ç™»éŒ²ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful:', registration.scope);
                    
                    // æ›´æ–°ãŒè¦‹ã¤ã‹ã£ãŸã‚‰å³åº§ã«åæ˜ ã‚’ä¿ƒã™
                    registration.onupdatefound = () => {
                        const installingWorker = registration.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    console.log('New content is available; please refresh.');
                                } else {
                                    console.log('Content is cached for offline use.');
                                }
                            }
                        };
                    };
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed:', err);
                });
        });
        
        // æ›´æ–°æ™‚ã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹å‡¦ç†
        let refreshing;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (refreshing) return;
            refreshing = true;
            window.location.reload();
        });
    }
</script>

</body>
</html>
