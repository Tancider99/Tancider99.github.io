<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SABR METRICS LAB | Ultimate Calculator Edition</title>
    <style>
        /* --- Design Tokens --- */
        :root {
            --c-bg: #f8fafc;
            --c-surface: #ffffff;
            --c-text-primary: #1e293b;
            --c-text-secondary: #64748b;
            --c-border: #e2e8f0;
            
            /* Category Colors & Accents */
            --cat-bat: #0ea5e9; --bg-bat: #f0f9ff; /* Sky Blue */
            --cat-pit: #f43f5e; --bg-pit: #fff1f2; /* Rose */
            --cat-fld: #d97706; --bg-fld: #fffbeb; /* Amber */
            --cat-tot: #10b981; --bg-tot: #ecfdf5; /* Emerald */
            --cat-std: #6366f1; --bg-std: #eef2ff; /* Indigo */
            --data-source-color: #4b5563;
            --ai-color: #8b5cf6;
            
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-float: 0 10px 40px -10px rgba(0, 0, 0, 0.15);

            --font-sans: "Inter", "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            --font-mono: "JetBrains Mono", "Fira Code", Consolas, monospace;
            --font-serif: "Times New Roman", Times, serif; /* For Formulas */
        }

        /* --- Dark Mode Overrides --- */
        body.dark-mode {
            --c-bg: #0f172a;
            --c-surface: #1e293b;
            --c-text-primary: #f1f5f9;
            --c-text-secondary: #94a3b8;
            --c-border: #334155;
            
            --bg-bat: rgba(14, 165, 233, 0.15);
            --bg-pit: rgba(244, 63, 94, 0.15);
            --bg-fld: rgba(245, 158, 11, 0.15);
            --bg-tot: rgba(16, 185, 129, 0.15);
            --bg-std: rgba(99, 102, 241, 0.15);
            
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        body {
            background-color: var(--c-bg);
            color: var(--c-text-primary);
            font-family: var(--font-sans);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            overflow-y: scroll;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Header --- */
        header {
            background: var(--c-surface);
            padding: 4rem 2rem;
            text-align: center;
            position: relative;
            border-bottom: 1px solid var(--c-border);
            background-image: radial-gradient(var(--c-border) 1px, transparent 1px);
            background-size: 20px 20px;
            transition: background-color 0.3s;
        }

        .brand {
            font-size: 3.5rem;
            font-weight: 900;
            letter-spacing: -0.05em;
            margin: 0;
            color: var(--c-text-primary);
            background: linear-gradient(135deg, var(--c-text-primary) 0%, var(--c-text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .brand span { color: var(--cat-bat); -webkit-text-fill-color: var(--cat-bat); }
        
        .subtitle {
            color: var(--c-text-secondary);
            margin-top: 1rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        /* --- Sticky Controls --- */
        .controls-area {
            position: sticky;
            top: 0;
            background: var(--c-surface);
            opacity: 0.98;
            backdrop-filter: blur(12px);
            z-index: 100;
            border-bottom: 1px solid var(--c-border);
            padding: 1rem 0;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .search-wrapper {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            margin: 0 0 1rem;
            padding: 0 2rem;
            position: relative;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 16px 24px 16px 50px;
            border-radius: 16px;
            border: 1px solid var(--c-border);
            background: var(--c-bg);
            font-size: 1rem;
            color: var(--c-text-primary);
            box-sizing: border-box;
            transition: all 0.2s;
            outline: none;
            box-shadow: inner 0 2px 4px rgba(0,0,0,0.02);
        }
        .search-input:focus {
            background: var(--c-surface);
            border-color: var(--cat-bat);
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
        }
        .search-icon {
            position: absolute;
            left: 45px; top: 50%; transform: translateY(-50%);
            color: var(--c-text-secondary);
            pointer-events: none;
        }

        .theme-toggle {
            background: var(--c-bg);
            border: 1px solid var(--c-border);
            color: var(--c-text-primary);
            width: 54px;
            height: 54px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .theme-toggle:hover {
            border-color: var(--c-text-secondary);
            transform: translateY(-2px);
        }

        .filter-scroll {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 0 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .filter-scroll::-webkit-scrollbar { height: 0; }

        .filter-chip {
            background: var(--c-surface);
            border: 1px solid var(--c-border);
            color: var(--c-text-secondary);
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex; align-items: center; gap: 6px;
        }
        .filter-chip:hover {
            background: var(--c-bg); color: var(--c-text-primary); transform: translateY(-2px);
        }
        .filter-chip.active {
            background: var(--c-text-primary); color: var(--c-surface);
            border-color: var(--c-text-primary); box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* --- Grid --- */
        .grid-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 40px 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .metric-card {
            background: var(--c-surface);
            border-radius: 20px;
            border: 1px solid var(--c-border);
            padding: 32px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            box-shadow: var(--shadow-card);
        }
        .metric-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
            border-color: var(--cat-bat);
        }
        
        .cat-bat:hover { border-color: var(--cat-bat); }
        .cat-pit:hover { border-color: var(--cat-pit); }
        .cat-fld:hover { border-color: var(--cat-fld); }
        .cat-tot:hover { border-color: var(--cat-tot); }
        .cat-std:hover { border-color: var(--cat-std); }

        .card-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
        }
        .card-tag {
            font-size: 0.7rem; font-weight: 800; padding: 6px 12px; border-radius: 8px;
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .cat-bat .card-tag { background: var(--bg-bat); color: var(--cat-bat); }
        .cat-pit .card-tag { background: var(--bg-pit); color: var(--cat-pit); }
        .cat-fld .card-tag { background: var(--bg-fld); color: var(--cat-fld); }
        .cat-tot .card-tag { background: var(--bg-tot); color: var(--cat-tot); }
        .cat-std .card-tag { background: var(--bg-std); color: var(--cat-std); }
        
        .calc-icon {
            font-size: 1.2rem; opacity: 0.3; transition: 0.2s;
        }
        .metric-card:hover .calc-icon { opacity: 1; transform: scale(1.1); }
        .calc-icon.ai { color: var(--ai-color); opacity: 0.8; }

        .metric-title {
            font-size: 2.2rem; font-weight: 800; margin: 0; line-height: 1;
            color: var(--c-text-primary); letter-spacing: -0.03em;
        }
        .metric-full {
            font-size: 0.85rem; color: var(--c-text-secondary); font-weight: 600;
            margin: 6px 0 20px; text-transform: uppercase; letter-spacing: 0.02em;
        }
        .metric-desc {
            font-size: 0.95rem; color: var(--c-text-secondary); margin: 0; line-height: 1.6;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; }

        .modal-panel {
            background: var(--c-surface);
            width: 95%; max-width: 850px; max-height: 92vh;
            border-radius: 24px; padding: 0;
            position: relative; overflow: hidden;
            box-shadow: var(--shadow-float);
            transform: scale(0.95) translateY(20px); 
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column;
            border: 1px solid var(--c-border);
        }
        .modal-overlay.show .modal-panel { transform: scale(1) translateY(0); }

        .modal-header {
            padding: 32px 40px; background: var(--c-bg); border-bottom: 1px solid var(--c-border);
            position: relative;
        }
        .modal-body {
            padding: 40px; overflow-y: auto; color: var(--c-text-primary);
        }

        .m-cat {
            font-size: 0.8rem; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.5rem;
        }
        .m-title {
            font-size: 3.5rem; font-weight: 900; margin: 0; line-height: 1; letter-spacing: -0.03em; color: var(--c-text-primary);
        }
        .m-full { font-size: 1.1rem; color: var(--c-text-secondary); margin-top: 5px; font-weight: 500; }

        .close-btn {
            position: absolute; top: 24px; right: 24px;
            background: var(--c-surface); border: 1px solid var(--c-border);
            width: 44px; height: 44px; border-radius: 50%;
            font-size: 1.5rem; color: var(--c-text-secondary);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .close-btn:hover { background: var(--c-bg); color: var(--c-text-primary); transform: rotate(90deg); }

        .section-label {
            font-size: 0.8rem; font-weight: 800; color: var(--c-text-secondary);
            text-transform: uppercase; letter-spacing: 0.1em; margin: 3rem 0 1.5rem;
            display: flex; align-items: center; gap: 12px;
        }
        .section-label::before { content:'#'; color: var(--cat-bat); }
        .section-label::after { content:''; flex:1; height:1px; background: var(--c-border); }

        /* --- Formula Box --- */
        .formula-box {
            background: #1e293b; /* Always dark for formula */
            border: 1px solid #334155;
            padding: 30px; border-radius: 16px;
            font-family: var(--font-serif); font-size: 1.3rem; font-style: italic;
            color: #e2e8f0; overflow-x: auto;
            text-align: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
        }
        .formula-var {
            color: #38bdf8; font-weight: bold; margin: 0 2px; font-family: var(--font-sans); font-style: normal;
        }
        .formula-op { color: #94a3b8; margin: 0 5px; }

        /* --- Calculator Section --- */
        .calc-container {
            background: var(--c-bg); border: 1px solid var(--c-border);
            border-radius: 16px; padding: 30px;
            margin-top: 10px;
            position: relative; /* For ocr button positioning */
        }
        .calc-container.ai-mode {
            background: rgba(139, 92, 246, 0.05); border-color: var(--ai-color);
        }
        .calc-container.ai-mode .calc-title span { color: var(--ai-color); }
        .calc-container.ai-mode .calc-btn { background: var(--ai-color); }
        .calc-container.ai-mode .calc-btn:hover { background: #7c3aed; opacity: 0.9; }
        .calc-container.ai-mode .calc-res-value { color: var(--ai-color); }

        .calc-title {
            font-size: 1rem; font-weight: 800; color: var(--cat-bat); margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        
        .calc-inputs {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px;
            margin-top: 20px;
        }
        .calc-group { display: flex; flex-direction: column; gap: 5px; }
        .calc-label { font-size: 0.7rem; font-weight: 700; color: var(--c-text-secondary); text-transform: uppercase; }
        .calc-field, .calc-select {
            padding: 10px; border-radius: 8px; border: 1px solid var(--c-border);
            font-family: var(--font-mono); text-align: right; font-size: 1rem; background: var(--c-surface); color: var(--c-text-primary);
        }
        .calc-select { text-align: left; font-family: var(--font-sans); cursor: pointer; }
        .calc-field:focus, .calc-select:focus { outline: none; border-color: var(--cat-bat); ring: 2px rgba(14,165,233,0.2); }

        /* Preset Styles */
        .preset-bar {
            display: flex; gap: 8px; margin-bottom: 15px; align-items: center;
            background: rgba(0,0,0,0.03); padding: 12px; border-radius: 12px;
            flex-wrap: wrap; border: 1px solid var(--c-border);
        }
        .preset-label { width: 100%; font-size: 0.75rem; font-weight: 700; color: var(--c-text-secondary); margin-bottom: 4px; }
        .preset-select {
            flex: 1; min-width: 140px;
            padding: 8px; border-radius: 8px; border: 1px solid var(--c-border);
            font-family: var(--font-sans); font-size: 0.9rem;
        }
        .preset-input {
            flex: 1; min-width: 140px;
            padding: 8px; border-radius: 8px; border: 1px solid var(--c-border);
            font-family: var(--font-sans); font-size: 0.9rem;
        }
        .preset-btn {
            padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer;
            font-weight: 700; font-size: 0.8rem; color: white;
            transition: 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 4px;
        }
        .btn-load { background: var(--c-text-secondary); }
        .btn-load:hover { background: var(--c-text-primary); }
        .btn-save { background: var(--cat-bat); }
        .btn-save:hover { opacity: 0.9; }
        .btn-del { background: #ef4444; color: white; }
        .btn-del:hover { opacity: 0.9; }

        /* --- Advanced Settings Style --- */
        .advanced-details {
            grid-column: 1 / -1;
            margin-top: 10px;
            border: 1px solid var(--c-border);
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0,0,0,0.02);
        }
        .advanced-summary {
            padding: 12px 15px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--c-text-secondary);
            background: rgba(255,255,255,0.5);
            user-select: none;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .advanced-summary::before {
            content: 'âš™ï¸';
            font-size: 1rem;
        }
        .advanced-summary:hover {
            background: var(--c-surface);
            color: var(--cat-bat);
        }
        .advanced-content {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            border-top: 1px solid var(--c-border);
        }
        .advanced-details[open] .advanced-summary {
            border-bottom: 1px solid transparent;
        }

        .warning-msg {
            grid-column: 1 / -1;
            background: #fffbeb;
            border: 1px solid #fcd34d;
            color: #b45309;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .calc-result-area {
            margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--c-border);
            display: flex; justify-content: flex-end; align-items: center; gap: 15px;
        }
        .calc-res-label { font-size: 0.9rem; color: var(--c-text-secondary); font-weight: 600; }
        .calc-res-label span { font-size: 0.7em; background: var(--ai-color); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
        .calc-res-value { font-size: 2.5rem; font-weight: 900; color: var(--cat-bat); font-family: var(--font-mono); line-height: 1; }
        .calc-btn {
            background: var(--cat-bat); color: white; border: none; padding: 10px 24px;
            border-radius: 50px; font-weight: 700; cursor: pointer;
            margin-top: 20px; width: 100%; transition: 0.2s;
        }
        .calc-btn:hover { opacity: 0.9; transform: translateY(-1px); }

        .criteria-table {
            width: 100%; border-collapse: collapse; font-size: 0.95rem;
        }
        .criteria-table th { text-align: left; color: var(--c-text-secondary); width: 120px; padding: 12px 0; border-bottom: 1px solid var(--c-border); }
        .criteria-table td { padding: 12px 0; border-bottom: 1px solid var(--c-border); color: var(--c-text-primary); font-weight: 600; }

        .related-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .rel-chip {
            background: var(--c-bg); padding: 8px 20px; border-radius: 50px;
            font-size: 0.85rem; font-weight: 700; color: var(--c-text-secondary);
            cursor: pointer; border: 1px solid transparent; transition: 0.2s;
        }
        .rel-chip:hover { background: var(--c-text-primary); color: var(--c-surface); }

        .no-result {
            grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--c-text-secondary);
        }
        
        /* Helper for formula formatting */
        .var { color: #38bdf8; font-family: var(--font-sans); font-weight: 600; font-style: normal; margin: 0 2px; }

        @media (max-width: 700px) {
            .brand { font-size: 2.5rem; }
            .m-title { font-size: 2.5rem; }
            .grid-container { grid-template-columns: 1fr; padding: 40px 1rem;}
            .modal-panel { width: 100%; height: 100%; border-radius: 0; }
            .search-wrapper { padding: 0 1rem; }
        }

    </style>
</head>
<body>

    <header>
        <h1 class="brand">SABR<span>METRICS</span> LAB</h1>
        <p class="subtitle">Comprehensive Baseball Analytics Dictionary & Calculator</p>
    </header>

    <div class="controls-area">
        <div class="search-wrapper">
            <span class="search-icon">ğŸ”</span>
            <input type="text" class="search-input" id="searchInput" placeholder="æŒ‡æ¨™åã€æ„å‘³ã€è¨ˆç®—å¼ã§æ¤œç´¢..." oninput="handleSearch()">
            <button class="theme-toggle" onclick="toggleTheme()" title="Dark Mode">ğŸŒ™</button>
        </div>
        
        <!-- Batch Calc Buttons Added (Icons Removed) -->
        <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
            <button class="preset-btn btn-save" onclick="openBatchCalc('bat')" style="font-size:0.9rem; padding:10px 20px;">é‡æ‰‹ä¸€æ‹¬è¨ˆç®—</button>
            <button class="preset-btn btn-del" onclick="openBatchCalc('pit')" style="font-size:0.9rem; padding:10px 20px; background:#f43f5e;">æŠ•æ‰‹ä¸€æ‹¬è¨ˆç®—</button>
        </div>

        <div class="filter-scroll">
            <div class="filter-chip active" onclick="filterCategory('all')" data-cat="all">ALL</div>
            <div class="filter-chip" onclick="filterCategory('std')" data-cat="std">åŸºæœ¬</div>
            <div class="filter-chip" onclick="filterCategory('bat')" data-cat="bat">æ‰“æ’ƒ</div>
            <div class="filter-chip" onclick="filterCategory('pit')" data-cat="pit">æŠ•çƒ</div>
            <div class="filter-chip" onclick="filterCategory('fld')" data-cat="fld">å®ˆå‚™èµ°å¡</div>
            <div class="filter-chip" onclick="filterCategory('tot')" data-cat="tot">ç·åˆ</div>
        </div>
    </div>

    <div class="grid-container" id="grid">
        <!-- Generated -->
    </div>

    <div class="modal-overlay" id="modal" onclick="closeModalOutside(event)">
        <div class="modal-panel">
            <div class="modal-header" id="modal-header">
                <button class="close-btn" onclick="closeModal()">Ã—</button>
                <div id="modal-title-area"></div>
            </div>
            <div class="modal-body" id="modal-body-content"></div>
        </div>
    </div>

<script>
    // --- Data Helper ---
    const formatVar = (text) => `<span class="var">${text}</span>`;

    // --- Constants (Default Values) ---
    const DEFAULTS = {
        // ãƒªãƒ¼ã‚°å…¨ä½“ã®çµ±è¨ˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯æ¦‚ç®—ï¼‰
        LG_PA: 28500,
        LG_RUNS: 2800,
        LG_HITS: 6900,
        LG_2B: 1150,
        LG_3B: 120,
        LG_HR: 485, 
        LG_BB: 2300,
        // æ–°è¦è¿½åŠ : ãƒªãƒ¼ã‚°ç·æ•°è©³ç´°ï¼ˆOBP/SLGã®ä»£ã‚ã‚Šï¼‰
        LG_AB: 28750, // æ‰“æ•° (å¤‰æ›´: 24900 -> 28750)
        LG_HBP: 300,  // æ­»çƒ (å¤‰æ›´: 200 -> 300)
        LG_SF: 190,   // çŠ é£› (å¤‰æ›´: 230 -> 190)
        LG_SH: 550    // çŠ æ‰“ (å¤‰æ›´: 700 -> 550)
    };

    // Park Factors
    const PARK_FACTORS = {
        'avg':      {name: 'å¹³å‡',     pf: 1.00},
        'jingu':    {name: 'æ˜æ²»ç¥å®®', pf: 1.19},
        'yoko':     {name: 'æ¨ªæµœ',     pf: 1.04},
        'mazda':    {name: 'ãƒãƒ„ãƒ€',   pf: 0.99},
        'tokyo':    {name: 'æ±äº¬ãƒ‰ãƒ¼ãƒ ', pf: 0.97},
        'koshien':  {name: 'ç”²å­åœ’',   pf: 0.92},
        'nagoya':   {name: 'ãƒãƒ³ãƒ†ãƒªãƒ³', pf: 0.86},
        'escon':    {name: 'ã‚¨ã‚¹ã‚³ãƒ³', pf: 1.06},
        'zozo':     {name: 'ZOZOãƒãƒªãƒ³', pf: 1.06},
        'paypay':   {name: 'PayPay',   pf: 1.05},
        'belluna':  {name: 'ãƒ™ãƒ«ãƒ¼ãƒŠ', pf: 0.97},
        'kyocera':  {name: 'äº¬ã‚»ãƒ©',   pf: 0.95},
        'rakuten':  {name: 'æ¥½å¤©ãƒ¢ãƒã‚¤ãƒ«', pf: 0.94}
    };

    // --- Helper to calculate Derived Constants ---
    function calcDerived(d) {
        // åŸºæœ¬å…¥åŠ›å€¤
        const lg_hr = DEFAULTS.LG_HR;
        const lg_bb = d.lg_bb !== undefined ? d.lg_bb : DEFAULTS.LG_BB;
        // æ–°è¦è©³ç´°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        const lg_ab = d.lg_ab !== undefined ? d.lg_ab : DEFAULTS.LG_AB;
        const lg_hbp = d.lg_hbp !== undefined ? d.lg_hbp : DEFAULTS.LG_HBP;
        const lg_sf = d.lg_sf !== undefined ? d.lg_sf : DEFAULTS.LG_SF;
        const lg_sh = d.lg_sh !== undefined ? d.lg_sh : DEFAULTS.LG_SH;

        // å›ºå®šå€¤ã‚’è¿”ã™åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (isDefault) ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚
        // ã™ã¹ã¦å…¥åŠ›å€¤ã«åŸºã¥ãå‹•çš„ã«è¨ˆç®—ã•ã‚Œã¾ã™ã€‚

        // --- ãƒªãƒ¼ã‚°è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®— ---
        const lg_ibb = lg_bb * 0.03; 
        const lg_roe = Math.max(0, d.lg_pa - (lg_ab + lg_bb + lg_hbp + lg_sf + lg_sh));
        const lg_1b = d.lg_hits - d.lg_2b - d.lg_3b - lg_hr;
        const lg_obp = (d.lg_hits + lg_bb + lg_hbp) / (lg_ab + lg_bb + lg_hbp + lg_sf);

        // --- wOBAè¨ˆç®— (åŸºæº–ä¿‚æ•°: wOBA Scale=1.28æƒ³å®š) ---
        const woba_denom = lg_ab + lg_bb - lg_ibb + lg_hbp + lg_sf;
        
        // åŸºæº–ä¿‚æ•°ã§ã®ãƒªãƒ¼ã‚°wOBAç®—å‡º
        const woba_num_std = 
            0.692 * (lg_bb - lg_ibb) +
            0.73  * lg_hbp +
            0.966 * lg_roe +
            0.865 * lg_1b +
            1.334 * d.lg_2b +
            1.725 * d.lg_3b +
            2.065 * lg_hr;
            
        const lg_woba_std = woba_denom > 0 ? woba_num_std / woba_denom : 0;

        // --- ä¿‚æ•°è£œæ­£æ¯”ç‡ (Fitting Ratio) ---
        // ãƒªãƒ¼ã‚°å‡ºå¡ç‡ã¨åŸºæº–wOBAã®æ¯”ç‡ã‹ã‚‰ã€ç’°å¢ƒã«åˆã‚ã›ãŸä¿‚æ•°ã®è£œæ­£å€ç‡ã‚’ç®—å‡º
        const fitting_ratio = (lg_woba_std > 0 && lg_obp > 0) ? (lg_obp / lg_woba_std) : 1.0;

        // å®Ÿéš›ã®ãƒªãƒ¼ã‚°wOBA (OBPã¨ä¸€è‡´ã™ã‚‹ã‚ˆã†ã«è£œæ­£ã•ã‚Œã‚‹)
        const lg_woba = lg_woba_std * fitting_ratio;

        // --- wOBA Scaleã®è¨ˆç®— ---
        // åŸºæº–å€¤1.28ã«è£œæ­£å€ç‡ã‚’æ›ã‘ã‚‹
        const woba_scale = 1.28 * fitting_ratio;

        // --- ãã®ä»–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ---
        const lg_r_pa = d.lg_runs / d.lg_pa;
        const est_lg_ip = d.lg_pa / 4.25;
        const rpw = 20 * (d.lg_runs / est_lg_ip);
        const rep_per_pa = 0.12 * (lg_woba / woba_scale);
        
        // tRAã®è¨ˆç®— (å›ºå®šå€¤ã‚’ä½¿ç”¨ã›ãšè¨ˆç®—)
        const lg_tra = (d.lg_runs / est_lg_ip) * 9 * 0.92;

        return { lg_r_pa, rpw, rep_per_pa, lg_woba, lg_tra, woba_scale, fitting_ratio };
    }

    // --- Helper: è©³ç´°ã‚¹ã‚¿ãƒƒãƒ„ã®è¨ˆç®— (Calculate Details from Inputs) ---
    function estimateDetails(d) {
        // IBBã¯å…¥åŠ›ãŒãªã„ãŸã‚æ¦‚ç®— (å››çƒã®ç´„4%)
        const ibb = d.bb * 0.04;

        // ROE (å¤±ç­–å‡ºå¡) ã®è¨ˆç®—
        // ROE = æ‰“å¸­ - (æ‰“æ•° + å››çƒ + æ­»çƒ + çŠ é£› + çŠ æ‰“)
        const roe = Math.max(0, d.pa - (d.ab + d.bb + d.hbp + d.sf + d.sh));

        // å˜æ‰“ (S)
        const s = d.h - d.d - d.t - d.hr;

        return { ibb, roe, s };
    }

    // --- Terms Database ---
    const terms = [
        /* ---------------- ç·åˆ (Total) ---------------- */
        {
            id: "war", category: "tot", title: "WAR (é‡æ‰‹)", full: "Wins Above Replacement (Batter)",
            short: "æ‰“æ’ƒã€èµ°å¡ã€å®ˆå‚™ã‚’ç·åˆçš„ã«è©•ä¾¡ã—ã¦é‡æ‰‹ã®è²¢çŒ®åº¦ã‚’è¡¨ã™æŒ‡æ¨™ã€‚",
            desc: "ä»£æ›¿å¯èƒ½ãªæ§ãˆé¸æ‰‹ï¼ˆãƒªãƒ—ãƒ¬ã‚¤ã‚¹ãƒ¡ãƒ³ãƒˆãƒ»ãƒ¬ãƒ™ãƒ«ã®é¸æ‰‹ï¼‰ãŒå‡ºå ´ã™ã‚‹å ´åˆã«æ¯”ã¹ã¦ã©ã‚Œã ã‘å‹åˆ©æ•°ã‚’å¢—ã‚„ã—ãŸã‹ã«ã‚ˆã£ã¦è¨ˆç®—ã•ã‚Œã‚‹ã€‚<br>wOBAä¿‚æ•°ã¯ãƒªãƒ¼ã‚°ç’°å¢ƒï¼ˆwOBA Scaleï¼‰ã«åˆã‚ã›ã¦è‡ªå‹•è£œæ­£ã•ã‚Œã¾ã™ã€‚",
            formula: `(wRAA + UZR + BaseRunning + ãƒã‚¸ã‚·ãƒ§ãƒ³è£œæ­£ + ä»£æ›¿æ°´æº–è£œæ­£) Ã· RPW`,
            criteria: "2.0: ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ / 5.0: ã‚¹ã‚¿ãƒ¼ / 8.0: MVP",
            related: ["wraa", "uzr", "woba", "rpw"],
            aiMode: true,
            inputs: [
                {id:'pa', label:'æ‰“å¸­æ•°'}, {id:'ab', label:'æ‰“æ•°'},
                {id:'h', label:'å®‰æ‰“'}, {id:'d', label:'äºŒå¡æ‰“'}, {id:'t', label:'ä¸‰å¡æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'}, 
                {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ'}, 
                {id:'sf', label:'çŠ é£›'}, {id:'sh', label:'çŠ æ‰“'},
                {id:'sb', label:'ç›—å¡'}, {id:'cs', label:'ç›—å¡æ­»'},
                
                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                {id:'pos', label:'å®ˆå‚™ä½ç½®', type:'select', options:{'dh':'DH', '1b':'ä¸€å¡', 'lf':'å·¦ç¿¼', 'rf':'å³ç¿¼', '3b':'ä¸‰å¡', '2b':'äºŒå¡', 'cf':'ä¸­å …', 'ss':'éŠæ’ƒ', 'c':'æ•æ‰‹'}},
                {id:'def', label:'å®ˆå‚™è©•ä¾¡', type:'select', options:{'0':'å¹³å‡çš„ (0)', '5':'ä¸Šæ‰‹ã„ (+5)', '10':'åæ‰‹ (+10)', '15':'ç¥ (+15)', '-5':'è‹¦æ‰‹ (-5)', '-10':'ä¸‹æ‰‹ (-10)'}},
                
                {id:'lg_pa', label:'ãƒªãƒ¼ã‚°ç·æ‰“å¸­', type:'number', advanced:true, default: DEFAULTS.LG_PA},
                {id:'lg_ab', label:'ãƒªãƒ¼ã‚°ç·æ‰“æ•°', type:'number', advanced:true, default: DEFAULTS.LG_AB}, 
                {id:'lg_runs', label:'ãƒªãƒ¼ã‚°ç·å¾—ç‚¹', type:'number', advanced:true, default: DEFAULTS.LG_RUNS},
                {id:'lg_hits', label:'ãƒªãƒ¼ã‚°ç·å®‰æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_HITS},
                {id:'lg_2b', label:'ãƒªãƒ¼ã‚°ç·äºŒå¡æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_2B},
                {id:'lg_3b', label:'ãƒªãƒ¼ã‚°ç·ä¸‰å¡æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_3B},
                {id:'lg_bb', label:'ãƒªãƒ¼ã‚°ç·å››çƒ', type:'number', advanced:true, default: DEFAULTS.LG_BB},
                {id:'lg_hbp', label:'ãƒªãƒ¼ã‚°ç·æ­»çƒ', type:'number', advanced:true, default: DEFAULTS.LG_HBP},
                {id:'lg_sf', label:'ãƒªãƒ¼ã‚°ç·çŠ é£›', type:'number', advanced:true, default: DEFAULTS.LG_SF},
                {id:'lg_sh', label:'ãƒªãƒ¼ã‚°ç·çŠ æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_SH}
            ],
            calc: (d) => {
                const C = calcDerived(d);
                const est = estimateDetails(d);
                const fr = C.fitting_ratio; // è£œæ­£ä¿‚æ•°

                // 1. Calculate wOBA (Coefficients scaled by fitting_ratio)
                const woba_denom = d.ab + d.bb - est.ibb + d.hbp + d.sf;

                const woba_num = 
                    (0.692 * fr) * (d.bb - est.ibb) +
                    (0.73  * fr) * d.hbp +
                    (0.966 * fr) * est.roe +
                    (0.865 * fr) * est.s +
                    (1.334 * fr) * d.d +
                    (1.725 * fr) * d.t +
                    (2.065 * fr) * d.hr;

                const woba_val = woba_denom > 0 ? woba_num / woba_denom : 0;
                
                // 2. wRAA
                const raw_wRAA = ((woba_val - C.lg_woba) / C.woba_scale) * d.pa;

                // 3. Park Adj
                const pf = PARK_FACTORS[d.stadium].pf;
                const home_ratio = 0.5;
                const pf_coef = (home_ratio * pf) + ((1 - home_ratio) * (6 - pf) / 5);
                const parkAdj = (1 - pf_coef) * C.lg_r_pa * d.pa;
                
                const battingRuns = raw_wRAA + parkAdj;
                
                // 4. Pos Adj
                const posVals = {'dh':-15.1, '1b':-14.1, 'lf':-12.0, 'rf':-5.0, '3b':-4.8, '2b':3.4, 'cf':4.2, 'ss':10.3, 'c':18.1};
                const posAdj = (posVals[d.pos] || 0) * (d.pa / 600);
                
                // 5. UZR & BaseRunning
                const uzr = parseFloat(d.def) || 0;
                const baseRunning = (d.sb * 0.2) - (d.cs * 0.4);
                
                // 6. Replacement Level
                const repRuns = C.rep_per_pa * d.pa;
                
                // 7. Calc WAR
                const totalRuns = battingRuns + uzr + baseRunning + posAdj + repRuns;
                return (totalRuns / C.rpw).toFixed(1);
            }
        },
        {
            id: "wrc_plus", category: "bat", title: "wRC+", full: "weighted Runs Created Plus",
            short: "æ‰“æ’ƒã®å‚‘å‡ºåº¦ã‚’è©•ä¾¡ã™ã‚‹æŒ‡æ¨™",
            desc: "æ‰“å¸­ã‚ãŸã‚Šã®å¾—ç‚¹å‰µå‡ºã®å¤šã•ã‚’å¹³å‡çš„ãªæ‰“è€…ã‚’100ã¨ã—ãŸå ´åˆã®ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã§è©•ä¾¡ã™ã‚‹æŒ‡æ¨™ã€‚",
            formula: `(((wRAA/æ‰“å¸­ + R/PA) + (R/PA - PFè£œæ­£ä¿‚æ•°Ã—R/PA)) Ã· R/PA) Ã— 100`,
            criteria: "100: å¹³å‡ / 160: MVPå€™è£œ / 200: æ­´å²çš„",
            related: ["woba", "wraa"],
            aiMode: true,
            inputs: [
                {id:'pa', label:'æ‰“å¸­æ•°'}, {id:'ab', label:'æ‰“æ•°'},
                {id:'h', label:'å®‰æ‰“'}, {id:'d', label:'äºŒå¡æ‰“'}, {id:'t', label:'ä¸‰å¡æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'}, 
                {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ}, 
                {id:'sf', label:'çŠ é£›'}, {id:'sh', label:'çŠ æ‰“'},

                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                {id:'lg_pa', label:'ãƒªãƒ¼ã‚°ç·æ‰“å¸­', type:'number', advanced:true, default: DEFAULTS.LG_PA},
                {id:'lg_ab', label:'ãƒªãƒ¼ã‚°ç·æ‰“æ•°', type:'number', advanced:true, default: DEFAULTS.LG_AB}, 
                {id:'lg_runs', label:'ãƒªãƒ¼ã‚°ç·å¾—ç‚¹', type:'number', advanced:true, default: DEFAULTS.LG_RUNS},
                {id:'lg_hits', label:'ãƒªãƒ¼ã‚°ç·å®‰æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_HITS},
                {id:'lg_2b', label:'ãƒªãƒ¼ã‚°ç·äºŒå¡æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_2B},
                {id:'lg_3b', label:'ãƒªãƒ¼ã‚°ç·ä¸‰å¡æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_3B},
                {id:'lg_bb', label:'ãƒªãƒ¼ã‚°ç·å››çƒ', type:'number', advanced:true, default: DEFAULTS.LG_BB},
                {id:'lg_hbp', label:'ãƒªãƒ¼ã‚°ç·æ­»çƒ', type:'number', advanced:true, default: DEFAULTS.LG_HBP},
                {id:'lg_sf', label:'ãƒªãƒ¼ã‚°ç·çŠ é£›', type:'number', advanced:true, default: DEFAULTS.LG_SF},
                {id:'lg_sh', label:'ãƒªãƒ¼ã‚°ç·çŠ æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_SH}
            ],
            calc: (d) => {
                const C = calcDerived(d);
                const est = estimateDetails(d);
                const fr = C.fitting_ratio;
                const pf = PARK_FACTORS[d.stadium].pf;
                
                // wOBA
                const woba_denom = d.ab + d.bb - est.ibb + d.hbp + d.sf;
                const woba_num = 
                    (0.692 * fr) * (d.bb - est.ibb) +
                    (0.73  * fr) * d.hbp +
                    (0.966 * fr) * est.roe +
                    (0.865 * fr) * est.s +
                    (1.334 * fr) * d.d +
                    (1.725 * fr) * d.t +
                    (2.065 * fr) * d.hr;
                const woba_val = woba_denom > 0 ? woba_num / woba_denom : 0;
                
                // wRAA
                const raw_wraa = ((woba_val - C.lg_woba) / C.woba_scale) * d.pa;
                
                // Park Adj
                const home_ratio = 0.5;
                const pf_coef = (home_ratio * pf) + ((1 - home_ratio) * (6 - pf) / 5);
                const parkAdj = (1 - pf_coef) * C.lg_r_pa * d.pa;

                // wRC+ Calc
                const wrc_plus_val = (((raw_wraa + parkAdj) / d.pa) + C.lg_r_pa) / C.lg_r_pa * 100;
                
                return wrc_plus_val.toFixed(0);
            }
        },
        {
            id: "pit_war", category: "tot", title: "WAR (æŠ•æ‰‹)", full: "Wins Above Replacement (Pitcher)",
            short: "æŠ•çƒã‚’ç·åˆçš„ã«è©•ä¾¡ã—ã¦æŠ•æ‰‹ã®è²¢çŒ®åº¦ã‚’è¡¨ã™æŒ‡æ¨™ã€‚",
            desc: "ä»£æ›¿å¯èƒ½ãªæ§ãˆé¸æ‰‹ã«æ¯”ã¹ã¦ã©ã‚Œã ã‘å‹åˆ©æ•°ã‚’å¢—ã‚„ã—ãŸã‹ã€‚<br>SPRAR (å…ˆç™ºã¨ã—ã¦ã®è²¢çŒ®) ã¨ RPRAR (æ•‘æ´ã¨ã—ã¦ã®è²¢çŒ®) ã‚’è¶³ã—åˆã‚ã›ã€RPWã§å‰²ã£ã¦ç®—å‡ºã—ã¾ã™ã€‚",
            formula: `(SPRAR + RPRAR) Ã· RPW`,
            criteria: "2.0: ãƒ­ãƒ¼ãƒ†æŠ•æ‰‹ / 4.0: ã‚¨ãƒ¼ã‚¹",
            related: ["fip", "tra", "rsaa", "rpw"],
            aiMode: true,
            inputs: [
                {id:'ip', label:'æŠ•çƒå›'}, {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'hr', label:'è¢«æœ¬å¡æ‰“'},
                {id:'role', label:'å½¹å‰²', type:'select', options:{'sp':'å…ˆç™º', 'rp':'æ•‘æ´'}},
                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                
                // è©³ç´°è¨­å®šã‚’é‡æ‰‹WARã¨çµ±ä¸€
                {id:'lg_pa', label:'ãƒªãƒ¼ã‚°ç·æ‰“å¸­', type:'number', advanced:true, default: DEFAULTS.LG_PA},
                {id:'lg_ab', label:'ãƒªãƒ¼ã‚°ç·æ‰“æ•°', type:'number', advanced:true, default: DEFAULTS.LG_AB}, 
                {id:'lg_runs', label:'ãƒªãƒ¼ã‚°ç·å¾—ç‚¹', type:'number', advanced:true, default: DEFAULTS.LG_RUNS},
                {id:'lg_hits', label:'ãƒªãƒ¼ã‚°ç·å®‰æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_HITS},
                {id:'lg_2b', label:'ãƒªãƒ¼ã‚°ç·äºŒå¡æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_2B},
                {id:'lg_3b', label:'ãƒªãƒ¼ã‚°ç·ä¸‰å¡æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_3B},
                {id:'lg_bb', label:'ãƒªãƒ¼ã‚°ç·å››çƒ', type:'number', advanced:true, default: DEFAULTS.LG_BB},
                {id:'lg_hbp', label:'ãƒªãƒ¼ã‚°ç·æ­»çƒ', type:'number', advanced:true, default: DEFAULTS.LG_HBP},
                {id:'lg_sf', label:'ãƒªãƒ¼ã‚°ç·çŠ é£›', type:'number', advanced:true, default: DEFAULTS.LG_SF},
                {id:'lg_sh', label:'ãƒªãƒ¼ã‚°ç·çŠ æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_SH}
            ],
            calc: (d) => {
                const C = calcDerived(d);

                // 1. FIP Calculation (Standard Constant approx 3.10)
                const fip = (13 * d.hr + 3 * d.bb - 2 * d.so) / d.ip + 3.10;

                // 2. League Parameters
                const est_lg_ip = d.lg_pa / 4.25;
                const lg_r_9 = (d.lg_runs / est_lg_ip) * 9;

                // 3. Park Adjustment
                const pf = PARK_FACTORS[d.stadium].pf;
                // Park Adjusted League RA9
                const lg_ra9_park = lg_r_9 * pf;

                // 4. Runs Above Average (RAA) based on FIP
                // RAA = (League RA - Pitcher FIP) * IP / 9
                const raa = (lg_ra9_park - fip) * (d.ip / 9);

                // 5. Replacement Level Adjustment
                // SP: +0.38 runs/9, RP: +0.47 runs/9 (approx)
                const rep_bonus = d.role === 'sp' ? 0.38 : 0.47;
                const rep_runs = rep_bonus * (d.ip / 9);

                // 6. RAR (Runs Above Replacement) -> SPRAR or RPRAR
                const rar = raa + rep_runs;
                
                // Since inputs only allow one role, SPRAR+RPRAR is just RAR
                return (rar / C.rpw).toFixed(1);
            }
        },
        {
            id: "rpw", category: "tot", title: "RPW", full: "Runs Per Win",
            short: "å‹åˆ©ã‚’1ã¤å¢—ã‚„ã™ã®ã«å¿…è¦ãªå¾—ç‚¹æ•°ã€‚",
            desc: "ã€Œ1å‹ã®é‡ã¿ã€ã‚’å¾—ç‚¹æ›ç®—ã—ãŸã‚‚ã®ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯8.5ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚",
            formula: `20 Ã— (ãƒªãƒ¼ã‚°ç·å¾—ç‚¹ Ã· ãƒªãƒ¼ã‚°ç·æŠ•çƒå›)`,
            criteria: "8.5 ï½ 10.0",
            related: ["war", "pythag"]
        },
        {
            id: "wpa", category: "tot", title: "WPA", full: "Win Probability Added",
            short: "å‹åˆ©ç¢ºç‡ã‚’ã©ã‚Œã ã‘å¤‰å‹•ã•ã›ãŸã‹ã€‚",
            desc: "çŠ¶æ³ï¼ˆç‚¹å·®ã€ã‚¤ãƒ‹ãƒ³ã‚°ã€èµ°è€…ã€ã‚¢ã‚¦ãƒˆï¼‰ã”ã¨ã®å‹åˆ©ç¢ºç‡ã‚’ã€ãƒ—ãƒ¬ã‚¤å‰å¾Œã§ã©ã‚Œã ã‘å¢—ã‚„ã—ãŸã‹ã€‚å‹è² å¼·ã•ã‚’æ¸¬ã‚‹ã®ã«æœ€é©ã€‚ã‚µãƒ¨ãƒŠãƒ©ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ãªã©ã¯éå¸¸ã«é«˜ã„å€¤ã«ãªã‚‹ã€‚",
            formula: `ãƒ—ãƒ¬ã‚¤å¾Œã®å‹åˆ©ç¢ºç‡ - ãƒ—ãƒ¬ã‚¤å‰ã®å‹åˆ©ç¢ºç‡`,
            criteria: "çŠ¶æ³ã«ä¾å­˜",
            related: ["re24"]
        },
        {
            id: "re24", category: "tot", title: "RE24", full: "Run Expectancy 24",
            short: "çŠ¶æ³åˆ¥ã®ã€Œå¾—ç‚¹æœŸå¾…å€¤ã€ã®å¢—æ¸›ã€‚",
            desc: "24ç¨®é¡ã®çŠ¶æ³ï¼ˆç„¡æ­»ä¸€å¡ãªã©ï¼‰ã«ãŠã‘ã‚‹å¾—ç‚¹æœŸå¾…å€¤ã‚’ã©ã‚Œã ã‘æ”¹å–„ã•ã›ãŸã‹ã€‚æ‰“ç‚¹ãªã©ã‚ˆã‚Šæ–‡è„ˆã‚’æ­£ç¢ºã«åæ˜ ã™ã‚‹ã€‚",
            formula: `ãƒ—ãƒ¬ã‚¤å¾ŒæœŸå¾…å€¤ - ãƒ—ãƒ¬ã‚¤å‰æœŸå¾…å€¤ + å¾—ç‚¹`,
            criteria: "0: å¹³å‡",
            related: ["wpa"]
        },
        {
            id: "pythag", category: "tot", title: "Pythagenpat", full: "Pythagorean Expectation",
            short: "å¾—å¤±ç‚¹ã‹ã‚‰äºˆæ¸¬ã•ã‚Œã‚‹ã€Œæœ¬æ¥ã‚ã‚‹ã¹ãå‹ç‡ã€ã€‚",
            desc: "å®Ÿéš›ã®å‹ç‡ãŒã“ã‚Œã‚ˆã‚Šé«˜ã„ã¨ã€Œé‹ãŒè‰¯ã„ã€ã¾ãŸã¯ã€Œæ¥æˆ¦ã«å¼·ã„ï¼ˆç›£ç£ã®é‡‡é…ãŒè‰¯ã„ï¼‰ã€ã¨ã•ã‚Œã‚‹ã€‚1.02ãªã©ã§ã¯ã€æœªæ¥ã®å‹ç‡äºˆæ¸¬ã«å½¹ç«‹ã¤ã¨ã—ã¦é‡è¦–ã•ã‚Œã‚‹ã€‚",
            formula: `${formatVar('å¾—ç‚¹')}^x Ã· (${formatVar('å¾—ç‚¹')}^x + ${formatVar('å¤±ç‚¹')}^x) <br><small style="font-size:0.7em; color:#94a3b8;">x = (å¾—ç‚¹+å¤±ç‚¹)^0.287</small>`,
            criteria: "å®Ÿéš›ã®å‹ç‡ã¨ã®ä¹–é›¢ã‚’ç¢ºèª",
            inputs: [
                {id:'rs', label:'å¾—ç‚¹'}, {id:'ra', label:'å¤±ç‚¹'}
            ],
            calc: (d) => {
                const x = Math.pow((d.rs + d.ra), 0.287);
                return (Math.pow(d.rs, x) / (Math.pow(d.rs, x) + Math.pow(d.ra, x))).toFixed(3);
            }
        },
        {
            id: "pf", category: "tot", title: "PF", full: "Park Factor",
            short: "çƒå ´ã®ç‰¹æ€§ï¼ˆæ‰“è€…æœ‰åˆ©/æŠ•æ‰‹æœ‰åˆ©ï¼‰ã‚’è¡¨ã™æ•°å€¤ã€‚",
            desc: "1.00ãŒå¹³å‡ã€‚1.00ã‚ˆã‚Šå¤§ãã‘ã‚Œã°æ‰“è€…æœ‰åˆ©ã€å°ã•ã‘ã‚Œã°æŠ•æ‰‹æœ‰åˆ©ã€‚ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã¯ã€é¸æ‰‹ã®æˆç¸¾ã‚’æ¯”è¼ƒã™ã‚‹éš›ã«ã“ã®PFè£œæ­£ã‚’ã‹ã‘ã‚‹ã“ã¨ãŒå¸¸è­˜ã¨ãªã£ã¦ã„ã‚‹ã€‚",
            formula: `(æœ¬æ‹ åœ°ã§ã®æœ¬å¡æ‰“ + è¢«æœ¬å¡æ‰“) Ã· (æ•µåœ°ã§ã®æœ¬å¡æ‰“ + è¢«æœ¬å¡æ‰“)`,
            criteria: "1.00: ä¸­ç«‹ / 1.20: ãƒ’ãƒƒã‚¿ãƒ¼ã‚ºãƒ‘ãƒ¼ã‚¯",
            related: ["wrc_plus"]
        },

        /* ---------------- æ‰“æ’ƒ (Batting) ---------------- */
        {
            id: "avg", category: "std", title: "AVG", full: "Batting Average",
            short: "æ‰“ç‡ã€‚",
            formula: `${formatVar('å®‰æ‰“')} Ã· ${formatVar('æ‰“æ•°')}`,
            criteria: ".250: å¹³å‡ / .300: å„ªç§€",
            inputs: [{id:'h', label:'å®‰æ‰“'}, {id:'ab', label:'æ‰“æ•°'}],
            calc: (d) => (d.h / d.ab).toFixed(3).replace(/^0/,'')
        },
        {
            id: "obp", category: "std", title: "OBP", full: "On Base Percentage",
            short: "å‡ºå¡ç‡ã€‚",
            desc: "æ‰“ç‡ã‚ˆã‚Šã‚‚å¾—ç‚¹ã¨ã®ç›¸é–¢ãŒé«˜ã„ãŸã‚ã€ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã¯æ‰“ç‡ã‚ˆã‚Šé‡è¦–ã•ã‚Œã‚‹ã€‚å››æ­»çƒã‚’é¸ã¹ã‚‹æ‰“è€…ã¯ä¾¡å€¤ãŒé«˜ã„ã€‚",
            formula: `(${formatVar('å®‰æ‰“')} + ${formatVar('å››çƒ')} + ${formatVar('æ­»çƒ')}) Ã· (${formatVar('æ‰“æ•°')} + ${formatVar('å››çƒ')} + ${formatVar('æ­»çƒ')} + ${formatVar('çŠ é£›')})`,
            criteria: ".320: å¹³å‡ / .400: å„ªç§€",
            related: ["ops", "isod"],
            inputs: [{id:'h', label:'å®‰æ‰“'}, {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ'}, {id:'ab', label:'æ‰“æ•°'}, {id:'sf', label:'çŠ é£›'}],
            calc: (d) => ((d.h+d.bb+d.hbp)/(d.ab+d.bb+d.hbp+d.sf)).toFixed(3).replace(/^0/,'')
        },
        {
            id: "slg", category: "std", title: "SLG", full: "Slugging Percentage",
            short: "é•·æ‰“ç‡ã€‚",
            desc: "æ‰“ç‡ã®ã‚ˆã†ãªåå‰ã ãŒã€Œ1æ‰“æ•°ã‚ãŸã‚Šã®æœŸå¾…å¡æ‰“æ•°ã€ã‚’è¡¨ã™ã€‚å˜æ‰“=1ã€æœ¬å¡æ‰“=4ã¨ã—ã¦è¨ˆç®—ã€‚",
            formula: `${formatVar('å¡æ‰“')} Ã· ${formatVar('æ‰“æ•°')}`,
            criteria: ".400: å¹³å‡ / .500: ãƒ‘ãƒ¯ãƒ¼ãƒ’ãƒƒã‚¿ãƒ¼",
            related: ["ops", "iso"],
            inputs: [{id:'tb', label:'å¡æ‰“'}, {id:'ab', label:'æ‰“æ•°'}],
            calc: (d) => (d.tb / d.ab).toFixed(3).replace(/^0/,'')
        },
        {
            id: "ops", category: "std", title: "OPS", full: "On-base Plus Slugging",
            short: "å‡ºå¡ç‡ + é•·æ‰“ç‡ã€‚",
            desc: "è¨ˆç®—ãŒç°¡å˜ã§ã‚ã‚ŠãªãŒã‚‰ã€ãƒãƒ¼ãƒ ã®å¾—ç‚¹æ•°ã¨éå¸¸ã«é«˜ã„ç›¸é–¢ã‚’æŒã¤æŒ‡æ¨™ã€‚ç¾åœ¨ã§ã¯å…¬å¼è¨˜éŒ²ã¨ã—ã¦ã‚‚æ¡ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã€‚",
            formula: `${formatVar('å‡ºå¡ç‡')} + ${formatVar('é•·æ‰“ç‡')}`,
            criteria: ".730: å¹³å‡ / .800: å„ªç§€ / 1.000: æœ€å¼·",
            related: ["woba", "xr"],
            inputs: [
                {id:'h', label:'å®‰æ‰“'}, {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ'}, 
                {id:'ab', label:'æ‰“æ•°'}, {id:'sf', label:'çŠ é£›'}, {id:'tb', label:'å¡æ‰“'}
            ],
            calc: (d) => {
                const obp = (d.h+d.bb+d.hbp)/(d.ab+d.bb+d.hbp+d.sf);
                const slg = d.tb / d.ab;
                return (obp + slg).toFixed(3).replace(/^0/,'');
            }
        },
        {
            id: "woba", category: "bat", title: "wOBA", full: "weighted On-Base Average",
            short: "å„ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾—ç‚¹ä¾¡å€¤ã§é‡ã¿ä»˜ã‘ã—ãŸã€ŒçœŸã®å‡ºå¡ç‡ã€ã€‚",
            desc: "OPSã®æ¬ ç‚¹ï¼ˆå‡ºå¡ç‡ã‚’éå°è©•ä¾¡ã—ã¦ã„ã‚‹ç‚¹ï¼‰ã‚’ä¿®æ­£ã—ã€å„ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå˜æ‰“ã€æœ¬å¡æ‰“ã€å››çƒãªã©ï¼‰ãŒå¾—ç‚¹ã«ã©ã‚Œã ã‘è²¢çŒ®ã—ãŸã‹ã‚’ä¿‚æ•°åŒ–ã—ã¦è¨ˆç®—ã™ã‚‹ã€‚ä¿‚æ•°ã¯å¹´åº¦ã”ã¨ã«å¤‰å‹•ã™ã‚‹ã€‚",
            formula: `(0.69Ã—${formatVar('å››çƒ')} + 0.72Ã—${formatVar('æ­»çƒ')} + 0.89Ã—${formatVar('å˜æ‰“')} + 1.27Ã—${formatVar('äºŒå¡æ‰“')} + 1.62Ã—${formatVar('ä¸‰å¡æ‰“')} + 2.10Ã—${formatVar('æœ¬å¡æ‰“')}) Ã· ${formatVar('æ‰“å¸­')}`,
            criteria: ".320: å¹³å‡ / .400: MVPç´š",
            related: ["ops", "wrc_plus"],
            inputs: [
                {id:'pa', label:'æ‰“å¸­'}, {id:'ab', label:'æ‰“æ•°'},
                {id:'s', label:'å˜æ‰“'}, {id:'d', label:'äºŒå¡æ‰“'}, {id:'t', label:'ä¸‰å¡æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'}, 
                {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ', default:0}, 
                {id:'sf', label:'çŠ é£›', default:0}, {id:'sh', label:'çŠ æ‰“', default:0},

                // è©³ç´°å…¥åŠ›ã¸å¤‰æ›´
                {id:'lg_pa', label:'ãƒªãƒ¼ã‚°ç·æ‰“å¸­', type:'number', advanced:true, default: DEFAULTS.LG_PA},
                {id:'lg_ab', label:'ãƒªãƒ¼ã‚°ç·æ‰“æ•°', type:'number', advanced:true, default: DEFAULTS.LG_AB}, 
                {id:'lg_runs', label:'ãƒªãƒ¼ã‚°ç·å¾—ç‚¹', type:'number', advanced:true, default: DEFAULTS.LG_RUNS},
                {id:'lg_hits', label:'ãƒªãƒ¼ã‚°ç·å®‰æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_HITS},
                {id:'lg_2b', label:'ãƒªãƒ¼ã‚°ç·äºŒå¡æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_2B},
                {id:'lg_3b', label:'ãƒªãƒ¼ã‚°ç·ä¸‰å¡æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_3B},
                {id:'lg_bb', label:'ãƒªãƒ¼ã‚°ç·å››çƒ', type:'number', advanced:true, default: DEFAULTS.LG_BB},
                {id:'lg_hbp', label:'ãƒªãƒ¼ã‚°ç·æ­»çƒ', type:'number', advanced:true, default: DEFAULTS.LG_HBP},
                {id:'lg_sf', label:'ãƒªãƒ¼ã‚°ç·çŠ é£›', type:'number', advanced:true, default: DEFAULTS.LG_SF},
                {id:'lg_sh', label:'ãƒªãƒ¼ã‚°ç·çŠ æ‰“', type:'number', advanced:true, default: DEFAULTS.LG_SH}
            ],
            calc: (d) => {
                const C = calcDerived(d);
                const est = estimateDetails(d);
                const fr = C.fitting_ratio;
                
                const woba_denom = d.ab + d.bb - est.ibb + d.hbp + d.sf;
                const woba_num = 
                    (0.692 * fr) * (d.bb - est.ibb) +
                    (0.73  * fr) * d.hbp +
                    (0.966 * fr) * est.roe +
                    (0.865 * fr) * d.s + 
                    (1.334 * fr) * d.d +
                    (1.725 * fr) * d.t +
                    (2.065 * fr) * d.hr;
                    
                return woba_denom > 0 ? (woba_num / woba_denom).toFixed(3).replace(/^0/,'') : "---";
            }
        },
        {
            id: "wraa", category: "bat", title: "wRAA", full: "weighted Runs Above Average",
            short: "å¹³å‡çš„ãªæ‰“è€…ã‚ˆã‚Šã€Œä½•ç‚¹ã€å¤šãå–ã£ãŸã‹ã€‚",
            desc: "ç©ã¿ä¸Šã’æŒ‡æ¨™ã€‚å‡ºå ´æ•°ãŒå¤šãã€ã‹ã¤æ‰“æ’ƒæˆç¸¾ãŒè‰¯ã„ã»ã©æ•°å€¤ãŒé«˜ããªã‚‹ã€‚WARã®æ‰“æ’ƒæ§‹æˆè¦ç´ ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã€‚<br>å¼ä¸­ã®<strong>wOBAScaleï¼ˆç´„1.24ï¼‰</strong>ã¯ã€wOBAã‚’å‡ºå¡ç‡ã®ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆ.320å‰å¾ŒãŒå¹³å‡ï¼‰ã«åˆã‚ã›ã‚‹ãŸã‚ã«æ›ã‘ã‚‰ã‚Œã¦ã„ãŸä¿‚æ•°ã‚’ã€å¾—ç‚¹å˜ä½ã«æˆ»ã™ãŸã‚ã«å‰²ã‚‹ã‚‚ã®ã€‚",
            formula: `(${formatVar('wOBA')} - ãƒªãƒ¼ã‚°å¹³å‡wOBA) Ã· wOBAScale Ã— ${formatVar('æ‰“å¸­')}`,
            criteria: "0: å¹³å‡ / +20: ä¸€æµ",
            related: ["war", "woba"]
        },
        {
            id: "iso", category: "bat", title: "ISO", full: "Isolated Power",
            short: "æ‰“ç‡ã‚’é™¤ã„ãŸç´”ç²‹ãªé•·æ‰“åŠ›ã€‚",
            desc: "é•·æ‰“ç‡ã‹ã‚‰æ‰“ç‡ã‚’å¼•ã„ã¦ç®—å‡ºã™ã‚‹ã€‚å˜æ‰“ã‚’ç„¡è¦–ã—ã€äºŒå¡æ‰“ä»¥ä¸Šã‚’æ‰“ã¤èƒ½åŠ›ã®ã¿ã‚’è©•ä¾¡ã™ã‚‹ã€‚",
            formula: `${formatVar('é•·æ‰“ç‡')} - ${formatVar('æ‰“ç‡')}`,
            criteria: ".140: å¹³å‡ / .250: å¼·æ‰“è€…",
            inputs: [{id:'slg', label:'é•·æ‰“ç‡'}, {id:'avg', label:'æ‰“ç‡'}],
            calc: (d) => (d.slg - d.avg).toFixed(3).replace(/^0/,'')
        },
        {
            id: "babip", category: "bat", title: "BABIP", full: "Batting Average on Balls In Play",
            short: "ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼æ‰“çƒã®ãƒ’ãƒƒãƒˆç‡ï¼ˆé‹ã®æŒ‡æ¨™ï¼‰ã€‚",
            desc: "æœ¬å¡æ‰“ä»¥å¤–ã®ãƒ•ã‚§ã‚¢ã‚¾ãƒ¼ãƒ³ã«é£›ã‚“ã æ‰“çƒãŒãƒ’ãƒƒãƒˆã«ãªã£ãŸå‰²åˆã€‚æ¥µç«¯ã«é«˜ã„/ä½ã„å ´åˆã¯ã€Œé‹ã€ã‚„ã€Œå®ˆå‚™ã€ã®å½±éŸ¿ãŒå¼·ãã€ç¿Œå¹´ã¯å¹³å‡ï¼ˆç´„.300ï¼‰ã«è¿‘ã¥ãå‚¾å‘ãŒã‚ã‚‹ã€‚",
            formula: `(${formatVar('å®‰æ‰“')}-${formatVar('æœ¬å¡æ‰“')}) Ã· (${formatVar('æ‰“æ•°')}-${formatVar('ä¸‰æŒ¯')}-${formatVar('æœ¬å¡æ‰“')}+${formatVar('çŠ é£›')})`,
            criteria: ".300å‰å¾ŒãŒåŸºæº–",
            inputs: [{id:'h', label:'å®‰æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'}, {id:'ab', label:'æ‰“æ•°'}, {id:'so', label:'ä¸‰æŒ¯'}, {id:'sf', label:'çŠ é£›'}],
            calc: (d) => ((d.h - d.hr) / (d.ab - d.so - d.hr + d.sf)).toFixed(3).replace(/^0/,'')
        },
        {
            id: "bb_k", category: "bat", title: "BB/K", full: "Walk to Strikeout Ratio",
            short: "ä¸‰æŒ¯1ã¤ã«å¯¾ã™ã‚‹å››çƒã®æ•°ã€‚",
            desc: "é¸çƒçœ¼ã¨ã‚³ãƒ³ã‚¿ã‚¯ãƒˆèƒ½åŠ›ã®ãƒãƒ©ãƒ³ã‚¹ã‚’ç¤ºã™ã€‚1.0ã‚’è¶…ãˆã‚Œã°éå¸¸ã«å„ªç§€ãªæ‰“è€…ã¨ã•ã‚Œã‚‹ã€‚",
            formula: `${formatVar('å››çƒ')} Ã· ${formatVar('ä¸‰æŒ¯')}`,
            criteria: "0.4: å¹³å‡ / 1.0ä»¥ä¸Š: å„ªç§€",
            inputs: [{id:'bb', label:'å››çƒ'}, {id:'so', label:'ä¸‰æŒ¯'}],
            calc: (d) => (d.bb / d.so).toFixed(2)
        },
        {
            id: "k_pct", category: "bat", title: "K%", full: "Strikeout Percentage",
            short: "æ‰“å¸­ã«å ã‚ã‚‹ä¸‰æŒ¯ã®å‰²åˆã€‚",
            desc: "ä¸‰æŒ¯ãŒå°‘ãªã„ã»ã©ã‚³ãƒ³ã‚¿ã‚¯ãƒˆèƒ½åŠ›ãŒé«˜ã„ã¨ã•ã‚Œã‚‹ãŒã€ç¾ä»£é‡çƒã§ã¯é•·æ‰“ã¨ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã¨ã—ã¦ã‚ã‚‹ç¨‹åº¦è¨±å®¹ã•ã‚Œã‚‹å‚¾å‘ã€‚",
            formula: `${formatVar('ä¸‰æŒ¯')} Ã· ${formatVar('æ‰“å¸­')}`,
            criteria: "20%: å¹³å‡ / 10%ä»¥ä¸‹: ã‚³ãƒ³ã‚¿ã‚¯ãƒˆå·§è€…",
            inputs: [{id:'so', label:'ä¸‰æŒ¯'}, {id:'pa', label:'æ‰“å¸­'}],
            calc: (d) => ((d.so / d.pa) * 100).toFixed(1) + '%'
        },
        {
            id: "bb_pct", category: "bat", title: "BB%", full: "Walk Percentage",
            short: "æ‰“å¸­ã«å ã‚ã‚‹å››çƒã®å‰²åˆã€‚",
            desc: "é¸çƒçœ¼ã®è‰¯ã•ã‚’ç¤ºã™ã€‚æ‰“ç‡ãŒä½ãã¦ã‚‚BB%ãŒé«˜ã„é¸æ‰‹ã¯å‡ºå¡èƒ½åŠ›ãŒé«˜ãã€ãƒãƒ¼ãƒ ã¸ã®è²¢çŒ®åº¦ã¯å¤§ãã„ã€‚",
            formula: `${formatVar('å››çƒ')} Ã· ${formatVar('æ‰“å¸­')}`,
            criteria: "8%: å¹³å‡ / 10%ä»¥ä¸Š: é¸çƒçœ¼ãŒè‰¯ã„",
            inputs: [{id:'bb', label:'å››çƒ'}, {id:'pa', label:'æ‰“å¸­'}],
            calc: (d) => ((d.bb / d.pa) * 100).toFixed(1) + '%'
        },
        {
            id: "rc", category: "bat", title: "RC", full: "Runs Created",
            short: "æ‰“è€…ãŒå‰µå‡ºã—ãŸç·å¾—ç‚¹æ•°ã€‚",
            desc: "ãƒ“ãƒ«ãƒ»ã‚¸ã‚§ãƒ¼ãƒ ã‚ºãŒè€ƒæ¡ˆã—ãŸå¤å…¸çš„ãªæŒ‡æ¨™ã€‚å®‰æ‰“ã‚„å››çƒãªã©ã®å‡ºå¡èƒ½åŠ›ã¨ã€é•·æ‰“åŠ›ã‚’æ›ã‘åˆã‚ã›ã¦å¾—ç‚¹èƒ½åŠ›ã‚’æ¨å®šã™ã‚‹ã€‚",
            formula: `(å‡ºå¡èƒ½åŠ›A Ã— é€²å¡èƒ½åŠ›B) Ã· (æ‰“å¸­C)`,
            criteria: "ç©ã¿ä¸Šã’å‹æŒ‡æ¨™",
            inputs: [{id:'h', label:'å®‰æ‰“'}, {id:'bb', label:'å››çƒ'}, {id:'tb', label:'å¡æ‰“'}, {id:'ab', label:'æ‰“æ•°'}, {id:'sf', label:'çŠ é£›'}],
            calc: (d) => {
                // Basic RC Formula
                const a = d.h + d.bb;
                const b = d.tb;
                const c = d.ab + d.bb;
                return ((a * b) / c).toFixed(1);
            }
        },
        {
            id: "rc27", category: "bat", title: "RC27", full: "Runs Created per 27 Outs",
            short: "ã“ã®æ‰“è€…9äººã§æ‰“ç·šã‚’çµ„ã‚“ã æ™‚ã®1è©¦åˆäºˆæƒ³å¾—ç‚¹ã€‚",
            desc: "RCã‚’27ã‚¢ã‚¦ãƒˆï¼ˆ1è©¦åˆåˆ†ï¼‰ã«æ›ç®—ã—ãŸã‚‚ã®ã€‚æ‰“è€…ã®å¾—ç‚¹èƒ½åŠ›ã‚’ç›´æ„Ÿçš„ã«ç†è§£ã—ã‚„ã™ã„ã€‚",
            formula: `RC Ã· (${formatVar('æ‰“æ•°')}-${formatVar('å®‰æ‰“')}+${formatVar('ç›—å¡æ­»')}+${formatVar('ä½µæ®º')}+${formatVar('çŠ æ‰“')}+${formatVar('çŠ é£›')}) Ã— 27`,
            criteria: "4.5ç‚¹: å¹³å‡",
            inputs: [{id:'h', label:'å®‰æ‰“'}, {id:'bb', label:'å››çƒ'}, {id:'tb', label:'å¡æ‰“'}, {id:'ab', label:'æ‰“æ•°'}],
            calc: (d) => {
                const rc = ((d.h + d.bb) * d.tb) / (d.ab + d.bb);
                const outs = d.ab - d.h; 
                return (rc / outs * 27).toFixed(2);
            }
        },
        {
            id: "xr", category: "bat", title: "XR", full: "Extrapolated Runs",
            short: "å„ãƒ—ãƒ¬ãƒ¼ã«å¾—ç‚¹ä¾¡å€¤ä¿‚æ•°ã‚’æ›ã‘ã¦ç®—å‡ºã™ã‚‹å¾—ç‚¹åŠ›ã€‚",
            desc: "RCã¨ä¼¼ã¦ã„ã‚‹ãŒã€ã‚ˆã‚Šå„ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå˜æ‰“0.5ç‚¹ã€æœ¬å¡æ‰“1.44ç‚¹ãªã©ï¼‰ã®å¾—ç‚¹è²¢çŒ®ã‚’ç·šå½¢çš„ã«è¶³ã—åˆã‚ã›ã¦è©•ä¾¡ã™ã‚‹æ—¥æœ¬ã§äººæ°—ã®æŒ‡æ¨™ã€‚",
            formula: `0.5Ã—${formatVar('å˜æ‰“')} + 0.72Ã—${formatVar('äºŒå¡æ‰“')} + 1.44Ã—${formatVar('HR')} + 0.34Ã—(${formatVar('å››çƒ')}+${formatVar('æ­»çƒ')})...`,
            criteria: "RC27ã¨åŒæ§˜ã«è©•ä¾¡å¯èƒ½",
            related: ["rc27"],
            inputs: [{id:'s', label:'å˜æ‰“'}, {id:'d', label:'äºŒå¡æ‰“'}, {id:'t', label:'ä¸‰å¡æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'}, {id:'bb', label:'å››æ­»çƒ'}],
            calc: (d) => (0.5*d.s + 0.72*d.d + 1.04*d.t + 1.44*d.hr + 0.34*d.bb).toFixed(1)
        },
        {
            id: "ab_hr", category: "bat", title: "AB/HR", full: "At Bats per Home Run",
            short: "HR1æœ¬æ‰“ã¤ã®ã«ã‹ã‹ã‚‹æ‰“æ•°ã€‚",
            formula: `${formatVar('æ‰“æ•°')} Ã· ${formatVar('æœ¬å¡æ‰“')}`,
            criteria: "20.0ä»¥ä¸‹: æœ¬å¡æ‰“æ‰“è€…",
            inputs: [{id:'ab', label:'æ‰“æ•°'}, {id:'hr', label:'æœ¬å¡æ‰“'}],
            calc: (d) => (d.ab / d.hr).toFixed(1)
        },
        {
            id: "pa_bb", category: "bat", title: "PA/BB", full: "Plate Appearances per Walk",
            short: "å››çƒã‚’1ã¤é¸ã¶ã®ã«ã‹ã‹ã‚‹æ‰“å¸­æ•°ã€‚",
            formula: `${formatVar('æ‰“å¸­')} Ã· ${formatVar('å››çƒ')}`,
            inputs: [{id:'pa', label:'æ‰“å¸­'}, {id:'bb', label:'å››çƒ'}],
            calc: (d) => (d.pa / d.bb).toFixed(1)
        },
        {
            id: "isod", category: "bat", title: "IsoD", full: "Isolated Discipline",
            short: "å››æ­»çƒã«ã‚ˆã‚‹å‡ºå¡èƒ½åŠ›ã€‚",
            desc: "å‡ºå¡ç‡ã‹ã‚‰æ‰“ç‡ã‚’å¼•ã„ã¦ç®—å‡ºã™ã‚‹ã€‚é¸çƒçœ¼ã®è‰¯ã•ã‚’ç¤ºã™ã€‚",
            formula: `${formatVar('å‡ºå¡ç‡')} - ${formatVar('æ‰“ç‡')}`,
            criteria: "0.06: å¹³å‡ / 0.10: é¸çƒçœ¼è‰¯",
            inputs: [{id:'obp', label:'å‡ºå¡ç‡'}, {id:'avg', label:'æ‰“ç‡'}],
            calc: (d) => (d.obp - d.avg).toFixed(3).replace(/^0/,'')
        },
        {
            id: "gpa", category: "bat", title: "GPA", full: "Gross Production Average",
            short: "OPSã‚ˆã‚Šæ‰“ç‡ã«è¿‘ã„æ„Ÿè¦šã§è©•ä¾¡ã§ãã‚‹æŒ‡æ¨™ã€‚",
            desc: "OPSã¯å‡ºå¡ç‡ã‚’éå°è©•ä¾¡ã™ã‚‹å‚¾å‘ãŒã‚ã‚‹ãŸã‚ã€å‡ºå¡ç‡ã«1.8å€ã®é‡ã¿ã‚’ã‹ã‘ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã€ã•ã‚‰ã«æ‰“ç‡ã®ã‚ˆã†ãªã‚¹ã‚±ãƒ¼ãƒ«ã«å¤‰æ›ã—ãŸã‚‚ã®ã€‚",
            formula: `(1.8 Ã— ${formatVar('å‡ºå¡ç‡')} + ${formatVar('é•·æ‰“ç‡')}) Ã· 4`,
            criteria: ".250: å¹³å‡",
            inputs: [{id:'obp', label:'å‡ºå¡ç‡'}, {id:'slg', label:'é•·æ‰“ç‡'}],
            calc: (d) => ((1.8 * d.obp + d.slg) / 4).toFixed(3).replace(/^0/,'')
        },
        {
            id: "seca", category: "bat", title: "SecA", full: "Secondary Average",
            short: "æ‰“ç‡ä»¥å¤–ã®è¦ç´ ï¼ˆå››çƒã€é•·æ‰“ã€ç›—å¡ï¼‰ã§ã®è²¢çŒ®åº¦ã€‚",
            desc: "ãƒ“ãƒ«ãƒ»ã‚¸ã‚§ãƒ¼ãƒ ã‚ºè€ƒæ¡ˆã€‚ã€Œæ‰“ç‡ã€ã«å«ã¾ã‚Œãªã„æ”»æ’ƒåŠ›ã‚’æ¸¬ã‚‹ã€‚",
            formula: `(${formatVar('å¡æ‰“')}-${formatVar('å®‰æ‰“')} + ${formatVar('å››çƒ')} + ${formatVar('ç›—å¡')} - ${formatVar('ç›—å¡æ­»')}) Ã· ${formatVar('æ‰“æ•°')}`,
            criteria: ".250: å¹³å‡ / .400: è¶…å„ªç§€",
            inputs: [{id:'tb', label:'å¡æ‰“'}, {id:'h', label:'å®‰æ‰“'}, {id:'bb', label:'å››çƒ'}, {id:'sb', label:'ç›—å¡'}, {id:'cs', label:'ç›—å¡æ­»'}, {id:'ab', label:'æ‰“æ•°'}],
            calc: (d) => ((d.tb - d.h + d.bb + d.sb - d.cs) / d.ab).toFixed(3).replace(/^0/,'')
        },
        {
            id: "noi", category: "bat", title: "NOI", full: "New Offensive Index",
            short: "å‡ºå¡ç‡ï¼‹é•·æ‰“ç‡Ã·3ã€‚",
            desc: "OPSã®ç°¡æ˜“ä¿®æ­£ç‰ˆã€‚å‡ºå¡ç‡ã®ä¾¡å€¤ã‚’é•·æ‰“ç‡ã®3å€ã¨è¦‹ç©ã‚‚ã£ã¦è¨ˆç®—ã™ã‚‹ã€‚æ—¥æœ¬ç‹¬è‡ªã®æŒ‡æ¨™ã€‚",
            formula: `(${formatVar('å‡ºå¡ç‡')} + ${formatVar('é•·æ‰“ç‡')} Ã· 3) Ã— 1000`,
            criteria: "450: å¹³å‡ / 550: å„ªç§€",
            inputs: [{id:'obp', label:'å‡ºå¡ç‡'}, {id:'slg', label:'é•·æ‰“ç‡'}],
            calc: (d) => ((d.obp + d.slg / 3) * 1000).toFixed(0)
        },
        
        /* ---------------- æŠ•çƒ (Pitching) ---------------- */
        {
            id: "era", category: "std", title: "ERA", full: "Earned Run Average",
            short: "é˜²å¾¡ç‡ã€‚",
            formula: `${formatVar('è‡ªè²¬ç‚¹')} Ã— 9 Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "3.00: å¹³å‡",
            inputs: [{id:'er', label:'è‡ªè²¬ç‚¹'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => (d.er * 9 / d.ip).toFixed(2)
        },
        {
            id: "whip", category: "std", title: "WHIP", full: "Walks plus Hits per Inning Pitched",
            short: "1å›ã‚ãŸã‚Šã«å‡ºã—ãŸãƒ©ãƒ³ãƒŠãƒ¼ã®æ•°ã€‚",
            formula: `(${formatVar('è¢«å®‰æ‰“')} + ${formatVar('ä¸å››çƒ')}) Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "1.30: å¹³å‡ / 1.00æœªæº€: ã‚¨ãƒ¼ã‚¹",
            inputs: [{id:'h', label:'è¢«å®‰æ‰“'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => ((d.h + d.bb) / d.ip).toFixed(2)
        },
        {
            id: "fip", category: "pit", title: "FIP", full: "Fielding Independent Pitching",
            short: "å®ˆå‚™ã®å½±éŸ¿ã‚’é™¤å¤–ã—ãŸã€ŒçœŸã®é˜²å¾¡ç‡ã€ã€‚",
            desc: "æŠ•æ‰‹ã®è²¬ä»»ã§ã‚ã‚‹ä¸‰æŒ¯ãƒ»å››çƒãƒ»è¢«æœ¬å¡æ‰“ã®ã¿ã§è©•ä¾¡ã™ã‚‹ã€‚é˜²å¾¡ç‡ã‚ˆã‚Šã‚‚å°†æ¥ã®æˆç¸¾äºˆæ¸¬ã«å½¹ç«‹ã¤ã€‚",
            formula: `(13Ã—${formatVar('æœ¬å¡æ‰“')} + 3Ã—(${formatVar('å››çƒ')}+${formatVar('æ­»çƒ')}) - 2Ã—${formatVar('ä¸‰æŒ¯')}) Ã· ${formatVar('æŠ•çƒå›')} + 3.10`,
            criteria: "é˜²å¾¡ç‡ã¨åŒã˜æ„Ÿè¦šã§è©•ä¾¡",
            inputs: [{id:'hr', label:'è¢«æœ¬å¡æ‰“'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'hbp', label:'ä¸æ­»çƒ'}, {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => ((13*d.hr + 3*(d.bb+d.hbp) - 2*d.so)/d.ip + 3.10).toFixed(2)
        },
        {
            id: "xfip", category: "pit", title: "xFIP", full: "Expected FIP",
            short: "è¢«æœ¬å¡æ‰“ã®ä»£ã‚ã‚Šã«ã€Œãƒ•ãƒ©ã‚¤ãƒœãƒ¼ãƒ«æ•°ã€ã‚’ç”¨ã„ãŸFIPã®é€²åŒ–ç‰ˆã€‚",
            desc: "HR/FBï¼ˆãƒ•ãƒ©ã‚¤ã«å¯¾ã™ã‚‹æœ¬å¡æ‰“ã®å‰²åˆï¼‰ã‚’ãƒªãƒ¼ã‚°å¹³å‡å€¤ï¼ˆç´„10.5%ï¼‰ã«ç½®ãæ›ãˆã¦è¨ˆç®—ã—ã¾ã™ã€‚è¢«æœ¬å¡æ‰“ã®é‹è¦ç´ ã‚’æ’é™¤ã—ã€ã‚ˆã‚Šç´”ç²‹ãªå®ŸåŠ›ã‚’æ¸¬ã‚Šã¾ã™ã€‚",
            formula: `(13Ã—(FBÃ—0.105) + 3Ã—(BB+HBP) - 2Ã—SO) Ã· IP + 3.10`,
            criteria: "é˜²å¾¡ç‡ã‚¹ã‚±ãƒ¼ãƒ«",
            inputs: [{id:'fb', label:'ãƒ•ãƒ©ã‚¤æ•°'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'hbp', label:'ä¸æ­»çƒ'}, {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => {
                // xFIP Constant approx 3.10, HR/FB approx 10.5%
                return ((13 * (d.fb * 0.105) + 3 * (d.bb + d.hbp) - 2 * d.so) / d.ip + 3.10).toFixed(2);
            }
        },
        {
            id: "siera", category: "pit", title: "SIERA", full: "Skill-Interactive Earned Run Average",
            short: "æ‰“çƒã®è³ªã‚„ä¸‰æŒ¯ãƒ»å››çƒã‚’è€ƒæ…®ã—ãŸã€FIPã‚ˆã‚Šç²¾åº¦ã®é«˜ã„å°†æ¥äºˆæ¸¬æŒ‡æ¨™ã€‚",
            desc: "ã‚´ãƒ­ã€ãƒ•ãƒ©ã‚¤ã€å†…é‡ãƒ•ãƒ©ã‚¤ã®æ§‹æˆæ¯”ã‚„ã€ãã‚ŒãŒä¸‰æŒ¯ãƒ»å››çƒã¨ã©ã†çµ„ã¿åˆã‚ã•ã‚‹ã‹ã‚’è€ƒæ…®ã—ã¦è¨ˆç®—ã•ã‚Œã‚‹ã€‚æŠ•çƒã®ã€Œè³ªã€ã‚’æœ€ã‚‚æ­£ç¢ºã«åæ˜ ã™ã‚‹ã¨ã•ã‚Œã‚‹æŒ‡æ¨™ã®ä¸€ã¤ã€‚",
            formula: `6.145 - 16.986Ã—(SO/PA) + 11.434Ã—(BB/PA) - 1.858Ã—((GB-FB-PU)/PA) + ...`,
            criteria: "é˜²å¾¡ç‡ã‚¹ã‚±ãƒ¼ãƒ«",
            related: ["fip", "xfip", "tra"],
            inputs: [
                {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}, 
                {id:'gb', label:'ã‚´ãƒ­'}, {id:'fb', label:'ãƒ•ãƒ©ã‚¤'}, {id:'pu', label:'å†…é‡ãƒ•ãƒ©ã‚¤'},
                {id:'bf', label:'æ‰“è€…æ•°'}
            ],
            calc: (d) => {
                const pa = d.bf;
                if(!pa) return "---";
                
                const A = d.so / pa;
                const B = d.bb / pa;
                const C = (d.gb - d.fb - d.pu) / pa;
                
                const val = 6.145 - 16.986*A + 11.434*B - 1.858*C + 7.653*Math.pow(A,2) + 6.664*Math.pow(C,2) + 10.130*A*C - 5.195*B*C;
                return val.toFixed(2);
            }
        },
        {
            id: "tra", category: "pit", title: "tRA", full: "True Runs Allowed",
            short: "æ‰“çƒã®ç¨®é¡ï¼ˆã‚´ãƒ­ãƒ»ãƒ•ãƒ©ã‚¤ï¼‰ã‚‚è€ƒæ…®ã—ãŸç©¶æ¥µã®æŒ‡æ¨™ã€‚",
            desc: "FIPã‚’ç™ºå±•ã•ã›ã€å¥ªä¸‰æŒ¯ãƒ»å››æ­»çƒã«åŠ ãˆã€æ‰“ãŸã‚ŒãŸæ‰“çƒãŒã‚´ãƒ­ã‹ãƒ•ãƒ©ã‚¤ã‹ãƒ©ã‚¤ãƒŠãƒ¼ã‹ã«ã‚ˆã£ã¦æœŸå¾…å¤±ç‚¹å€¤ã‚’å‰²ã‚Šå½“ã¦ã¦ç®—å‡ºã™ã‚‹ã€‚1.02ãªã©ã®ã‚µã‚¤ãƒˆã§æ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ã€‚",
            formula: `æ‰“çƒç¨®åˆ¥ã”ã¨ã®æœŸå¾…å¤±ç‚¹å€¤ã®ç·å’Œ`,
            criteria: "é˜²å¾¡ç‡ã‚¹ã‚±ãƒ¼ãƒ«",
            related: ["fip"]
        },
        {
            id: "k_9", category: "pit", title: "K/9", full: "Strikeouts per 9",
            short: "å¥ªä¸‰æŒ¯ç‡ã€‚",
            formula: `${formatVar('å¥ªä¸‰æŒ¯')} Ã— 9 Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "7.0: å¹³å‡ / 9.0: ãƒ‰ã‚¯ã‚¿ãƒ¼K",
            inputs: [{id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => (d.so * 9 / d.ip).toFixed(2)
        },
        {
            id: "bb_9", category: "pit", title: "BB/9", full: "Walks per 9",
            short: "ä¸å››çƒç‡ã€‚",
            formula: `${formatVar('ä¸å››çƒ')} Ã— 9 Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "3.0: å¹³å‡ / 2.0ä»¥ä¸‹: åˆ¶çƒè‰¯",
            inputs: [{id:'bb', label:'ä¸å››çƒ'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => (d.bb * 9 / d.ip).toFixed(2)
        },
        {
            id: "k_bb_pit", category: "pit", title: "K/BB", full: "K-to-BB Ratio",
            short: "å¥ªä¸‰æŒ¯ã¨ä¸å››çƒã®æ¯”ç‡ã€‚",
            desc: "æŠ•æ‰‹ã®å®Œæˆåº¦ãƒ»å®‰å®šæ„Ÿã‚’ç¤ºã™é‡è¦æŒ‡æ¨™ã€‚3.5ã‚’è¶…ãˆã‚‹ã¨éå¸¸ã«å„ªç§€ã¨ã•ã‚Œã‚‹ã€‚",
            formula: `${formatVar('å¥ªä¸‰æŒ¯')} Ã· ${formatVar('ä¸å››çƒ')}`,
            criteria: "2.5: å¹³å‡ / 4.0: éå¸¸ã«å„ªç§€",
            inputs: [{id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}],
            calc: (d) => (d.so / d.bb).toFixed(2)
        },
        {
            id: "hr_9", category: "pit", title: "HR/9", full: "Home Runs per 9",
            short: "è¢«æœ¬å¡æ‰“ç‡ã€‚",
            formula: `${formatVar('è¢«æœ¬å¡æ‰“')} Ã— 9 Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "1.0æœªæº€ãŒæœ›ã¾ã—ã„",
            inputs: [{id:'hr', label:'è¢«æœ¬å¡æ‰“'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => (d.hr * 9 / d.ip).toFixed(2)
        },
        {
            id: "dice", category: "pit", title: "DICE", full: "Defense Independent Component ERA",
            short: "FIPã¨ã»ã¼åŒã˜æ¦‚å¿µã®æŒ‡æ¨™ã€‚",
            desc: "FIPã¨è¨ˆç®—å¼ãŒéå¸¸ã«ä¼¼ã¦ã„ã‚‹ãŒã€ä¿‚æ•°ãŒå¾®å¦™ã«ç•°ãªã‚‹ã€‚å®ˆå‚™ã«ä¾å­˜ã—ãªã„æŠ•çƒå†…å®¹ã‚’è©•ä¾¡ã™ã‚‹ã€‚",
            formula: `3.00 + (13Ã—${formatVar('HR')} + 3Ã—(${formatVar('å››çƒ')}+${formatVar('æ­»çƒ')}) - 2Ã—${formatVar('ä¸‰æŒ¯')}) Ã· ${formatVar('IP')}`,
            criteria: "é˜²å¾¡ç‡ã‚¹ã‚±ãƒ¼ãƒ«",
            inputs: [{id:'hr', label:'HR'}, {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ'}, {id:'so', label:'ä¸‰æŒ¯'}, {id:'ip', label:'IP'}],
            calc: (d) => (3.00 + (13*d.hr + 3*(d.bb+d.hbp) - 2*d.so)/d.ip).toFixed(2)
        },
        {
            id: "lob_pct", category: "pit", title: "LOB%", full: "Left On Base Percentage",
            short: "æ®‹å¡ç‡ï¼ˆãƒ©ãƒ³ãƒŠãƒ¼ã‚’è¿”ã•ãªã‹ã£ãŸå‰²åˆï¼‰ã€‚",
            desc: "æŠ•æ‰‹ã®ç²˜ã‚Šå¼·ã•ã‚’ç¤ºã™ãŒã€BABIPåŒæ§˜ã«é‹ã®è¦ç´ ã‚‚å¼·ã„ã€‚å¹³å‡ã¯ç´„72%ã§ã€æ¥µç«¯ã«é«˜ã„å ´åˆã¯ç¿Œå¹´ã¯æºã‚Šæˆ»ã—ãŒè­¦æˆ’ã•ã‚Œã‚‹ã€‚",
            formula: `(${formatVar('H')}+${formatVar('BB')}-${formatVar('R')}) Ã· (${formatVar('H')}+${formatVar('BB')}-1.4Ã—${formatVar('HR')})`,
            criteria: "72%å‰å¾Œ",
            inputs: [{id:'h', label:'è¢«å®‰æ‰“'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'r', label:'å¤±ç‚¹'}, {id:'hr', label:'è¢«HR'}],
            calc: (d) => (((d.h+d.bb-d.r)/(d.h+d.bb-1.4*d.hr))*100).toFixed(1) + '%'
        },
        {
            id: "pfr", category: "pit", title: "PFR", full: "Power/Finesse Ratio",
            short: "æŠ•æ‰‹ã®ã‚¿ã‚¤ãƒ—ï¼ˆæœ¬æ ¼æ´¾/æŠ€å·§æ´¾ï¼‰ã‚’åˆ†é¡ã™ã‚‹æŒ‡æ¨™ã€‚",
            desc: "å¥ªä¸‰æŒ¯ã¨ä¸å››çƒã®åˆè¨ˆã«ã‚ˆã‚‹è©•ä¾¡ã€‚é«˜ã„ã»ã©ä¸‰æŒ¯ãŒå–ã‚Œã¦å››çƒã‚’å‡ºã•ãªã„ã€Œãƒ‘ãƒ¯ãƒ¼ãƒ”ãƒƒãƒãƒ£ãƒ¼ã€å¯„ã‚Šã€‚",
            formula: `(${formatVar('å¥ªä¸‰æŒ¯')} + ${formatVar('ä¸å››çƒ')}) Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "-",
            inputs: [{id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => ((d.so + d.bb) / d.ip).toFixed(2)
        },
        {
            id: "ld_pct", category: "pit", title: "LD%", full: "Line Drive Percentage",
            short: "å…¨æ‰“çƒã«å ã‚ã‚‹ãƒ©ã‚¤ãƒŠãƒ¼ã®å‰²åˆã€‚",
            desc: "ãƒ©ã‚¤ãƒŠãƒ¼æ€§ã®æ‰“çƒã¯ãƒ’ãƒƒãƒˆã«ãªã‚Šã‚„ã™ã„ãŸã‚ã€ã“ã®æ•°å€¤ãŒé«˜ã„æŠ•æ‰‹ã¯BABIPãŒé«˜ããªã‚Šã‚„ã™ã„å‚¾å‘ãŒã‚ã‚‹ã€‚",
            formula: `${formatVar('LD')} Ã· (${formatVar('LD')}+${formatVar('GB')}+${formatVar('FB')})`,
            criteria: "10%: å¹³å‡",
            inputs: [{id:'ld', label:'ãƒ©ã‚¤ãƒŠãƒ¼'}, {id:'gb', label:'ã‚´ãƒ­'}, {id:'fb', label:'ãƒ•ãƒ©ã‚¤'}],
            calc: (d) => (d.ld / (d.ld + d.gb + d.fb) * 100).toFixed(1) + '%'
        },
        {
            id: "gb_pct", category: "pit", title: "GB%", full: "Ground Ball Percentage",
            short: "å…¨æ‰“çƒã«å ã‚ã‚‹ã‚´ãƒ­ã®å‰²åˆã€‚",
            desc: "ã‚´ãƒ­ãŒå¤šã„æŠ•æ‰‹ã¯é•·æ‰“ã‚’æµ´ã³ã«ããã€ä½µæ®ºã‚’å–ã‚Šã‚„ã™ã„ã€‚ä¸€èˆ¬çš„ã«45%å‰å¾ŒãŒå¹³å‡ã€‚",
            formula: `${formatVar('GB')} Ã· (${formatVar('LD')}+${formatVar('GB')}+${formatVar('FB')})`,
            criteria: "45%: å¹³å‡ / 50%è¶…: ã‚´ãƒ­P",
            inputs: [{id:'ld', label:'ãƒ©ã‚¤ãƒŠãƒ¼'}, {id:'gb', label:'ã‚´ãƒ­'}, {id:'fb', label:'ãƒ•ãƒ©ã‚¤'}],
            calc: (d) => (d.gb / (d.ld + d.gb + d.fb) * 100).toFixed(1) + '%'
        },
        {
            id: "fb_pct", category: "pit", title: "FB%", full: "Fly Ball Percentage",
            short: "å…¨æ‰“çƒã«å ã‚ã‚‹ãƒ•ãƒ©ã‚¤ã®å‰²åˆã€‚",
            desc: "ãƒ•ãƒ©ã‚¤ãŒå¤šã„æŠ•æ‰‹ã¯ä¸‰æŒ¯ãŒå¤šã„å‚¾å‘ãŒã‚ã‚‹ä¸€æ–¹ã€æœ¬å¡æ‰“ã‚’æ‰“ãŸã‚Œã‚‹ãƒªã‚¹ã‚¯ã‚‚é«˜ã¾ã‚‹ã€‚",
            formula: `${formatVar('FB')} Ã· (${formatVar('LD')}+${formatVar('GB')}+${formatVar('FB')})`,
            criteria: "45%: å¹³å‡",
            inputs: [{id:'ld', label:'ãƒ©ã‚¤ãƒŠãƒ¼'}, {id:'gb', label:'ã‚´ãƒ­'}, {id:'fb', label:'ãƒ•ãƒ©ã‚¤'}],
            calc: (d) => (d.fb / (d.ld + d.gb + d.fb) * 100).toFixed(1) + '%'
        },

        /* ---------------- å®ˆå‚™ (Fielding) ---------------- */
        {
            id: "uzr", category: "fld", title: "UZR", full: "Ultimate Zone Rating",
            short: "å®ˆå‚™ã«ã‚ˆã‚‹å¤±ç‚¹é˜²æ­¢é‡ï¼ˆå¹³å‡æ¯”ï¼‰ã€‚",
            desc: "1.02ãªã©ã§æ¡ç”¨ã•ã‚Œã‚‹å®ˆå‚™æŒ‡æ¨™ã®ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã€‚ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ã‚¾ãƒ¼ãƒ³ã«åˆ†å‰²ã—ã€æ‰“çƒã”ã¨ã®å‡¦ç†é›£æ˜“åº¦ã«å¿œã˜ã¦è²¢çŒ®åº¦ã‚’ç®—å‡ºã™ã‚‹ã€‚",
            formula: "åŠ ç‚¹æ–¹å¼",
            criteria: "0: å¹³å‡ / +15: ã‚´ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ©ãƒ–"
        },
        {
            id: "der", category: "fld", title: "DER", full: "Defensive Efficiency Ratio",
            short: "æœ¬å¡æ‰“ä»¥å¤–ã®ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼æ‰“çƒã‚’ã‚¢ã‚¦ãƒˆã«ã—ãŸå‰²åˆã€‚",
            desc: "ãƒãƒ¼ãƒ å…¨ä½“ã®å®ˆå‚™åŠ›ã‚’æ¸¬ã‚‹æŒ‡æ¨™ã€‚BABIPã®é€†æ•°ã«è¿‘ã„æ¦‚å¿µã€‚",
            formula: `1 - ((${formatVar('è¢«å®‰æ‰“')} - ${formatVar('è¢«HR')}) Ã· (${formatVar('æ‰“è€…')} - ${formatVar('ä¸‰æŒ¯')} - ${formatVar('å››çƒ')} - ${formatVar('æ­»çƒ')} - ${formatVar('è¢«HR')}))`,
            criteria: ".700å‰å¾ŒãŒå¹³å‡",
            inputs: [{id:'h', label:'è¢«å®‰æ‰“'}, {id:'hr', label:'è¢«HR'}, {id:'bf', label:'æ‰“è€…æ•°'}, {id:'so', label:'å¥ªä¸‰æŒ¯'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'hbp', label:'ä¸æ­»çƒ'}],
            calc: (d) => (1 - ((d.h - d.hr) / (d.bf - d.so - d.bb - d.hbp - d.hr))).toFixed(3).replace(/^0/,'')
        },
        {
            id: "drs", category: "fld", title: "DRS", full: "Defensive Runs Saved",
            short: "UZRã¨ä¸¦ã¶å®ˆå‚™æŒ‡æ¨™ã®æ±ºå®šç‰ˆã€‚",
            desc: "UZRã¨åŒæ§˜ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã ãŒã€æ¸¬å®šæ–¹æ³•ãŒç•°ãªã‚‹ã€‚MLBã§ã¯UZRã¨å…±ã«ã‚´ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ©ãƒ–è³ã®é¸è€ƒåŸºæº–ã¨ãªã‚‹ã€‚",
            formula: "åŠ ç‚¹æ–¹å¼",
            criteria: "+15ä»¥ä¸Š: æœ€é«˜ãƒ¬ãƒ™ãƒ«"
        },
        {
            id: "rf", category: "fld", title: "RF", full: "Range Factor",
            short: "1è©¦åˆã‚ãŸã‚Šã«é–¢ä¸ã—ãŸã‚¢ã‚¦ãƒˆã®æ•°ã€‚",
            desc: "å®ˆå‚™ç¯„å›²ã®åºƒã•ã‚’ç¤ºã™ã¨ã•ã‚Œã‚‹ãŒã€æŠ•æ‰‹ã®å¥ªä¸‰æŒ¯èƒ½åŠ›ãªã©ã«å½±éŸ¿ã‚’å—ã‘ã‚‹ãŸã‚ã€UZRãªã©ã‚ˆã‚Šç²¾åº¦ã¯ä½ã„ã€‚",
            formula: `(${formatVar('åˆºæ®º')}+${formatVar('è£œæ®º')}) Ã· ${formatVar('å®ˆå‚™å›')} Ã— 9`,
            inputs: [{id:'po', label:'åˆºæ®º'}, {id:'a', label:'è£œæ®º'}, {id:'inn', label:'å®ˆå‚™å›'}],
            calc: (d) => ((d.po + d.a) / d.inn * 9).toFixed(2)
        },
        {
            id: "fp", category: "fld", title: "FP%", full: "Fielding Percentage",
            short: "å®ˆå‚™ç‡ã€‚",
            desc: "å¤±ç­–ã‚’ã—ãªã‹ã£ãŸå‰²åˆã€‚å®ˆå‚™ç¯„å›²ã®åºƒã•ã¯è€ƒæ…®ã•ã‚Œãªã„ãŸã‚ã€ç¾ä»£ã®ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã¯é‡è¦è¦–ã•ã‚Œãªã„ã€‚",
            formula: `(${formatVar('åˆºæ®º')}+${formatVar('è£œæ®º')}) Ã· (${formatVar('åˆºæ®º')}+${formatVar('è£œæ®º')}+${formatVar('å¤±ç­–')})`,
            inputs: [{id:'po', label:'åˆºæ®º'}, {id:'a', label:'è£œæ®º'}, {id:'e', label:'å¤±ç­–'}],
            calc: (d) => ((d.po + d.a)/(d.po + d.a + d.e)).toFixed(3).replace(/^0/,'')
        },

        /* ---------------- èµ°å¡ (Running) ---------------- */
        {
            id: "wsb", category: "fld", title: "wSB", full: "weighted Stolen Base Runs",
            short: "ç›—å¡ã«ã‚ˆã‚‹å¾—ç‚¹è²¢çŒ®ã€‚",
            desc: "ç›—å¡æˆåŠŸã«ã‚ˆã‚‹ãƒ—ãƒ©ã‚¹ã¨ã€ç›—å¡æ­»ã«ã‚ˆã‚‹ãƒã‚¤ãƒŠã‚¹ï¼ˆæˆåŠŸã‚ˆã‚ŠãƒšãƒŠãƒ«ãƒ†ã‚£ãŒå¤§ãã„ï¼‰ã‚’åˆç®—ã—ãŸã‚‚ã®ã€‚",
            formula: `0.2Ã—${formatVar('ç›—å¡')} - 0.4Ã—${formatVar('ç›—å¡æ­»')}`,
            desc: "ä¿‚æ•°ã¯æ¦‚ç®—å€¤ã€‚ç›—å¡æ­»ã®ãƒã‚¤ãƒŠã‚¹ã¯æˆåŠŸã®ãƒ—ãƒ©ã‚¹ã‚ˆã‚Šå¤§ãã„ã€‚",
            inputs: [{id:'sb', label:'ç›—å¡'}, {id:'cs', label:'ç›—å¡æ­»'}],
            calc: (d) => (0.2*d.sb - 0.4*d.cs).toFixed(1)
        },
        {
            id: "sb_pct", category: "fld", title: "SB%", full: "Stolen Base Percentage",
            short: "ç›—å¡æˆåŠŸç‡ã€‚",
            formula: `${formatVar('ç›—å¡')} Ã· (${formatVar('ç›—å¡')} + ${formatVar('ç›—å¡æ­»')})`,
            criteria: "70%ä»¥ä¸ŠãŒæç›Šåˆ†å²ç‚¹",
            inputs: [{id:'sb', label:'ç›—å¡'}, {id:'cs', label:'ç›—å¡æ­»'}],
            calc: (d) => ((d.sb / (d.sb + d.cs)) * 100).toFixed(1) + '%'
        },

        /* ---------------- ãã®ä»– ---------------- */
        {
            id: "p_ip", category: "pit", title: "P/IP", full: "Pitches per Inning",
            short: "1ã‚¤ãƒ‹ãƒ³ã‚°ã‚ãŸã‚Šã®æŠ•çƒæ•°ã€‚",
            formula: `${formatVar('æŠ•çƒæ•°')} Ã· ${formatVar('æŠ•çƒå›')}`,
            criteria: "15çƒä»¥ä¸‹: çœã‚¨ãƒ",
            inputs: [{id:'np', label:'çƒæ•°'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => (d.np / d.ip).toFixed(1)
        },
        {
            id: "rsaa", category: "pit", title: "RSAA", full: "Runs Saved Above Average",
            short: "å¹³å‡çš„ãªæŠ•æ‰‹ã«æ¯”ã¹ã¦ã€ã©ã‚Œã ã‘å¤±ç‚¹ã‚’é˜²ã„ã ã‹ã€‚",
            desc: "é˜²å¾¡ç‡ã¨æŠ•çƒå›ã‚’åŸºã«ç®—å‡ºã™ã‚‹ç©ã¿ä¸Šã’ç³»æŒ‡æ¨™ã€‚WARã®æŠ•çƒç‰ˆã®ç°¡æ˜“è¨ˆç®—ã«ä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚",
            formula: `(ãƒªãƒ¼ã‚°å¹³å‡é˜²å¾¡ç‡ - ${formatVar('é˜²å¾¡ç‡')}) Ã— ${formatVar('æŠ•çƒå›')} Ã· 9`,
            criteria: "ãƒ—ãƒ©ã‚¹ãªã‚‰å¹³å‡ä»¥ä¸Š",
            inputs: [{id:'lg_era', label:'Lå¹³å‡é˜²å¾¡ç‡'}, {id:'era', label:'é˜²å¾¡ç‡'}, {id:'ip', label:'æŠ•çƒå›'}],
            calc: (d) => ((d.lg_era - d.era) * d.ip / 9).toFixed(1)
        }
    ];

    // --- Application Logic ---
    const grid = document.getElementById('grid');
    const modal = document.getElementById('modal');
    const modalTitleArea = document.getElementById('modal-title-area');
    const modalBodyContent = document.getElementById('modal-body-content');
    const searchInput = document.getElementById('searchInput');
    const filterChips = document.querySelectorAll('.filter-chip');
    
    let currentFilter = 'all';
    let currentSearch = '';
    let currentTermId = null; // Track currently open modal for OCR

    // Dark Mode Toggle Function
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const btn = document.querySelector('.theme-toggle');
        if (document.body.classList.contains('dark-mode')) {
            btn.textContent = 'â˜€ï¸';
            btn.title = "Light Mode";
        } else {
            btn.textContent = 'ğŸŒ™';
            btn.title = "Dark Mode";
        }
    }

    function render() {
        grid.innerHTML = '';
        
        const filtered = terms.filter(term => {
            const catMatch = currentFilter === 'all' || term.category === currentFilter;
            const searchLower = currentSearch.toLowerCase();
            const searchMatch = !currentSearch || 
                term.title.toLowerCase().includes(searchLower) || 
                term.full.toLowerCase().includes(searchLower) ||
                term.short.includes(currentSearch) ||
                (term.desc && term.desc.includes(currentSearch));
            return catMatch && searchMatch;
        });

        if(filtered.length === 0) {
            grid.innerHTML = '<div class="no-result">ä¸€è‡´ã™ã‚‹ç”¨èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
            return;
        }

        filtered.forEach(term => {
            const el = document.createElement('div');
            el.className = `metric-card cat-${term.category}`;
            el.onclick = () => openModal(term.id);
            
            let catLabel = getCatLabel(term.category);
            // æ–‡è¨€å¤‰æ›´: è©³ç´°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -> æ¨å®š, ã‚¢ã‚¤ã‚³ãƒ³ã¯ã‚°ãƒ©ãƒ•(ğŸ“Š)ã®ã¾ã¾
            const hasCalc = term.inputs ? `<span class="calc-icon ${term.aiMode ? 'ai' : ''}" title="${term.aiMode ? 'æ¨å®š' : 'è¨ˆç®—å¯èƒ½'}">${term.aiMode ? 'ğŸ“Š' : 'ğŸ§®'}</span>` : '';
            
            el.innerHTML = `
                <div class="card-header">
                    <span class="card-tag">${catLabel}</span>
                    ${hasCalc}
                </div>
                <h3 class="metric-title">${term.title}</h3>
                <div class="metric-full">${term.full}</div>
                <p class="metric-desc">${term.short}</p>
            `;
            grid.appendChild(el);
        });
    }

    function getCatLabel(cat) {
        switch(cat){
            case 'bat': return "Batting";
            case 'pit': return "Pitching";
            case 'fld': return "Fielding";
            case 'tot': return "Overall";
            case 'std': return "Basic";
            default: return "";
        }
    }
    
    function getCatColor(cat) {
        switch(cat){
            case 'bat': return "#0ea5e9";
            case 'pit': return "#f43f5e";
            case 'fld': return "#f59e0b";
            case 'tot': return "#10b981";
            case 'std': return "#6366f1";
            default: return "#64748b";
        }
    }

    function handleSearch() {
        currentSearch = searchInput.value;
        render();
    }

    function filterCategory(cat) {
        currentFilter = cat;
        filterChips.forEach(chip => {
            if(chip.dataset.cat === cat) chip.classList.add('active');
            else chip.classList.remove('active');
        });
        render();
    }

    function createInputHtml(inp) {
        if(inp.type === 'select') {
            const opts = Object.keys(inp.options).map(k => `<option value="${k}">${inp.options[k]}</option>`).join('');
            return `
                <div class="calc-group">
                    <label class="calc-label">${inp.label}</label>
                    <select class="calc-select" id="calc-${inp.id}">
                        ${opts}
                    </select>
                </div>
            `;
        } else {
            // Handle default value if present
            const defaultVal = inp.default !== undefined ? inp.default : '';
            const advClass = inp.advanced ? 'advanced-input' : '';
            return `
                <div class="calc-group">
                    <label class="calc-label">${inp.label}</label>
                    <input type="number" class="calc-field ${advClass}" id="calc-${inp.id}" placeholder="0" value="${defaultVal}" ${inp.advanced ? 'oninput="checkAdvancedChanges()"' : ''}>
                </div>
            `;
        }
    }

    function openModal(id) {
        currentTermId = id; // Set current term ID
        const term = terms.find(t => t.id === id);
        if(!term) return;

        // Build Related HTML
        let relatedHtml = '';
        if(term.related && term.related.length > 0) {
            term.related.forEach(rid => {
                const rTerm = terms.find(t => t.id === rid);
                if(rTerm) {
                    relatedHtml += `<div class="rel-chip" onclick="event.stopPropagation(); openModal('${rid}')">${rTerm.title}</div>`;
                }
            });
        }

        // Build Calculator HTML if inputs exist
        let calcHtml = '';
        if(term.inputs && term.calc) {
            const basicInputs = [];
            const advancedInputs = [];

            term.inputs.forEach(inp => {
                if (inp.advanced) {
                    advancedInputs.push(inp);
                } else {
                    basicInputs.push(inp);
                }
            });

            const basicInputsHtml = basicInputs.map(inp => createInputHtml(inp)).join('');
            
            let advancedSectionHtml = '';
            if (advancedInputs.length > 0) {
                const advInputsHtml = advancedInputs.map(inp => createInputHtml(inp)).join('');
                advancedSectionHtml = `
                    <details class="advanced-details">
                        <summary class="advanced-summary">è©³ç´°è¨­å®š (ãƒªãƒ¼ã‚°å¹³å‡å€¤ãªã©)</summary>
                        <div class="advanced-content">
                            ${advInputsHtml}
                        </div>
                        <div id="warning-box" class="warning-msg" style="display:none;">
                            âš ï¸ è©³ç´°è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã¨ç²¾åº¦ãŒè½ã¡ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
                        </div>
                    </details>
                `;
            }

            const aiClass = term.aiMode ? 'ai-mode' : '';
            // æ–‡è¨€å¤‰æ›´: ESTIMATER -> ESTIMATOR
            const aiIcon = term.aiMode ? 'ğŸ“Š' : 'ğŸ§®';
            const aiText = term.aiMode ? 'æ¨å®šã‚’å®Ÿè¡Œ' : 'CALCULATE';
            const titleText = term.aiMode ? 'ESTIMATOR' : 'SIMULATOR';

            calcHtml = `
                <div class="section-label">LABORATORY / ${aiText}</div>
                <div class="calc-container ${aiClass}" id="calc-container">
                    <div class="calc-title">
                        <div><span>${aiIcon}</span> ${term.title} ${titleText}</div>
                    </div>
                    
                    <!-- Preset Controls -->
                    <div class="preset-bar">
                        <div class="preset-label">ğŸ’¾ æˆç¸¾ãƒ—ãƒªã‚»ãƒƒãƒˆ (è‡ªå‹•å…¥åŠ›)</div>
                        <select class="preset-select" id="preset-select">
                            <option value="">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ...</option>
                        </select>
                        <button type="button" class="preset-btn btn-load" onclick="loadPreset()">èª­è¾¼</button>
                        <button type="button" class="preset-btn btn-del" onclick="removePreset()" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                        <div style="flex-basis: 100%; height: 0; margin: 0;"></div> <!-- Line break for visual -->
                        <input type="text" class="preset-input" id="preset-name" placeholder="æ–°è¦ä¿å­˜å (ä¾‹: 2024å±±ç”°)">
                        <button type="button" class="preset-btn btn-save" onclick="savePreset()">ä¿å­˜</button>
                    </div>

                    <div class="calc-inputs">
                        ${basicInputsHtml}
                        ${advancedSectionHtml}
                    </div>
                    <button class="calc-btn" onclick="calculateMetric('${term.id}')">
                        ${aiText}
                    </button>
                    <div class="calc-result-area">
                        <!-- æ–‡è¨€å¤‰æ›´: ESTIMATED -> æ¨å®šå€¤ -->
                        <div class="calc-res-label">RESULT ${term.aiMode ? '<span>æ¨å®šå€¤</span>' : ''}:</div>
                        <div class="calc-res-value" id="calc-result">---</div>
                    </div>
                </div>
            `;
        }

        const catLabel = getCatLabel(term.category);
        const catColor = getCatColor(term.category);

        // Header
        modalTitleArea.innerHTML = `
            <div class="m-cat" style="color:${catColor}">${catLabel}</div>
            <h2 class="m-title">${term.title}</h2>
            <div class="m-full">${term.full}</div>
        `;

        // Body
        modalBodyContent.innerHTML = `
            <p style="font-size:1.2rem; font-weight:700; line-height:1.6; color:var(--c-text-primary);">${term.short}</p>
            ${term.desc ? `<p style="color:var(--c-text-secondary); line-height:1.8;">${term.desc}</p>` : ''}

            <div class="section-label">è¨ˆç®—å¼ / FORMULA</div>
            <div class="formula-box">${term.formula}</div>

            ${calcHtml}

            <div class="section-label">è©•ä¾¡åŸºæº– / CRITERIA</div>
            <table class="criteria-table">
                <tr><th>ç›®å®‰</th><td>${term.criteria || '---'}</td></tr>
            </table>

            <div class="section-label">é–¢é€£æŒ‡æ¨™ / RELATED</div>
            <div class="related-grid">${relatedHtml || '<span style="color:#94a3b8; font-size:0.9rem">ãªã—</span>'}</div>
        `;

        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('show');
        });

        // Initialize Preset List
        updatePresetList();
    }

    // Logic to check advanced inputs
    window.checkAdvancedChanges = function() {
        const warningBox = document.getElementById('warning-box');
        if (!warningBox) return;

        const advInputs = document.querySelectorAll('.advanced-input');
        let isChanged = false;

        advInputs.forEach(input => {
            const key = input.id.replace('calc-', '').toUpperCase();
            const defVal = DEFAULTS[key];
            if (defVal !== undefined && parseFloat(input.value) !== defVal) {
                isChanged = true;
            }
        });

        warningBox.style.display = isChanged ? 'flex' : 'none';
    }

    // Calculation Function
    window.calculateMetric = function(id) {
        const term = terms.find(t => t.id === id);
        if(!term || !term.inputs) return;

        const data = {};
        let allFilled = true;
        
        term.inputs.forEach(inp => {
            const el = document.getElementById(`calc-${inp.id}`);
            const val = el.value;
            if(val === '' && inp.type !== 'select') allFilled = false;
            
            if(inp.type === 'select') {
                data[inp.id] = val;
            } else {
                data[inp.id] = parseFloat(val) || 0;
            }
        });

        if(!allFilled && !confirm("æœªå…¥åŠ›ã®é …ç›®ã¯0ã¨ã—ã¦è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿ")) return;

        const result = term.calc(data);
        
        const resDiv = document.getElementById('calc-result');
        resDiv.style.opacity = 0;
        resDiv.style.transform = "translateY(10px)";
        setTimeout(() => {
            resDiv.innerHTML = result;
            resDiv.style.transition = "all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)";
            resDiv.style.opacity = 1;
            resDiv.style.transform = "translateY(0)";
        }, 50);
    }

    function closeModal() {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    function closeModalOutside(e) {
        if (e.target === modal) closeModal();
    }

    /* --- Batch Calculator Logic --- */
    function openBatchCalc(mode) {
        const isBat = mode === 'bat';
        const title = isBat ? "é‡æ‰‹æŒ‡æ¨™ ä¸€æ‹¬è¨ˆç®— (Batch Batter)" : "æŠ•æ‰‹æŒ‡æ¨™ ä¸€æ‹¬è¨ˆç®— (Batch Pitcher)";
        const catColor = isBat ? getCatColor('bat') : getCatColor('pit');
        
        // Define input fields for batch mode
        let fields = [];
        if (isBat) {
            fields = [
                {id:'pa', label:'æ‰“å¸­æ•°'}, {id:'ab', label:'æ‰“æ•°'},
                {id:'h', label:'å®‰æ‰“'}, {id:'d', label:'äºŒå¡æ‰“'}, {id:'t', label:'ä¸‰å¡æ‰“'}, {id:'hr', label:'æœ¬å¡æ‰“'},
                {id:'bb', label:'å››çƒ'}, {id:'hbp', label:'æ­»çƒ', default:0}, {id:'so', label:'ä¸‰æŒ¯', default:0},
                {id:'sf', label:'çŠ é£›', default:0}, {id:'sh', label:'çŠ æ‰“', default:0},
                {id:'sb', label:'ç›—å¡', default:0}, {id:'cs', label:'ç›—å¡æ­»', default:0},
                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                {id:'pos', label:'å®ˆå‚™ä½ç½®', type:'select', options:{'dh':'DH', '1b':'ä¸€å¡', 'lf':'å·¦ç¿¼', 'rf':'å³ç¿¼', '3b':'ä¸‰å¡', '2b':'äºŒå¡', 'cf':'ä¸­å …', 'ss':'éŠæ’ƒ', 'c':'æ•æ‰‹'}},
                {id:'def', label:'å®ˆå‚™è©•ä¾¡', type:'select', options:{'0':'å¹³å‡çš„ (0)', '5':'ä¸Šæ‰‹ã„ (+5)', '10':'åæ‰‹ (+10)', '15':'ç¥ (+15)', '-5':'è‹¦æ‰‹ (-5)', '-10':'ä¸‹æ‰‹ (-10)'}}
            ];
        } else {
            fields = [
                {id:'ip', label:'æŠ•çƒå›'}, {id:'er', label:'è‡ªè²¬ç‚¹'}, {id:'r', label:'å¤±ç‚¹'},
                {id:'h', label:'è¢«å®‰æ‰“'}, {id:'hr', label:'è¢«æœ¬å¡æ‰“'}, {id:'bb', label:'ä¸å››çƒ'}, {id:'hbp', label:'ä¸æ­»çƒ', default:0},
                {id:'so', label:'å¥ªä¸‰æŒ¯'}, 
                {id:'gb', label:'ã‚´ãƒ­', default:0}, {id:'fb', label:'ãƒ•ãƒ©ã‚¤', default:0}, {id:'pu', label:'å†…é‡ãƒ•ãƒ©ã‚¤', default:0},
                {id:'stadium', label:'æœ¬æ‹ åœ°', type:'select', options: Object.keys(PARK_FACTORS).reduce((acc, key) => ({...acc, [key]: PARK_FACTORS[key].name}), {})},
                {id:'role', label:'å½¹å‰²', type:'select', options:{'sp':'å…ˆç™º', 'rp':'æ•‘æ´'}}
            ];
        }

        // Generate HTML
        const inputsHtml = fields.map(inp => createInputHtml(inp)).join('');
        
        // Generate Advanced Settings (Shared)
        // Using the same structure as individual calculators for League constants
        // For simplicity, we'll just inject a hidden container that holds default league values or use global defaults in calculation
        // To allow editing, we can reuse the advanced inputs html generation but it's getting large.
        // Let's just add the most critical League Stats for context.
        const advFields = isBat ? 
            ['lg_pa', 'lg_ab', 'lg_runs', 'lg_hits', 'lg_bb', 'lg_hbp', 'lg_sf'] : 
            ['lg_pa', 'lg_runs', 'lg_hits', 'lg_bb']; // Pitching simplified context
            
        // Find definitions for these advanced fields from existing terms (e.g., from WAR)
        const warTerm = terms.find(t => t.id === (isBat ? 'war' : 'pit_war'));
        const advInputsHtml = warTerm.inputs.filter(i => i.advanced).map(inp => createInputHtml(inp)).join('');

        const html = `
            <div class="section-label">INPUT DATA / ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</div>
            <div class="calc-container" style="border-color:${catColor}">
                
                <!-- Preset Controls (Added to Batch Mode) -->
                <div class="preset-bar">
                    <div class="preset-label">ğŸ’¾ æˆç¸¾ãƒ—ãƒªã‚»ãƒƒãƒˆ (è‡ªå‹•å…¥åŠ›)</div>
                    <select class="preset-select" id="preset-select">
                        <option value="">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ...</option>
                    </select>
                    <button type="button" class="preset-btn btn-load" onclick="loadPreset()">èª­è¾¼</button>
                    <button type="button" class="preset-btn btn-del" onclick="removePreset()" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                    <div style="flex-basis: 100%; height: 0; margin: 0;"></div> <!-- Line break for visual -->
                    <input type="text" class="preset-input" id="preset-name" placeholder="æ–°è¦ä¿å­˜å (ä¾‹: 2024å±±ç”°)">
                    <button type="button" class="preset-btn btn-save" onclick="savePreset()">ä¿å­˜</button>
                </div>

                <div class="calc-inputs">
                    ${inputsHtml}
                    <details class="advanced-details">
                        <summary class="advanced-summary">è©³ç´°è¨­å®š (ãƒªãƒ¼ã‚°å¹³å‡å€¤ãªã©)</summary>
                        <div class="advanced-content">
                            ${advInputsHtml}
                        </div>
                    </details>
                </div>
                <button class="calc-btn" style="background:${catColor}" onclick="runBatchCalc('${mode}')">
                    ä¸€æ‹¬è¨ˆç®—å®Ÿè¡Œ (CALCULATE ALL)
                </button>
            </div>
            <div id="batch-results-area" style="margin-top:30px;"></div>
        `;

        modalTitleArea.innerHTML = `
            <div class="m-cat" style="color:${catColor}">BATCH CALCULATOR</div>
            <h2 class="m-title">${title}</h2>
        `;
        modalBodyContent.innerHTML = html;
        
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('show');
        });
        
        // Initialize Preset List for Batch Mode
        updatePresetList();
    }

    function runBatchCalc(mode) {
        const isBat = mode === 'bat';
        const data = {};
        
        // Collect all inputs
        const inputs = document.querySelectorAll('.calc-field, .calc-select');
        inputs.forEach(el => {
            const id = el.id.replace('calc-', '');
            if(el.tagName === 'SELECT') {
                data[id] = el.value;
            } else {
                data[id] = parseFloat(el.value) || 0;
            }
        });

        // Calculate Indicators
        let results = [];
        
        terms.forEach(term => {
            // Check if this term belongs to the current mode (category check)
            // bat/std/fld/tot for Batters
            // pit/std/tot for Pitchers
            let isRelevant = false;
            if (isBat) {
                if (['bat', 'std', 'fld', 'tot'].includes(term.category)) isRelevant = true;
                // Exclude pitching specific terms even if in 'tot' or 'std' (like ERA)
                if (term.id === 'era' || term.id === 'whip' || term.category === 'pit') isRelevant = false;
                // Special case: WAR is relevant
                if (term.id === 'pit_war') isRelevant = false;
            } else {
                if (['pit', 'std', 'tot'].includes(term.category)) isRelevant = true;
                // Exclude batting specific
                if (['bat', 'fld'].includes(term.category)) isRelevant = false;
                if (term.id === 'war') isRelevant = false; // Exclude Batter WAR
                // Include basics like ERA, WHIP
            }

            if (isRelevant && term.calc) {
                try {
                    // Check if we have necessary inputs? 
                    // term.calc will run with 0s if missing, which is acceptable for batch
                    // However, we should try to avoid NaN results
                    const res = term.calc(data);
                    if (res !== "---" && res !== "NaN" && res !== "Infinity") {
                        results.push({
                            title: term.title,
                            full: term.full,
                            value: res,
                            criteria: term.criteria,
                            cat: term.category
                        });
                    }
                } catch(e) {
                    // skip errors
                }
            }
        });

        // Render Table
        if (results.length === 0) {
            document.getElementById('batch-results-area').innerHTML = '<div class="no-result">è¨ˆç®—å¯èƒ½ãªæŒ‡æ¨™ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
            return;
        }

        let tableHtml = `
            <div class="section-label">CALCULATION RESULTS / çµæœä¸€è¦§</div>
            <table class="criteria-table">
                <thead>
                    <tr style="background:var(--c-bg);">
                        <th style="padding-left:10px;">æŒ‡æ¨™ (METRIC)</th>
                        <th style="text-align:right; padding-right:20px;">å€¤ (VALUE)</th>
                        <th>åŸºæº– (CRITERIA)</th>
                    </tr>
                </thead>
                <tbody>
        `;

        results.forEach(r => {
            const catColor = getCatColor(r.cat);
            tableHtml += `
                <tr>
                    <td style="padding-left:10px;">
                        <span style="color:${catColor}; font-weight:900;">${r.title}</span>
                        <div style="font-size:0.75rem; color:var(--c-text-secondary);">${r.full}</div>
                    </td>
                    <td style="text-align:right; padding-right:20px; font-family:var(--font-mono); font-size:1.5rem; font-weight:700; color:var(--c-text-primary);">
                        ${r.value}
                    </td>
                    <td style="font-size:0.85rem; color:var(--c-text-secondary);">
                        ${r.criteria || '-'}
                    </td>
                </tr>
            `;
        });

        tableHtml += `</tbody></table>`;
        
        // Add Copy Button
        tableHtml += `
            <button class="calc-btn" style="margin-top:20px; background:var(--c-text-secondary);" onclick="copyBatchResults()">
                ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼ (COPY TEXT)
            </button>
        `;

        const resArea = document.getElementById('batch-results-area');
        resArea.innerHTML = tableHtml;
        resArea.scrollIntoView({behavior: 'smooth'});
    }

    function copyBatchResults() {
        const rows = document.querySelectorAll('#batch-results-area tr');
        let text = "ã€SABR METRICS LAB Calculation Resultsã€‘\n";
        rows.forEach((row, i) => {
            if(i===0) return; // skip header
            const cols = row.querySelectorAll('td');
            if(cols.length > 0) {
                const metric = cols[0].querySelector('span').innerText;
                const value = cols[1].innerText.trim();
                text += `${metric}: ${value}\n`;
            }
        });
        navigator.clipboard.writeText(text).then(() => {
            alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
        });
    }

    /* --- Preset Logic (LocalStorage) --- */
    const STORAGE_KEY = 'sabr_metrics_presets';

    function getPresets() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        } catch (e) {
            console.error("Failed to parse presets", e);
            return {};
        }
    }

    function savePresets(presets) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(presets));
    }

    function updatePresetList() {
        const select = document.getElementById('preset-select');
        if (!select) return;

        const presets = getPresets();
        select.innerHTML = '<option value="">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ...</option>';
        
        Object.keys(presets).forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        });
    }

    window.savePreset = function() {
        const nameInput = document.getElementById('preset-name');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('ä¿å­˜åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // Collect current input values
        const inputs = document.querySelectorAll('.calc-field, .calc-select');
        const data = {};
        let hasData = false;

        inputs.forEach(input => {
            // Strip "calc-" prefix from ID
            const key = input.id.replace('calc-', '');
            if (input.value) {
                data[key] = input.value;
                hasData = true;
            }
        });

        if (!hasData) {
            alert('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }

        const presets = getPresets();
        if (presets[name] && !confirm(`"${name}" ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
        }

        presets[name] = data;
        savePresets(presets);
        
        updatePresetList();
        document.getElementById('preset-select').value = name;
        nameInput.value = ''; // clear input
        alert(`"${name}" ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
    }

    window.loadPreset = function() {
        const select = document.getElementById('preset-select');
        const name = select.value;
        
        if (!name) return;

        const presets = getPresets();
        const data = presets[name];
        
        if (data) {
            let count = 0;
            Object.keys(data).forEach(key => {
                const el = document.getElementById(`calc-${key}`);
                if (el) {
                    el.value = data[key];
                    // Visual feedback
                    el.style.backgroundColor = "#f0fdf4";
                    setTimeout(() => el.style.backgroundColor = "", 1000);
                    count++;
                }
            });
            
            // Trigger advanced check if any advanced inputs were loaded
            if (window.checkAdvancedChanges) window.checkAdvancedChanges();
        }
    }

    window.removePreset = function() {
        const select = document.getElementById('preset-select');
        const name = select.value;
        
        if (!name) return;

        // "Are you sure?" confirmation removed for easier deletion
        const presets = getPresets();
        if (presets[name]) {
            delete presets[name];
            savePresets(presets);
            updatePresetList();
            select.value = ""; // Reset selection
            alert(`"${name}" ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
    }

    // Initial Render
    render();

</script>
</body>
</html>
